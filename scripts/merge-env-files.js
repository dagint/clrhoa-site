#!/usr/bin/env node
/**
 * Merge .vars.local and .secrets.local into .env.local for local development.
 * This makes .vars.local and .secrets.local the authoritative source.
 * 
 * Run: node scripts/merge-env-files.js
 * Or it runs automatically before dev/build via npm scripts.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const VARS_FILE = '.vars.local';
const SECRETS_FILE = '.secrets.local';
const OUTPUT_FILE = '.env.local';

function parseEnvFile(filePath) {
  if (!fs.existsSync(filePath)) {
    return {};
  }
  
  const content = fs.readFileSync(filePath, 'utf-8');
  const vars = {};
  
  for (const line of content.split('\n')) {
    const trimmed = line.trim();
    // Skip comments and empty lines
    if (!trimmed || trimmed.startsWith('#')) continue;
    
    const match = trimmed.match(/^([A-Z_][A-Z0-9_]*)\s*=\s*(.*)$/);
    if (match) {
      const [, name, value] = match;
      // Remove quotes if present
      const cleanValue = value.replace(/^["']|["']$/g, '').trim();
      // Only include non-empty values (skip SET_ME and empty)
      if (cleanValue && cleanValue !== 'SET_ME') {
        vars[name] = cleanValue;
      }
    }
  }
  
  return vars;
}

function main() {
  const varsPath = path.join(process.cwd(), VARS_FILE);
  const secretsPath = path.join(process.cwd(), SECRETS_FILE);
  const outputPath = path.join(process.cwd(), OUTPUT_FILE);
  
  const vars = parseEnvFile(varsPath);
  const secrets = parseEnvFile(secretsPath);
  
  // Merge: secrets override vars if there's a conflict (secrets take precedence)
  const merged = { ...vars, ...secrets };
  
  if (Object.keys(merged).length === 0) {
    console.log('⚠️  No variables found in .vars.local or .secrets.local');
    console.log('   .env.local will be empty or unchanged\n');
    return;
  }
  
  // Build output file
  const lines = [
    '# Auto-generated from .vars.local and .secrets.local',
    '# DO NOT EDIT THIS FILE DIRECTLY',
    '# Edit .vars.local (for PUBLIC_* vars) and .secrets.local (for secrets) instead',
    '# Then run: npm run env:merge',
    '#',
    '',
  ];
  
  // Group by type
  const publicVars = Object.keys(merged).filter(k => k.startsWith('PUBLIC_') || k === 'SITE' || k === 'SITE_LAST_MODIFIED');
  const runtimeSecrets = Object.keys(merged).filter(k => !publicVars.includes(k));
  
  if (publicVars.length > 0) {
    lines.push('# Build-time variables (PUBLIC_*)');
    publicVars.sort().forEach(name => {
      lines.push(`${name}=${merged[name]}`);
    });
    lines.push('');
  }
  
  if (runtimeSecrets.length > 0) {
    lines.push('# Runtime secrets (Workers)');
    runtimeSecrets.sort().forEach(name => {
      lines.push(`${name}=${merged[name]}`);
    });
    lines.push('');
  }
  
  fs.writeFileSync(outputPath, lines.join('\n'), 'utf-8');
  
  console.log(`✅ Merged ${publicVars.length} vars and ${runtimeSecrets.length} secrets into ${OUTPUT_FILE}`);
  console.log(`   Source: ${VARS_FILE} + ${SECRETS_FILE}\n`);
}

try {
  main();
} catch (err) {
  console.error('Error:', err);
  process.exit(1);
}
