# Deploy to Cloudflare Pages and sync secrets from GitHub Secrets
name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Required if variables are set under Settings → Environments → production.
    # PUBLIC_* must be in GitHub Variables (Actions → Variables, or Environment → production → Variables), NOT Secrets.
    environment: production
    permissions:
      contents: read
      deployments: write
    # Build-time PUBLIC_* vars: set once at job level so Build and Sync steps inherit them.
    # They are inlined into the site at build; ensure they exist in GitHub Variables (not Secrets).
    env:
      CI: true
      SITE: ${{ vars.SITE }}
      SITE_LAST_MODIFIED: ${{ vars.SITE_LAST_MODIFIED }}
      PUBLIC_STATICFORMS_API_KEY: ${{ vars.PUBLIC_STATICFORMS_API_KEY }}
      PUBLIC_RECAPTCHA_SITE_KEY: ${{ vars.PUBLIC_RECAPTCHA_SITE_KEY }}
      PUBLIC_ANALYTICS_PROVIDER: ${{ vars.PUBLIC_ANALYTICS_PROVIDER }}
      PUBLIC_CLOUDFLARE_WEB_ANALYTICS_TOKEN: ${{ vars.PUBLIC_CLOUDFLARE_WEB_ANALYTICS_TOKEN }}
      PUBLIC_SECURITY_EMAIL: ${{ vars.PUBLIC_SECURITY_EMAIL }}
      PUBLIC_MAILING_ADDRESS_NAME: ${{ vars.PUBLIC_MAILING_ADDRESS_NAME }}
      PUBLIC_MAILING_ADDRESS_LINE1: ${{ vars.PUBLIC_MAILING_ADDRESS_LINE1 }}
      PUBLIC_MAILING_ADDRESS_LINE2: ${{ vars.PUBLIC_MAILING_ADDRESS_LINE2 }}
      PUBLIC_PHYSICAL_ADDRESS_STREET: ${{ vars.PUBLIC_PHYSICAL_ADDRESS_STREET }}
      PUBLIC_PHYSICAL_ADDRESS_CITY: ${{ vars.PUBLIC_PHYSICAL_ADDRESS_CITY }}
      PUBLIC_PHYSICAL_ADDRESS_STATE: ${{ vars.PUBLIC_PHYSICAL_ADDRESS_STATE }}
      PUBLIC_PHYSICAL_ADDRESS_ZIP: ${{ vars.PUBLIC_PHYSICAL_ADDRESS_ZIP }}
      PUBLIC_MEETING_LOCATION: ${{ vars.PUBLIC_MEETING_LOCATION }}
      PUBLIC_MEETING_ROOM: ${{ vars.PUBLIC_MEETING_ROOM }}
      PUBLIC_MEETING_ADDRESS_STREET: ${{ vars.PUBLIC_MEETING_ADDRESS_STREET }}
      PUBLIC_MEETING_ADDRESS_CITY: ${{ vars.PUBLIC_MEETING_ADDRESS_CITY }}
      PUBLIC_MEETING_ADDRESS_STATE: ${{ vars.PUBLIC_MEETING_ADDRESS_STATE }}
      PUBLIC_MEETING_ADDRESS_ZIP: ${{ vars.PUBLIC_MEETING_ADDRESS_ZIP }}
      PUBLIC_TRASH_SCHEDULE: ${{ vars.PUBLIC_TRASH_SCHEDULE }}
      PUBLIC_RECYCLING_SCHEDULE: ${{ vars.PUBLIC_RECYCLING_SCHEDULE }}
      PUBLIC_RECYCLING_CENTER_NAME: ${{ vars.PUBLIC_RECYCLING_CENTER_NAME }}
      PUBLIC_RECYCLING_CENTER_ADDRESS: ${{ vars.PUBLIC_RECYCLING_CENTER_ADDRESS }}
      PUBLIC_RECYCLING_CENTER_HOURS: ${{ vars.PUBLIC_RECYCLING_CENTER_HOURS }}
      PUBLIC_RECYCLING_CENTER_PHONE: ${{ vars.PUBLIC_RECYCLING_CENTER_PHONE }}
      PUBLIC_RECYCLING_CENTER_WEBSITE: ${{ vars.PUBLIC_RECYCLING_CENTER_WEBSITE }}
      PUBLIC_WASTE_MANAGEMENT_CONTACT: ${{ vars.PUBLIC_WASTE_MANAGEMENT_CONTACT }}
      PUBLIC_WASTE_MANAGEMENT_PHONE: ${{ vars.PUBLIC_WASTE_MANAGEMENT_PHONE }}
      PUBLIC_WASTE_MANAGEMENT_WEBSITE: ${{ vars.PUBLIC_WASTE_MANAGEMENT_WEBSITE }}
      PUBLIC_QUARTERLY_DUES_AMOUNT: ${{ vars.PUBLIC_QUARTERLY_DUES_AMOUNT }}
      PUBLIC_PAYMENT_METHODS: ${{ vars.PUBLIC_PAYMENT_METHODS }}
      PUBLIC_LATE_FEE_AMOUNT: ${{ vars.PUBLIC_LATE_FEE_AMOUNT }}
      PUBLIC_LATE_FEE_DAYS: ${{ vars.PUBLIC_LATE_FEE_DAYS }}
      PUBLIC_PAYMENT_INSTRUCTIONS: ${{ vars.PUBLIC_PAYMENT_INSTRUCTIONS }}
      PUBLIC_PAYMENT_DROP_OFF_LOCATION: ${{ vars.PUBLIC_PAYMENT_DROP_OFF_LOCATION }}
      PUBLIC_WATER_RESTRICTION_SCHEDULE: ${{ vars.PUBLIC_WATER_RESTRICTION_SCHEDULE }}
      PUBLIC_WATER_RESTRICTION_PHONE: ${{ vars.PUBLIC_WATER_RESTRICTION_PHONE }}
      PUBLIC_WATER_RESTRICTION_WEBSITE: ${{ vars.PUBLIC_WATER_RESTRICTION_WEBSITE }}
      PUBLIC_WATER_UTILITY_CONTACT: ${{ vars.PUBLIC_WATER_UTILITY_CONTACT }}
      PUBLIC_WATER_UTILITY_PHONE: ${{ vars.PUBLIC_WATER_UTILITY_PHONE }}
      PUBLIC_WATER_UTILITY_WEBSITE: ${{ vars.PUBLIC_WATER_UTILITY_WEBSITE }}
      PUBLIC_FACEBOOK_URL: ${{ vars.PUBLIC_FACEBOOK_URL }}
      PUBLIC_TWITTER_URL: ${{ vars.PUBLIC_TWITTER_URL }}
      PUBLIC_INSTAGRAM_URL: ${{ vars.PUBLIC_INSTAGRAM_URL }}
      PUBLIC_NEXTDOOR_URL: ${{ vars.PUBLIC_NEXTDOOR_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Verify PUBLIC_* vars are available (masked in logs). If many show "missing", add them in GitHub → Variables or Environment production.
      - name: Verify public env vars
        run: node -e "
          const names = ['SITE','SITE_LAST_MODIFIED','PUBLIC_RECAPTCHA_SITE_KEY','PUBLIC_MEETING_LOCATION','PUBLIC_QUARTERLY_DUES_AMOUNT','PUBLIC_MAILING_ADDRESS_NAME','PUBLIC_SECURITY_EMAIL'];
          console.log('Public env vars (set = non-empty, missing = empty/not set):');
          names.forEach(n => { const v = process.env[n]; console.log('  ' + n + ': ' + (v && v.length ? 'set (' + v.length + ' chars)' : 'missing')); });
          console.log('If key vars show missing, set them in GitHub: Settings → Environments → production → Environment variables (or Actions → Variables).');
        "

      - name: Build
        run: npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_DEPLOY_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: clrhoa-site
          directory: dist
          # Git commit info for deployment
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync Secrets to Cloudflare Pages
        if: success()
        run: |
          echo "Syncing secrets and variables from GitHub to Cloudflare Pages..."
          node scripts/sync-secrets-to-cloudflare-pages.js
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_DEPLOY_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
          NOTIFY_BOARD_EMAIL: ${{ secrets.NOTIFY_BOARD_EMAIL }}
          NOTIFY_ARB_EMAIL: ${{ secrets.NOTIFY_ARB_EMAIL }}
          NOTIFY_NOREPLY_EMAIL: ${{ secrets.NOTIFY_NOREPLY_EMAIL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          MAILCHANNELS_API_KEY: ${{ secrets.MAILCHANNELS_API_KEY }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_PHONE_NUMBER: ${{ secrets.TWILIO_PHONE_NUMBER }}
          RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}
          # PUBLIC_* and SITE are inherited from job env (set above)

      - name: Deploy backup Worker and sync its secrets
        if: success()
        run: |
          echo "Injecting CLOUDFLARE_ACCOUNT_ID into backup worker wrangler.toml..."
          node -e "
            const fs = require('fs');
            const path = 'workers/backup/wrangler.toml';
            const accountId = process.env.CLOUDFLARE_ACCOUNT_ID || '';
            if (!accountId) { console.error('CLOUDFLARE_ACCOUNT_ID not set'); process.exit(1); }
            let c = fs.readFileSync(path, 'utf8');
            c = c.replace(/REPLACE_WITH_ACCOUNT_ID/g, accountId);
            fs.writeFileSync(path, c);
          "
          echo "Deploying backup Worker (clrhoa-backup)..."
          npx wrangler deploy --config workers/backup/wrangler.toml
          echo "Syncing secrets to backup Worker..."
          node scripts/sync-backup-worker-secrets.js
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_DEPLOY_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_BACKUP_API_TOKEN: ${{ secrets.CLOUDFLARE_BACKUP_API_TOKEN }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
          BACKUP_TRIGGER_SECRET: ${{ secrets.BACKUP_TRIGGER_SECRET }}
