---
/**
 * Role Switcher Component
 *
 * Displays current elevated role and provides revert/elevation controls.
 * Shows when user has elevated access (effectiveRole != 'member').
 */

import { getRoleInfo } from '../config/menus';

interface Props {
  effectiveRole: string;
  staffRole: string;
  elevatedUntil?: number;
  assumedRole?: string;
  assumedUntil?: number;
}

const { effectiveRole, staffRole, elevatedUntil, assumedRole, assumedUntil } = Astro.props;

const isElevated = effectiveRole !== 'member' && effectiveRole !== staffRole?.toLowerCase();
const roleInfo = getRoleInfo(effectiveRole);

// Calculate time remaining for elevation
const now = Date.now();
const elevationRemaining = elevatedUntil && elevatedUntil > now
  ? Math.ceil((elevatedUntil - now) / 1000 / 60) // minutes
  : 0;

const assumptionRemaining = assumedUntil && assumedUntil > now
  ? Math.ceil((assumedUntil - now) / 1000 / 60) // minutes
  : 0;

// Don't show if not elevated
if (!isElevated && !assumedRole) {
  return null;
}

// Role-specific colors
const colorClasses: Record<string, string> = {
  purple: 'bg-purple-50 border-purple-200 text-purple-900',
  blue: 'bg-blue-50 border-blue-200 text-blue-900',
  green: 'bg-green-50 border-green-200 text-green-900',
  indigo: 'bg-indigo-50 border-indigo-200 text-indigo-900',
  gray: 'bg-gray-50 border-gray-200 text-gray-900',
};

const badgeColors: Record<string, string> = {
  purple: 'bg-purple-100 text-purple-800 border-purple-300',
  blue: 'bg-blue-100 text-blue-800 border-blue-300',
  green: 'bg-green-100 text-green-800 border-green-300',
  indigo: 'bg-indigo-100 text-indigo-800 border-indigo-300',
  gray: 'bg-gray-100 text-gray-800 border-gray-300',
};

const bgClass = colorClasses[roleInfo.color] || colorClasses.gray;
const badgeClass = badgeColors[roleInfo.color] || badgeColors.gray;
---

<div class={`role-switcher border rounded-lg p-3 mb-4 ${bgClass}`}>
  <div class="flex items-center justify-between gap-4">
    <div class="flex items-center gap-3 flex-1">
      <!-- Role Badge -->
      <div class={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold border ${badgeClass}`}>
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
        <span>{roleInfo.label}</span>
      </div>

      <!-- Status Text -->
      <div class="flex-1">
        <div class="text-sm font-medium">
          Currently elevated as <span class="font-semibold">{roleInfo.label}</span>
        </div>
        {elevationRemaining > 0 && (
          <div class="text-xs opacity-75 mt-0.5">
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {elevationRemaining} minutes remaining
          </div>
        )}
        {assumedRole && assumptionRemaining > 0 && (
          <div class="text-xs opacity-75 mt-0.5">
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
            </svg>
            Role assumed ({assumptionRemaining}min left)
          </div>
        )}
      </div>
    </div>

    <!-- Revert Button -->
    <form action="/api/pim/de-elevate" method="POST" class="shrink-0">
      <input type="hidden" name="return_url" value={Astro.url.pathname} />
      <button
        type="submit"
        class="px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors
               hover:bg-white hover:shadow-sm
               focus:outline-none focus:ring-2 focus:ring-offset-1"
        title="Revert to member access"
      >
        <svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
        </svg>
        Revert
      </button>
    </form>
  </div>

  <!-- Help Text -->
  <details class="mt-2">
    <summary class="text-xs opacity-60 cursor-pointer hover:opacity-80 transition-opacity">
      What does this mean?
    </summary>
    <div class="mt-2 text-xs opacity-75 space-y-1">
      <p>
        You're currently using elevated {roleInfo.label} permissions. Your actions are audited.
      </p>
      <p>
        Click <strong>Revert</strong> to return to normal member access. You can re-elevate anytime.
      </p>
      {assumedRole && (
        <p class="mt-1 pt-1 border-t border-current/20">
          <strong>Role Assumption:</strong> Acting as {assumedRole} only. Drop this role to assume another.
        </p>
      )}
    </div>
  </details>
</div>

<style>
  details summary::-webkit-details-marker {
    display: none;
  }
  details summary::marker {
    content: '';
  }
  details summary::before {
    content: 'â–¸ ';
    display: inline-block;
    transition: transform 0.2s;
  }
  details[open] summary::before {
    transform: rotate(90deg);
  }
</style>
