---
/**
 * Dynamic Navigation Component
 *
 * Automatically adapts navigation based on user's effective role.
 * Switches menus instantly when role changes (elevation/reversion).
 */

import { getPrimaryLinksForRole, getSecondaryLinksForRole, universalLinks, getRoleInfo } from '../config/menus';

interface Props {
  currentPath: string;
  effectiveRole: string;
  staffRole?: string;
  draftCount?: number;
  arbInReviewCount?: number;
  vendorPendingCount?: number;
}

const {
  currentPath,
  effectiveRole,
  staffRole = '',
  draftCount = 0,
  arbInReviewCount = 0,
  vendorPendingCount = 0,
} = Astro.props;

// Get role-specific menus
const primaryLinks = getPrimaryLinksForRole(effectiveRole);
const secondaryLinks = getSecondaryLinksForRole(effectiveRole);
const roleInfo = getRoleInfo(effectiveRole);

// Check if current path matches a link
function isCurrent(href: string): boolean {
  if (href === '/portal/dashboard') return currentPath === '/portal/dashboard';
  if (href === '/portal/board') return currentPath === '/portal/board' || currentPath.startsWith('/board/');
  if (href === '/portal/admin') return currentPath === '/portal/admin' || currentPath.startsWith('/portal/admin/');
  if (href === '/portal/arb') return currentPath === '/portal/arb' || currentPath.startsWith('/portal/arb');
  return currentPath.startsWith(href);
}

const linkClass = (href: string) =>
  isCurrent(href)
    ? 'text-clr-green font-medium'
    : 'text-gray-600 hover:text-clr-green portal-theme-text-muted';

// Determine if user has elevated access
const isElevated = effectiveRole !== 'member';
const canElevate = staffRole && staffRole !== 'member' && !isElevated;
---

<header class="bg-white portal-theme-header portal-header-accent shadow-sm" role="banner">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <!-- Logo & Role Badge -->
      <a href={roleInfo.landingZone} class="flex flex-col shrink-0">
        <span class="flex items-center gap-2">
          <span class="text-xl font-heading font-bold text-clr-green">Member Portal</span>
          {isElevated && (
            <span class="inline-flex items-center gap-1 rounded-full bg-blue-100 border border-blue-300 px-2 py-0.5 text-xs font-medium text-blue-800" aria-label={`Elevated as ${roleInfo.label}`}>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              {roleInfo.label}
            </span>
          )}
        </span>
        <span class="text-xs text-gray-500 portal-theme-text-muted mt-0.5">Crooked Lake Reserve HOA</span>
      </a>

      <!-- Navigation -->
      <nav class="flex flex-wrap items-center gap-2 sm:gap-3" aria-label="Portal navigation">
        <!-- Primary Links -->
        {primaryLinks.slice(0, 4).map((link) => (
          <a href={link.href} class={`text-sm ${linkClass(link.href)}`} title={link.description}>
            {link.label}
          </a>
        ))}

        <!-- More Dropdown -->
        {secondaryLinks.length > 0 && (
          <div class="portal-nav-dropdown relative inline-block">
            <details class="group" id="nav-more-details">
              <summary class="list-none cursor-pointer text-sm text-gray-600 hover:text-clr-green portal-theme-text-muted flex items-center gap-0.5 py-1 px-2 rounded hover:bg-gray-100" aria-haspopup="true">
                More
                <svg class="w-4 h-4 transition group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="absolute left-0 top-full mt-1 py-2 w-64 rounded-xl bg-white border border-gray-200 shadow-lg z-50 portal-theme-card" role="menu">
                {secondaryLinks.map((section) => (
                  <div>
                    {section.title && (
                      <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b border-gray-100">
                        {section.title}
                      </div>
                    )}
                    {section.items.map((item) => (
                      <a
                        href={item.href}
                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 portal-theme-text"
                        title={item.description}
                      >
                        {item.label}
                        {item.badge && (
                          <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            {item.badge}
                          </span>
                        )}
                      </a>
                    ))}
                  </div>
                ))}

                {/* Show elevation option if available */}
                {canElevate && (
                  <div class="border-t border-gray-200 mt-2 pt-2">
                    <a
                      href={`/portal/request-elevated-access?return=${encodeURIComponent(currentPath)}`}
                      class="block px-4 py-2 text-sm text-amber-700 hover:bg-amber-50 font-medium"
                    >
                      <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                      </svg>
                      Request Elevation
                    </a>
                  </div>
                )}
              </div>
            </details>
          </div>
        )}

        <!-- Universal Links Dropdown -->
        <div class="portal-nav-dropdown relative inline-block">
          <details class="group" id="nav-help-details">
            <summary class="list-none cursor-pointer text-sm text-gray-600 hover:text-clr-green portal-theme-text-muted flex items-center gap-0.5 py-1 px-2 rounded hover:bg-gray-100" aria-haspopup="true">
              Help
              <svg class="w-4 h-4 transition group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="absolute right-0 top-full mt-1 py-2 w-52 rounded-xl bg-white border border-gray-200 shadow-lg z-50 portal-theme-card" role="menu">
              {universalLinks.map((link) => (
                <a href={link.href} class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 portal-theme-text" title={link.description}>
                  {link.label}
                </a>
              ))}
            </div>
          </details>
        </div>

        <!-- Theme Toggle -->
        <button type="button" id="theme-toggle" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 portal-theme-text-muted shrink-0" aria-label="Toggle dark mode">
          <span id="theme-icon-light" class="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
          </span>
          <span id="theme-icon-dark">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </span>
        </button>

        <!-- Public Site Link -->
        <a href="/" class="text-sm text-gray-500 hover:text-clr-green portal-theme-text-muted" title="Back to public site">
          Public site
        </a>

        <!-- Sign Out -->
        <a href="/api/logout" class="text-sm text-gray-500 hover:text-clr-orange" title="Sign out of portal">
          Sign out
        </a>
      </nav>
    </div>
  </div>
</header>

<style>
  .portal-nav-dropdown details summary::-webkit-details-marker { display: none; }
  .portal-nav-dropdown details summary::marker { content: ''; }
</style>

<script is:inline>
  (function () {
    var KEY = 'clrhoa_theme';
    var root = document.documentElement;
    var toggle = document.getElementById('theme-toggle');
    var iconLight = document.getElementById('theme-icon-light');
    var iconDark = document.getElementById('theme-icon-dark');

    if (!toggle || !iconLight || !iconDark) return;

    function applyTheme(dark) {
      if (dark) {
        root.classList.add('dark');
        iconLight.classList.remove('hidden');
        iconDark.classList.add('hidden');
      } else {
        root.classList.remove('dark');
        iconLight.classList.add('hidden');
        iconDark.classList.remove('hidden');
      }
    }

    try {
      var stored = localStorage.getItem(KEY);
      var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(stored === 'dark' || (stored !== 'light' && prefersDark));
    } catch (_) {
      applyTheme(false);
    }

    toggle.addEventListener('click', function () {
      var isDark = root.classList.toggle('dark');
      try { localStorage.setItem(KEY, isDark ? 'dark' : 'light'); } catch (_) {}
      iconLight.classList.toggle('hidden', !isDark);
      iconDark.classList.toggle('hidden', isDark);
    });

    // Auto-close dropdowns on pointer leave
    document.querySelectorAll('.portal-nav-dropdown').forEach(function (el) {
      var detailsEl = el.querySelector('details');
      if (!detailsEl) return;
      var closeTimer = null;
      el.addEventListener('pointerleave', function () {
        closeTimer = setTimeout(function () {
          detailsEl.open = false;
        }, 400);
      });
      el.addEventListener('pointerenter', function () {
        if (closeTimer) clearTimeout(closeTimer);
      });
    });
  })();
</script>
