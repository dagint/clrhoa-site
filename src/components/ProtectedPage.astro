---
/**
 * Wrapper for portal pages that require auth. Validates session server-side.
 * Redirects (login + profile required) are done in middleware so they run before
 * any response is sent. We never call Astro.redirect() here to avoid ResponseSentError.
 * If session is missing (e.g. expired cookie, or middleware had no env), we render
 * a client-side redirect to login instead of calling Astro.redirect().
 */
export const prerender = false;

import { getSessionFromCookie } from '../lib/auth';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const secret = env?.SESSION_SECRET;
const cookieHeader = Astro.request.headers.get('cookie') ?? undefined;
const session = await getSessionFromCookie(cookieHeader, secret);
---

{!session ? (
  <div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
    <div class="text-center max-w-md">
      <p class="text-gray-700 mb-4">Session expired or invalid. Redirecting to login...</p>
      <a href="/portal/login" class="text-clr-green font-semibold hover:underline">Log in again</a>
    </div>
    <script is:inline>
      // Immediate JavaScript redirect (replaces archaic meta refresh)
      window.location.replace('/portal/login');
    </script>
    <noscript>
      {/* Fallback for browsers with JavaScript disabled - user can click the link */}
      <meta http-equiv="refresh" content="3;url=/portal/login" />
    </noscript>
  </div>
) : (
  <div class="contents">
    <slot />
  </div>
)}
