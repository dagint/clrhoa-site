---
/**
 * Reusable portal page wrapper with sidebar + header.
 * Reduces duplication across portal pages.
 * Usage: <PortalPage currentPath="/portal/page" pageTitle="Page Title" ...props>
 */
import ProtectedPage from './ProtectedPage.astro';
import PortalSidebar from './PortalSidebar.astro';
import PortalHeader from './PortalHeader.astro';
import PimElevationBanner from './PimElevationBanner.astro';

interface Props {
  currentPath: string;
  pageTitle: string;
  userName?: string;
  userEmail: string;
  effectiveRole?: string;
  draftCount?: number;
  role?: string;
  staffRole?: string;
  arbInReviewCount?: number;
  vendorPendingCount?: number;
  maintenanceOpenCount?: number;
  meetingsRsvpCount?: number;
  feedbackDueCount?: number;
  elevatedUntil?: number | null;
}

const {
  currentPath,
  pageTitle,
  userName,
  userEmail,
  effectiveRole = 'member',
  draftCount = 0,
  role = '',
  staffRole = '',
  arbInReviewCount = 0,
  vendorPendingCount = 0,
  maintenanceOpenCount = 0,
  meetingsRsvpCount = 0,
  feedbackDueCount = 0,
  elevatedUntil = null,
} = Astro.props;

// Get session from Astro.locals (set by middleware) to check elevation status
const session = Astro.locals.session;
const sessionElevatedUntil = (session as any)?.elevated_until;

// Use prop if provided, otherwise check session
const actualElevatedUntil = elevatedUntil ?? sessionElevatedUntil ?? null;

// Check if PIM elevation banner should be shown
const now = Date.now();
const showPimBanner = actualElevatedUntil && actualElevatedUntil > now;
---

<ProtectedPage>
  <!-- Sidebar Navigation -->
  <PortalSidebar
    currentPath={currentPath}
    draftCount={draftCount}
    role={effectiveRole}
    staffRole={staffRole}
    arbInReviewCount={arbInReviewCount}
    vendorPendingCount={vendorPendingCount}
    maintenanceOpenCount={maintenanceOpenCount}
    meetingsRsvpCount={meetingsRsvpCount}
    feedbackDueCount={feedbackDueCount}
  />

  <!-- Main Content Area -->
  <div id="portal-content" class="flex-1 flex flex-col overflow-hidden lg:ml-72 transition-all duration-300">
    <!-- Top Header -->
    <PortalHeader userName={userName} userEmail={userEmail} effectiveRole={effectiveRole}>
      <span slot="title">{pageTitle}</span>
    </PortalHeader>

    <!-- PIM Elevation Banner (shown when user has elevated access) -->
    <!-- Position below fixed header (h-16 = 64px) -->
    {showPimBanner && (
      <div class="mt-16">
        <PimElevationBanner elevatedUntil={actualElevatedUntil!} role={effectiveRole} />
      </div>
    )}

    <!-- Scrollable Content -->
    <!-- Padding adjusted based on whether banner is shown -->
    <main class={showPimBanner ? "flex-1 overflow-y-auto" : "flex-1 overflow-y-auto pt-16 lg:pt-16"}>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <slot />
      </div>
    </main>
  </div>
</ProtectedPage>
