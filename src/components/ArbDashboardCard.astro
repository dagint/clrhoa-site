---
import type { ArbRequest, ArbFile } from '../lib/arb-db';
import { sanitizeForDisplay } from '../lib/sanitize';

interface Props {
  request: ArbRequest;
  files: ArbFile[];
  approval: { status: string; by: string; date: string } | null;
}

const { request: req, files, approval } = Astro.props;

function getFileViewUrl(r2KeysJson: string): string | null {
  try {
    const o = JSON.parse(r2KeysJson) as { originals?: string[]; review?: string[]; archive?: string[] };
    const key = o.originals?.[0] ?? o.review?.[0] ?? o.archive?.[0];
    return key ? `/api/portal/file/${encodeURIComponent(key)}` : null;
  } catch {
    return null;
  }
}

function getFileViewerUrl(r2KeysJson: string): string | null {
  try {
    const o = JSON.parse(r2KeysJson) as { originals?: string[]; review?: string[]; archive?: string[] };
    const key = o.originals?.[0] ?? o.review?.[0] ?? o.archive?.[0];
    return key ? `/api/portal/file-view?key=${encodeURIComponent(key)}` : null;
  } catch {
    return null;
  }
}

const IMAGE_EXT = /\.(jpe?g|png|gif|webp|heic)$/i;
function isImageFilename(filename: string): boolean {
  return IMAGE_EXT.test(filename);
}

function isPdfFilename(filename: string): boolean {
  return /\.pdf$/i.test(filename);
}

function getAllFileUrls(files: ArbFile[]): string[] {
  return files
    .map((f) => getFileViewUrl(f.r2_keys))
    .filter((url): url is string => url !== null);
}

const APPLICATION_TYPES = ['Exterior Paint', 'Landscape Installation', 'Swimming Pool', 'Recreational Equipment', 'Fencing', 'Other'];
function selectedTypes(applicationType: string | null): string[] {
  return applicationType ? applicationType.split(',').map((s) => s.trim()).filter(Boolean) : [];
}
---

<button
  type="button"
  class="arb-summary w-full text-left p-4 sm:p-6 flex flex-wrap justify-between gap-2 items-start hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2"
  data-request-id={req.id}
  aria-expanded="false"
  aria-controls={`arb-details-${req.id}`}
  aria-label={`Toggle details for request ${req.id}`}
>
  <div class="flex-1 min-w-0" id={`arb-summary-${req.id}`}>
    <div class="flex flex-wrap justify-between gap-2 mb-2">
      <span class="font-mono text-sm text-gray-500" aria-label="Request ID">#{req.id}</span>
      <span
        class={`inline-flex px-2 py-1 rounded text-xs font-semibold shrink-0 ${
          req.status === 'pending'
            ? 'bg-amber-100 text-amber-800'
            : req.status === 'in_review'
              ? 'bg-blue-100 text-blue-800'
              : req.status === 'approved'
                ? 'bg-green-100 text-green-800'
                : req.status === 'cancelled'
                  ? 'bg-gray-100 text-gray-600'
                  : 'bg-red-100 text-red-800'
        }`}
      >
        {req.status === 'in_review' ? 'In review' : req.status === 'cancelled' ? 'Cancelled' : req.status}
      </span>
    </div>
    <p class="text-sm text-gray-600 mb-1"><strong>From:</strong> {req.owner_email}</p>
    {req.phone && <p class="text-sm text-gray-600 mb-1"><strong>Phone:</strong> {req.phone}</p>}
    {req.property_address && <p class="text-sm text-gray-600 mb-1"><strong>Address/Lot:</strong> {sanitizeForDisplay(req.property_address)}</p>}
    <p class="text-gray-700 line-clamp-2" set:html={sanitizeForDisplay(req.description)}></p>
    <div class="flex flex-wrap items-center gap-2 mt-2">
      <p class="text-xs text-gray-400">Submitted: {new Date(req.created).toLocaleString()}</p>
      {req.review_deadline && (
        <>
          <span class="text-xs text-gray-400">|</span>
          <p class={`text-xs font-semibold ${
            new Date(req.review_deadline) < new Date()
              ? 'text-red-600'
              : new Date(req.review_deadline) < new Date(Date.now() + 3 * 24 * 60 * 60 * 1000)
                ? 'text-amber-600'
                : 'text-gray-500'
          }`} data-deadline={req.review_deadline}>
            Deadline: {new Date(req.review_deadline).toLocaleDateString()}
            {new Date(req.review_deadline) < new Date() && ' (OVERDUE)'}
          </p>
        </>
      )}
    </div>
  </div>
  <span class="arb-chevron text-gray-400 shrink-0 ml-2" aria-hidden="true">&#9660;</span>
</button>
<div class="arb-details hidden border-t border-gray-100 bg-gray-50/50" data-request-id={req.id} id={`arb-details-${req.id}`} role="region" aria-labelledby={`arb-summary-${req.id}`}>
  <div class="p-4 sm:p-6 arb-details-screen">
    {req.revision_notes && (
      <div class="mb-4 rounded-xl border-2 border-amber-200 bg-amber-50 p-4">
        <p class="text-sm font-semibold text-amber-900 mb-1">ARB requested revisions (sent to owner)</p>
        <p class="text-sm text-amber-900 whitespace-pre-wrap" set:html={sanitizeForDisplay(req.revision_notes)}></p>
      </div>
    )}
    <div class="rounded-xl border border-gray-200 bg-white p-4 sm:p-6 space-y-4 text-sm read-only-form">
      <h3 class="text-lg font-heading font-bold text-clr-green border-b border-gray-100 pb-2 mb-2">Architectural Review Application</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-500 mb-1">Association</label>
          <div class="w-full rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-gray-600">Crooked Lake Reserve</div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-500 mb-1">Date of application</label>
          <div class="w-full rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-gray-600">{new Date(req.created).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-500 mb-1">Applicant</label>
          <div class="w-full rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-gray-700">{sanitizeForDisplay(req.applicant_name) || '-'}</div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-500 mb-1">Phone</label>
          <div class="w-full rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-gray-700">{req.phone ?? '-'}</div>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-500 mb-1">Property address</label>
          <div class="w-full rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-gray-700">{sanitizeForDisplay(req.property_address) || '-'}</div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-500 mb-1">Email</label>
          <div class="w-full rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-gray-700">{req.owner_email}</div>
        </div>
      </div>
      <div>
        <span class="block text-sm font-semibold text-gray-500 mb-2">Application for</span>
        <div class="flex flex-wrap gap-x-6 gap-y-2">
          {APPLICATION_TYPES.map((type) => (
            <label class="inline-flex items-center gap-2 text-gray-600">
              <input type="checkbox" disabled checked={selectedTypes(req.application_type).includes(type)} class="rounded border-gray-300 bg-gray-100" />
              <span class="text-sm">{type}</span>
            </label>
          ))}
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-500 mb-1">Description</label>
        <div class="w-full rounded-lg border border-gray-200 bg-gray-100 px-3 py-2 text-gray-700 whitespace-pre-wrap min-h-[80px]" set:html={sanitizeForDisplay(req.description)}></div>
      </div>
      <p class="text-xs text-gray-500">Submitted: {new Date(req.created).toLocaleString()}{req.updated_at ? ` - Last updated: ${new Date(req.updated_at).toLocaleString()}` : ''}</p>
      {req.owner_notes && (
        <div class="mt-3 rounded-lg border border-purple-200 bg-purple-50 p-3">
          <p class="text-xs font-semibold text-purple-900 mb-1">Owner Notes</p>
          <p class="text-sm text-purple-900 whitespace-pre-wrap" set:html={sanitizeForDisplay(req.owner_notes)}></p>
        </div>
      )}
      {(req.status === 'approved' || req.status === 'rejected') && approval && (
        <div class={`rounded-xl border-2 p-4 ${approval.status === 'approved' ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`}>
          <p class={`text-sm font-semibold ${approval.status === 'approved' ? 'text-green-900' : 'text-red-900'}`}>
            {approval.status === 'approved' ? 'Approved' : 'Rejected'} on {approval.date} by {approval.by}
          </p>
        </div>
      )}
      {files.length > 0 && (
        <div class="print-attachments-section pt-2 border-t border-gray-200">
          <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
            <p class="font-semibold text-gray-700 text-sm">Attachments ({files.length})</p>
            <button
              type="button"
              class="download-all-files no-print px-3 py-1.5 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-xs font-semibold text-gray-700 focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2"
              data-request-id={req.id}
              aria-label={`Download all ${files.length} attachments as ZIP`}
            >
              Download all as ZIP
            </button>
          </div>
          <ul class="space-y-3">
            {files.map((file) => {
              const viewUrl = getFileViewUrl(file.r2_keys);
              const viewerUrl = getFileViewerUrl(file.r2_keys);
              const isImage = isImageFilename(file.filename);
              const isPdf = isPdfFilename(file.filename);
              return (
                <li class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                  <p class="text-gray-700 text-sm font-medium mb-1">{file.filename}</p>
                  {isImage && viewerUrl && (
                    <iframe
                      src={viewerUrl}
                      title={`View ${file.filename}`}
                      sandbox="allow-same-origin"
                      class="w-full max-w-md aspect-video object-contain rounded border-0 bg-gray-100"
                      style="min-height: 120px;"
                    />
                  )}
                  {isPdf && viewUrl && (
                    <iframe
                      src={viewUrl}
                      title={`View ${file.filename}`}
                      class="w-full max-w-md aspect-video rounded border border-gray-300 bg-gray-100"
                      style="min-height: 400px;"
                    />
                  )}
                  {viewUrl && (
                    <a href={viewUrl} target="_blank" rel="noopener noreferrer" class="text-clr-green font-semibold hover:underline text-xs inline-block mt-1">View / download</a>
                  )}
                </li>
              );
            })}
          </ul>
        </div>
      )}
    </div>
    {req.status === 'in_review' && (
      <>
        {req.review_deadline && new Date(req.review_deadline) < new Date() && (
          <div class="mt-3 rounded-lg border-2 border-red-300 bg-red-50 p-3 no-print">
            <p class="text-sm font-semibold text-red-900">Warning: Review deadline passed: {new Date(req.review_deadline).toLocaleDateString()}</p>
          </div>
        )}
        <div class="flex flex-wrap gap-2 pt-4 no-print" role="group" aria-label="Request actions">
          <button type="button" class="arb-action px-3 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" data-request-id={req.id} data-action="approve" aria-label={`Approve request ${req.id}`}>Approve</button>
          <button type="button" class="arb-action px-3 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" data-request-id={req.id} data-action="reject" aria-label={`Reject request ${req.id}`}>Reject</button>
          <button type="button" class="arb-action px-3 py-2 rounded-lg border border-amber-600 text-amber-700 hover:bg-amber-50 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2" data-request-id={req.id} data-action="request_revision" aria-label={`Request revision for request ${req.id}`}>Request revision</button>
          <button type="button" class="arb-add-notes px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2" data-request-id={req.id} aria-label={`Add internal notes for request ${req.id}`}>Add notes</button>
          <button type="button" class="arb-set-deadline px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2" data-request-id={req.id} aria-label={`Set review deadline for request ${req.id}`}>Set deadline</button>
        </div>
        {req.arb_internal_notes && (
          <div class="mt-3 rounded-lg border border-blue-200 bg-blue-50 p-3 no-print">
            <p class="text-xs font-semibold text-blue-900 mb-1">ARB Internal Notes</p>
            <p class="text-sm text-blue-900 whitespace-pre-wrap arb-internal-notes-text" set:html={sanitizeForDisplay(req.arb_internal_notes)}></p>
            <button type="button" class="arb-edit-notes mt-2 text-xs text-blue-700 hover:underline" data-request-id={req.id}>Edit notes</button>
          </div>
        )}
      </>
    )}
    {req.status === 'pending' && <p class="no-print text-sm text-amber-700 pt-4">Awaiting owner. They can edit and then submit for review.</p>}
    <div class="no-print pt-4 border-t border-gray-200 flex flex-wrap items-center gap-3">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" class="print-include-attachments rounded border-gray-300 text-clr-green focus:ring-clr-green" checked />
        Include attachments in PDF
      </label>
      <button type="button" class="print-to-pdf px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-sm font-semibold text-gray-700 focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2" aria-label={`Print or save request ${req.id} as PDF`}>Print / Save as PDF</button>
    </div>
  </div>
  <div class="print-form-view hidden p-6" aria-hidden="true">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Architectural Review Application</h3>
    <div class="space-y-3 text-sm">
      <div class="grid grid-cols-2 gap-4">
        <div><span class="font-semibold text-gray-600">Association:</span> Crooked Lake Reserve</div>
        <div><span class="font-semibold text-gray-600">Date of application:</span> {new Date(req.created).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><span class="font-semibold text-gray-600">Applicant:</span> {sanitizeForDisplay(req.applicant_name) || '-'}</div>
        <div><span class="font-semibold text-gray-600">Phone:</span> {sanitizeForDisplay(req.phone) || '-'}</div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><span class="font-semibold text-gray-600">Property address:</span> {sanitizeForDisplay(req.property_address) || '-'}</div>
        <div><span class="font-semibold text-gray-600">Email:</span> {sanitizeForDisplay(req.owner_email)}</div>
      </div>
      <div><span class="font-semibold text-gray-600">Application for:</span> {sanitizeForDisplay(req.application_type) || '-'}</div>
      <div><span class="font-semibold text-gray-600">Description:</span></div>
      <div class="whitespace-pre-wrap border border-gray-200 p-3 rounded" set:html={sanitizeForDisplay(req.description)}></div>
      <div class="text-xs text-gray-500">Submitted: {new Date(req.created).toLocaleString()}</div>
      {files.length > 0 && (
        <div class="print-attachments-section pt-2 border-t">
          <p class="font-semibold">Attachments ({files.length})</p>
          <ul class="list-disc pl-5">
            {files.map((f) => (<li>{f.filename}</li>))}
          </ul>
        </div>
      )}
    </div>
  </div>
</div>
