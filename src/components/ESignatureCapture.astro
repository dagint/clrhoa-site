---
/**
 * Electronic Signature Capture Component
 * ESIGN Act compliant signature capture for ARB requests and other documents
 *
 * Usage:
 * <ESignatureCapture
 *   documentType="arb_request"
 *   documentId={requestId}
 *   signerEmail={session.email}
 *   signerName={ownerName}
 *   intentText="I intend to submit this ARB request"
 * />
 */

interface Props {
  documentType: string;
  documentId?: string;
  signerEmail: string;
  signerName: string;
  intentText: string;
  class?: string;
}

const {
  documentType,
  documentId = '',
  signerEmail,
  signerName,
  intentText,
  class: className = ''
} = Astro.props;
---

<div class:list={['esignature-capture', className]}>
  <div class="p-6 rounded-xl bg-blue-50 border-2 border-blue-200">
    <h3 class="text-lg font-semibold text-blue-900 mb-3 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Electronic Signature Required
    </h3>

    <p class="text-sm text-blue-800 mb-4">
      By signing electronically, you agree that your electronic signature is legally binding and has the same effect as a handwritten signature.
    </p>

    <div class="space-y-4">
      <!-- Typed Name Field -->
      <div>
        <label for="esig-typed-name" class="block text-sm font-medium text-gray-700 mb-1">
          Type Your Full Name to Sign *
        </label>
        <input
          type="text"
          id="esig-typed-name"
          name="esig_typed_name"
          required
          placeholder={signerName}
          value={signerName}
          class="w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          autocomplete="name"
        />
        <p class="text-xs text-gray-600 mt-1">
          Please type your full name exactly as shown: <strong>{signerName}</strong>
        </p>
      </div>

      <!-- Consent Checkbox -->
      <div>
        <label class="flex items-start gap-3 cursor-pointer">
          <input
            type="checkbox"
            id="esig-consent"
            name="esig_consent"
            required
            class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <span class="text-sm text-gray-700 flex-1">
            <strong>I consent to use electronic signatures</strong> and understand that:
            <ul class="list-disc list-inside mt-1 space-y-1 text-xs text-gray-600">
              <li>My electronic signature is legally binding</li>
              <li>I have the right to request paper documents</li>
              <li>A record of this signature will be maintained</li>
              <li>My signature will be timestamped and logged with my IP address</li>
            </ul>
          </span>
        </label>
      </div>

      <!-- Intent Statement (Hidden, will be included in signature data) -->
      <input type="hidden" name="esig_intent" value={intentText} />
      <input type="hidden" name="esig_document_type" value={documentType} />
      {documentId && <input type="hidden" name="esig_document_id" value={documentId} />}
      <input type="hidden" name="esig_signer_email" value={signerEmail} />

      <!-- Legal Notice -->
      <div class="p-3 rounded-lg bg-white border border-blue-200 text-xs text-gray-600">
        <strong class="text-gray-900">Electronic Signatures in Global and National Commerce Act (ESIGN):</strong>
        This signature is subject to the ESIGN Act (15 U.S.C. ยง 7001). Your signature will be associated with this document,
        timestamped, and stored securely. You may request a copy of this signed document at any time.
      </div>
    </div>
  </div>

  <!-- Client-side validation -->
  <script>
    // Validate signature before form submission
    function validateESignature() {
      const typedName = (document.getElementById('esig-typed-name') as HTMLInputElement)?.value.trim();
      const consent = (document.getElementById('esig-consent') as HTMLInputElement)?.checked;
      const form = document.getElementById('esig-typed-name')?.closest('form');

      if (!form) return true; // No form found, skip validation

      // Get expected name from data attribute or placeholder
      const expectedName = (document.getElementById('esig-typed-name') as HTMLInputElement)?.placeholder || '';

      // Add submit handler to validate
      form.addEventListener('submit', (e) => {
        if (!typedName) {
          alert('Please type your full name to sign.');
          e.preventDefault();
          return false;
        }

        if (!consent) {
          alert('You must consent to use electronic signatures to continue.');
          e.preventDefault();
          return false;
        }

        // Warn if name doesn't match expected (but allow it - could be legitimate difference)
        if (expectedName && typedName.toLowerCase() !== expectedName.toLowerCase()) {
          const proceed = confirm(
            `The name you typed (${typedName}) doesn't exactly match your registered name (${expectedName}).\n\n` +
            `This signature will still be legally binding. Do you want to continue?`
          );
          if (!proceed) {
            e.preventDefault();
            return false;
          }
        }

        return true;
      });
    }

    // Initialize validation when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', validateESignature);
    } else {
      validateESignature();
    }
  </script>
</div>

<style>
  .esignature-capture {
    /* Component styles */
  }
</style>
