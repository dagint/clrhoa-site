---
/**
 * Shown when user has JIT elevated access. Displays countdown and "Drop access" button.
 * Pass elevated_until (Unix ms) and optionally role for label.
 */
interface Props {
  elevatedUntil: number;
  role?: string;
}

const { elevatedUntil } = Astro.props;
---

<div id="pim-elevation-banner" class="bg-amber-100 border-b border-amber-300 px-4 py-2 flex flex-wrap items-center justify-between gap-2" role="status" aria-live="polite" data-elevated-until={String(elevatedUntil)}>
  <span class="text-amber-900 text-sm font-medium">
    <span id="pim-elevation-label">Elevated access</span>
    <span id="pim-elevation-timer" class="ml-2 font-mono">â€”</span>
  </span>
  <form id="pim-drop-form" method="post" action="/api/pim/drop" class="inline">
    <input type="hidden" name="_method" value="POST" />
    <button type="submit" class="text-amber-900 underline font-medium text-sm hover:no-underline">Drop access</button>
  </form>
</div>

<script>
  (function () {
    const timerEl = document.getElementById('pim-elevation-timer');
    const form = document.getElementById('pim-drop-form') as HTMLFormElement | null;
    const bannerEl = document.getElementById('pim-elevation-banner');
    if (!timerEl || !bannerEl) return;
    const elevatedUntil = parseInt(bannerEl.getAttribute('data-elevated-until') || '0', 10);

    function updateTimer() {
      const now = Date.now();
      const until = typeof elevatedUntil === 'number' ? elevatedUntil : 0;
      if (until <= now) {
        if (timerEl) timerEl.textContent = 'expired';
        if (form) (form as HTMLFormElement).submit();
        return;
      }
      const sec = Math.floor((until - now) / 1000);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      if (timerEl) timerEl.textContent = `expires in ${m}:${String(s).padStart(2, '0')}`;
    }

    updateTimer();
    const interval = setInterval(updateTimer, 1000);

    form?.addEventListener('submit', function (e) {
      e.preventDefault();
      clearInterval(interval);
      fetch('/api/pim/drop', { method: 'POST', credentials: 'same-origin' })
        .then(function (r) {
          if (r.ok) window.location.reload();
        })
        .catch(function () {});
    });
  })();
</script>
