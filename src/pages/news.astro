---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { listMeetingsForPublicNews } from '../lib/meetings-db';
import { listPublicNewsItems } from '../lib/news-items-db';
import { listPublicVendors } from '../lib/vendors-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const db = env?.DB;

const allNews = await getCollection('news');
const publishedNews = allNews
  .filter((item) => item.data.published)
  .map((item) => ({
    ...item,
    slug: item.data.slug || item.id.split('/').pop()?.replace('.md', '') || item.id,
  }));

const publicMeetings = db ? await listMeetingsForPublicNews(db) : [];
const boardNewsItems = db ? await listPublicNewsItems(db) : [];
const vendorCount = db ? (await listPublicVendors(db)).length : 0;

type NewsListItem =
  | { kind: 'article'; slug: string; title: string; date: Date; summary: string; tags?: string[] }
  | { kind: 'meeting'; id: string; title: string; date: Date; summary: string }
  | { kind: 'board'; id: string; title: string; date: Date; summary: string };
const items: NewsListItem[] = [
  ...publishedNews.map((item) => ({
    kind: 'article' as const,
    slug: item.slug,
    title: item.data.title,
    date: item.data.date,
    summary: item.data.summary,
    tags: item.data.tags,
  })),
  ...publicMeetings.map((m) => ({
    kind: 'meeting' as const,
    id: m.id,
    title: m.title ?? 'Meeting',
    date: new Date(m.datetime),
    summary: m.description?.trim() || (m.location ? `Location: ${m.location}` : 'Board meeting.'),
  })),
  ...boardNewsItems.map((n) => ({
    kind: 'board' as const,
    id: n.id,
    title: n.title,
    date: new Date(n.created_at),
    summary: n.body.slice(0, 200) + (n.body.length > 200 ? '…' : ''),
  })),
];
items.sort((a, b) => b.date.getTime() - a.date.getTime());

// Quarterly dues due dates: Jan 1, Apr 1, Jul 1, Oct 1
const QUARTER_DUE_DATES = [
  { month: 0, day: 1, quarter: 'Q1', name: 'January' },
  { month: 3, day: 1, quarter: 'Q2', name: 'April' },
  { month: 6, day: 1, quarter: 'Q3', name: 'July' },
  { month: 9, day: 1, quarter: 'Q4', name: 'October' },
];

function getNextDueDate(): { dueDate: Date; quarter: string; label: string; year: number } | null {
  const now = new Date();
  const year = now.getFullYear();
  for (const q of QUARTER_DUE_DATES) {
    const dueDate = new Date(year, q.month, q.day);
    if (now <= dueDate) return { dueDate, quarter: q.quarter, label: q.name, year };
  }
  return { dueDate: new Date(year + 1, 0, 1), quarter: 'Q1', label: 'January', year: year + 1 };
}

const nextDue = getNextDueDate();
---

<BaseLayout title="News & Announcements" description="Latest news and announcements from Crooked Lake Reserve HOA">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
      <h1 class="text-4xl font-heading font-bold text-clr-green mb-6">News & Announcements</h1>

      {vendorCount > 0 && (
        <div class="mb-6 rounded-xl border border-gray-200 bg-clr-beige/20 p-4">
          <p class="text-gray-700 font-body text-sm">
            <a href="/resources/vendors" class="text-clr-orange font-semibold hover:underline">Vendor list</a> — Board-recommended service providers (name and website only). Contact form available for vendors without a website.
          </p>
        </div>
      )}

      {(items.length === 0 && !nextDue) ? (
        <p class="text-clr-gray font-body">No news items available at this time.</p>
      ) : (
        <div class="space-y-6">
          {nextDue && (
            <article
              id="dues-reminder-card"
              class="border-b border-gray-100 pb-6 bg-clr-beige/20 -mx-4 px-4 py-4 rounded-xl border border-clr-green/20"
              data-due-date={nextDue.dueDate.toISOString().slice(0, 10)}
              style="display: none;"
            >
              <div class="flex items-start justify-between gap-4 mb-2 flex-wrap">
                <h2 class="text-2xl font-heading font-semibold text-clr-green">
                  <span id="dues-reminder-title">{nextDue.quarter} {nextDue.year} HOA Dues Reminder</span>
                </h2>
                <span class="text-sm text-clr-gray whitespace-nowrap font-body" id="dues-reminder-date">
                  Due {nextDue.dueDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                </span>
              </div>
              <p class="text-gray-700 mb-3 font-body">
                Quarterly HOA dues are due on the 1st of each quarter month (Jan 1, Apr 1, Jul 1, Oct 1). Payment options, mailing address, and drop-off information are on the Dues page.
              </p>
              <a
                href="/dues"
                class="text-clr-orange font-semibold hover:underline inline-block font-body"
              >
                View payment information →
              </a>
            </article>
          )}
          {items.map((item) => (
            <article class="border-b border-gray-100 pb-6 last:border-b-0">
              <div class="flex items-start justify-between gap-4 mb-2 flex-wrap">
                <h2 class="text-2xl font-heading font-semibold text-clr-green">
                  {item.kind === 'article' ? (
                    <a href={`/news/${item.slug}`} class="hover:underline transition-colors">
                      {item.title}
                    </a>
                  ) : item.kind === 'meeting' ? (
                    <a href={`/news/meeting/${item.id}`} class="hover:underline transition-colors">
                      {item.title}
                    </a>
                  ) : (
                    <a href={`/news/item/${item.id}`} class="hover:underline transition-colors">
                      {item.title}
                    </a>
                  )}
                </h2>
                <time class="text-sm text-clr-gray whitespace-nowrap font-body">
                  {item.date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
              </div>
              <p class="text-gray-700 mb-3 font-body">{item.summary}</p>
              {item.kind === 'article' && item.tags && item.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-3">
                  {item.tags.map((tag) => (
                    <span class="px-2 py-1 bg-clr-beige/50 text-clr-gray text-xs rounded font-body">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
              {item.kind === 'article' ? (
                <a
                  href={`/news/${item.slug}`}
                  class="text-clr-orange font-semibold hover:underline inline-block font-body"
                >
                  Read more →
                </a>
              ) : item.kind === 'meeting' ? (
                <a
                  href={`/news/meeting/${item.id}`}
                  class="text-clr-orange font-semibold hover:underline inline-block font-body"
                >
                  Read more →
                </a>
              ) : (
                <a
                  href={`/news/item/${item.id}`}
                  class="text-clr-orange font-semibold hover:underline inline-block font-body"
                >
                  Read more →
                </a>
              )}
            </article>
          ))}
        </div>
      )}
    </div>
  </div>
  {nextDue && (
    <script define:vars={{ dueDateIso: nextDue.dueDate.toISOString().slice(0, 10) }}>
      (function () {
        const card = document.getElementById('dues-reminder-card');
        if (!card) return;
        const due = new Date(dueDateIso + 'T23:59:59');
        const now = new Date();
        const thirtyDaysMs = 30 * 24 * 60 * 60 * 1000;
        const reminderStart = new Date(due.getTime() - thirtyDaysMs);
        if (now >= reminderStart && now <= due) {
          card.style.display = 'block';
        }
      })();
    </script>
  )}
</BaseLayout>
