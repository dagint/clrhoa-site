---
export const prerender = false;

import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getNewsItemById, getNewsItemImageKeys } from '../../../lib/news-items-db';

const { id } = Astro.params;
const runtime = Astro.locals.runtime;
const db = runtime?.env?.DB;

if (!id || !db) {
  return Astro.redirect('/news');
}

const item = await getNewsItemById(db, id);
if (!item || item.is_public !== 1) {
  return Astro.redirect('/news');
}

const imageKeys = getNewsItemImageKeys(item);

function formatDate(s: string): string {
  try {
    return new Date(s).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  } catch {
    return s;
  }
}
---

<BaseLayout title={item.title} description={item.body.slice(0, 160)}>
  <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
      <header class="mb-6">
        <a href="/news" class="text-clr-orange font-semibold hover:underline text-sm font-body mb-4 inline-block">← News</a>
        <h1 class="text-4xl font-heading font-bold text-clr-green mb-4">{item.title}</h1>
        <time class="text-clr-gray text-sm font-body">{formatDate(item.created_at)}</time>
      </header>
      <div class="prose prose-gray max-w-none font-body text-base whitespace-pre-wrap">{item.body}</div>
      {imageKeys.length > 0 && (
        <div class="mt-8" role="region" aria-label="Photo gallery">
          <div class="relative rounded-xl overflow-hidden bg-gray-100 border border-gray-200">
            {imageKeys.map((key, idx) => (
              <div
                class="news-gallery-slide"
                data-slide-index={idx}
                role="img"
                aria-label={`Photo ${idx + 1} of ${imageKeys.length}`}
                hidden={idx !== 0}
              >
                <img
                  src={`/api/news-file/${key}`}
                  alt=""
                  class="w-full aspect-video object-contain sm:object-cover max-h-[70vh] mx-auto"
                  loading={idx === 0 ? 'eager' : 'lazy'}
                  decoding="async"
                />
              </div>
            ))}
            {imageKeys.length > 1 && (
              <>
                <button
                  type="button"
                  class="news-gallery-prev absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2"
                  aria-label="Previous photo"
                >
                  <span aria-hidden="true">‹</span>
                </button>
                <button
                  type="button"
                  class="news-gallery-next absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 hover:bg-black/70 text-white flex items-center justify-center transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2"
                  aria-label="Next photo"
                >
                  <span aria-hidden="true">›</span>
                </button>
              </>
            )}
          </div>
          {imageKeys.length > 1 && (
            <div class="mt-3 flex items-center justify-center gap-3 flex-wrap">
              <span class="text-sm text-gray-600" aria-live="polite" aria-atomic="true" id="news-gallery-counter">
                Photo 1 of {imageKeys.length}
              </span>
              <span class="text-xs text-gray-500">← → to browse</span>
              <div class="flex gap-1.5" role="tablist" aria-label="Gallery photos">
                {imageKeys.map((_, idx) => (
                  <button
                    type="button"
                    class={`news-gallery-dot w-2.5 h-2.5 rounded-full border border-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-1 ${idx === 0 ? 'bg-clr-green' : 'bg-gray-200'}`}
                    data-slide-index={idx}
                    role="tab"
                    aria-label={`Go to photo ${idx + 1}`}
                    aria-selected={idx === 0}
                    tabindex={idx === 0 ? 0 : -1}
                  >
                    <span class="sr-only">Photo {idx + 1}</span>
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  </article>
</BaseLayout>

{imageKeys.length > 1 && (
  <script is:inline>
    (function () {
      var container = document.querySelector('[aria-label="Photo gallery"]');
      if (!container) return;
      var slides = container.querySelectorAll('.news-gallery-slide');
      var dots = container.querySelectorAll('.news-gallery-dot');
      var prevBtn = container.querySelector('.news-gallery-prev');
      var nextBtn = container.querySelector('.news-gallery-next');
      var counterEl = document.getElementById('news-gallery-counter');
      var total = slides.length;
      var current = 0;

      function showSlide(idx) {
        current = (idx + total) % total;
        slides.forEach(function (slide, i) {
          var isActive = i === current;
          slide.hidden = !isActive;
          if (slide.querySelector('img') && isActive) slide.querySelector('img').loading = 'eager';
        });
        dots.forEach(function (dot, i) {
          dot.setAttribute('aria-selected', i === current);
          dot.classList.toggle('bg-clr-green', i === current);
          dot.classList.toggle('bg-gray-200', i !== current);
          dot.tabIndex = i === current ? 0 : -1;
        });
        if (counterEl) counterEl.textContent = 'Photo ' + (current + 1) + ' of ' + total;
      }

      if (prevBtn) prevBtn.addEventListener('click', function () { showSlide(current - 1); });
      if (nextBtn) nextBtn.addEventListener('click', function () { showSlide(current + 1); });
      dots.forEach(function (dot, i) {
        dot.addEventListener('click', function () { showSlide(i); });
        dot.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showSlide(i); }
        });
      });

      container.addEventListener('keydown', function (e) {
        if (e.key === 'ArrowLeft') { e.preventDefault(); showSlide(current - 1); }
        if (e.key === 'ArrowRight') { e.preventDefault(); showSlide(current + 1); }
      });
      container.setAttribute('tabindex', '0');
    })();
  </script>
)}
