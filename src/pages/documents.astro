---
export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { listPublicDocuments } from '../lib/public-documents-db';

const allDocuments = await getCollection('documents');
const publishedDocuments = allDocuments.filter((item) => item.data.published);

const documentsByCategory = publishedDocuments.reduce((acc, doc) => {
  const category = doc.data.category;
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(doc);
  return acc;
}, {} as Record<string, typeof publishedDocuments>);

const categories = ['Governing Documents', 'Policies', 'Forms', 'Minutes', 'Other'] as const;

// Board/ARB may have uploaded replacements; use those links when present (public page: only slug/file_key/content_type)
const runtime = Astro.locals.runtime;
const env = runtime?.env;
const db = env?.DB;
const publicOverrides = db ? await listPublicDocuments(db) : [];
const overrideBySlug = Object.fromEntries(
  publicOverrides
    .filter((r) => r.file_key)
    .map((r) => [r.slug, { slug: r.slug, file_key: r.file_key, content_type: r.content_type }])
);

const keyRules = [
  { title: 'Quarterly dues', detail: 'Due on the 1st of January, April, July, and October.' },
  { title: 'Minimum 12-month leases', detail: 'Per Addendum C to the Covenants.' },
  { title: 'ARB approval required', detail: 'Architectural Review Board approval required for modifications. ($500 fee removed 2022.)' },
  { title: 'Fences & garage rules', detail: 'No chain-link fences; specific garage rules apply. See Covenants for details.' },
  { title: 'Lake access', detail: 'Lots 10–14: West Crooked Lake. Lots 15–24: Lake Dicie (no docks).' },
];
---

<BaseLayout title="Documents & Forms" description="Access HOA documents and forms">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
    <div class="max-w-2xl mx-auto mb-12">
      <h1 class="text-4xl font-heading font-bold text-clr-green mb-4">Documents & Forms</h1>
      <p class="text-gray-700 font-body mb-4">
        All official HOA documents and forms are available below.
        Governing documents are grouped by category with direct download links.
      </p>
    </div>

    <!-- Key Rules from Governing Docs -->
    <section class="mb-16">
      <h2 class="text-3xl font-heading font-bold text-center text-clr-green mb-8">Key Rules at a Glance</h2>
      <p class="text-center text-gray-700 font-body mb-8 max-w-2xl mx-auto">
        Summary of important rules from the Crooked Lake Reserve Covenants & Bylaws. See the full documents below for complete language.
      </p>
      <div class="text-center mb-8">
        <a
          href="/arb-process"
          class="inline-flex items-center gap-2 bg-clr-green hover:brightness-110 text-white px-6 py-3 rounded-xl font-semibold text-sm shadow-lg hover:shadow-xl transition-all font-body"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
          </svg>
          ARB Process Guide
        </a>
      </div>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-5xl mx-auto">
        {keyRules.map((rule) => (
          <div class="card-hover bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-heading font-semibold text-clr-green mb-2">{rule.title}</h3>
            <p class="text-clr-gray text-sm font-body">{rule.detail}</p>
          </div>
        ))}
      </div>
    </section>

    <!-- Documents by category with card layout and download links -->
    {categories.map((category) => {
      const docs = documentsByCategory[category] || [];
      if (docs.length === 0) return null;

      return (
        <section class="mb-12">
          <h2 class="text-2xl font-heading font-bold text-clr-green mb-6">{category}</h2>
          <div class="grid md:grid-cols-2 gap-6">
            {docs.map((doc) => {
              const slug = doc.data.slug;
              const override = slug ? overrideBySlug[slug] : null;
              const linkUrl = override?.file_key ? `/api/public-doc-file?slug=${encodeURIComponent(slug!)}` : doc.data.fileUrl;
              const isPdf = linkUrl.toLowerCase().includes('.pdf') || (override?.content_type?.toLowerCase().includes('pdf'));
              return (
              <div class="card-hover bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-xl font-heading font-semibold text-clr-green mb-2">{doc.data.title}</h3>
                <p class="text-clr-gray text-sm font-body mb-4">{doc.data.description}</p>
                {doc.data.effectiveDate && (
                  <p class="text-gray-500 text-xs font-body mb-4">
                    Effective: {doc.data.effectiveDate.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    })}
                  </p>
                )}
                <a
                  href={linkUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 bg-clr-orange hover:brightness-110 text-white px-6 py-3 rounded-xl font-semibold text-sm shadow-lg hover:shadow-xl transition-all font-body"
                >
                  <span aria-hidden="true">↓</span> {isPdf ? 'Download PDF' : 'Download'}
                </a>
              </div>
            );
            })}
          </div>
        </section>
      );
    })}
  </div>
</BaseLayout>
