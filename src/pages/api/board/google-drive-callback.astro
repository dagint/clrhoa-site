---
/**
 * GET /api/board/google-drive-callback â€” OAuth callback. Exchanges code for refresh_token, encrypts, saves to backup_config.
 */
export const prerender = false;

import { getUserRole } from '../../../types/auth';
import { encryptRefreshToken } from '../../../lib/backup-encrypt';

const runtime = Astro.locals.runtime;
const env = runtime?.env as Env & {
  GOOGLE_CLIENT_ID?: string;
  GOOGLE_CLIENT_SECRET?: string;
  BACKUP_ENCRYPTION_KEY?: string;
};

// Use session from middleware (already validated by middleware for /api/board/* routes)
const user = Astro.locals.user;
const luciaSession = Astro.locals.session;

if (!user || !luciaSession) {
  return Astro.redirect('/portal/login?error=session_expired');
}

const effectiveRole = getUserRole(user)?.toLowerCase() || 'member';
if (effectiveRole !== 'board' && effectiveRole !== 'admin' && effectiveRole !== 'arb_board') {
  return Astro.redirect('/portal/login?error=forbidden');
}

const url = new URL(Astro.request.url);
const code = url.searchParams.get('code');
const error = url.searchParams.get('error');
if (error) {
  return Astro.redirect(`/board/backups?error=${encodeURIComponent(error)}`);
}
if (!code) {
  return Astro.redirect('/board/backups?error=no_code');
}

const clientId = env?.GOOGLE_CLIENT_ID;
const clientSecret = env?.GOOGLE_CLIENT_SECRET;
const encryptionKey = env?.BACKUP_ENCRYPTION_KEY;
if (!clientId || !clientSecret || !encryptionKey) {
  return Astro.redirect('/board/backups?error=config');
}

const origin = url.origin;
const redirectUri = `${origin}/api/board/google-drive-callback`;
const res = await fetch('https://oauth2.googleapis.com/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: new URLSearchParams({
    client_id: clientId,
    client_secret: clientSecret,
    code,
    redirect_uri: redirectUri,
    grant_type: 'authorization_code',
  }),
});
if (!res.ok) {
  const t = await res.text();
  return Astro.redirect(`/board/backups?error=${encodeURIComponent('token_exchange_failed')}`);
}
const data = (await res.json()) as { refresh_token?: string };
if (!data.refresh_token) {
  return Astro.redirect('/board/backups?error=no_refresh_token');
}

const encrypted = encryptRefreshToken(data.refresh_token, encryptionKey);
const db = env?.DB;
if (!db) return Astro.redirect('/board/backups?error=db');

await db.prepare(
  `UPDATE backup_config SET google_refresh_token_encrypted = ?, updated_by = ?, updated_at = datetime('now') WHERE id = 1`
).bind(encrypted, user.email).run();

return Astro.redirect('/board/backups?connected=1');
---
