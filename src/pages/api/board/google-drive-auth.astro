---
/**
 * GET /api/board/google-drive-auth â€” Board/Admin only. Redirects to Google OAuth for Drive.
 * Requires env: GOOGLE_CLIENT_ID. Redirect URI must be registered in Google Cloud Console.
 */
export const prerender = false;

import { getUserRole } from '../../../types/auth';

const runtime = Astro.locals.runtime;
const env = runtime?.env as Env & { GOOGLE_CLIENT_ID?: string };

// Use session from middleware (already validated by middleware for /api/board/* routes)
const user = Astro.locals.user;
const luciaSession = Astro.locals.session;

if (!user || !luciaSession) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), {
    status: 401,
    headers: { 'Content-Type': 'application/json' },
  });
}

const effectiveRole = getUserRole(user)?.toLowerCase() || 'member';
if (effectiveRole !== 'board' && effectiveRole !== 'admin' && effectiveRole !== 'arb_board') {
  return new Response(JSON.stringify({ error: 'Forbidden' }), {
    status: 403,
    headers: { 'Content-Type': 'application/json' },
  });
}
const clientId = env?.GOOGLE_CLIENT_ID;
if (!clientId) {
  return new Response('Google Drive not configured (missing GOOGLE_CLIENT_ID)', { status: 503 });
}
const url = new URL(Astro.request.url);
const origin = url.origin;
const redirectUri = `${origin}/api/board/google-drive-callback`;
const state = crypto.randomUUID();
const scope = 'https://www.googleapis.com/auth/drive.file';
const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({
  client_id: clientId,
  redirect_uri: redirectUri,
  response_type: 'code',
  scope,
  state,
  access_type: 'offline',
  prompt: 'consent',
})}`;
return Astro.redirect(authUrl);
---
