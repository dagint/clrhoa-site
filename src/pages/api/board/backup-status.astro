---
/**
 * GET /api/board/backup-status â€” Board/Admin only. Returns whether Cloudflare credentials
 * are configured (for manual download) and last R2 backup run time. Does not expose secrets.
 */
export const prerender = false;

import { getUserRole } from '../../../types/auth';

const runtime = Astro.locals.runtime;
const env = runtime?.env as Record<string, unknown> & { CLOUDFLARE_ACCOUNT_ID?: string; CLOUDFLARE_BACKUP_API_TOKEN?: string };

// Use session from middleware (already validated by middleware for /api/board/* routes)
const user = Astro.locals.user;
const luciaSession = Astro.locals.session;

if (!user || !luciaSession) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: { 'Content-Type': 'application/json' } });
}

const userRole = getUserRole(user)?.toLowerCase() || 'member';
const canManageBackup = userRole === 'board' || userRole === 'admin' || userRole === 'arb_board';
if (!canManageBackup) {
  return new Response(JSON.stringify({ error: 'Forbidden' }), { status: 403, headers: { 'Content-Type': 'application/json' } });
}

// Debug: Log what we're seeing
console.log('[BACKUP DEBUG] Checking env vars:', {
  hasAccountId: !!env?.CLOUDFLARE_ACCOUNT_ID,
  hasBackupToken: !!env?.CLOUDFLARE_BACKUP_API_TOKEN,
  accountIdType: typeof env?.CLOUDFLARE_ACCOUNT_ID,
  backupTokenType: typeof env?.CLOUDFLARE_BACKUP_API_TOKEN,
  envKeys: env ? Object.keys(env).filter(k => k.includes('CLOUDFLARE')).join(', ') : 'no env'
});

const manual_download_configured = Boolean(
  env?.CLOUDFLARE_ACCOUNT_ID && String(env.CLOUDFLARE_ACCOUNT_ID).trim() !== '' &&
  env?.CLOUDFLARE_BACKUP_API_TOKEN && String(env.CLOUDFLARE_BACKUP_API_TOKEN).trim() !== ''
);

let last_r2_backup_at: string | null = null;
let last_google_backup_at: string | null = null;
let schedule_type = 'daily';
let schedule_hour_utc = 2;
let schedule_day_of_week: number | null = null;
let google_drive_enabled = false;
const db = env?.DB as D1Database | undefined;
if (db) {
  try {
    const row = await db.prepare(
      `SELECT last_r2_backup_at, last_google_backup_at, schedule_type, schedule_hour_utc, schedule_day_of_week, google_drive_enabled FROM backup_config WHERE id = 1`
    ).first<{
      last_r2_backup_at: string | null;
      last_google_backup_at: string | null;
      schedule_type?: string;
      schedule_hour_utc?: number;
      schedule_day_of_week?: number | null;
      google_drive_enabled?: number;
    }>();
    if (row?.last_r2_backup_at) last_r2_backup_at = row.last_r2_backup_at;
    if (row?.last_google_backup_at) last_google_backup_at = row.last_google_backup_at;
    if (row?.schedule_type) schedule_type = row.schedule_type;
    if (row?.schedule_hour_utc !== undefined) schedule_hour_utc = row.schedule_hour_utc;
    if (row?.schedule_day_of_week !== undefined) schedule_day_of_week = row.schedule_day_of_week;
    if (row?.google_drive_enabled !== undefined) google_drive_enabled = Boolean(row.google_drive_enabled);
  } catch {
    // Column may not exist before migration
  }
}

return new Response(
  JSON.stringify({
    manual_download_configured,
    last_r2_backup_at,
    last_google_backup_at,
    schedule_type,
    schedule_hour_utc,
    schedule_day_of_week,
    google_drive_enabled
  }),
  { status: 200, headers: { 'Content-Type': 'application/json' } }
);
---
