---
/**
 * /api/meetings â€” CRUD for meetings.
 * GET: list (all authenticated get upcoming; board gets all).
 * POST: create (board only). Body: title, datetime, location, description, optional agenda_r2_key.
 * PUT: update (board only). Body: id, title?, datetime?, location?, description?, agenda_r2_key?.
 * DELETE: delete (board only). Body: id or ?id=.
 */
export const prerender = false;

import { requireSession, requireDb, jsonResponse } from '../../lib/api-helpers';
import { getEffectiveRole, verifyCsrfToken } from '../../lib/auth';
import {
  listUpcomingMeetings,
  listAllMeetings,
  getMeetingById,
  createMeetingId,
  insertMeeting,
  updateMeeting,
  deleteMeeting,
} from '../../lib/meetings-db';

const auth = await requireSession(Astro);
if ('response' in auth) return auth.response;
const { session } = auth;

const dbResult = requireDb(Astro.locals.runtime?.env);
if ('response' in dbResult) return dbResult.response;
const { db } = dbResult;

const effectiveRole = getEffectiveRole(session);
const isBoard = effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board';

if (Astro.request.method === 'GET') {
  const meetings = isBoard ? await listAllMeetings(db) : await listUpcomingMeetings(db);
  return jsonResponse({ meetings });
}

if (Astro.request.method === 'POST') {
  if (!isBoard) return jsonResponse({ error: 'Forbidden' }, 403);
  let body: Record<string, unknown>;
  try {
    const ct = Astro.request.headers.get('content-type') ?? '';
    if (ct.includes('application/json')) {
      body = await Astro.request.json();
    } else {
      const form = await Astro.request.formData();
      body = {
        title: form.get('title'),
        datetime: form.get('datetime'),
        location: form.get('location'),
        description: form.get('description'),
        agenda_r2_key: form.get('agenda_r2_key') || undefined,
        post_to_public_news: form.get('post_to_public_news') ?? undefined,
        csrf_token: form.get('csrf_token') ?? form.get('csrfToken'),
      };
    }
  } catch {
    return jsonResponse({ error: 'Invalid body' }, 400);
  }
  const csrf = body.csrf_token ?? body.csrfToken;
  if (!verifyCsrfToken(session, typeof csrf === 'string' ? csrf : undefined)) {
    return jsonResponse({ error: 'Invalid security token. Please refresh the page.' }, 403);
  }
  const title = String(body.title ?? '').trim();
  const datetime = String(body.datetime ?? '').trim();
  if (!title || !datetime) {
    return jsonResponse({ error: 'Title and datetime are required' }, 400);
  }
  const postToPublic = body.post_to_public_news === true || body.post_to_public_news === '1' || body.post_to_public_news === 'on';
  const id = createMeetingId();
  await insertMeeting(db, id, {
    title,
    description: body.description != null ? String(body.description).trim() : null,
    datetime,
    location: body.location != null ? String(body.location).trim() : null,
    agenda_r2_key: body.agenda_r2_key != null ? String(body.agenda_r2_key).trim() : null,
    post_to_public_news: postToPublic ? 1 : 0,
    created_by: session.email,
  });
  return jsonResponse({ success: true, id, message: 'Meeting created' });
}

if (Astro.request.method === 'PUT') {
  if (!isBoard) return jsonResponse({ error: 'Forbidden' }, 403);
  let body: Record<string, unknown>;
  try {
    const ct = Astro.request.headers.get('content-type') ?? '';
    body = ct.includes('application/json') ? await Astro.request.json() : Object.fromEntries(await Astro.request.formData());
  } catch {
    return jsonResponse({ error: 'Invalid body' }, 400);
  }
  const csrf = body.csrf_token ?? body.csrfToken;
  if (!verifyCsrfToken(session, typeof csrf === 'string' ? csrf : undefined)) {
    return jsonResponse({ error: 'Invalid security token. Please refresh the page.' }, 403);
  }
  const id = String(body.id ?? '').trim();
  if (!id) return jsonResponse({ error: 'id is required' }, 400);
  const existing = await getMeetingById(db, id);
  if (!existing) return jsonResponse({ error: 'Meeting not found' }, 404);
  const postToPublic =
    body.post_to_public_news !== undefined
      ? (body.post_to_public_news === true || body.post_to_public_news === '1' || body.post_to_public_news === 'on' ? 1 : 0)
      : undefined;
  await updateMeeting(db, id, {
    title: body.title !== undefined ? String(body.title).trim() : undefined,
    description: body.description !== undefined ? (body.description ? String(body.description).trim() : null) : undefined,
    datetime: body.datetime !== undefined ? String(body.datetime).trim() : undefined,
    location: body.location !== undefined ? (body.location ? String(body.location).trim() : null) : undefined,
    agenda_r2_key: body.agenda_r2_key !== undefined ? (body.agenda_r2_key ? String(body.agenda_r2_key).trim() : null) : undefined,
    post_to_public_news: postToPublic,
  });
  return jsonResponse({ success: true, message: 'Meeting updated' });
}

if (Astro.request.method === 'DELETE') {
  if (!isBoard) return jsonResponse({ error: 'Forbidden' }, 403);
  const url = new URL(Astro.request.url);
  let body: Record<string, unknown>;
  try {
    const ct = Astro.request.headers.get('content-type') ?? '';
    body = ct.includes('application/json') ? await Astro.request.json() : Object.fromEntries(await Astro.request.formData());
  } catch {
    body = {};
  }
  const csrf = body.csrf_token ?? body.csrfToken;
  if (!verifyCsrfToken(session, typeof csrf === 'string' ? csrf : undefined)) {
    return jsonResponse({ error: 'Invalid security token. Please refresh the page.' }, 403);
  }
  let id = url.searchParams.get('id') ?? String(body.id ?? '').trim();
  if (!id) return jsonResponse({ error: 'id is required' }, 400);
  const meeting = await getMeetingById(db, id);
  if (!meeting) return jsonResponse({ error: 'Meeting not found' }, 404);
  const r2 = Astro.locals.runtime?.env?.CLOURHOA_FILES;
  if (r2 && meeting.agenda_r2_key) {
    try {
      await r2.delete(meeting.agenda_r2_key);
    } catch {
      // Non-fatal: DB row will still be removed; orphan can be purged later
    }
  }
  const ok = await deleteMeeting(db, id);
  if (!ok) return jsonResponse({ error: 'Meeting not found' }, 404);
  return jsonResponse({ success: true, message: 'Meeting deleted' });
}

return new Response(null, { status: 405, headers: { Allow: 'GET, POST, PUT, DELETE' } });
---
