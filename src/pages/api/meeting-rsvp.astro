---
/**
 * POST /api/meeting-rsvp â€” owner RSVP for a meeting.
 * Body: meeting_id, response ('yes' | 'no' | 'maybe').
 */
export const prerender = false;

import { requireSession, requireDb, jsonResponse } from '../../lib/api-helpers';
import { getMeetingById, setRsvp } from '../../lib/meetings-db';

const auth = await requireSession(Astro);
if ('response' in auth) return auth.response;
const { session } = auth;

const dbResult = requireDb(Astro.locals.runtime?.env);
if ('response' in dbResult) return dbResult.response;
const { db } = dbResult;

if (Astro.request.method !== 'POST') {
  return new Response(null, { status: 405, headers: { Allow: 'POST' } });
}

let body: Record<string, unknown>;
try {
  const ct = Astro.request.headers.get('content-type') ?? '';
  body = ct.includes('application/json') ? await Astro.request.json() : Object.fromEntries(await Astro.request.formData());
} catch {
  return jsonResponse({ error: 'Invalid body' }, 400);
}

const meetingId = String(body.meeting_id ?? '').trim();
const response = String(body.response ?? '').trim().toLowerCase();
if (!meetingId) return jsonResponse({ error: 'meeting_id is required' }, 400);
if (!['yes', 'no', 'maybe'].includes(response)) {
  return jsonResponse({ error: 'response must be yes, no, or maybe' }, 400);
}

const meeting = await getMeetingById(db, meetingId);
if (!meeting) return jsonResponse({ error: 'Meeting not found' }, 404);

await setRsvp(db, meetingId, session.email, response);
return jsonResponse({ success: true, response });
---
