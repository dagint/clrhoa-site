---
/**
 * POST /api/arb-resubmit â€” Owner submits (or resubmits) a pending request for ARB review.
 * Body: requestId (JSON) or request_id (form). Sets status to in_review.
 */
export const prerender = false;

import { getSessionFromCookie, verifyCsrfToken, verifyOrigin } from '../../lib/auth';
import { checkRateLimit, getRateLimitConfig } from '../../lib/rate-limit';
import { getSecurityMonitor } from '../../lib/monitoring';
import { getArbRequest, setArbRequestInReview } from '../../lib/arb-db';
import { incrementCycle, transitionStatus, setDeadline } from '../../lib/arb-voting-db';
import { canTransitionStatus } from '../../lib/arb-status-machine';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  env?.SESSION_SECRET
);

if (!session) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), {
    status: 401,
    headers: { 'Content-Type': 'application/json' },
  });
}

// CSRF protection: verify origin
const origin = Astro.request.headers.get('origin');
const referer = Astro.request.headers.get('referer');
const expectedOrigin = Astro.url.origin;
if (!verifyOrigin(origin, referer, expectedOrigin)) {
  return new Response(JSON.stringify({ error: 'Invalid origin. Request blocked for security.' }), {
    status: 403,
    headers: { 'Content-Type': 'application/json' },
  });
}

if (Astro.request.method !== 'POST') {
  return new Response(JSON.stringify({ error: 'Method not allowed' }), {
    status: 405,
    headers: { 'Content-Type': 'application/json' },
  });
}

const db = env?.DB;
if (!db) {
  return new Response(JSON.stringify({ error: 'Server configuration error' }), {
    status: 503,
    headers: { 'Content-Type': 'application/json' },
  });
}

let requestId: string | null = null;
let csrfToken: string | null = null;
const contentType = Astro.request.headers.get('content-type') ?? '';
if (contentType.includes('application/json')) {
  try {
    const body = await Astro.request.json() as { requestId?: string; request_id?: string; csrfToken?: string };
    requestId = (body.requestId ?? body.request_id ?? '').trim() || null;
    csrfToken = body.csrfToken || null;
  } catch {
    requestId = null;
  }
} else {
  const formData = await Astro.request.formData();
  requestId = (formData.get('request_id') ?? formData.get('requestId')) as string;
  requestId = requestId?.trim() || null;
  csrfToken = formData.get('csrf_token') as string | null;
}

// CSRF token verification
if (!verifyCsrfToken(session, csrfToken)) {
  return new Response(
    JSON.stringify({ error: 'Invalid security token. Please refresh the page and try again.' }),
    { status: 403, headers: { 'Content-Type': 'application/json' } }
  );
}

if (!requestId) {
  return new Response(JSON.stringify({ error: 'Request ID is required.' }), {
    status: 400,
    headers: { 'Content-Type': 'application/json' },
  });
}

const clientIp = Astro.clientAddress || Astro.request.headers.get('cf-connecting-ip') || null;

// Get request to check workflow version
const request = await getArbRequest(db, requestId);
if (!request) {
  return new Response(
    JSON.stringify({ error: 'Request not found.' }),
    { status: 404, headers: { 'Content-Type': 'application/json' } }
  );
}

// Check ownership
if (request.owner_email.toLowerCase() !== session.email.toLowerCase()) {
  return new Response(
    JSON.stringify({ error: 'You do not own this request.' }),
    { status: 403, headers: { 'Content-Type': 'application/json' } }
  );
}

// Handle v1 (legacy) workflow
if (request.workflow_version !== 2) {
  const updated = await setArbRequestInReview(db, requestId, session.email, clientIp);
  if (!updated) {
    return new Response(
      JSON.stringify({
        error: 'Request not in a state that can be submitted for review (must be pending).',
      }),
      { status: 400, headers: { 'Content-Type': 'application/json' } }
    );
  }
  return new Response(
    JSON.stringify({
      success: true,
      requestId,
      message: 'Request submitted for ARB review. You can no longer edit it until the ARB returns it for revision.',
    }),
    { status: 200, headers: { 'Content-Type': 'application/json' } }
  );
}

// Handle v2 (multi-stage voting) workflow
const currentStage = request.current_stage || '';

// Check if request can be resubmitted (must be in ARC_RETURNED or BOARD_RETURNED)
const canResubmit = currentStage === 'ARC_RETURNED' || currentStage === 'BOARD_RETURNED' || currentStage === 'DRAFT';
if (!canResubmit) {
  return new Response(
    JSON.stringify({
      error: `Cannot resubmit from status "${currentStage}". Request must be in DRAFT, ARC_RETURNED, or BOARD_RETURNED status.`,
    }),
    { status: 400, headers: { 'Content-Type': 'application/json' } }
  );
}

// Verify transition is allowed
const transitionCheck = canTransitionStatus(currentStage, 'SUBMITTED', 2);
if (!transitionCheck.allowed) {
  return new Response(
    JSON.stringify({
      error: `Transition not allowed: ${transitionCheck.reason}`,
    }),
    { status: 400, headers: { 'Content-Type': 'application/json' } }
  );
}

// If resubmitting after BOARD_RETURNED, increment cycle (new round of voting)
if (currentStage === 'BOARD_RETURNED' || currentStage === 'ARC_RETURNED') {
  await incrementCycle(db, requestId);
}

// Transition to SUBMITTED
const updated = await transitionStatus(
  db,
  requestId,
  'SUBMITTED',
  'SUBMITTED',
  session.email,
  `Request resubmitted by owner after ${currentStage}`,
  clientIp
);

if (!updated) {
  return new Response(
    JSON.stringify({ error: 'Failed to resubmit request.' }),
    { status: 500, headers: { 'Content-Type': 'application/json' } }
  );
}

// Set submitted_at timestamp (starts/restarts the 30-day deadline clock)
const now = new Date().toISOString();
await db
  .prepare(
    `UPDATE arb_requests
     SET submitted_at = ?
     WHERE id = ?`
  )
  .bind(now, requestId)
  .run();

// Set deadline (submitted_at + 30 days)
await setDeadline(db, requestId, now);

return new Response(
  JSON.stringify({
    success: true,
    requestId,
    status: 'SUBMITTED',
    stage: 'SUBMITTED',
    message: 'Request submitted for ARC review. You can no longer edit it until it is returned for revision.',
  }),
  { status: 200, headers: { 'Content-Type': 'application/json' } }
);
---
