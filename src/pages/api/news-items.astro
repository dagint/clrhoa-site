---
/**
 * GET /api/news-items — Public: ?public=1 returns only is_public=1. No query = all (admin only).
 * POST /api/news-items — Board/admin: create news (title, body, is_public 0|1).
 */
export const prerender = false;

import { getSessionFromCookie, isElevatedRole, getEffectiveRole } from '../../lib/auth';
import { listPublicNewsItems, listAllNewsItems, insertNewsItem } from '../../lib/news-items-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const db = env?.DB;

if (!db) {
  return new Response(JSON.stringify({ error: 'Unavailable' }), {
    status: 503,
    headers: { 'Content-Type': 'application/json' },
  });
}

if (Astro.request.method === 'GET') {
  const u = new URL(Astro.request.url);
  const publicOnly = u.searchParams.get('public') === '1';
  if (publicOnly) {
    const items = await listPublicNewsItems(db);
    return new Response(JSON.stringify({ items }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    });
  }
  const session = await getSessionFromCookie(
    Astro.request.headers.get('cookie') ?? undefined,
    env?.SESSION_SECRET
  );
  if (!session || !isElevatedRole(getEffectiveRole(session))) {
    return new Response(JSON.stringify({ error: 'Forbidden' }), {
      status: 403,
      headers: { 'Content-Type': 'application/json' },
    });
  }
  const items = await listAllNewsItems(db);
  return new Response(JSON.stringify({ items }), {
    status: 200,
    headers: { 'Content-Type': 'application/json' },
  });
}

if (Astro.request.method === 'POST') {
  const session = await getSessionFromCookie(
    Astro.request.headers.get('cookie') ?? undefined,
    env?.SESSION_SECRET
  );
  if (!session || !isElevatedRole(getEffectiveRole(session))) {
    return new Response(JSON.stringify({ error: 'Forbidden' }), {
      status: 403,
      headers: { 'Content-Type': 'application/json' },
    });
  }
  let body: { title?: string; body?: string; is_public?: number; show_on_public?: number | boolean; show_on_portal?: number | boolean };
  try {
    body = await Astro.request.json();
  } catch {
    return new Response(JSON.stringify({ error: 'Invalid JSON' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    });
  }
  const title = typeof body.title === 'string' ? body.title.trim() : '';
  const bodyText = typeof body.body === 'string' ? body.body : '';
  const isPublic = body.show_on_public !== undefined
    ? (body.show_on_public === 1 ? 1 : 0)
    : (body.is_public === 1 ? 1 : 0);
  const showOnPortal = body.show_on_portal !== undefined
    ? (body.show_on_portal === 1 ? 1 : 0)
    : 1;
  if (!title) {
    return new Response(JSON.stringify({ error: 'title required' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    });
  }
  const id = await insertNewsItem(db, { title, body: bodyText, is_public: isPublic, show_on_portal: showOnPortal });
  return new Response(JSON.stringify({ success: true, id }), {
    status: 200,
    headers: { 'Content-Type': 'application/json' },
  });
}

return new Response(JSON.stringify({ error: 'Method not allowed' }), {
  status: 405,
  headers: { 'Content-Type': 'application/json' },
});
---
