---
/**
 * GET /api/permissions/for-role?role=<role>
 *
 * Returns all permissions for a specific role.
 * Authentication required - users can only query their own role unless admin.
 *
 * Query params:
 * - role: Required. One of: member, arb, board, admin
 *
 * Returns: { role: string, permissions: Record<string, PermissionLevel> }
 */
export const prerender = false;

import { getSessionFromCookie, getEffectiveRole } from '../../../lib/auth';
import { getRolePermissions } from '../../../utils/permissions';
import { isValidRole } from '../../../utils/permissions';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const db = env?.DB;

if (Astro.request.method !== 'GET') {
  return new Response(JSON.stringify({ error: 'Method not allowed' }), {
    status: 405,
    headers: { 'Content-Type': 'application/json', Allow: 'GET' },
  });
}

// Auth check
const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  env?.SESSION_SECRET
);

if (!session) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), {
    status: 401,
    headers: { 'Content-Type': 'application/json' },
  });
}

const effectiveRole = getEffectiveRole(session);

// Get requested role from query params
const url = new URL(Astro.request.url);
const requestedRole = url.searchParams.get('role');

if (!requestedRole) {
  return new Response(
    JSON.stringify({
      error: 'Missing required query parameter: role',
      usage: '/api/permissions/for-role?role=<role>',
    }),
    {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    }
  );
}

// Validate role
if (!isValidRole(requestedRole)) {
  return new Response(
    JSON.stringify({
      error: 'Invalid role',
      validRoles: ['member', 'arb', 'board', 'admin'],
    }),
    {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    }
  );
}

// Authorization: Users can only query their own role, admins can query any role
if (effectiveRole !== 'admin' && effectiveRole !== requestedRole) {
  return new Response(
    JSON.stringify({
      error: 'Forbidden',
      message: `You can only query permissions for your own role (${effectiveRole}). Admins can query any role.`,
    }),
    {
      status: 403,
      headers: { 'Content-Type': 'application/json' },
    }
  );
}

try {
  // Get permissions for the requested role
  const permissions = await getRolePermissions(requestedRole, db);

  return new Response(
    JSON.stringify({
      role: requestedRole,
      permissions,
      count: Object.keys(permissions).length,
    }),
    {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    }
  );
} catch (err) {
  console.error('Failed to fetch role permissions:', err);
  return new Response(
    JSON.stringify({
      error: 'Failed to fetch permissions',
      details: err instanceof Error ? err.message : String(err),
    }),
    {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    }
  );
}
---
