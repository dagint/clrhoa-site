---
/**
 * POST /api/usage/record â€” Record a page view (path from body).
 * Sets _usage_sid cookie if missing for anonymous session. Optionally attaches user_id from Lucia auth.
 */
export const prerender = false;

import { validateSession, getSessionId } from '../../../lib/auth/middleware';
import { getUserEmail } from '../../../types/auth';
import { insertPageView } from '../../../lib/usage-db';

const USAGE_SID_COOKIE = '_usage_sid';
const USAGE_SID_MAX_AGE = 60 * 60 * 24 * 365; // 1 year

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const db = env?.DB;

if (Astro.request.method !== 'POST') {
  return new Response(null, { status: 405, headers: { Allow: 'POST' } });
}

if (!db) {
  return new Response(null, { status: 503 });
}

let path = '/';
try {
  const body = await Astro.request.json().catch(() => ({})) as { path?: string };
  if (typeof body.path === 'string' && body.path.trim()) path = body.path.trim().slice(0, 2048);
} catch {
  /* use default path */
}

const cookies = Astro.cookies;
let sessionId = cookies.get(USAGE_SID_COOKIE)?.value?.trim();
if (!sessionId) {
  sessionId = crypto.randomUUID?.() ?? `s${Date.now().toString(36)}${Math.random().toString(36).slice(2)}`;
  cookies.set(USAGE_SID_COOKIE, sessionId, {
    path: '/',
    maxAge: USAGE_SID_MAX_AGE,
    sameSite: 'lax',
    secure: import.meta.env.PROD,
    httpOnly: true,
  });
}

// Get user ID from Lucia session if authenticated
let userId: string | null = null;
const luciaSessionId = getSessionId(Astro);
if (luciaSessionId && db) {
  const { session, user } = await validateSession(db, luciaSessionId, Astro.url.href);
  if (session && user) {
    const email = getUserEmail(user);
    if (email) userId = email.trim();
  }
}

await insertPageView(db, { path, session_id: sessionId, user_id: userId });

return new Response(null, {
  status: 204,
  headers: {},
});
---
