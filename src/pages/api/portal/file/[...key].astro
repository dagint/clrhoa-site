---
/**
 * GET /api/portal/file/[...key] â€” stream R2 object. Requires valid session cookie.
 */
export const prerender = false;

import { getSessionFromCookie } from '../../../../lib/auth';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  env?.SESSION_SECRET
);

if (!session) {
  return new Response('Unauthorized', { status: 401 });
}

const rawKey = Astro.params.key;
if (!rawKey) {
  return new Response('Bad Request', { status: 400 });
}
// Rest param can be string (one segment) or array (multiple segments)
const key = Array.isArray(rawKey)
  ? rawKey.map((s) => decodeURIComponent(s)).join('/')
  : decodeURIComponent(rawKey);

const r2 = env?.CLOURHOA_FILES;
if (!r2) {
  return new Response('Service unavailable', { status: 503 });
}

const object = await r2.get(key);
if (!object) {
  return new Response('Not Found', { status: 404 });
}

const headers = new Headers();
const ct = object.httpMetadata?.contentType;
if (ct) headers.set('Content-Type', ct);
const disp = object.httpMetadata?.contentDisposition;
if (disp) headers.set('Content-Disposition', disp);
else headers.set('Content-Disposition', `attachment; filename="${key.split('/').pop() ?? 'download'}"`);

return new Response(object.body as ReadableStream, { headers });