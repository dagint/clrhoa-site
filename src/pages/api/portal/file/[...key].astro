---
/**
 * GET /api/portal/file/[...key] â€” stream R2 object. Requires valid session cookie.
 * Allowed keys: arb/<requestId>/... (owner or elevated), member-docs/... (must exist in member_documents; any member).
 */
export const prerender = false;

import { getSessionFromCookie } from '../../../../lib/auth';
import { requireArbRequestAccess } from '../../../../lib/access-control';
import { getMemberDocumentByFileKey } from '../../../../lib/member-documents-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  env?.SESSION_SECRET
);

if (!session) {
  return new Response('Unauthorized', { status: 401 });
}

const rawKey = Astro.params.key;
if (!rawKey) {
  return new Response('Bad Request', { status: 400 });
}
// Rest param can be string (one segment) or array (multiple segments)
const key = Array.isArray(rawKey)
  ? rawKey.map((s) => decodeURIComponent(s)).join('/')
  : decodeURIComponent(rawKey);

if (key.includes('..')) {
  return new Response('Forbidden', { status: 403 });
}

const db = env?.DB;

// Member documents: only serve keys that exist in member_documents (any logged-in member can access)
if (key.startsWith('member-docs/')) {
  if (!db) return new Response('Service unavailable', { status: 503 });
  const row = await getMemberDocumentByFileKey(db, key);
  if (!row) return new Response('Not Found', { status: 404 });
  const r2 = env?.CLOURHOA_FILES;
  if (!r2) return new Response('Service unavailable', { status: 503 });
  const object = await r2.get(key);
  if (!object) return new Response('Not Found', { status: 404 });
  const headers = new Headers();
  const ct = object.httpMetadata?.contentType;
  if (ct) headers.set('Content-Type', ct);
  headers.set('Content-Disposition', `attachment; filename="${key.split('/').pop() ?? 'download'}"`);
  return new Response(object.body as ReadableStream, { headers });
}

// ARB attachment keys: must be request owner or elevated
if (!key.startsWith('arb/')) {
  return new Response('Forbidden', { status: 403 });
}

if (!db) {
  return new Response('Service unavailable', { status: 503 });
}
const segments = key.split('/');
const requestId = segments[1];
if (!requestId) {
  return new Response('Forbidden', { status: 403 });
}
const access = await requireArbRequestAccess(db, requestId, session);
if ('response' in access) {
  return new Response(access.response.status === 404 ? 'Not Found' : 'Forbidden', { status: access.response.status });
}

const r2 = env?.CLOURHOA_FILES;
if (!r2) {
  return new Response('Service unavailable', { status: 503 });
}

const object = await r2.get(key);
if (!object) {
  return new Response('Not Found', { status: 404 });
}

const headers = new Headers();
const ct = object.httpMetadata?.contentType;
if (ct) headers.set('Content-Type', ct);
const disp = object.httpMetadata?.contentDisposition;
if (disp) headers.set('Content-Disposition', disp);
else headers.set('Content-Disposition', `attachment; filename="${key.split('/').pop() ?? 'download'}"`);

return new Response(object.body as ReadableStream, { headers });