---
/**
 * POST /api/pim/drop â€” Drop JIT elevated access. Audit logged.
 */
export const prerender = false;

import { getSessionFromCookie, isElevatedRole, createSessionWithElevation, SESSION_COOKIE_NAME } from '../../../lib/auth';
import { insertPimElevationLog } from '../../../lib/pim-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const db = env?.DB;
const secret = env?.SESSION_SECRET;

if (Astro.request.method !== 'POST') {
  return new Response(JSON.stringify({ error: 'Method not allowed' }), {
    status: 405,
    headers: { 'Content-Type': 'application/json' },
  });
}

if (!secret) {
  return new Response(JSON.stringify({ error: 'Unavailable' }), { status: 503, headers: { 'Content-Type': 'application/json' } });
}

const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  secret
);
if (!session) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: { 'Content-Type': 'application/json' } });
}

const cookieValue = await createSessionWithElevation(
  Astro.request.headers.get('cookie') ?? undefined,
  secret,
  null
);
if (!cookieValue) {
  return new Response(JSON.stringify({ error: 'Session invalid' }), { status: 400, headers: { 'Content-Type': 'application/json' } });
}

if (db && isElevatedRole(session.role)) {
  await insertPimElevationLog(db, {
    email: session.email,
    role: session.role,
    action: 'drop',
    expires_at: null,
  });
}

const isProd = import.meta.env.PROD;
const cookieHeader = `${SESSION_COOKIE_NAME}=${cookieValue}; Path=/; Max-Age=${60 * 60 * 24 * 7}; SameSite=Lax${isProd ? '; Secure' : ''}; HttpOnly`;

return new Response(JSON.stringify({ success: true }), {
  status: 200,
  headers: {
    'Content-Type': 'application/json',
    'Set-Cookie': cookieHeader,
  },
});
---
