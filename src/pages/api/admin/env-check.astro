---
/**
 * GET /api/admin/env-check â€” Admin only. Returns which env vars are set (names only; no values).
 * For troubleshooting only. Do not expose to non-admin or return secret values.
 */
export const prerender = false;

import { getSessionFromCookie, getEffectiveRole } from '../../../lib/auth';

const runtime = Astro.locals.runtime;
const env = runtime?.env;

if (Astro.request.method !== 'GET') {
  return new Response(JSON.stringify({ error: 'Method not allowed' }), {
    status: 405,
    headers: { 'Content-Type': 'application/json' },
  });
}

const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  env?.SESSION_SECRET
);
if (!session) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: { 'Content-Type': 'application/json' } });
}

if (getEffectiveRole(session) !== 'admin') {
  return new Response(JSON.stringify({ error: 'Forbidden. Admin only.' }), { status: 403, headers: { 'Content-Type': 'application/json' } });
}

const ENV_KEYS = [
  'DB',
  'CLOURHOA_USERS',
  'CLOURHOA_FILES',
  'SESSION_SECRET',
  'KV',
  'CLOUDFLARE_ACCOUNT_ID',
  'CLOUDFLARE_DEPLOY_API_TOKEN',
  'CLOUDFLARE_BACKUP_API_TOKEN',
  'D1_DATABASE_ID',
  'GOOGLE_CLIENT_ID',
  'GOOGLE_CLIENT_SECRET',
  'BACKUP_ENCRYPTION_KEY',
  'NOTIFY_BOARD_EMAIL',
  'NOTIFY_ARB_EMAIL',
  'NOTIFY_NOREPLY_EMAIL',
  'RESEND_API_KEY',
  'MAILCHANNELS_API_KEY',
  'TWILIO_ACCOUNT_SID',
  'TWILIO_AUTH_TOKEN',
  'TWILIO_PHONE_NUMBER',
];

const out: Record<string, 'set' | 'unset'> = {};
const e = env as Record<string, unknown> | undefined;
for (const k of ENV_KEYS) {
  const v = e?.[k];
  out[k] = v != null && (typeof v !== 'string' || v !== '') ? 'set' : 'unset';
}

return new Response(JSON.stringify(out), {
  status: 200,
  headers: { 'Content-Type': 'application/json' },
});
---
