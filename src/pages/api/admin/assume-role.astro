---
/**
 * POST /api/admin/assume-role â€” Admin only. Set or clear assumed role (Board or ARB, not both).
 * Body: { role: 'board' | 'arb' | 'none', csrf_token: string }.
 * Clearly logged and auditable in admin_assumed_role_audit.
 */
export const prerender = false;

import { getSessionFromCookie, verifyCsrfToken, verifyOrigin, createSessionWithAssumedRole, ASSUMED_ROLES, ASSUMED_ROLE_TTL_MS, type AdminAssumedRole, SESSION_COOKIE_NAME } from '../../../lib/auth';
import { insertAdminAssumedRoleAudit } from '../../../lib/admin-assumed-role-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const db = env?.DB;
const secret = env?.SESSION_SECRET;
const ipAddress = Astro.request.headers.get('cf-connecting-ip') ?? Astro.request.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ?? null;

if (Astro.request.method !== 'POST') {
  return new Response(JSON.stringify({ error: 'Method not allowed' }), {
    status: 405,
    headers: { 'Content-Type': 'application/json' },
  });
}

if (!secret) {
  return new Response(JSON.stringify({ error: 'Unavailable' }), { status: 503, headers: { 'Content-Type': 'application/json' } });
}

const origin = Astro.request.headers.get('origin');
const referer = Astro.request.headers.get('referer');
if (!verifyOrigin(origin, referer, Astro.url.origin)) {
  return new Response(JSON.stringify({ error: 'Invalid origin.' }), { status: 403, headers: { 'Content-Type': 'application/json' } });
}

const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  secret
);
if (!session) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401, headers: { 'Content-Type': 'application/json' } });
}

const sessionRole = session.role?.toLowerCase();
if (sessionRole !== 'admin' && sessionRole !== 'arb_board') {
  return new Response(JSON.stringify({ error: 'Forbidden. Only admins or ARB+Board can assume a role.' }), { status: 403, headers: { 'Content-Type': 'application/json' } });
}

let body: { role?: string; csrf_token?: string; csrfToken?: string };
try {
  body = await Astro.request.json();
} catch {
  return new Response(JSON.stringify({ error: 'Invalid JSON' }), { status: 400, headers: { 'Content-Type': 'application/json' } });
}

if (!verifyCsrfToken(session, body.csrf_token ?? body.csrfToken)) {
  return new Response(JSON.stringify({ error: 'Invalid security token.' }), { status: 403, headers: { 'Content-Type': 'application/json' } });
}

const raw = (body.role ?? '').trim().toLowerCase();
if (raw !== 'board' && raw !== 'arb' && raw !== 'none' && raw !== '') {
  return new Response(JSON.stringify({ error: 'role must be board, arb, or none' }), { status: 400, headers: { 'Content-Type': 'application/json' } });
}
const assumed_role: AdminAssumedRole | null = raw === 'none' || raw === '' ? null : (raw as AdminAssumedRole);

const cookieValue = await createSessionWithAssumedRole(
  Astro.request.headers.get('cookie') ?? undefined,
  secret,
  assumed_role
);
if (!cookieValue) {
  return new Response(JSON.stringify({ error: 'Session invalid' }), { status: 400, headers: { 'Content-Type': 'application/json' } });
}

if (db) {
  try {
    await insertAdminAssumedRoleAudit(db, {
      admin_email: session.email,
      actor_role: sessionRole === 'arb_board' ? 'arb_board' : 'admin',
      action: assumed_role ? 'assume' : 'clear',
      role_assumed: assumed_role ?? undefined,
      action_detail: assumed_role ? `${sessionRole} assumed role: ${assumed_role}` : `${sessionRole} cleared assumed role`,
      ip_address: ipAddress,
    });
  } catch (e) {
    console.error('[admin assume-role] audit insert failed:', e);
  }
}

const isProd = import.meta.env.PROD;
const cookieHeader = `${SESSION_COOKIE_NAME}=${cookieValue}; Path=/; Max-Age=${60 * 60 * 24 * 7}; SameSite=Lax${isProd ? '; Secure' : ''}; HttpOnly`;

const assumed_until = assumed_role ? Date.now() + ASSUMED_ROLE_TTL_MS : undefined;
return new Response(
  JSON.stringify({ success: true, assumed_role: assumed_role ?? null, assumed_until: assumed_until ?? null }),
  {
    status: 200,
    headers: {
      'Content-Type': 'application/json',
      'Set-Cookie': cookieHeader,
    },
  }
);
---
