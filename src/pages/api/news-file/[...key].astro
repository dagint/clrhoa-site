---
/**
 * GET /api/news-file/news/{newsItemId}/{filename} â€” Serve a news item photo from R2.
 * If the news item is public (is_public=1), anyone can view. Otherwise requires session (portal member).
 */
export const prerender = false;

import { getSessionFromCookie } from '../../../lib/auth';
import { getNewsItemById, getNewsItemImageKeys } from '../../../lib/news-items-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const rawKey = Astro.params.key;
if (!rawKey) {
  return new Response('Bad Request', { status: 400 });
}
const key = Array.isArray(rawKey)
  ? rawKey.map((s) => decodeURIComponent(s)).join('/')
  : decodeURIComponent(rawKey);

if (!key.startsWith('news/') || key.includes('..')) {
  return new Response('Forbidden', { status: 403 });
}

const parts = key.split('/');
const newsItemId = parts[1];
if (!newsItemId) {
  return new Response('Bad Request', { status: 400 });
}

const db = env?.DB;
const r2 = env?.CLOURHOA_FILES;
if (!db || !r2) {
  return new Response('Service unavailable', { status: 503 });
}

const item = await getNewsItemById(db, newsItemId);
if (!item) {
  return new Response('Not Found', { status: 404 });
}

const allowedKeys = getNewsItemImageKeys(item);
if (!allowedKeys.includes(key)) {
  return new Response('Not Found', { status: 404 });
}

const isPublic = item.is_public === 1;
if (!isPublic) {
  const session = await getSessionFromCookie(
    Astro.request.headers.get('cookie') ?? undefined,
    env?.SESSION_SECRET
  );
  if (!session) {
    return new Response('Unauthorized', { status: 401 });
  }
}

const object = await r2.get(key);
if (!object) {
  return new Response('Not Found', { status: 404 });
}

const headers = new Headers();
const ct = object.httpMetadata?.contentType ?? 'image/jpeg';
headers.set('Content-Type', ct);
headers.set('Cache-Control', 'public, max-age=86400');

return new Response(object.body as ReadableStream, { headers });
---
