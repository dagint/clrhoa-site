---
/**
 * POST /api/feedback-upload â€” board uploads PDF for a feedback doc.
 * Returns { key } for use in feedback doc create.
 */
export const prerender = false;

import { requireSession, jsonResponse } from '../../lib/api-helpers';
import { getEffectiveRole, verifyCsrfToken, isBoardOnly } from '../../lib/auth';

const auth = await requireSession(Astro);
if ('response' in auth) return auth.response;
const { session } = auth;

const effectiveRole = getEffectiveRole(session);
const isBoard = isBoardOnly(effectiveRole) || effectiveRole === 'admin';
if (!isBoard) return jsonResponse({ error: 'Forbidden' }, 403);

const r2 = Astro.locals.runtime?.env?.CLOURHOA_FILES;
if (!r2) return jsonResponse({ error: 'Server configuration error' }, 503);

if (Astro.request.method !== 'POST') {
  return new Response(null, { status: 405, headers: { Allow: 'POST' } });
}

let file: File;
try {
  const form = await Astro.request.formData();
  const csrf = form.get('csrf_token') ?? form.get('csrfToken');
  if (!verifyCsrfToken(session, typeof csrf === 'string' ? csrf : undefined)) {
    return jsonResponse({ error: 'Invalid security token. Please refresh the page.' }, 403);
  }
  const f = form.get('file');
  if (!(f instanceof File) || f.size === 0) {
    return jsonResponse({ error: 'No file or empty file' }, 400);
  }
  if (f.type !== 'application/pdf') {
    return jsonResponse({ error: 'Only PDF files are allowed' }, 400);
  }
  if (f.size > 10 * 1024 * 1024) {
    return jsonResponse({ error: 'File must be under 10MB' }, 400);
  }
  file = f;
} catch {
  return jsonResponse({ error: 'Invalid form data' }, 400);
}

const id = crypto.randomUUID?.() ?? Math.random().toString(36).slice(2) + Date.now().toString(36);
const key = `feedback/${id}.pdf`;
await r2.put(key, await file.arrayBuffer(), {
  httpMetadata: { contentType: 'application/pdf' },
});

return jsonResponse({ success: true, key });
---
