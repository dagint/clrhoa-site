---
/**
 * POST /api/meeting-agenda-upload â€” board uploads agenda PDF for a meeting.
 * Multipart: file (application/pdf). Returns { key } for use in meeting create/update.
 */
export const prerender = false;

import { requireSession, jsonResponse } from '../../lib/api-helpers';

const auth = await requireSession(Astro);
if (auth.response) return auth.response;
const { session } = auth;

const isBoard = session.role === 'board' || session.role === 'admin' || session.role === 'arb_board';
if (!isBoard) return jsonResponse({ error: 'Forbidden' }, 403);

const r2 = Astro.locals.runtime?.env?.CLOURHOA_FILES;
if (!r2) return jsonResponse({ error: 'Server configuration error' }, 503);

if (Astro.request.method !== 'POST') {
  return new Response(null, { status: 405, headers: { Allow: 'POST' } });
}

let file: File;
try {
  const form = await Astro.request.formData();
  const f = form.get('file');
  if (!(f instanceof File) || f.size === 0) {
    return jsonResponse({ error: 'No file or empty file' }, 400);
  }
  if (f.type !== 'application/pdf') {
    return jsonResponse({ error: 'Only PDF files are allowed' }, 400);
  }
  if (f.size > 10 * 1024 * 1024) {
    return jsonResponse({ error: 'File must be under 10MB' }, 400);
  }
  file = f;
} catch {
  return jsonResponse({ error: 'Invalid form data' }, 400);
}

const id = crypto.randomUUID?.() ?? Math.random().toString(36).slice(2) + Date.now().toString(36);
const key = `meetings/agendas/${id}.pdf`;
await r2.put(key, await file.arrayBuffer(), {
  httpMetadata: { contentType: 'application/pdf' },
});

return jsonResponse({ success: true, key });
---
