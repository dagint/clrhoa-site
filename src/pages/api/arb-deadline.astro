---
/**
 * POST /api/arb-deadline â€” Set or clear review deadline for a request (ARB/Board/Admin only).
 */
export const prerender = false;

import { getSessionFromCookie, verifyCsrfToken, verifyOrigin } from '../../lib/auth';
import { checkRateLimit, getRateLimitConfig } from '../../lib/rate-limit';
import { getSecurityMonitor } from '../../lib/monitoring';
import { getArbRequest } from '../../lib/arb-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const session = await getSessionFromCookie(
  Astro.request.headers.get('cookie') ?? undefined,
  env?.SESSION_SECRET
);

if (!session) {
  return new Response(JSON.stringify({ error: 'Unauthorized' }), {
    status: 401,
    headers: { 'Content-Type': 'application/json' },
  });
}

const allowedRoles = ['arb', 'board', 'admin', 'arb_board'];
if (!allowedRoles.includes(session.role)) {
  return new Response(JSON.stringify({ error: 'Forbidden. ARB or Board role required.' }), {
    status: 403,
    headers: { 'Content-Type': 'application/json' },
  });
}

if (Astro.request.method !== 'POST') {
  return new Response(JSON.stringify({ error: 'Method not allowed' }), {
    status: 405,
    headers: { 'Content-Type': 'application/json' },
  });
}

const db = env?.DB;
if (!db) {
  return new Response(JSON.stringify({ error: 'Server configuration error' }), {
    status: 503,
    headers: { 'Content-Type': 'application/json' },
  });
}

let body: { requestId?: string; deadline?: string | null; csrfToken?: string };
try {
  body = await Astro.request.json();
} catch {
  return new Response(JSON.stringify({ error: 'Invalid JSON body' }), {
    status: 400,
    headers: { 'Content-Type': 'application/json' },
  });
}

// CSRF token verification
if (!verifyCsrfToken(session, body.csrfToken)) {
  return new Response(
    JSON.stringify({ error: 'Invalid security token. Please refresh the page and try again.' }),
    { status: 403, headers: { 'Content-Type': 'application/json' } }
  );
}

const requestId = (body.requestId ?? '').trim();
if (!requestId) {
  return new Response(JSON.stringify({ error: 'Missing requestId.' }), {
    status: 400,
    headers: { 'Content-Type': 'application/json' },
  });
}

const request = await getArbRequest(db, requestId);
if (!request) {
  return new Response(JSON.stringify({ error: 'Request not found.' }), {
    status: 404,
    headers: { 'Content-Type': 'application/json' },
  });
}

const deadline = body.deadline === null ? null : (body.deadline?.trim() || null);
const result = await db
  .prepare(`UPDATE arb_requests SET review_deadline = ?, updated_at = datetime('now') WHERE id = ?`)
  .bind(deadline, requestId)
  .run();

if ((result.meta.changes ?? 0) > 0) {
  return new Response(
    JSON.stringify({
      success: true,
      requestId,
      message: deadline ? 'Deadline set.' : 'Deadline cleared.',
    }),
    { status: 200, headers: { 'Content-Type': 'application/json' } }
  );
}

return new Response(JSON.stringify({ error: 'Update failed.' }), {
  status: 500,
  headers: { 'Content-Type': 'application/json' },
});
