---
import BaseLayout from '../layouts/BaseLayout.astro';

// StaticForms: https://www.staticforms.xyz/ — uses apiKey, redirectTo, honeypot; optional reCAPTCHA/ALTCHA in dashboard
const staticformsApiKey = import.meta.env.PUBLIC_STATICFORMS_API_KEY ?? '';
const formAction = staticformsApiKey ? 'https://api.staticforms.dev/submit' : '#';
const thanksUrl = `${import.meta.env.SITE ?? 'https://clrhoa.com'}/contact/thanks`;
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY ?? '';

// Contact information from environment variables
const mailingAddressName = import.meta.env.PUBLIC_MAILING_ADDRESS_NAME ?? 'Crooked Lake Reserve HOA';
const mailingAddressLine1 = import.meta.env.PUBLIC_MAILING_ADDRESS_LINE1 ?? 'P.O. Box 1234';
const mailingAddressLine2 = import.meta.env.PUBLIC_MAILING_ADDRESS_LINE2 ?? 'Your City, ST 12345';

// Get URL parameters for pre-filling form
const url = Astro.url;
const recipientParam = url.searchParams.get('recipient');
const vendorParam = url.searchParams.get('vendor');
const prefillRecipient = recipientParam === 'vendor' ? 'vendor' : recipientParam || '';
const prefillMessage = vendorParam 
  ? `I would like to request contact information for: ${vendorParam}`
  : '';
---

<BaseLayout title="Contact Us" description="Contact the Board of Directors or the Architectural Review Board (ARB) directly. Use the contact form to send a message; for matters requiring attachments, a member will reach out to you.">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-2xl mx-auto">
      <h1 class="text-4xl font-heading font-bold text-clr-green mb-6">Contact the Board or ARB</h1>

      <section class="mb-8">
        <p class="text-gray-700 mb-4 font-body">
          Use the form below to contact the <strong>Board of Directors</strong> or the <strong>Architectural Review Board (ARB)</strong> directly. Choose who you want to reach and your message will be sent securely to that group.
        </p>
        <p class="text-gray-700 mb-6 font-body">
          This form does not accept file attachments. If your matter requires documents or photos, send your message here and a member of the Board or ARB will reach out to you to arrange sharing attachments.
        </p>

        <!-- Contact form (StaticForms: honeypot + optional reCAPTCHA in dashboard) -->
        {staticformsApiKey ? (
          <div class="bg-clr-beige/30 border border-gray-100 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-heading font-semibold text-clr-green mb-4">Send a message</h2>
            <form id="contact-form" action={formAction} method="POST" class="space-y-4" novalidate data-redirect-to={thanksUrl}>
              <input type="text" name="honeypot" class="hidden" tabindex="-1" autocomplete="off" aria-hidden="true" />
              <input type="hidden" name="apiKey" value={staticformsApiKey} />
              <input type="hidden" name="redirectTo" value={thanksUrl} />
              
              <!-- Recipient field -->
              <div>
                <label for="recipient" class="block text-sm font-medium text-gray-700 mb-1 font-body">
                  I would like to contact: <span class="text-red-600" aria-label="required">*</span>
                </label>
                <select 
                  id="recipient" 
                  name="recipient" 
                  required 
                  aria-required="true"
                  aria-describedby="recipient-error"
                  class="w-full px-3 py-2.5 rounded-lg border border-gray-300 text-gray-800 focus:ring-2 focus:ring-clr-green focus:border-clr-green font-body bg-white invalid:border-red-500"
                  value={prefillRecipient}
                >
                  <option value="">Select recipient...</option>
                  <option value="board" selected={prefillRecipient === 'board'}>Board of Directors</option>
                  <option value="arb" selected={prefillRecipient === 'arb'}>Architectural Review Board (ARB)</option>
                  <option value="vendor" selected={prefillRecipient === 'vendor'}>Vendor Information Request</option>
                </select>
                <div id="recipient-error" class="text-red-600 text-sm mt-1 font-body hidden" role="alert" aria-live="polite"></div>
              </div>
              
              <!-- Name field -->
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1 font-body">
                  Name <span class="text-red-600" aria-label="required">*</span>
                </label>
                <input 
                  type="text" 
                  id="name" 
                  name="name" 
                  required 
                  aria-required="true"
                  aria-describedby="name-error"
                  minlength="2"
                  maxlength="100"
                  class="w-full px-3 py-2.5 rounded-lg border border-gray-300 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-clr-green focus:border-clr-green font-body invalid:border-red-500" 
                  placeholder="Your name" 
                />
                <div id="name-error" class="text-red-600 text-sm mt-1 font-body hidden" role="alert" aria-live="polite"></div>
              </div>
              
              <!-- Email field -->
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1 font-body">
                  Email <span class="text-red-600" aria-label="required">*</span>
                </label>
                <input 
                  type="email" 
                  id="email" 
                  name="email" 
                  required 
                  aria-required="true"
                  aria-describedby="email-error"
                  class="w-full px-3 py-2.5 rounded-lg border border-gray-300 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-clr-green focus:border-clr-green font-body invalid:border-red-500" 
                  placeholder="you@example.com" 
                />
                <div id="email-error" class="text-red-600 text-sm mt-1 font-body hidden" role="alert" aria-live="polite"></div>
              </div>
              
              <!-- Message field -->
              <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-1 font-body">
                  Message <span class="text-red-600" aria-label="required">*</span>
                </label>
                <textarea 
                  id="message" 
                  name="message" 
                  rows="4" 
                  required 
                  aria-required="true"
                  aria-describedby="message-error"
                  minlength="10"
                  maxlength="2000"
                  class="w-full px-3 py-2.5 rounded-lg border border-gray-300 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-clr-green focus:border-clr-green resize-y font-body invalid:border-red-500" 
                  placeholder="Your question or message..."
                >{prefillMessage}</textarea>
                <div id="message-error" class="text-red-600 text-sm mt-1 font-body hidden" role="alert" aria-live="polite"></div>
              </div>
              
              <!-- Form-level error message (validation) -->
              <div id="form-error" class="bg-red-50 border border-red-200 rounded-lg p-4 hidden" role="alert" aria-live="polite">
                <p class="text-red-800 text-sm font-body font-semibold">Please correct the errors below before submitting.</p>
              </div>
              <!-- Submit/network error -->
              <div id="form-submit-error" class="bg-red-50 border border-red-200 rounded-lg p-4 hidden" role="alert" aria-live="polite">
                <p class="text-red-800 text-sm font-body font-semibold">We couldn't send your message. Please try again in a few moments, or use the mailing address below.</p>
              </div>
              
              {recaptchaSiteKey && (
                <div class="g-recaptcha" data-sitekey={recaptchaSiteKey} data-theme="light"></div>
              )}
              <button type="submit" class="inline-flex items-center px-5 py-2.5 rounded-lg text-sm font-medium text-white bg-clr-green hover:bg-clr-green/90 transition-colors font-body disabled:opacity-50 disabled:cursor-not-allowed">
                Send message
              </button>
            </form>
          </div>
        ) : (
          <div class="bg-clr-beige/30 border border-gray-100 rounded-xl p-6 mb-8">
            <p class="text-gray-700 font-body">
              The contact form is currently being configured. Please check back soon or use the mailing address below.
            </p>
          </div>
        )}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="card-hover bg-clr-beige/30 p-6 rounded-2xl border border-gray-100">
            <h2 class="text-xl font-heading font-semibold text-clr-green mb-3">Contact Information</h2>
            <p class="text-clr-gray mb-2 font-body">
              Please use the contact form above to send messages securely. The form allows you to select
              whether you're contacting the Board of Directors or the Architectural Review Board.
            </p>
            {!staticformsApiKey && (
              <p class="text-clr-gray font-body text-sm mt-2">
                <strong>Note:</strong> Contact form is being configured. For urgent matters, please use the mailing address.
              </p>
            )}
          </div>

          <div class="card-hover bg-clr-beige/30 p-6 rounded-2xl border border-gray-100">
            <h2 class="text-xl font-heading font-semibold text-clr-green mb-3">Mailing Address</h2>
            <p class="text-clr-gray font-body">
              {mailingAddressName}<br />
              {mailingAddressLine1}<br />
              {mailingAddressLine2}
            </p>
          </div>
        </div>

        <div class="bg-clr-beige/30 border border-gray-100 rounded-xl p-6 mb-6">
          <h2 class="text-xl font-heading font-semibold text-clr-green mb-3">Response Time</h2>
          <p class="text-gray-700 font-body">
            The board typically responds to inquiries within 2-3 business days.
            Messages are routed securely to the appropriate board members or committee members.
          </p>
        </div>

        <div class="border-t border-gray-100 pt-6">
          <h2 class="text-2xl font-heading font-semibold text-clr-green mb-4">Common Questions</h2>
          <div class="space-y-4">
            <div>
              <h3 class="text-lg font-heading font-semibold text-clr-green mb-2">How do I submit an architectural request?</h3>
              <p class="text-gray-700 font-body">
                Please download the Architectural Review form from the
                <a href="/documents" class="text-clr-orange hover:underline font-semibold">Documents</a> section
                and submit it to the board via email.
              </p>
            </div>
            <div>
              <h3 class="text-lg font-heading font-semibold text-clr-green mb-2">When are HOA dues due?</h3>
              <p class="text-gray-700 font-body">
                Dues are typically due quarterly. Check the latest news and announcements
                for specific due dates and payment instructions.
              </p>
            </div>
            <div>
              <h3 class="text-lg font-heading font-semibold text-clr-green mb-2">How can I attend a board meeting?</h3>
              <p class="text-gray-700 font-body">
                Board meetings are open to all homeowners. Meeting dates and locations
                are posted in the <a href="/news" class="text-clr-orange hover:underline font-semibold">News</a> section.
              </p>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  {staticformsApiKey && (
    <>
      {recaptchaSiteKey && (
        <script src="https://www.google.com/recaptcha/api.js" async defer></script>
      )}
      <script>
        (function () {
          const form = document.getElementById('contact-form');
          if (!form) return;

          const recipient = document.getElementById('recipient');
          const name = document.getElementById('name');
          const email = document.getElementById('email');
          const message = document.getElementById('message');
          const formError = document.getElementById('form-error');
          const formSubmitError = document.getElementById('form-submit-error');

          // Pre-fill form from URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const recipientParam = urlParams.get('recipient');
          const vendorParam = urlParams.get('vendor');
          
          if (recipientParam && recipient) {
            recipient.value = recipientParam;
          }
          
          if (vendorParam && message) {
            message.value = `I would like to request contact information for: ${vendorParam}`;
          }

          function showError(field, errorElement, message) {
            field.setAttribute('aria-invalid', 'true');
            field.classList.add('border-red-500');
            field.classList.remove('border-gray-300');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
          }

          function clearError(field, errorElement) {
            field.setAttribute('aria-invalid', 'false');
            field.classList.remove('border-red-500');
            field.classList.add('border-gray-300');
            errorElement.classList.add('hidden');
            errorElement.textContent = '';
          }

          function validateRecipient() {
            const errorElement = document.getElementById('recipient-error');
            if (!recipient.value) {
              showError(recipient, errorElement, 'Please select a recipient.');
              return false;
            }
            clearError(recipient, errorElement);
            return true;
          }

          function validateName() {
            const errorElement = document.getElementById('name-error');
            const value = name.value.trim();
            if (!value) {
              showError(name, errorElement, 'Name is required.');
              return false;
            }
            if (value.length < 2) {
              showError(name, errorElement, 'Name must be at least 2 characters.');
              return false;
            }
            if (value.length > 100) {
              showError(name, errorElement, 'Name must be less than 100 characters.');
              return false;
            }
            clearError(name, errorElement);
            return true;
          }

          function validateEmail() {
            const errorElement = document.getElementById('email-error');
            const value = email.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!value) {
              showError(email, errorElement, 'Email is required.');
              return false;
            }
            if (!emailRegex.test(value)) {
              showError(email, errorElement, 'Please enter a valid email address.');
              return false;
            }
            clearError(email, errorElement);
            return true;
          }

          function validateMessage() {
            const errorElement = document.getElementById('message-error');
            const value = message.value.trim();
            if (!value) {
              showError(message, errorElement, 'Message is required.');
              return false;
            }
            if (value.length < 10) {
              showError(message, errorElement, 'Message must be at least 10 characters.');
              return false;
            }
            if (value.length > 2000) {
              showError(message, errorElement, 'Message must be less than 2000 characters.');
              return false;
            }
            clearError(message, errorElement);
            return true;
          }

          // Real-time validation on blur
          recipient.addEventListener('blur', validateRecipient);
          recipient.addEventListener('change', validateRecipient);
          name.addEventListener('blur', validateName);
          name.addEventListener('input', function() {
            if (name.getAttribute('aria-invalid') === 'true') {
              validateName();
            }
          });
          email.addEventListener('blur', validateEmail);
          email.addEventListener('input', function() {
            if (email.getAttribute('aria-invalid') === 'true') {
              validateEmail();
            }
          });
          message.addEventListener('blur', validateMessage);
          message.addEventListener('input', function() {
            if (message.getAttribute('aria-invalid') === 'true') {
              validateMessage();
            }
          });

          // Form submission: validate, then submit via fetch for error handling
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (formSubmitError) formSubmitError.classList.add('hidden');
            const isValid = validateRecipient() && validateName() && validateEmail() && validateMessage();
            if (!isValid) {
              formError.classList.remove('hidden');
              formError.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              const firstInvalid = form.querySelector('[aria-invalid="true"]');
              if (firstInvalid) firstInvalid.focus();
              return;
            }
            formError.classList.add('hidden');
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) { submitBtn.setAttribute('disabled', 'true'); submitBtn.textContent = 'Sending…'; }
            try {
              const res = await fetch(form.action, { method: 'POST', body: new FormData(form) });
              if (res.ok) {
                const redirectTo = form.dataset.redirectTo || form.querySelector('[name="redirectTo"]')?.value;
                if (redirectTo) window.location.href = redirectTo;
                else if (formSubmitError) formSubmitError.querySelector('p').textContent = 'Message sent. You will be redirected shortly.';
              } else {
                if (formSubmitError) { formSubmitError.classList.remove('hidden'); formSubmitError.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
              }
            } catch (_) {
              if (formSubmitError) { formSubmitError.classList.remove('hidden'); formSubmitError.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
            } finally {
              if (submitBtn) { submitBtn.removeAttribute('disabled'); submitBtn.textContent = 'Send message'; }
            }
          });
        })();
      </script>
    </>
  )}
</BaseLayout>
