---
export const prerender = false;

import { getBoardContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { listOwners, listDirectoryLogs } from '../../lib/directory-db';
import { listAssessmentPaymentsForAudit } from '../../lib/assessments-db';
import { listSubmissions } from '../../lib/vendor-submissions-db';
import { listMemberDocuments } from '../../lib/member-documents-db';
import { listAllSpecialAssessments } from '../../lib/assessments-db';
import { listPreapprovalItems } from '../../lib/preapproval-db';
import { listAllFeedbackDocs } from '../../lib/feedback-db';
import { listAllMeetings } from '../../lib/meetings-db';
import { listVendorAuditLog } from '../../lib/vendors-db';
import { listPimElevationLog } from '../../lib/pim-db';
import { listAdminAssumedRoleAudit } from '../../lib/admin-assumed-role-db';
import { listArbAuditLog } from '../../lib/arb-db';
import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';

import BoardNav from '../../components/BoardNav.astro';
const ctx = await getBoardContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;

const AUDIT_PAGE_SIZES = [10, 25, 50, 100] as const;
const DEFAULT_AUDIT_PAGE_SIZE = 10;
const url = Astro.url;
const getPage = (key: string): number => {
  const p = url.searchParams.get(key);
  const n = p ? parseInt(p, 10) : 1;
  return Number.isNaN(n) || n < 1 ? 1 : Math.min(n, 1000);
};
const getLimit = (): number => {
  const p = url.searchParams.get('audit_limit');
  const n = p ? parseInt(p, 10) : DEFAULT_AUDIT_PAGE_SIZE;
  return AUDIT_PAGE_SIZES.includes(n as (typeof AUDIT_PAGE_SIZES)[number]) ? n : DEFAULT_AUDIT_PAGE_SIZE;
};
const adminPage = getPage('admin_page');
const pimPage = getPage('pim_page');
const directoryPage = getPage('directory_page');
const paymentsPage = getPage('payments_page');
const vendorPage = getPage('vendor_page');
const arbPage = getPage('arb_page');
const pageSize = getLimit();

function auditPageUrl(key: string, value: number): string {
  const u = new URL(url);
  if (value <= 1) u.searchParams.delete(key);
  else u.searchParams.set(key, String(value));
  if (pageSize !== DEFAULT_AUDIT_PAGE_SIZE) u.searchParams.set('audit_limit', String(pageSize));
  return u.pathname + u.search;
}

const db = env?.DB;
const { email, role, name } = session;
const badges = await getPortalBadgeCounts(db, email, role, name);
const directoryLogs = db ? await listDirectoryLogs(db, pageSize, (directoryPage - 1) * pageSize) : [];
const arbLogs = db ? await listArbAuditLog(db, pageSize, (arbPage - 1) * pageSize) : [];
const owners = db ? await listOwners(db) : [];
const ownersWithCreator = owners.filter((o) => o.created_by_email?.trim());
const ownersWithUpdater = owners.filter((o) => o.updated_by?.trim()).sort((a, b) => (b.updated_at ?? '').localeCompare(a.updated_at ?? ''));


const paymentAudit = db ? await listAssessmentPaymentsForAudit(db, pageSize, (paymentsPage - 1) * pageSize) : [];
const vendorApproved = db ? await listSubmissions(db, { status: 'approved' }) : [];
const vendorRejected = db ? await listSubmissions(db, { status: 'rejected' }) : [];
const vendorSubmissionsAudit = [...vendorApproved, ...vendorRejected]
  .sort((a, b) => (b.reviewed_at ?? b.submitted_at ?? '').localeCompare(a.reviewed_at ?? a.submitted_at ?? ''))
  .slice(0, 200);
const memberDocsAudit = db ? await listMemberDocuments(db) : [];
const specialAssessmentsAudit = db
  ? (await listAllSpecialAssessments(db)).sort((a, b) => (b.created ?? '').localeCompare(a.created ?? '')).slice(0, 200)
  : [];
const preapprovalAudit = db ? await listPreapprovalItems(db) : [];
const feedbackDocsAudit = db ? await listAllFeedbackDocs(db) : [];
const meetingsAudit = db ? (await listAllMeetings(db)).slice(0, 200) : [];
const vendorAuditLog = db ? await listVendorAuditLog(db, pageSize, (vendorPage - 1) * pageSize) : [];
const pimElevationLog = db ? await listPimElevationLog(db, pageSize, (pimPage - 1) * pageSize) : [];
const showAdminAssumeRoleAudit = effectiveRole === 'board' || effectiveRole === 'admin';
let adminAssumedRoleLog: Awaited<ReturnType<typeof listAdminAssumedRoleAudit>> = [];
if (db && showAdminAssumeRoleAudit) {
  try {
    adminAssumedRoleLog = await listAdminAssumedRoleAudit(db, pageSize, (adminPage - 1) * pageSize);
  } catch {
    // Table may not exist yet (run schema-admin-assumed-role.sql)
  }
}

const BLANK = '-';
/** Shown in place of sensitive content (revealed phone/email) in audit views to avoid exposing PII. */
const REDACTED = '—';

function formatDate(s: string | null): string {
  if (!s) return BLANK;
  try {
    const d = new Date(s);
    return Number.isNaN(d.getTime()) ? s : d.toLocaleString();
  } catch {
    return s ?? BLANK;
  }
}
---

<PortalLayout title="Audit logs | Board | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/board/audit-logs"
    pageTitle="Audit logs"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
  >
    <BoardNav currentPath="/board/audit-logs" />

unt}
<p class="text-gray-600 mb-4">
        Full audit logs for transparency: PIM elevated access requests, directory (contact reveals, who added/updated owners), assessment payments recorded, vendor list changes and vendor submission approvals/rejections, member document uploads, special assessments, preapproval library, feedback docs, meetings, and ARB status changes. <strong>Revealed contact information (phone numbers and emails that were viewed) is redacted for privacy, but the identity of who performed each action is shown for accountability.</strong>
  </p>
  <div class="flex flex-wrap items-center gap-2 mb-8">
    <label for="audit-per-page" class="text-sm text-gray-600">Per page:</label>
    <select id="audit-per-page" name="audit_limit" class="rounded border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-700 focus:border-clr-green focus:outline-none focus:ring-1 focus:ring-clr-green" aria-label="Audit log entries per page">
      {AUDIT_PAGE_SIZES.map((size) => (
        <option value={size} selected={pageSize === size}>{size}</option>
      ))}
    </select>
    <span class="text-sm text-gray-500">Each paged section shows this many entries. Use Previous and Next at the bottom of a section to browse.</span>
  </div>
  <script>
    document.getElementById('audit-per-page')?.addEventListener('change', function (this: HTMLSelectElement) {
      const limit = this.value;
      const u = new URL(window.location.href);
      u.searchParams.set('audit_limit', limit);
      u.searchParams.delete('admin_page');
      u.searchParams.delete('pim_page');
      u.searchParams.delete('directory_page');
      u.searchParams.delete('payments_page');
      u.searchParams.delete('vendor_page');
      u.searchParams.delete('arb_page');
      if (limit === '10') u.searchParams.delete('audit_limit');
      window.location.href = u.pathname + u.search;
    });
  </script>

  <!-- Admin assume role: when admins assumed Board/ARB or cleared (Board and Admin only) -->
  {showAdminAssumeRoleAudit && adminAssumedRoleLog.length > 0 && (
  <section aria-labelledby="admin-assume-heading">
    <h2 id="admin-assume-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Admin assume role (technical assistance)</h2>
    <p class="text-base text-gray-600 mb-3">When an administrator assumed Board or ARB role to provide technical assistance, and actions they performed while assumed. One role at a time; all actions are logged.</p>
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Email</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Actor</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Action</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Role assumed</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Detail</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">IP</th>
            </tr>
          </thead>
          <tbody>
            {adminAssumedRoleLog.map((row) => (
              <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                <td class="py-2 px-3 font-mono text-sm">{row.admin_email ?? BLANK}</td>
                <td class="py-2 px-3">{row.actor_role ?? '—'}</td>
                <td class="py-2 px-3">{row.action === 'assume' ? 'Assume' : row.action === 'clear' ? 'Clear' : 'Action'}</td>
                <td class="py-2 px-3">{row.role_assumed ?? '—'}</td>
                <td class="py-2 px-3 text-gray-600 max-w-xs truncate" title={row.action_detail ?? ''}>{row.action_detail ?? '—'}</td>
                <td class="py-2 px-3 text-gray-500 text-xs">{row.ip_address ?? '—'}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Admin assume role pagination">
        <span class="text-gray-600">Page {adminPage}</span>
        <div class="flex gap-2">
          {adminPage > 1 && <a href={auditPageUrl('admin_page', adminPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
          {adminAssumedRoleLog.length === pageSize && <a href={auditPageUrl('admin_page', adminPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
        </div>
      </nav>
    </div>
  </section>
  )}

  <!-- PIM: elevated access requests (who elevated when, who dropped) -->
  <section aria-labelledby="pim-elevation-heading">
    <h2 id="pim-elevation-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">PIM: elevated access requests</h2>
    <p class="text-base text-gray-600 mb-3">When someone with an elevated role (Board, ARB, Admin) requested temporary elevated access or dropped it. All CRUD operations while elevated are covered by the other audit sections below.</p>
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
      {pimElevationLog.length === 0 ? (
        <p class="p-4 text-gray-500">No PIM elevation entries yet.</p>
      ) : (
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                <th class="text-left py-2 px-3 font-medium text-gray-700">Email</th>
                <th class="text-left py-2 px-3 font-medium text-gray-700">Role</th>
                <th class="text-left py-2 px-3 font-medium text-gray-700">Action</th>
                <th class="text-left py-2 px-3 font-medium text-gray-700">Expires at</th>
              </tr>
            </thead>
            <tbody>
              {pimElevationLog.map((row) => (
                <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                  <td class="py-2 px-3 text-gray-600">{formatDate(row.elevated_at)}</td>
                  <td class="py-2 px-3 font-mono text-sm">{row.email ?? BLANK}</td>
                  <td class="py-2 px-3">{row.role ?? BLANK}</td>
                  <td class="py-2 px-3">{row.action === 'elevate' ? 'Elevated' : 'Dropped'}</td>
                  <td class="py-2 px-3 text-gray-600">{row.expires_at ? formatDate(row.expires_at) : '—'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
      {pimElevationLog.length > 0 && (
        <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="PIM elevation pagination">
          <span class="text-gray-600">Page {pimPage}</span>
          <div class="flex gap-2">
            {pimPage > 1 && <a href={auditPageUrl('pim_page', pimPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
            {pimElevationLog.length === pageSize && <a href={auditPageUrl('pim_page', pimPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
          </div>
        </nav>
      )}
    </div>
  </section>

  <!-- Directory: contact reveal log -->
      <section aria-labelledby="dir-reveal-heading">
        <h2 id="dir-reveal-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Contact reveal log (directory)</h2>
        <p class="text-base text-gray-600 mb-3">Who viewed whose phone or email. Board, ARB, and Admin access is recorded here even when the member has opted out of sharing with other members. Target &quot;(full directory export)&quot; means the viewer downloaded the full member list (names, emails, phones) as CSV; one log entry per export.</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {directoryLogs.length === 0 ? (
            <p class="p-4 text-gray-500">No directory reveal entries yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Viewer</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Viewer role</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Target (whose info was revealed)</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Phone</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Email</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">IP</th>
                  </tr>
                </thead>
                <tbody>
                  {directoryLogs.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.timestamp)}</td>
                      <td class="py-2 px-3 font-mono text-sm">{row.viewer_email ?? BLANK}</td>
                      <td class="py-2 px-3">{row.viewer_role ?? BLANK}</td>
                      <td class="py-2 px-3">{row.target_name ?? BLANK}</td>
                      <td class="py-2 px-3 font-mono text-gray-500">{REDACTED}</td>
                      <td class="py-2 px-3 font-mono text-gray-500">{REDACTED}</td>
                      <td class="py-2 px-3 text-gray-500 text-xs">{row.ip_address ?? BLANK}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
          {directoryLogs.length > 0 && (
            <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Directory log pagination">
              <span class="text-gray-600">Page {directoryPage}</span>
              <div class="flex gap-2">
                {directoryPage > 1 && <a href={auditPageUrl('directory_page', directoryPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
                {directoryLogs.length === pageSize && <a href={auditPageUrl('directory_page', directoryPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
              </div>
            </nav>
          )}
        </div>
      </section>

      <!-- Who added which owner -->
      <section aria-labelledby="dir-added-heading">
        <h2 id="dir-added-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Directory: who added which owner</h2>
        <p class="text-base text-gray-600 mb-3">Owners added via the board directory (with recorded creator).</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {ownersWithCreator.length === 0 ? (
            <p class="p-4 text-gray-500">No directory add records (created_by_email) yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Owner (name / email)</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Added by</th>
                  </tr>
                </thead>
                <tbody>
                  {ownersWithCreator.map((o) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3">{o.name ?? BLANK} / {REDACTED}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- Who updated which owner -->
      <section aria-labelledby="dir-updated-heading">
        <h2 id="dir-updated-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Directory: who updated which owner</h2>
        <p class="text-base text-gray-600 mb-3">Last update by board (edit or CSV upload). Run the owners-updated-by migration to populate.</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {ownersWithUpdater.length === 0 ? (
            <p class="p-4 text-gray-500">No directory update records (updated_by) yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Updated at</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Owner (name / email)</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Updated by</th>
                  </tr>
                </thead>
                <tbody>
                  {ownersWithUpdater.slice(0, 300).map((o) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(o.updated_at ?? null)}</td>
                      <td class="py-2 px-3">{o.name ?? BLANK} / {REDACTED}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- Assessment payments recorded -->
      <section aria-labelledby="payments-audit-heading">
        <h2 id="payments-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Assessment payments recorded</h2>
        <p class="text-base text-gray-600 mb-3">Who recorded which payment (dues and special assessments). Only payments with a recorded-by value appear.</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {paymentAudit.length === 0 ? (
            <p class="p-4 text-gray-500">No payment records with recorded-by yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Owner</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Paid at</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Amount</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Method</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Check #</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Recorded by</th>
                  </tr>
                </thead>
                <tbody>
                  {paymentAudit.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                      <td class="py-2 px-3">{row.paid_at ?? BLANK}</td>
                      <td class="py-2 px-3">{row.amount != null ? `$${Number(row.amount).toFixed(2)}` : BLANK}</td>
                      <td class="py-2 px-3">{row.payment_method === 'electronic_transfer' ? 'E-transfer' : row.payment_method === 'check' ? 'Check' : row.payment_method === 'cash' ? 'Cash' : row.payment_method ?? BLANK}</td>
                      <td class="py-2 px-3">{row.check_number ?? BLANK}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
          {paymentAudit.length > 0 && (
            <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Payments pagination">
              <span class="text-gray-600">Page {paymentsPage}</span>
              <div class="flex gap-2">
                {paymentsPage > 1 && <a href={auditPageUrl('payments_page', paymentsPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
                {paymentAudit.length === pageSize && <a href={auditPageUrl('payments_page', paymentsPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
              </div>
            </nav>
          )}
        </div>
      </section>

      <!-- Vendor list: changes (create, update, delete) -->
      <section aria-labelledby="vendor-changes-heading">
        <h2 id="vendor-changes-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Vendor list: changes</h2>
        <p class="text-base text-gray-600 mb-3">Who created, updated, or deleted vendors (including vendors approved from member suggestions). Run the vendor-audit migration to enable.</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {vendorAuditLog.length === 0 ? (
            <p class="p-4 text-gray-500">No vendor change log yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Action</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Vendor (name)</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Vendor ID</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">By</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">IP</th>
                  </tr>
                </thead>
                <tbody>
                  {vendorAuditLog.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3">{row.action}</td>
                      <td class="py-2 px-3">{row.vendor_name ?? BLANK}</td>
                      <td class="py-2 px-3 font-mono text-gray-600">{row.vendor_id ?? BLANK}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                      <td class="py-2 px-3 text-gray-500 text-xs">{row.ip_address ?? BLANK}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
          {vendorAuditLog.length > 0 && (
            <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Vendor audit pagination">
              <span class="text-gray-600">Page {vendorPage}</span>
              <div class="flex gap-2">
                {vendorPage > 1 && <a href={auditPageUrl('vendor_page', vendorPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
                {vendorAuditLog.length === pageSize && <a href={auditPageUrl('vendor_page', vendorPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
              </div>
            </nav>
          )}
        </div>
      </section>

      <!-- Vendor submissions: approved/rejected -->
      <section aria-labelledby="vendor-audit-heading">
        <h2 id="vendor-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Vendor submissions: approved or rejected</h2>
        <p class="text-base text-gray-600 mb-3">Who reviewed member-suggested vendors (approved or rejected) and when.</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {vendorSubmissionsAudit.length === 0 ? (
            <p class="p-4 text-gray-500">No vendor approvals or rejections yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Reviewed at</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Vendor (name)</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Status</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Reviewed by</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Submitted by</th>
                  </tr>
                </thead>
                <tbody>
                  {vendorSubmissionsAudit.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.reviewed_at)}</td>
                      <td class="py-2 px-3">{row.name ?? BLANK}</td>
                      <td class="py-2 px-3">{row.status ?? BLANK}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- Member documents: uploads -->
      <section aria-labelledby="member-docs-audit-heading">
        <h2 id="member-docs-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Member documents: uploads</h2>
        <p class="text-base text-gray-600 mb-3">Who uploaded which member-only document (minutes, budgets, other).</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {memberDocsAudit.length === 0 ? (
            <p class="p-4 text-gray-500">No member document uploads yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Category</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Title</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Uploaded at</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Uploaded by</th>
                  </tr>
                </thead>
                <tbody>
                  {memberDocsAudit.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3">{row.category ?? BLANK}</td>
                      <td class="py-2 px-3">{row.title ?? BLANK}</td>
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.uploaded_at)}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- Special assessments: who created -->
      <section aria-labelledby="special-assessments-audit-heading">
        <h2 id="special-assessments-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Special assessments: who created</h2>
        <p class="text-base text-gray-600 mb-3">Who created which special assessment (owner, amount, due date).</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {specialAssessmentsAudit.length === 0 ? (
            <p class="p-4 text-gray-500">No special assessments yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Owner</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Description</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Amount</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created by</th>
                  </tr>
                </thead>
                <tbody>
                  {specialAssessmentsAudit.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                      <td class="py-2 px-3 max-w-xs truncate" title={row.description ?? undefined}>{row.description ?? BLANK}</td>
                      <td class="py-2 px-3">{row.amount != null ? `$${Number(row.amount).toFixed(2)}` : BLANK}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- Preapproval library: who created -->
      <section aria-labelledby="preapproval-audit-heading">
        <h2 id="preapproval-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Preapproval library: who created</h2>
        <p class="text-base text-gray-600 mb-3">Who added which preapproval item (category, title).</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {preapprovalAudit.length === 0 ? (
            <p class="p-4 text-gray-500">No preapproval items yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Category</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Title</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created by</th>
                  </tr>
                </thead>
                <tbody>
                  {preapprovalAudit.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3">{row.category ?? BLANK}</td>
                      <td class="py-2 px-3 max-w-xs truncate" title={row.title ?? undefined}>{row.title ?? BLANK}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- Feedback docs: who created -->
      <section aria-labelledby="feedback-docs-audit-heading">
        <h2 id="feedback-docs-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Feedback docs: who created</h2>
        <p class="text-base text-gray-600 mb-3">Who created which feedback/ballot document (title, deadline).</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {feedbackDocsAudit.length === 0 ? (
            <p class="p-4 text-gray-500">No feedback docs yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Title</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Deadline</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created by</th>
                  </tr>
                </thead>
                <tbody>
                  {feedbackDocsAudit.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3 max-w-xs truncate" title={row.title ?? undefined}>{row.title ?? BLANK}</td>
                      <td class="py-2 px-3">{row.deadline ?? BLANK}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- Meetings: who created -->
      <section aria-labelledby="meetings-audit-heading">
        <h2 id="meetings-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">Meetings: who created</h2>
        <p class="text-base text-gray-600 mb-3">Who created which meeting (title, date).</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {meetingsAudit.length === 0 ? (
            <p class="p-4 text-gray-500">No meetings yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Title</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Date & time</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Created by</th>
                  </tr>
                </thead>
                <tbody>
                  {meetingsAudit.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3 max-w-xs truncate" title={row.title ?? undefined}>{row.title ?? BLANK}</td>
                      <td class="py-2 px-3">{row.datetime ?? BLANK}</td>
                      <td class="py-2 px-3">{REDACTED}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      <!-- ARB audit log -->
      <section aria-labelledby="arb-audit-heading">
        <h2 id="arb-audit-heading" class="text-2xl font-heading font-semibold text-clr-green mb-3">ARB audit log</h2>
        <p class="text-base text-gray-600 mb-3">Status changes: who approved, sent back for requestor updates, etc.</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          {arbLogs.length === 0 ? (
            <p class="p-4 text-gray-500">No ARB audit entries yet.</p>
          ) : (
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Request</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Action</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Old &rarr; New status</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">By</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Notes</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">IP</th>
                  </tr>
                </thead>
                <tbody>
                  {arbLogs.map((row) => (
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3 font-mono">{row.request_id}</td>
                      <td class="py-2 px-3">{row.action}</td>
                      <td class="py-2 px-3">{row.old_status ?? BLANK} &rarr; {row.new_status ?? BLANK}</td>
                      <td class="py-2 px-3 font-mono text-sm">{row.changed_by_email ?? BLANK}{row.changed_by_role ? ` (${row.changed_by_role})` : ''}</td>
                      <td class="py-2 px-3 text-gray-600 max-w-xs truncate" title={row.notes ?? undefined}>{row.notes ?? BLANK}</td>
                      <td class="py-2 px-3 text-gray-500 text-xs">{row.ip_address ?? BLANK}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
          {arbLogs.length > 0 && (
            <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="ARB audit pagination">
              <span class="text-gray-600">Page {arbPage}</span>
              <div class="flex gap-2">
                {arbPage > 1 && <a href={auditPageUrl('arb_page', arbPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
                {arbLogs.length === pageSize && <a href={auditPageUrl('arb_page', arbPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
              </div>
            </nav>
          )}
        </div>
      </section>
  </PortalPage>
</PortalLayout>
