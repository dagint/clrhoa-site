---
export const prerender = false;

import { getBoardContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { isBoardOnly } from '../../lib/auth';
import { listVendors } from '../../lib/vendors-db';
import { listPendingSubmissions } from '../../lib/vendor-submissions-db';
import { escapeHtml } from '../../lib/sanitize';
import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';

import BoardNav from '../../components/BoardNav.astro';
const ctx = await getBoardContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;
const isBoardOrAdmin = isBoardOnly(effectiveRole) || effectiveRole === 'admin';

const VENDORS_PAGE_SIZES = [10, 25, 50, 100] as const;
const DEFAULT_VENDORS_PAGE_SIZE = 25;
const url = Astro.url;
const getPage = (): number => {
  const p = url.searchParams.get('page');
  const n = p ? parseInt(p, 10) : 1;
  return Number.isNaN(n) || n < 1 ? 1 : Math.min(n, 1000);
};
const getLimit = (): number => {
  const p = url.searchParams.get('limit');
  const n = p ? parseInt(p, 10) : DEFAULT_VENDORS_PAGE_SIZE;
  return VENDORS_PAGE_SIZES.includes(n as (typeof VENDORS_PAGE_SIZES)[number]) ? n : DEFAULT_VENDORS_PAGE_SIZE;
};
const page = getPage();
const pageSize = getLimit();

function vendorsPageUrl(value: number): string {
  const u = new URL(url);
  if (value <= 1) u.searchParams.delete('page');
  else u.searchParams.set('page', String(value));
  if (pageSize !== DEFAULT_VENDORS_PAGE_SIZE) u.searchParams.set('limit', String(pageSize));
  return u.pathname + u.search;
}

const db = env?.DB;
const { email, role, name } = session;
const badges = await getPortalBadgeCounts(db, email, role, name);
const vendorsList = db ? await listVendors(db, pageSize, (page - 1) * pageSize) : [];
const pendingSubmissions = db ? await listPendingSubmissions(db) : [];


/** Unique sorted categories from current vendors; always include "Other". */
const existingCategories = Array.from(
  new Set(
    vendorsList
      .map((v) => (v.category ?? '').trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
if (!existingCategories.includes('Other')) existingCategories.push('Other');

function parseFiles(filesJson: string | null): { name: string; key: string }[] {
  if (!filesJson) return [];
  try {
    const arr = JSON.parse(filesJson);
    if (!Array.isArray(arr)) return [];
    return arr.filter((f) => f && typeof f === 'object' && f.key).map((f) => ({ name: (f && f.name) ?? 'File', key: f.key }));
  } catch {
    return [];
  }
}
---

<PortalLayout title="Vendors | Board | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/board/vendors"
    pageTitle="Vendors"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
  >
    <BoardNav currentPath="/board/vendors" />

unt}
<div id="csrf-holder" class="hidden" data-csrf={escapeHtml(session.csrfToken ?? '')} aria-hidden="true"></div>
  <div id="vendors-message" class="hidden mb-4 p-4 rounded-xl border" role="status" aria-live="polite" aria-atomic="true"></div>
      {pendingSubmissions.length > 0 && (
        <section class="mb-8">
          <h2 class="text-3xl font-heading font-bold text-clr-green mb-3">Pending vendor suggestions</h2>
          <p class="text-base text-gray-600 mb-4">Members have suggested these vendors. Approve to add them to the list, or reject with an optional note.</p>
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <ul class="divide-y divide-gray-100">
              {pendingSubmissions.map((sub) => {
                const subFiles = parseFiles(sub.files);
                return (
                  <li class="p-4">
                    <div class="flex flex-wrap items-start justify-between gap-3">
                      <div>
                        <span class="font-medium text-gray-900">{sub.name ?? '-'}</span>
                        {sub.category && <span class="ml-2 text-sm text-gray-500">({sub.category})</span>}
                        {sub.phone && <div class="text-sm text-gray-600">{sub.phone}</div>}
                        {sub.email && <div class="text-sm text-gray-600">{sub.email}</div>}
                        {sub.website && (
                          <div class="text-sm text-gray-600"><a href={sub.website.startsWith('http') ? sub.website : `https://${sub.website}`} target="_blank" rel="noopener noreferrer" class="text-clr-green hover:underline">{sub.website}</a></div>
                        )}
                        {sub.notes && <p class="text-base text-gray-500 mt-1">{sub.notes}</p>}
                        {sub.submitted_by && <p class="text-xs text-gray-400 mt-1">Submitted by {sub.submitted_by}</p>}
                        {subFiles.length > 0 && (
                          <div class="mt-2 text-sm text-clr-green">
                            {subFiles.map((f) => {
                              return <a href={`/api/portal/file/${encodeURIComponent(f.key)}`} class="mr-2 hover:underline">{f.name}</a>;
                            })}
                          </div>
                        )}
                      </div>
                      <div class="flex flex-col sm:flex-row gap-2">
                        <button type="button" class="approve-submission-btn px-5 py-2.5 bg-clr-green text-white rounded-lg text-base font-medium hover:brightness-110" data-id={sub.id}>Approve</button>
                        <button type="button" class="reject-submission-btn px-5 py-2.5 bg-gray-200 text-gray-700 rounded-lg text-base font-medium hover:bg-gray-300" data-id={sub.id}>Reject</button>
                      </div>
                    </div>
                    <div class="reject-notes-wrap hidden mt-2" data-for={sub.id}>
                      <label class="block text-xs font-medium text-gray-500 mb-1">Rejection note (optional)</label>
                      <input type="text" class="reject-notes-input block w-full rounded border border-gray-200 px-2 py-1 text-sm" placeholder="e.g. Duplicate or not relevant" />
                      <button type="button" class="confirm-reject-btn mt-2 px-3 py-1 bg-red-100 text-red-700 rounded text-base" data-id={sub.id}>Confirm reject</button>
                    </div>
                  </li>
                );
              })}
            </ul>
          </div>
        </section>
      )}

      {isBoardOrAdmin && (
        <>
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8" aria-labelledby="upload-vendor-list-heading">
        <h2 id="upload-vendor-list-heading" class="text-3xl font-heading font-bold text-clr-green mb-3">Upload vendor list</h2>
        <p class="text-base text-gray-600 mb-4">Upload a CSV file to add many vendors at once. Columns: <strong>name</strong>, category, phone, email, website, notes. Optional: <strong>show_on_public</strong> (1 = public and portal, 0 = portal only). First row may be a header.</p>
        <div id="vendor-upload-message" class="hidden mb-4 p-4 rounded-xl border" role="status" aria-live="polite"></div>
        <form id="vendor-upload-csv-form" class="flex flex-wrap items-end gap-4">
          <input type="hidden" name="csrf_token" value={escapeHtml(session.csrfToken ?? '')} />
          <div>
            <label for="vendor-csv-file" class="block text-sm font-medium text-gray-700 mb-1">CSV file</label>
            <input type="file" id="vendor-csv-file" name="file" accept=".csv,text/csv,text/plain" class="block w-full text-sm text-gray-500 file:mr-4 file:rounded file:border-0 file:bg-clr-green file:px-4 file:py-2 file:text-white file:font-medium hover:file:brightness-110" />
          </div>
          <button type="submit" id="vendor-upload-csv-btn" class="px-5 py-2.5 bg-clr-green text-white rounded-lg font-medium hover:brightness-110">Upload CSV</button>
        </form>
        <p class="text-base text-gray-500 mt-3">
          <a href="/sample-vendor-list.csv" download class="text-clr-green hover:underline">Download sample CSV</a>
        </p>
      </section>

      <h2 class="text-2xl font-heading font-bold text-clr-green mb-6">Add or edit vendor</h2>

      <form id="vendor-form" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 space-y-4">
        <input type="hidden" name="action" id="form-action" value="create" />
        <input type="hidden" name="id" id="form-vendor-id" value="" />
        <input type="hidden" name="csrf_token" id="form-csrf" value={escapeHtml(session.csrfToken ?? '')} />
        <div>
          <label for="vendor-name" class="block text-sm font-medium text-gray-700">Name *</label>
          <input type="text" id="vendor-name" name="name" required class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
        </div>
        <div>
          <label for="vendor-category-select" class="block text-sm font-medium text-gray-700">Category</label>
          <div class="mt-1 flex flex-wrap items-center gap-2">
            <select id="vendor-category-select" name="category_select" class="rounded-lg border border-gray-200 px-3 py-2 min-w-[180px]" aria-label="Choose existing category or add new">
              {existingCategories.map((c) => (
                <option value={c}>{c}</option>
              ))}
              <option value="__new__">Add new category…</option>
            </select>
            <input type="text" id="vendor-category-new" name="category_new" placeholder="New category name" class="hidden rounded-lg border border-gray-200 px-3 py-2 w-48" aria-label="New category name" />
            <input type="hidden" id="vendor-category" name="category" value={existingCategories[0] ?? 'Other'} />
          </div>
        </div>
        <div>
          <label for="vendor-phone" class="block text-sm font-medium text-gray-700">Phone</label>
          <input type="text" id="vendor-phone" name="phone" class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
        </div>
        <div>
          <label for="vendor-email" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="vendor-email" name="email" class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
        </div>
        <div>
          <label for="vendor-website" class="block text-sm font-medium text-gray-700">Website (optional)</label>
          <input type="url" id="vendor-website" name="website" placeholder="https://example.com" class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
        </div>
        <div>
          <label for="vendor-notes" class="block text-sm font-medium text-gray-700">Notes</label>
          <textarea id="vendor-notes" name="notes" rows={3} class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2"></textarea>
        </div>
        <fieldset class="rounded-lg border border-gray-200 bg-gray-50/80 p-4" aria-describedby="vendor-visibility-desc">
          <legend class="text-sm font-medium text-gray-800">Visibility</legend>
          <p id="vendor-visibility-desc" class="sr-only">Choose whether this vendor appears on the public site, in the portal, or both.</p>
          <div class="mt-2 space-y-3">
            <label class="flex items-start gap-3 cursor-pointer">
              <input type="radio" name="show_on_public" id="vendor-show-public-portal" value="1" checked class="mt-0.5 rounded-full border-gray-300 text-clr-green focus:ring-clr-green" />
              <span class="text-sm">
                <span class="font-medium text-gray-800">Show on public & portal</span>
                <span class="block text-gray-600 mt-0.5">This vendor appears on the public Resources vendor page and in the member portal.</span>
              </span>
            </label>
            <label class="flex items-start gap-3 cursor-pointer">
              <input type="radio" name="show_on_public" id="vendor-show-portal-only" value="0" class="mt-0.5 rounded-full border-gray-300 text-clr-green focus:ring-clr-green" />
              <span class="text-sm">
                <span class="font-medium text-gray-800">Portal only</span>
                <span class="block text-gray-600 mt-0.5">This vendor appears only in the member portal (not on the public website).</span>
              </span>
            </label>
          </div>
        </fieldset>
        <div>
          <label class="block text-sm font-medium text-gray-700">Files (optional)</label>
          <input type="file" id="vendor-files" name="file_0" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:rounded file:border-0 file:bg-clr-green file:px-4 file:py-2 file:text-white file:font-medium hover:file:brightness-110" />
        </div>
        <div class="flex gap-3">
          <button type="submit" id="vendor-submit" class="px-5 py-2.5 bg-clr-green text-white rounded-lg font-medium hover:brightness-110">Create vendor</button>
          <button type="button" id="vendor-cancel-edit" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 hidden">Cancel edit</button>
        </div>
      </form>
        </>
      )}

      <h3 class="text-lg font-heading font-semibold text-clr-green mb-3">Current vendors — edit inline</h3>
      <p class="text-base text-gray-600 mb-4">Edit any cell and click <strong>Save</strong> on that row to update. Use the form above to add a new vendor.</p>
      {vendorsList.length === 0 && page === 1 ? (
        <p class="text-gray-500">No vendors yet. Add one above or upload a CSV.</p>
      ) : (
        <>
        <div class="flex flex-wrap items-center gap-2 mb-4">
          <label for="vendors-per-page" class="text-sm text-gray-600">Per page:</label>
          <select id="vendors-per-page" name="limit" class="rounded border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-700 focus:border-clr-green focus:outline-none focus:ring-1 focus:ring-clr-green" aria-label="Entries per page">
            {VENDORS_PAGE_SIZES.map((size) => (
              <option value={size} selected={pageSize === size}>{size}</option>
            ))}
          </select>
        </div>
        <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white">
          <table class="vendors-table w-full text-sm border-collapse" aria-label="Vendor list editable by row">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Name</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Category</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Phone</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Email</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Website</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 min-w-[100px]">Notes</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Visibility</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Files</th>
                <th class="text-left py-2 px-2 font-medium text-gray-700 whitespace-nowrap">Actions</th>
              </tr>
            </thead>
            <tbody>
              {vendorsList.map((v) => {
                const files = parseFiles(v.files);
                const catInList = existingCategories.includes((v.category ?? '').trim());
                return (
                  <tr class="vendor-row border-b border-gray-100 hover:bg-gray-50/50" data-vendor-id={v.id}>
                    <td class="py-1.5 px-2 align-top">
                      <input type="text" class="row-input row-name w-full min-w-[120px] rounded border border-gray-200 px-2 py-1" value={v.name ?? ''} data-original={v.name ?? ''} />
                    </td>
                    <td class="py-1.5 px-2 align-top">
                      <div class="row-category-wrap flex flex-wrap items-center gap-1">
                        <select class="row-category-select rounded border border-gray-200 px-2 py-1 min-w-[120px]" data-vendor-id={v.id} aria-label="Category">
                          {existingCategories.map((c) => (
                            <option value={c} selected={c === (v.category ?? '').trim()}>{c}</option>
                          ))}
                          <option value="__new__" selected={!catInList && Boolean((v.category ?? '').trim())}>Add new…</option>
                        </select>
                        <input type="text" class="row-category-new hidden rounded border border-gray-200 px-2 py-1 w-32" placeholder="New category" value={catInList ? '' : (v.category ?? '')} data-vendor-id={v.id} aria-label="New category name" />
                      </div>
                    </td>
                    <td class="py-1.5 px-2 align-top">
                      <input type="text" class="row-input row-phone w-full min-w-[100px] rounded border border-gray-200 px-2 py-1" value={v.phone ?? ''} />
                    </td>
                    <td class="py-1.5 px-2 align-top">
                      <input type="text" class="row-input row-email w-full min-w-[140px] rounded border border-gray-200 px-2 py-1" value={v.email ?? ''} />
                    </td>
                    <td class="py-1.5 px-2 align-top">
                      <input type="text" class="row-input row-website w-full min-w-[140px] rounded border border-gray-200 px-2 py-1" value={v.website ?? ''} placeholder="https://" />
                    </td>
                    <td class="py-1.5 px-2 align-top">
                      <input type="text" class="row-input row-notes w-full min-w-[100px] rounded border border-gray-200 px-2 py-1" value={v.notes ?? ''} />
                    </td>
                    <td class="py-1.5 px-2 align-top">
                      <select class="row-input row-show rounded border border-gray-200 px-2 py-1" data-vendor-id={v.id} aria-label="Visibility">
                        <option value="1" selected={v.show_on_public === 1}>Public & portal</option>
                        <option value="0" selected={v.show_on_public === 0}>Portal only</option>
                      </select>
                    </td>
                    <td class="py-1.5 px-2 align-top">
                      {files.length > 0 ? (
                        <span class="text-clr-green text-xs">
                          {files.map((f) => {
                            return <a href={`/api/portal/file/${encodeURIComponent(f.key)}`} class="hover:underline" target="_blank" rel="noopener noreferrer">{f.name}</a>;
                          })}
                        </span>
                      ) : (
                        <span class="text-gray-400">—</span>
                      )}
                    </td>
                    <td class="py-1.5 px-2 align-top whitespace-nowrap">
                      <button type="button" class="save-row-btn px-2 py-1 bg-clr-green text-white rounded text-xs font-medium hover:brightness-110" data-vendor-id={v.id}>Save</button>
                      <button type="button" class="edit-vendor-btn px-2 py-1 text-clr-green hover:underline text-xs" data-id={v.id} data-name={v.name ?? ''} data-category={v.category ?? ''} data-phone={v.phone ?? ''} data-email={v.email ?? ''} data-website={v.website ?? ''} data-notes={v.notes ?? ''} data-show-on-public={String(v.show_on_public ? 1 : 0)} title="Fill form above">Form</button>
                      <button type="button" class="delete-vendor-btn px-2 py-1 text-red-600 hover:underline text-xs" data-id={v.id}>Delete</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        {vendorsList.length > 0 && (
          <nav class="flex items-center justify-between gap-2 py-2 px-3 mt-4 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Vendors pagination">
            <span class="text-gray-600">Page {page}</span>
            <div class="flex gap-2">
              {page > 1 && <a href={vendorsPageUrl(page - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
              {vendorsList.length === pageSize && <a href={vendorsPageUrl(page + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
            </div>
          </nav>
        )}
        </>
      )}
  <script is:inline>
    document.getElementById('vendors-per-page')?.addEventListener('change', function () {
      const limit = this.value;
      const u = new URL(window.location.href);
      u.searchParams.set('limit', limit);
      u.searchParams.delete('page');
      if (limit === '25') u.searchParams.delete('limit');
      window.location.href = u.pathname + u.search;
    });
  </script>
  <script is:inline define:vars={{ existingCategories: existingCategories }}>
    (function () {
      if (typeof window === 'undefined') return;
      var csrfHolder = document.getElementById('csrf-holder');
      var csrfToken = (csrfHolder && csrfHolder.getAttribute('data-csrf')) || '';
      window.csrfToken = csrfToken;

      const form = document.getElementById('vendor-form');
      const actionInput = document.getElementById('form-action');
      const idInput = document.getElementById('form-vendor-id');
      const nameInput = document.getElementById('vendor-name');
      const categorySelect = document.getElementById('vendor-category-select');
      const categoryNewInput = document.getElementById('vendor-category-new');
      const categoryInput = document.getElementById('vendor-category');
      const phoneInput = document.getElementById('vendor-phone');
      const emailInput = document.getElementById('vendor-email');
      const websiteInput = document.getElementById('vendor-website');
      const notesInput = document.getElementById('vendor-notes');
      const fileInput = document.getElementById('vendor-files');
      const submitBtn = document.getElementById('vendor-submit');
      const cancelBtn = document.getElementById('vendor-cancel-edit');
      const csrfInput = document.getElementById('form-csrf');
      const radioPublicPortal = document.getElementById('vendor-show-public-portal');
      const radioPortalOnly = document.getElementById('vendor-show-portal-only');

      function setFormCreate() {
        actionInput.value = 'create';
        idInput.value = '';
        nameInput.value = '';
        if (categorySelect) categorySelect.value = existingCategories[0] || 'Other';
        if (categoryNewInput) { categoryNewInput.value = ''; categoryNewInput.classList.add('hidden'); }
        if (categoryInput) categoryInput.value = existingCategories[0] || 'Other';
        phoneInput.value = '';
        emailInput.value = '';
        if (websiteInput) websiteInput.value = '';
        notesInput.value = '';
        if (radioPublicPortal) radioPublicPortal.checked = true;
        if (radioPortalOnly) radioPortalOnly.checked = false;
        if (fileInput) fileInput.value = '';
        submitBtn.textContent = 'Create vendor';
        cancelBtn.classList.add('hidden');
      }

      function syncFormCategoryFromSelect() {
        var sel = categorySelect && categorySelect.value;
        if (sel === '__new__') {
          if (categoryNewInput) { categoryNewInput.classList.remove('hidden'); categoryInput.value = categoryNewInput.value.trim() || ''; }
        } else {
          if (categoryNewInput) categoryNewInput.classList.add('hidden');
          if (categoryInput) categoryInput.value = sel || '';
        }
      }
      if (categorySelect) {
        categorySelect.addEventListener('change', function () {
          var sel = this.value;
          if (categoryNewInput) {
            if (sel === '__new__') { categoryNewInput.classList.remove('hidden'); categoryNewInput.focus(); }
            else categoryNewInput.classList.add('hidden');
          }
          if (categoryInput) categoryInput.value = sel === '__new__' ? (categoryNewInput && categoryNewInput.value.trim()) || '' : sel;
        });
      }
      if (categoryNewInput) {
        categoryNewInput.addEventListener('input', function () { if (categoryInput) categoryInput.value = this.value.trim(); });
      }
      if (form) form.addEventListener('submit', function () { syncFormCategoryFromSelect(); });

      document.querySelectorAll('.edit-vendor-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          const name = this.getAttribute('data-name') ?? '';
          const category = this.getAttribute('data-category') ?? '';
          const phone = this.getAttribute('data-phone') ?? '';
          const email = this.getAttribute('data-email') ?? '';
          const website = this.getAttribute('data-website') ?? '';
          const notes = this.getAttribute('data-notes') ?? '';
          const showOnPublic = this.getAttribute('data-show-on-public') === '1';
          actionInput.value = 'update';
          idInput.value = id || '';
          nameInput.value = name;
          var catInList = existingCategories.indexOf(category) >= 0;
          if (categorySelect) categorySelect.value = catInList ? category : '__new__';
          if (categoryNewInput) { categoryNewInput.value = catInList ? '' : category; categoryNewInput.classList.toggle('hidden', catInList); }
          if (categoryInput) categoryInput.value = category;
          phoneInput.value = phone;
          emailInput.value = email;
          if (websiteInput) websiteInput.value = website;
          notesInput.value = notes;
          if (radioPublicPortal) radioPublicPortal.checked = showOnPublic;
          if (radioPortalOnly) radioPortalOnly.checked = !showOnPublic;
          submitBtn.textContent = 'Update vendor';
          cancelBtn.classList.remove('hidden');
        });
      });

      if (cancelBtn) {
        cancelBtn.addEventListener('click', setFormCreate);
      }

      const msgEl = document.getElementById('vendors-message');
      function showVendorsMessage(text, isError) {
        if (!msgEl) return;
        msgEl.textContent = text;
        msgEl.className = 'mb-4 p-4 rounded-xl border ' + (isError ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800');
        msgEl.classList.remove('hidden');
      }
      function clearVendorsMessage() { if (msgEl) { msgEl.textContent = ''; msgEl.classList.add('hidden'); } }

      var uploadForm = document.getElementById('vendor-upload-csv-form');
      var uploadMsg = document.getElementById('vendor-upload-message');
      var uploadBtn = document.getElementById('vendor-upload-csv-btn');
      var csvFileInput = document.getElementById('vendor-csv-file');
      function showUploadMessage(text, isError) {
        if (!uploadMsg) return;
        uploadMsg.textContent = text;
        uploadMsg.className = 'mb-4 p-4 rounded-xl border ' + (isError ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800');
        uploadMsg.classList.remove('hidden');
      }
      if (uploadForm && uploadBtn && csvFileInput) {
        uploadForm.addEventListener('submit', async function (e) {
          e.preventDefault();
          if (!csvFileInput.files || csvFileInput.files.length === 0) {
            showUploadMessage('Please select a CSV file.', true);
            return;
          }
          var fd = new FormData(uploadForm);
          fd.set('file', csvFileInput.files[0]);
          uploadBtn.disabled = true;
          uploadBtn.setAttribute('aria-busy', 'true');
          if (uploadMsg) uploadMsg.classList.add('hidden');
          try {
            var res = await fetch('/api/vendors/upload-csv', { method: 'POST', body: fd });
            var data = await res.json();
            if (res.ok && data.success) {
              var msg = data.added === 0 ? (data.message || 'No new vendors added.') : 'Added ' + data.added + ' vendor(s).';
              if (data.errors && data.errors.length) msg += ' Some rows had errors: ' + data.errors.slice(0, 3).join('; ');
              showUploadMessage(msg, false);
              if (data.added > 0) setTimeout(function () { window.location.reload(); }, 2000);
            } else {
              showUploadMessage(data.error || 'Upload failed', true);
            }
          } catch (err) {
            showUploadMessage('Network error. Try again.', true);
          } finally {
            uploadBtn.disabled = false;
            uploadBtn.removeAttribute('aria-busy');
          }
        });
      }

      document.querySelectorAll('.row-category-select').forEach(function (sel) {
        sel.addEventListener('change', function () {
          var row = this.closest('.vendor-row');
          var newInput = row ? row.querySelector('.row-category-new') : null;
          if (newInput) newInput.classList.toggle('hidden', this.value !== '__new__');
        });
      });
      document.querySelectorAll('.vendor-row').forEach(function (row) {
        var sel = row.querySelector('.row-category-select');
        if (sel && sel.value === '__new__') {
          var newInput = row.querySelector('.row-category-new');
          if (newInput) newInput.classList.remove('hidden');
        }
      });

      document.querySelectorAll('.save-row-btn').forEach(function (btn) {
        btn.addEventListener('click', async function () {
          var row = this.closest('.vendor-row');
          if (!row) return;
          var id = row.getAttribute('data-vendor-id');
          if (!id) return;
          var nameEl = row.querySelector('.row-name');
          var catSelect = row.querySelector('.row-category-select');
          var catNew = row.querySelector('.row-category-new');
          var phoneEl = row.querySelector('.row-phone');
          var emailEl = row.querySelector('.row-email');
          var websiteEl = row.querySelector('.row-website');
          var notesEl = row.querySelector('.row-notes');
          var showEl = row.querySelector('.row-show');
          var category = (catSelect && catSelect.value === '__new__' && catNew) ? (catNew.value || '').trim() : (catSelect ? catSelect.value : '');
          if (!category) category = 'Other';
          var fd = new FormData();
          fd.set('action', 'update');
          fd.set('id', id);
          fd.set('csrf_token', (csrfInput && csrfInput.value) || csrfToken || '');
          fd.set('name', (nameEl && nameEl.value) || '');
          fd.set('category', category);
          fd.set('phone', (phoneEl && phoneEl.value) || '');
          fd.set('email', (emailEl && emailEl.value) || '');
          fd.set('website', (websiteEl && websiteEl.value) || '');
          fd.set('notes', (notesEl && notesEl.value) || '');
          fd.set('show_on_public', (showEl && showEl.value) || '1');
          clearVendorsMessage();
          var b = this; b.disabled = true; b.setAttribute('aria-busy', 'true');
          try {
            var res = await fetch('/api/vendors', { method: 'PUT', body: fd });
            var data = await res.json();
            if (res.ok && data.success) {
              showVendorsMessage('Vendor updated.', false);
              b.textContent = 'Saved';
              setTimeout(function () { b.textContent = 'Save'; }, 2000);
            } else {
              showVendorsMessage(data.error || 'Update failed', true);
            }
          } catch (err) {
            showVendorsMessage('Network error. Try again.', true);
          } finally {
            b.disabled = false; b.removeAttribute('aria-busy');
          }
        });
      });

      document.querySelectorAll('.delete-vendor-btn').forEach((btn) => {
        btn.addEventListener('click', async function () {
          const id = this.getAttribute('data-id');
          if (!id || !confirm('Delete this vendor?')) return;
          clearVendorsMessage();
          const token = (csrfInput && csrfInput.value) || csrfToken || '';
          const b = this; b.disabled = true; b.setAttribute('aria-busy', 'true');
          try {
            const res = await fetch('/api/vendors', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, csrf_token: token }),
            });
            const data = await res.json();
            if (res.ok && data.success) {
              showVendorsMessage('Vendor removed.', false);
              var row = this.closest('.vendor-row');
              if (row) row.remove();
              else setTimeout(function () { window.location.reload(); }, 1500);
            } else {
              showVendorsMessage(data.error || 'Delete failed', true);
            }
          } catch (err) {
            showVendorsMessage('Network error. Try again.', true);
          } finally {
            b.disabled = false; b.removeAttribute('aria-busy');
          }
        });
      });

      const token = (csrfInput && csrfInput.value) || csrfToken || '';
      document.querySelectorAll('.approve-submission-btn').forEach((btn) => {
        btn.addEventListener('click', async function () {
          const id = this.getAttribute('data-id');
          if (!id || !confirm('Add this vendor to the recommended list?')) return;
          clearVendorsMessage();
          const b = this; b.disabled = true; b.setAttribute('aria-busy', 'true');
          try {
            const res = await fetch('/api/vendor-submissions', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, action: 'approve', csrf_token: token }),
            });
            const data = await res.json();
            if (res.ok && data.success) {
              showVendorsMessage('Vendor approved and added to the list.', false);
              setTimeout(function () { window.location.reload(); }, 1500);
            } else {
              showVendorsMessage(data.error || 'Approve failed', true);
            }
          } catch (err) {
            showVendorsMessage('Network error. Try again.', true);
          } finally {
            b.disabled = false; b.removeAttribute('aria-busy');
          }
        });
      });
      document.querySelectorAll('.reject-submission-btn').forEach((btn) => {
        btn.addEventListener('click', function () {
          const id = this.getAttribute('data-id');
          if (!id) return;
          const wrap = document.querySelector('.reject-notes-wrap[data-for="' + (typeof CSS !== 'undefined' && CSS.escape ? CSS.escape(id) : id) + '"]');
          wrap?.classList.toggle('hidden');
        });
      });
      document.querySelectorAll('.confirm-reject-btn').forEach((btn) => {
        btn.addEventListener('click', async function () {
          const id = this.getAttribute('data-id');
          if (!id) return;
          clearVendorsMessage();
          const b = this; b.disabled = true; b.setAttribute('aria-busy', 'true');
          try {
            const wrap = document.querySelector('.reject-notes-wrap[data-for="' + (typeof CSS !== 'undefined' && CSS.escape ? CSS.escape(id) : id) + '"]');
            const notesEl = wrap ? wrap.querySelector('.reject-notes-input') : null;
            const reviewNotes = (notesEl && notesEl.value) ? notesEl.value.trim() : null;
            const res = await fetch('/api/vendor-submissions', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, action: 'reject', review_notes: reviewNotes, csrf_token: token }),
            });
            const data = await res.json();
            if (res.ok && data.success) {
              showVendorsMessage('Suggestion rejected.', false);
              setTimeout(function () { window.location.reload(); }, 1500);
            } else {
              showVendorsMessage(data.error || 'Reject failed', true);
            }
          } catch (err) {
            showVendorsMessage('Network error. Try again.', true);
          } finally {
            b.disabled = false; b.removeAttribute('aria-busy');
          }
        });
      });

      form?.addEventListener('submit', async function (e) {
        e.preventDefault();
        clearVendorsMessage();
        const token = (csrfInput && csrfInput.value) || csrfToken || '';
        const formData = new FormData(form);
        formData.set('csrf_token', token);
        if (actionInput.value === 'update' && idInput.value) {
          formData.set('id', idInput.value);
        }
        // Append multiple files as file_0, file_1, ...
        if (fileInput?.files?.length) {
          for (let i = 0; i < fileInput.files.length; i++) {
            const file = fileInput.files[i];
            if (file) formData.set('file_' + i, file);
          }
        }
        const method = actionInput.value === 'update' ? 'PUT' : 'POST';
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');
        try {
          const res = await fetch('/api/vendors', { method, body: formData });
          const data = await res.json();
          if (res.ok && data.success) {
            showVendorsMessage(actionInput.value === 'update' ? 'Vendor updated.' : 'Vendor added.', false);
            setTimeout(function () { window.location.reload(); }, 1500);
          } else {
            showVendorsMessage(data.error || 'Request failed', true);
          }
        } catch (err) {
          showVendorsMessage('Network error. Try again.', true);
        } finally {
          submitBtn.disabled = false;
          submitBtn.removeAttribute('aria-busy');
        }
      });
    })();
  </script>
  </PortalPage>
</PortalLayout>
