---
export const prerender = false;

import { getBoardContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { isBoardOnly } from '../../lib/auth';
import { listAllMaintenance, parsePhotosJson } from '../../lib/maintenance-db';
import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';

import BoardNav from '../../components/BoardNav.astro';
const ctx = await getBoardContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;
const isBoard = isBoardOnly(effectiveRole) || effectiveRole === 'admin';

if (!isBoard) return Astro.redirect('/portal/dashboard');

const db = env?.DB;
const { email, role, name } = session;
const badges = await getPortalBadgeCounts(db, email, role, name);

const MAINTENANCE_PAGE_SIZES = [10, 25, 50, 100] as const;
const DEFAULT_MAINTENANCE_PAGE_SIZE = 25;
const url = Astro.url;
const statusFilter = (url.searchParams.get('status') as 'reported' | 'in_progress' | 'completed') || undefined;
const getPage = (): number => {
  const p = url.searchParams.get('page');
  const n = p ? parseInt(p, 10) : 1;
  return Number.isNaN(n) || n < 1 ? 1 : Math.min(n, 1000);
};
const getLimit = (): number => {
  const p = url.searchParams.get('limit');
  const n = p ? parseInt(p, 10) : DEFAULT_MAINTENANCE_PAGE_SIZE;
  return MAINTENANCE_PAGE_SIZES.includes(n as (typeof MAINTENANCE_PAGE_SIZES)[number]) ? n : DEFAULT_MAINTENANCE_PAGE_SIZE;
};
const page = getPage();
const pageSize = getLimit();

function maintenancePageUrl(value: number): string {
  const u = new URL(url);
  if (value <= 1) u.searchParams.delete('page');
  else u.searchParams.set('page', String(value));
  if (pageSize !== DEFAULT_MAINTENANCE_PAGE_SIZE) u.searchParams.set('limit', String(pageSize));
  if (statusFilter) u.searchParams.set('status', statusFilter);
  return u.pathname + u.search;
}

const allRequests = db ? await listAllMaintenance(db, statusFilter, pageSize, (page - 1) * pageSize) : [];

function formatDate(s: string): string {
  try {
    return new Date(s).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch {
    return s;
  }
}

function categoryLabel(cat: string): string {
  return cat === 'general' ? 'General' : cat.charAt(0).toUpperCase() + cat.slice(1);
}
---

<PortalLayout title="Maintenance | Board | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/board/maintenance"
    pageTitle="Maintenance"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
  >
    <BoardNav currentPath="/board/maintenance" />

unt}
<h2 class="text-3xl font-heading font-bold text-clr-green mb-4">Maintenance requests</h2>
      <div class="flex flex-wrap gap-2 mb-6">
        <a
          href="/board/maintenance"
          class={`px-5 py-2.5 rounded-lg text-sm font-medium ${!statusFilter ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          All
        </a>
        <a
          href="/board/maintenance?status=reported"
          class={`px-5 py-2.5 rounded-lg text-sm font-medium ${statusFilter === 'reported' ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          Reported
        </a>
        <a
          href="/board/maintenance?status=in_progress"
          class={`px-5 py-2.5 rounded-lg text-sm font-medium ${statusFilter === 'in_progress' ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          In progress
        </a>
        <a
          href="/board/maintenance?status=completed"
          class={`px-5 py-2.5 rounded-lg text-sm font-medium ${statusFilter === 'completed' ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          Completed
        </a>
      </div>

      {allRequests.length === 0 && page === 1 ? (
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center text-gray-500">
          No requests {statusFilter ? `with status "${statusFilter}"` : ''}.
        </div>
      ) : (
        <>
        <div class="flex flex-wrap items-center gap-2 mb-4">
          <label for="maintenance-per-page" class="text-sm text-gray-600">Per page:</label>
          <select id="maintenance-per-page" name="limit" class="rounded border border-gray-300 bg-white px-2 py-1.5 text-sm text-gray-700 focus:border-clr-green focus:outline-none focus:ring-1 focus:ring-clr-green" aria-label="Entries per page">
            {MAINTENANCE_PAGE_SIZES.map((size) => (
              <option value={size} selected={pageSize === size}>{size}</option>
            ))}
          </select>
        </div>
        <script is:inline>
          document.getElementById('maintenance-per-page')?.addEventListener('change', function () {
            const limit = this.value;
            const u = new URL(window.location.href);
            u.searchParams.set('limit', limit);
            u.searchParams.delete('page');
            if (limit === '25') u.searchParams.delete('limit');
            window.location.href = u.pathname + u.search;
          });
        </script>
        <ul class="space-y-4">
          {allRequests.map((r) => {
            const photos = parsePhotosJson(r.photos);
            return (
              <li class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                <div class="flex flex-wrap justify-between gap-3">
                  <div>
                    <span class="font-medium text-clr-green">{categoryLabel(r.category)}</span>
                    <span class="text-sm text-gray-500 ml-2">{formatDate(r.created)}</span>
                    <span class="ml-2 text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-700">
                      {r.owner_email}
                    </span>
                  </div>
                  <div class="flex items-center gap-2">
                    <select
                      class="status-select rounded-lg border border-gray-200 px-2 py-1 text-sm"
                      data-id={r.id}
                    >
                      <option value="reported" selected={r.status === 'reported'}>reported</option>
                      <option value="in_progress" selected={r.status === 'in_progress'}>in_progress</option>
                      <option value="completed" selected={r.status === 'completed'}>completed</option>
                    </select>
                    <input
                      type="text"
                      class="vendor-input w-32 rounded-lg border border-gray-200 px-2 py-1 text-sm"
                      placeholder="Vendor"
                      data-id={r.id}
                      value={r.vendor_assigned ?? ''}
                    />
                    <button
                      type="button"
                      class="save-maint text-base text-clr-green hover:underline"
                      data-id={r.id}
                    >
                      Save
                    </button>
                  </div>
                </div>
                <p class="text-gray-600 text-base mt-2">{r.description}</p>
                {photos.length > 0 && (
                  <div class="flex flex-wrap gap-2 mt-2">
                    {photos.slice(0, 5).map((key) => (
                      <a
                        href={`/api/portal/file/${encodeURIComponent(key)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-sm text-clr-green hover:underline"
                      >
                        View photo
                      </a>
                    ))}
                  </div>
                )}
              </li>
            );
          })}
        </ul>
        {allRequests.length > 0 && (
          <nav class="flex items-center justify-between gap-2 py-2 px-3 mt-4 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Maintenance pagination">
            <span class="text-gray-600">Page {page}</span>
            <div class="flex gap-2">
              {page > 1 && <a href={maintenancePageUrl(page - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
              {allRequests.length === pageSize && <a href={maintenancePageUrl(page + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
            </div>
          </nav>
        )}
        </>
      )}

<script is:inline>
  document.querySelectorAll('.save-maint').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      if (!id) return;
      const row = btn.closest('li');
      const statusSelect = row?.querySelector('.status-select');
      const vendorInput = row?.querySelector('.vendor-input');
      const status = statusSelect?.value ?? 'reported';
      const vendor_assigned = vendorInput?.value.trim() ?? '';

      try {
        const res = await fetch('/api/maintenance-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, status, vendor_assigned }),
          credentials: 'same-origin',
        });
        const data = await res.json();
        if (data.success) window.location.reload();
        else alert(data.error || 'Failed to update');
      } catch {
        alert('Network error');
      }
    });
  });
</script>
  </PortalPage>
</PortalLayout>
