---
export const prerender = false;

import BoardLayout from '../../layouts/BoardLayout.astro';
import { getBoardContext } from '../../lib/board-context';
import { listAllMaintenance, parsePhotosJson } from '../../lib/maintenance-db';
import { listArbRequestsByHousehold } from '../../lib/arb-db';

const ctx = await getBoardContext(Astro);
if (ctx.redirect) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;
const isBoard = effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board';
if (!isBoard) return Astro.redirect('/portal/dashboard');

const db = env?.DB;
const statusFilter = (Astro.url.searchParams.get('status') as 'reported' | 'in_progress' | 'completed') || undefined;
const allRequests = db ? await listAllMaintenance(db, statusFilter) : [];
const allArbRequests = db ? await listArbRequestsByHousehold(db, session.email) : [];
const draftCount = allArbRequests.filter((r) => r.status === 'pending').length;

function formatDate(s: string): string {
  try {
    return new Date(s).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch {
    return s;
  }
}

function categoryLabel(cat: string): string {
  return cat === 'general' ? 'General' : cat.charAt(0).toUpperCase() + cat.slice(1);
}
---

<BoardLayout title="Maintenance" subtitle="Manage maintenance requests" draftCount={draftCount} role={effectiveRole} session={session} elevatedUntil={session.elevated_until}>
  <h2 class="text-xl font-heading font-bold text-clr-green mb-4">Maintenance requests</h2>
      <div class="flex flex-wrap gap-2 mb-6">
        <a
          href="/board/maintenance"
          class={`px-3 py-1.5 rounded-lg text-sm font-medium ${!statusFilter ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          All
        </a>
        <a
          href="/board/maintenance?status=reported"
          class={`px-3 py-1.5 rounded-lg text-sm font-medium ${statusFilter === 'reported' ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          Reported
        </a>
        <a
          href="/board/maintenance?status=in_progress"
          class={`px-3 py-1.5 rounded-lg text-sm font-medium ${statusFilter === 'in_progress' ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          In progress
        </a>
        <a
          href="/board/maintenance?status=completed"
          class={`px-3 py-1.5 rounded-lg text-sm font-medium ${statusFilter === 'completed' ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
        >
          Completed
        </a>
      </div>

      {allRequests.length === 0 ? (
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center text-gray-500">
          No requests {statusFilter ? `with status "${statusFilter}"` : ''}.
        </div>
      ) : (
        <ul class="space-y-4">
          {allRequests.map((r) => {
            const photos = parsePhotosJson(r.photos);
            return (
              <li class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                <div class="flex flex-wrap justify-between gap-3">
                  <div>
                    <span class="font-medium text-clr-green">{categoryLabel(r.category)}</span>
                    <span class="text-sm text-gray-500 ml-2">{formatDate(r.created)}</span>
                    <span class="ml-2 text-xs font-medium px-2 py-0.5 rounded bg-gray-100 text-gray-700">
                      {r.owner_email}
                    </span>
                  </div>
                  <div class="flex items-center gap-2">
                    <select
                      class="status-select rounded-lg border border-gray-200 px-2 py-1 text-sm"
                      data-id={r.id}
                    >
                      <option value="reported" selected={r.status === 'reported'}>reported</option>
                      <option value="in_progress" selected={r.status === 'in_progress'}>in_progress</option>
                      <option value="completed" selected={r.status === 'completed'}>completed</option>
                    </select>
                    <input
                      type="text"
                      class="vendor-input w-32 rounded-lg border border-gray-200 px-2 py-1 text-sm"
                      placeholder="Vendor"
                      data-id={r.id}
                      value={r.vendor_assigned ?? ''}
                    />
                    <button
                      type="button"
                      class="save-maint text-sm text-clr-green hover:underline"
                      data-id={r.id}
                    >
                      Save
                    </button>
                  </div>
                </div>
                <p class="text-gray-600 text-sm mt-2">{r.description}</p>
                {photos.length > 0 && (
                  <div class="flex flex-wrap gap-2 mt-2">
                    {photos.slice(0, 5).map((key) => (
                      <a
                        href={`/api/portal/file/${encodeURIComponent(key)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-sm text-clr-green hover:underline"
                      >
                        View photo
                      </a>
                    ))}
                  </div>
                )}
              </li>
            );
          })}
        </ul>
      )}

<script>
  document.querySelectorAll('.save-maint').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const id = (btn as HTMLElement).dataset.id;
      if (!id) return;
      const row = btn.closest('li');
      const statusSelect = row?.querySelector('.status-select') as HTMLSelectElement;
      const vendorInput = row?.querySelector('.vendor-input') as HTMLInputElement;
      const status = statusSelect?.value ?? 'reported';
      const vendor_assigned = vendorInput?.value.trim() ?? '';

      try {
        const res = await fetch('/api/maintenance-update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, status, vendor_assigned }),
          credentials: 'same-origin',
        });
        const data = await res.json();
        if (data.success) window.location.reload();
        else alert(data.error || 'Failed to update');
      } catch {
        alert('Network error');
      }
    });
  });
</script>
</BoardLayout>