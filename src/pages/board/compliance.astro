---
export const prerender = false;

import { getBoardContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { isBoardOnly } from '../../lib/auth';
import { getComplianceStatus } from '../../lib/compliance-db';
import { getUpcomingMeetingsWithCompliance, formatAdvanceNotice } from '../../lib/meeting-compliance';
import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';

import BoardNav from '../../components/BoardNav.astro';
const ctx = await getBoardContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;

const isBoard = isBoardOnly(effectiveRole) || effectiveRole === 'admin';
if (!isBoard) return Astro.redirect('/portal/dashboard');

const db = env?.DB;
const { email, role, name } = session;
const badges = await getPortalBadgeCounts(db, email, role, name);

const complianceData = db ? await getComplianceStatus(db) : null;
const upcomingMeetings = db ? await getUpcomingMeetingsWithCompliance(db, 5) : [];

// Filter by status if specified
const statusFilter = Astro.url.searchParams.get('status')?.toUpperCase();
const validStatuses = ['COMPLIANT', 'PARTIAL', 'MISSING'];
const filteredStatuses = statusFilter && validStatuses.includes(statusFilter)
  ? complianceData?.statuses.filter((s) => s.status === statusFilter)
  : complianceData?.statuses;

// Get items needing immediate action (PARTIAL status)
const actionRequired = complianceData?.statuses.filter((s) => s.status === 'PARTIAL') ?? [];

// Calculate days until year-end for annual update context
const now = new Date();
const yearEnd = new Date(now.getFullYear(), 11, 31);
const daysUntilYearEnd = Math.ceil((yearEnd.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

function formatDate(s: string | null): string {
  if (!s) return '‚Äî';
  try {
    return new Date(s).toLocaleString(undefined, { dateStyle: 'medium' });
  } catch {
    return s;
  }
}

function getDocumentYear(doc: any): number {
  if (!doc?.document_date) return 0;
  try {
    return new Date(doc.document_date).getFullYear();
  } catch {
    return 0;
  }
}

function getStatusBadgeClass(status: string): string {
  switch (status) {
    case 'COMPLIANT':
      return 'bg-green-100 text-green-800';
    case 'PARTIAL':
      return 'bg-amber-100 text-amber-800';
    case 'MISSING':
      return 'bg-red-100 text-red-800';
    case 'NOT_APPLICABLE':
      return 'bg-gray-100 text-gray-600';
    default:
      return 'bg-gray-100 text-gray-800';
  }
}

function getStatusLabel(status: string): string {
  switch (status) {
    case 'COMPLIANT':
      return '‚úÖ Compliant';
    case 'PARTIAL':
      return '‚ö†Ô∏è Needs Review';
    case 'MISSING':
      return '‚ùå Missing';
    case 'NOT_APPLICABLE':
      return 'N/A';
    default:
      return status;
  }
}

function getCategoryLabel(category: string): string {
  const labels: Record<string, string> = {
    'governing_docs': 'Governing Documents',
    'financial': 'Financial',
    'meetings': 'Meetings',
    'contracts': 'Contracts',
    'insurance': 'Insurance',
    'governance': 'Governance',
    'other': 'Other'
  };
  return labels[category] ?? category;
}
---

<PortalLayout title="Florida HOA Compliance | Board | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/board/compliance"
    pageTitle="Florida HOA Compliance"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
  >
    <BoardNav currentPath="/board/compliance" />

unt}
<!-- Action Required Alert (if any PARTIAL items) -->
  {actionRequired.length > 0 && (
    <div class="mb-6 p-6 rounded-2xl bg-amber-50 border-2 border-amber-300 shadow-md">
      <div class="flex items-start gap-4">
        <div class="text-3xl">‚ö†Ô∏è</div>
        <div class="flex-1">
          <h2 class="text-3xl font-heading font-bold text-amber-900 mb-2">
            Action Required: {actionRequired.length} Document{actionRequired.length > 1 ? 's' : ''} Need{actionRequired.length === 1 ? 's' : ''} Annual Update
          </h2>
          <p class="text-base text-amber-800 mb-4">
            The following compliance documents require annual updates. Please upload current versions to maintain compliance.
          </p>
          <div class="space-y-2">
            {actionRequired.map((item) => (
              <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-amber-200">
                <div class="flex-1">
                  <div class="font-medium text-gray-900">{item.requirement.title}</div>
                  <div class="text-sm text-gray-600">
                    Current document from {getDocumentYear(item.document)}
                    {item.document?.document_date && ` (uploaded ${formatDate(item.document.uploaded_at)})`}
                  </div>
                </div>
                <a
                  href={`/board/compliance/${item.requirement.id}#upload`}
                  class="px-5 py-2.5 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 text-sm whitespace-nowrap ml-4"
                >
                  Update Now
                </a>
              </div>
            ))}
          </div>
          {daysUntilYearEnd < 90 && (
            <p class="text-xs text-amber-700 mt-3">
              üí° <strong>Year-end reminder:</strong> {daysUntilYearEnd} days until {now.getFullYear() + 1}. Consider updating all annual documents soon.
            </p>
          )}
        </div>
      </div>
    </div>
  )}

  <!-- Summary Card -->
  <div class="mb-8 p-6 rounded-2xl bg-white shadow-sm border border-gray-100">
    <div class="flex items-start justify-between flex-wrap gap-4 mb-4">
      <div>
        <h2 class="text-2xl font-heading font-bold text-clr-green mb-2">Compliance Dashboard</h2>
        <p class="text-base text-gray-600">Overall compliance score as of {new Date().toLocaleDateString()}</p>
      </div>
      <div class="text-right">
        <div class="text-5xl font-bold text-clr-green mb-1">{complianceData?.score ?? 0}%</div>
        <div class="text-sm text-gray-600">{complianceData?.compliantCount ?? 0} of {complianceData?.totalCount ?? 0} requirements met</div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="mb-4">
      <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
        <div
          class="h-full bg-clr-green transition-all duration-500"
          style={`width: ${complianceData?.score ?? 0}%`}
        ></div>
      </div>
    </div>

    <!-- Alert if non-compliant -->
    {complianceData && complianceData.score < 100 && (
      <div class="p-4 rounded-lg bg-amber-50 border border-amber-200">
        <p class="text-base text-amber-900">
          <strong>‚ö†Ô∏è Compliance gaps detected:</strong>
          {complianceData.missingCount > 0 && (
            <span> {complianceData.missingCount} requirement{complianceData.missingCount > 1 ? 's are' : ' is'} missing documents.</span>
          )}
          {complianceData.partialCount > 0 && (
            <span> {complianceData.partialCount} requirement{complianceData.partialCount > 1 ? 's need' : ' needs'} review or updates.</span>
          )}
          Florida Statute 720.303(4) requires all documents be posted to the association website.
        </p>
      </div>
    )}

    {complianceData && complianceData.score === 100 && (
      <div class="p-4 rounded-lg bg-green-50 border border-green-200">
        <p class="text-base text-green-900">
          <strong>‚úÖ Fully Compliant:</strong> All required documents are posted and current. Excellent work!
        </p>
      </div>
    )}
  </div>

  <!-- Quick Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="p-4 rounded-xl bg-green-50 border border-green-200">
      <div class="text-3xl font-bold text-green-800 mb-1">{complianceData?.compliantCount ?? 0}</div>
      <div class="text-sm font-medium text-green-700">Compliant</div>
      <div class="text-xs text-green-600 mt-1">Documents posted and current</div>
    </div>
    <div class="p-4 rounded-xl bg-amber-50 border border-amber-200">
      <div class="text-3xl font-bold text-amber-800 mb-1">{complianceData?.partialCount ?? 0}</div>
      <div class="text-sm font-medium text-amber-700">Needs Review</div>
      <div class="text-xs text-amber-600 mt-1">Outdated or requires update</div>
    </div>
    <div class="p-4 rounded-xl bg-red-50 border border-red-200">
      <div class="text-3xl font-bold text-red-800 mb-1">{complianceData?.missingCount ?? 0}</div>
      <div class="text-sm font-medium text-red-700">Missing</div>
      <div class="text-xs text-red-600 mt-1">No document uploaded</div>
    </div>
  </div>

  <!-- Meeting Notice Compliance Widget -->
  {upcomingMeetings.length > 0 && (
    <div class="mb-6 p-6 rounded-2xl bg-white shadow-sm border border-gray-100">
      <h3 class="text-lg font-heading font-semibold text-clr-green mb-4">üìÖ Upcoming Meeting Notices</h3>
      <p class="text-base text-gray-600 mb-4">
        Florida law requires meeting notices be posted in advance: 48 hours for Board meetings, 14 days for Member meetings.
      </p>
      <div class="space-y-3">
        {upcomingMeetings.map((status) => {
          const meetingDate = status.meeting.datetime ? new Date(status.meeting.datetime) : null;
          const isMember = status.meeting.meeting_type?.toLowerCase() === 'member';
          return (
            <div class={`p-4 rounded-xl border ${status.overallCompliant ? 'border-green-200 bg-green-50' : 'border-amber-200 bg-amber-50'}`}>
              <div class="flex items-start justify-between gap-4 flex-wrap">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-medium text-gray-900">{status.meeting.title || 'Untitled Meeting'}</span>
                    <span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700 capitalize">
                      {status.meeting.meeting_type || 'Board'}
                    </span>
                    {status.overallCompliant ? (
                      <span class="px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                        ‚úÖ Compliant
                      </span>
                    ) : (
                      <span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
                        ‚ö†Ô∏è Action Needed
                      </span>
                    )}
                  </div>
                  <div class="text-sm text-gray-600 mb-2">
                    {meetingDate && meetingDate.toLocaleString('en-US', {
                      weekday: 'short',
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      hour: 'numeric',
                      minute: '2-digit'
                    })}
                  </div>
                  <div class="text-sm space-y-1">
                    <div class={status.noticeCompliant ? 'text-green-700' : 'text-amber-800'}>
                      {status.noticeCompliant ? '‚úì' : '‚ö†'} Notice: {formatAdvanceNotice(status.noticeHoursEarly, isMember)}
                      {status.noticeCompliant ? '' : ` (need ${isMember ? '14 days' : '48 hours'})`}
                    </div>
                    {status.agendaRequired && (
                      <div class={status.agendaCompliant ? 'text-green-700' : 'text-amber-800'}>
                        {status.agendaCompliant ? '‚úì' : '‚ö†'} Agenda: {status.meeting.agenda_posted_at ? `${status.agendaDaysEarly} days` : 'Not posted'}
                        {status.agendaCompliant ? '' : ' (need 7 days)'}
                      </div>
                    )}
                  </div>
                </div>
                <a
                  href="/board/meetings"
                  class="px-5 py-2.5 text-sm bg-clr-green text-white rounded-lg font-medium hover:brightness-110 whitespace-nowrap"
                >
                  Manage
                </a>
              </div>
            </div>
          );
        })}
      </div>
      <p class="text-xs text-gray-500 mt-4">
        <a href="/board/meetings" class="text-clr-green hover:underline">View all meetings ‚Üí</a>
      </p>
    </div>
  )}

  <!-- Filter Buttons -->
  <div class="flex flex-wrap gap-2 mb-6">
    <a
      href="/board/compliance"
      class={`px-5 py-2.5 rounded-lg font-medium text-sm transition-colors ${!statusFilter ? 'bg-clr-green text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'}`}
    >
      All ({complianceData?.totalCount ?? 0})
    </a>
    <a
      href="/board/compliance?status=compliant"
      class={`px-5 py-2.5 rounded-lg font-medium text-sm transition-colors ${statusFilter === 'COMPLIANT' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'}`}
    >
      Compliant ({complianceData?.compliantCount ?? 0})
    </a>
    <a
      href="/board/compliance?status=partial"
      class={`px-5 py-2.5 rounded-lg font-medium text-sm transition-colors ${statusFilter === 'PARTIAL' ? 'bg-amber-600 text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'}`}
    >
      Needs Review ({complianceData?.partialCount ?? 0})
    </a>
    <a
      href="/board/compliance?status=missing"
      class={`px-5 py-2.5 rounded-lg font-medium text-sm transition-colors ${statusFilter === 'MISSING' ? 'bg-red-600 text-white' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'}`}
    >
      Missing ({complianceData?.missingCount ?? 0})
    </a>
  </div>

  <!-- Requirements Table -->
  <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white shadow-sm">
    <table class="w-full text-sm">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th class="px-4 py-3 font-semibold text-gray-700 text-left whitespace-nowrap">ID</th>
          <th class="px-4 py-3 font-semibold text-gray-700 text-left">Requirement</th>
          <th class="px-4 py-3 font-semibold text-gray-700 text-left whitespace-nowrap">Category</th>
          <th class="px-4 py-3 font-semibold text-gray-700 text-center whitespace-nowrap">Status</th>
          <th class="px-4 py-3 font-semibold text-gray-700 text-left whitespace-nowrap">Last Updated</th>
          <th class="px-4 py-3 font-semibold text-gray-700 text-center whitespace-nowrap">Action</th>
        </tr>
      </thead>
      <tbody>
        {filteredStatuses && filteredStatuses.length > 0 ? (
          filteredStatuses.map((item) => (
            <tr class="border-b border-gray-100 hover:bg-gray-50/50 transition-colors">
              <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap">{item.requirement.id}</td>
              <td class="px-4 py-3">
                <a
                  href={`/board/compliance/${item.requirement.id}`}
                  class="text-clr-green hover:underline font-medium"
                >
                  {item.requirement.title}
                </a>
                <div class="text-xs text-gray-500 mt-0.5">{item.requirement.statute_ref}</div>
              </td>
              <td class="px-4 py-3 text-gray-600 whitespace-nowrap">{getCategoryLabel(item.requirement.category)}</td>
              <td class="px-4 py-3 text-center">
                <span class={`inline-flex px-2 py-0.5 rounded text-xs font-medium whitespace-nowrap ${getStatusBadgeClass(item.status)}`}>
                  {getStatusLabel(item.status)}
                </span>
              </td>
              <td class="px-4 py-3 text-gray-600 whitespace-nowrap">
                {formatDate(item.lastUpdated)}
              </td>
              <td class="px-4 py-3 text-center">
                {item.status === 'MISSING' ? (
                  <a
                    href={`/board/compliance/${item.requirement.id}#upload`}
                    class="text-base text-white bg-clr-green hover:brightness-110 px-5 py-2.5 rounded font-medium inline-block whitespace-nowrap"
                  >
                    Upload
                  </a>
                ) : item.status === 'PARTIAL' ? (
                  <a
                    href={`/board/compliance/${item.requirement.id}`}
                    class="text-sm text-amber-700 hover:underline font-medium whitespace-nowrap"
                  >
                    Update
                  </a>
                ) : (
                  <a
                    href={`/board/compliance/${item.requirement.id}`}
                    class="text-sm text-clr-green hover:underline whitespace-nowrap"
                  >
                    View
                  </a>
                )}
              </td>
            </tr>
          ))
        ) : (
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
              No requirements found{statusFilter ? ` with status "${statusFilter}"` : ''}.
            </td>
          </tr>
        )}
      </tbody>
    </table>
  </div>

  <!-- Help Text -->
  <div class="mt-8 p-4 rounded-xl bg-blue-50 border border-blue-200 text-blue-900 text-sm">
    <p class="font-semibold mb-2">About Florida HOA Compliance</p>
    <p class="mb-2">
      Florida Statute 720.303(4) requires homeowners associations to post specific documents on their website or make them available digitally to members. This dashboard tracks compliance with all 15 statutory requirements.
    </p>
    <ul class="list-disc list-inside space-y-1 text-blue-800">
      <li><strong>Compliant:</strong> Document is posted and current</li>
      <li><strong>Needs Review:</strong> Document exists but requires annual update (e.g., budget, financial reports)</li>
      <li><strong>Missing:</strong> No document has been uploaded for this requirement</li>
    </ul>
    <p class="mt-3">
      <strong>Note:</strong> Some requirements (like meeting notices) are recurring and will need regular updates. Annual documents like budgets and financial reports are flagged for review each year.
    </p>
  </div>
  </PortalPage>
</PortalLayout>
