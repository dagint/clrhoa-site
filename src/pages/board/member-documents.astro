---
export const prerender = false;

import BoardLayout from '../../layouts/BoardLayout.astro';
import { getBoardContext } from '../../lib/board-context';
import { listMemberDocuments } from '../../lib/member-documents-db';
import { MEMBER_DOC_CATEGORIES, MEMBER_DOC_CATEGORY_LABELS } from '../../lib/member-documents-db';
import { listArbRequestsByHousehold } from '../../lib/arb-db';
import { sanitizeForScriptInjection } from '../../lib/sanitize';

const ctx = await getBoardContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;
const isBoard = effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board';
if (!isBoard) return Astro.redirect('/portal/dashboard');

const db = env?.DB;
const docs = db ? await listMemberDocuments(db) : [];
const allRequests = db ? await listArbRequestsByHousehold(db, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;

function formatDate(s: string | null): string {
  if (!s) return '-';
  try {
    return new Date(s).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
  } catch {
    return s;
  }
}

const docsByCategory = MEMBER_DOC_CATEGORIES.map((cat) => ({
  category: cat,
  label: MEMBER_DOC_CATEGORY_LABELS[cat],
  docs: docs.filter((d) => d.category === cat),
}));
---

<BoardLayout title="Member documents" subtitle="Redacted minutes, budgets, and other member-only files" draftCount={draftCount} role={effectiveRole} session={session} elevatedUntil={session.elevated_until}>
  <div class="mb-8 p-4 rounded-xl bg-blue-50 border border-blue-200 text-blue-900" role="alert">
    <p class="font-semibold">Members only.</p>
    <p class="text-sm mt-1">These files are visible only to logged-in members on the <a href="/portal/documents" class="underline font-medium" target="_blank" rel="noopener noreferrer">Documents page <span class="text-blue-700/80">(opens in new tab)</span></a>. Use for redacted minutes, budgets, and other member-only content.</p>
    <p class="text-sm mt-2 font-medium">Meeting minutes must be redacted before upload.</p>
    <p class="text-sm mt-0.5">Remove or black out any confidential or sensitive content (e.g. legal, personnel, or private owner details) prior to uploading.</p>
  </div>

  <div id="member-doc-message" class="hidden mb-4 p-4 rounded-xl border" role="status" aria-live="polite" aria-atomic="true"></div>

  <h2 class="text-lg font-heading font-semibold text-clr-green mb-3">Upload a document</h2>
  <form id="member-doc-form" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 space-y-4">
    <input type="hidden" name="csrf_token" value={session.csrfToken ?? ''} />
        <div>
          <label for="member-doc-category" class="block text-sm font-medium text-gray-700">Category *</label>
          <select id="member-doc-category" name="category" required class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2">
            {MEMBER_DOC_CATEGORIES.map((cat) => (
              <option value={cat}>{MEMBER_DOC_CATEGORY_LABELS[cat]}</option>
            ))}
          </select>
          <p class="text-xs text-amber-700 mt-1.5 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
            <strong>Minutes:</strong> Redact confidential or sensitive content before uploading.
          </p>
        </div>
        <div>
          <label for="member-doc-title" class="block text-sm font-medium text-gray-700">Title *</label>
          <input type="text" id="member-doc-title" name="title" required placeholder="e.g. January 2024 board minutes" class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
        </div>
        <div>
          <label for="member-doc-file" class="block text-sm font-medium text-gray-700">File *</label>
          <input type="file" id="member-doc-file" name="file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.csv,.xls,.xlsx,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/jpeg,image/png,image/gif,image/webp" class="mt-1 block w-full text-sm text-gray-600 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border file:border-gray-300 file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100" required data-accept-minutes=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" data-accept-all=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.csv,.xls,.xlsx,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,image/jpeg,image/png,image/gif,image/webp" />
          <p class="text-xs text-gray-500 mt-1" id="member-doc-file-hint">Minutes: PDF or Word. Budgets / Other: PDF, Word, CSV, Excel (.xls, .xlsx), or images (resized on upload).</p>
        </div>
        <button type="submit" id="member-doc-submit" class="px-4 py-2 bg-clr-green text-white rounded-lg font-medium hover:brightness-110 disabled:opacity-70 disabled:cursor-not-allowed" aria-busy="false">Upload</button>
  </form>

  <h2 class="text-lg font-heading font-semibold text-clr-green mb-3">Current documents</h2>
  {docs.length === 0 ? (
        <p class="text-gray-500">No member documents yet. Upload one above.</p>
      ) : (
        <div class="space-y-6">
          {docsByCategory.map(({ label, docs: catDocs }) => (
            catDocs.length > 0 && (
              <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-base font-heading font-semibold text-clr-green mb-3">{label}</h3>
                <ul class="space-y-2">
                  {catDocs.map((doc) => (
                    <li class="flex flex-wrap items-center justify-between gap-2 py-2 border-b border-gray-100 last:border-0">
                      <span class="font-medium text-gray-900">{doc.title}</span>
                      <div class="flex items-center gap-3 text-sm">
                        <span class="text-gray-500">{formatDate(doc.uploaded_at)}</span>
                        <button type="button" class="delete-member-doc-btn text-red-600 hover:underline" data-id={doc.id} data-title={doc.title}>Delete</button>
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
            )
          ))}
        </div>
      )}

  <p class="mt-8 text-sm text-gray-500">
    Members see these documents grouped by category on <a href="/portal/documents" class="text-clr-green hover:underline" target="_blank" rel="noopener noreferrer">Portal &gt; Documents <span class="text-gray-400">(opens in new tab)</span></a>.
  </p>
</BoardLayout>

<script is:inline define:vars={{ csrfToken: sanitizeForScriptInjection(session?.csrfToken ?? '') }}>
  (function () {
    if (typeof window === 'undefined') return;

    const form = document.getElementById('member-doc-form');
    const submitBtn = document.getElementById('member-doc-submit');
    const fileInput = document.getElementById('member-doc-file');
    const csrfInput = form?.querySelector('input[name="csrf_token"]');
    const messageEl = document.getElementById('member-doc-message');
    const DOC_IMAGE_MAX_WIDTH = 1920;
    const DOC_IMAGE_JPEG_QUALITY = 0.82;

    function optimizeImageForWeb(file) {
      var imageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/heic'];
      var isImage = file.type && (imageTypes.includes(file.type) || file.type.startsWith('image/'));
      if (!isImage) return Promise.resolve(file);
      return new Promise(function (resolve) {
        var img = new Image();
        var url = URL.createObjectURL(file);
        img.onload = function () {
          URL.revokeObjectURL(url);
          var w = img.naturalWidth;
          var h = img.naturalHeight;
          if (w > DOC_IMAGE_MAX_WIDTH) {
            h = Math.round((h * DOC_IMAGE_MAX_WIDTH) / w);
            w = DOC_IMAGE_MAX_WIDTH;
          }
          var canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          var ctx = canvas.getContext('2d');
          if (!ctx) { resolve(file); return; }
          ctx.drawImage(img, 0, 0, w, h);
          canvas.toBlob(function (blob) {
            var name = file.name.replace(/\.[^.]+$/i, '.jpg');
            resolve(blob ? new File([blob], name, { type: 'image/jpeg' }) : file);
          }, 'image/jpeg', DOC_IMAGE_JPEG_QUALITY);
        };
        img.onerror = function () {
          URL.revokeObjectURL(url);
          resolve(file);
        };
        img.src = url;
      });
    }

    function showMessage(text, isError) {
      if (!messageEl) return;
      messageEl.textContent = text;
      messageEl.className = 'mb-4 p-4 rounded-xl border ' + (isError ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800');
      messageEl.classList.remove('hidden');
    }
    function hideMessage() {
      if (messageEl) messageEl.classList.add('hidden');
    }

    var categorySelect = document.getElementById('member-doc-category');
    if (categorySelect && fileInput) {
      var acceptMinutes = fileInput.getAttribute('data-accept-minutes') || '';
      var acceptAll = fileInput.getAttribute('data-accept-all') || '';
      categorySelect.addEventListener('change', function () {
        fileInput.accept = this.value === 'minutes' ? acceptMinutes : acceptAll;
        fileInput.value = '';
      });
      fileInput.accept = categorySelect.value === 'minutes' ? acceptMinutes : acceptAll;
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      var rawFile = fileInput?.files?.[0];
      if (!rawFile || rawFile.size === 0) {
        showMessage('Please select a file.', true);
        return;
      }
      hideMessage();
      const token = csrfInput?.value || csrfToken || '';
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');
      }
      var file = rawFile;
      if (rawFile.type && rawFile.type.startsWith('image/')) {
        try {
          if (submitBtn) submitBtn.textContent = 'Optimizing image…';
          file = await optimizeImageForWeb(rawFile);
        } catch (err) {
          file = rawFile;
        }
        if (submitBtn) submitBtn.textContent = 'Upload';
      }
      const fd = new FormData(form);
      fd.set('file', file);
      fd.set('csrf_token', token);
      if (submitBtn) submitBtn.textContent = 'Uploading…';
      try {
        const res = await fetch('/api/member-document-upload', { method: 'POST', body: fd, credentials: 'same-origin' });
        const data = await res.json();
        if (res.ok && data.success) {
          showMessage(data.message || 'Document uploaded.', false);
          window.location.reload();
        } else {
          showMessage(data.error || 'Upload failed.', true);
        }
      } catch (err) {
        showMessage('Network error. Try again.', true);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.setAttribute('aria-busy', 'false');
          submitBtn.textContent = 'Upload';
        }
      }
    });

    document.querySelectorAll('.delete-member-doc-btn').forEach((btn) => {
      btn.addEventListener('click', async function () {
        const id = this.getAttribute('data-id');
        const title = this.getAttribute('data-title') || 'this document';
        if (!id || !confirm('Delete "' + title + '"? This cannot be undone.')) return;
        hideMessage();
        const token = csrfInput?.value || csrfToken || '';
        const b = this;
        b.disabled = true;
        b.setAttribute('aria-busy', 'true');
        try {
          const res = await fetch('/api/member-document', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: parseInt(id, 10), csrf_token: token }),
            credentials: 'same-origin',
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showMessage('Document deleted.', false);
            setTimeout(function () { window.location.reload(); }, 1500);
          } else {
            showMessage(data.error || 'Delete failed.', true);
          }
        } catch (err) {
          showMessage('Network error. Try again.', true);
        } finally {
          b.disabled = false;
          b.removeAttribute('aria-busy');
        }
      });
    });
  })();
</script>
