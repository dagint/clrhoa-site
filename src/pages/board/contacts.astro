---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import AdminNav from '../../components/BoardNav.astro';
import { getAdminContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { CONTACT_SUBMISSIONS_EXPIRY_WHERE } from '../../lib/contact-submissions';

const ctx = await getAdminContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;
const isBoard = effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board';
if (!isBoard) return Astro.redirect('/portal/dashboard');

const db = env?.DB;
const { email, role, name } = session;
const badges = await getPortalBadgeCounts(db, email, role, name);

const pageSize = 20;
const page = Math.max(1, parseInt(Astro.url.searchParams.get('page') ?? '1', 10) || 1);
const offset = (page - 1) * pageSize;

let submissions: { id: string; name: string; email: string; message: string; recipient: string; email_sent: number; email_error: string | null; created_at: string }[] = [];
let total = 0;
if (db) {
  try {
    const countRow = await db.prepare(`SELECT COUNT(*) as n FROM contact_submissions WHERE ${CONTACT_SUBMISSIONS_EXPIRY_WHERE}`).first<{ n: number }>();
    total = countRow?.n ?? 0;
    const result = await db.prepare(
      `SELECT id, name, email, message, recipient, email_sent, email_error, created_at FROM contact_submissions WHERE ${CONTACT_SUBMISSIONS_EXPIRY_WHERE} ORDER BY created_at DESC LIMIT ? OFFSET ?`
    ).bind(pageSize, offset).all<{ id: string; name: string; email: string; message: string; recipient: string; email_sent: number; email_error: string | null; created_at: string }>();
    submissions = result.results ?? [];
  } catch (_) {
    // Table may not exist yet; run npm run db:contact-submissions:local or db:contact-submissions
  }
}
const totalPages = Math.max(1, Math.ceil(total / pageSize));
const start = total === 0 ? 0 : (page - 1) * pageSize + 1;
const end = Math.min(page * pageSize, total);

function formatDate(s: string | null): string {
  if (!s) return '—';
  try {
    return new Date(s).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
  } catch {
    return s;
  }
}

function recipientLabel(r: string): string {
  return r === 'arb' ? 'ARB' : r === 'vendor' ? 'Vendor request' : 'Board';
}

/** Sanitize for mailto: href to prevent attribute breakout (XSS). */
function safeMailto(email: string): string {
  return email.replace(/[^a-zA-Z0-9._%+-@]/g, '').slice(0, 254) || '#';
}
---

<PortalLayout title="Contact submissions | Board | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/board/contacts"
    pageTitle="Contact submissions"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    <AdminNav currentPath="/board/contacts" />

    <div class="mb-6">
      <p class="text-base text-gray-600">
        Every public contact form submission is logged here. If the email to the board failed, you can follow up from this list. Submissions older than 1 year are not shown (optional cleanup: <code class="bg-gray-100 px-1 rounded">npm run db:contact-submissions-delete-expired</code>). Run <code class="bg-gray-100 px-1 rounded">npm run db:contact-submissions:local</code> (or <code class="bg-gray-100 px-1 rounded">db:contact-submissions</code> for remote) if the table does not exist yet.
      </p>
    </div>

    {submissions.length === 0 && total === 0 ? (
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center text-gray-500 text-base">
        No contact submissions yet, or the <code>contact_submissions</code> table has not been created.
      </div>
    ) : (
      <>
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
          <p class="text-base text-gray-600">
            Showing {start}–{end} of {total}
          </p>
          <nav class="flex items-center gap-2" aria-label="Pagination">
            <a
              href={page > 1 ? `?page=${page - 1}` : undefined}
              class:list={['px-5 py-2.5 rounded border text-base font-medium', page > 1 ? 'border-gray-300 text-gray-700 hover:bg-gray-50' : 'border-gray-200 text-gray-400 cursor-not-allowed pointer-events-none']}
              aria-disabled={page <= 1}
            >
              Previous
            </a>
            <span class="text-base text-gray-600">
              Page {page} of {totalPages}
            </span>
            <a
              href={page < totalPages ? `?page=${page + 1}` : undefined}
              class:list={['px-5 py-2.5 rounded border text-base font-medium', page < totalPages ? 'border-gray-300 text-gray-700 hover:bg-gray-50' : 'border-gray-200 text-gray-400 cursor-not-allowed pointer-events-none']}
              aria-disabled={page >= totalPages}
            >
              Next
            </a>
          </nav>
        </div>
        <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white">
          <table class="w-full text-base" aria-label="Contact form submissions">
            <thead>
              <tr class="border-b border-gray-200 bg-gray-50 text-left">
                <th class="px-4 py-3 font-semibold text-gray-700">Date</th>
                <th class="px-4 py-3 font-semibold text-gray-700">Name</th>
                <th class="px-4 py-3 font-semibold text-gray-700">Email</th>
                <th class="px-4 py-3 font-semibold text-gray-700">Recipient</th>
                <th class="px-4 py-3 font-semibold text-gray-700">Message</th>
                <th class="px-4 py-3 font-semibold text-gray-700">Email sent</th>
                <th class="px-4 py-3 font-semibold text-gray-700 w-20">Actions</th>
              </tr>
            </thead>
            <tbody>
              {submissions.map((row) => (
                <tr class="border-b border-gray-100 hover:bg-gray-50/50" data-submission-id={row.id}>
                  <td class="px-4 py-3 text-gray-600 whitespace-nowrap">{formatDate(row.created_at)}</td>
                  <td class="px-4 py-3 font-medium text-gray-800">{row.name}</td>
                  <td class="px-4 py-3">
                    <a href={`mailto:${safeMailto(row.email)}`} class="text-clr-green hover:underline">{row.email}</a>
                  </td>
                  <td class="px-4 py-3 text-gray-700">{recipientLabel(row.recipient)}</td>
                  <td class="px-4 py-3 text-gray-700 max-w-xs truncate" title={row.message}>{row.message.length > 80 ? row.message.slice(0, 80) + '…' : row.message}</td>
                  <td class="px-4 py-3">
                    {row.email_sent ? (
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-sm font-medium bg-green-100 text-green-800">Sent</span>
                    ) : (
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-sm font-medium bg-amber-100 text-amber-800" title={row.email_error ?? 'Email failed'}>
                        Failed
                      </span>
                    )}
                  </td>
                  <td class="px-4 py-3">
                    <button
                      type="button"
                      class="text-red-600 hover:text-red-800 text-base font-medium"
                      data-delete-id={row.id}
                      aria-label={`Delete submission from ${row.name}`}
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </>
    )}

    <script is:inline define:vars={{ currentPage: page }}>
      document.querySelectorAll('[data-delete-id]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-delete-id');
          if (!id || !confirm('Remove this contact submission? This cannot be undone.')) return;
          const row = btn.closest('tr');
          btn.setAttribute('disabled', '');
          try {
            const res = await fetch(`/api/board/contact-submissions?id=${encodeURIComponent(id)}`, { method: 'DELETE', credentials: 'same-origin' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              alert(data.error || 'Delete failed');
              btn.removeAttribute('disabled');
              return;
            }
            row?.remove();
            const remaining = document.querySelectorAll('tbody tr[data-submission-id]').length;
            if (remaining === 0 && currentPage > 1) {
              window.location.href = `?page=${currentPage - 1}`;
            } else {
              window.location.reload();
            }
          } catch (e) {
            alert('Request failed');
            btn.removeAttribute('disabled');
          }
        });
      });
    </script>
  </PortalPage>
</PortalLayout>
