---
export const prerender = false;

import BoardLayout from '../../layouts/BoardLayout.astro';
import { getSessionFromCookie } from '../../lib/auth';
import { listPreapprovalItems, listPreapprovalCategories, parsePhotos } from '../../lib/preapproval-db';
import { listArbRequestsByOwner } from '../../lib/arb-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const cookieHeader = Astro.request.headers.get('cookie') ?? undefined;
let session = await getSessionFromCookie(cookieHeader, env?.SESSION_SECRET);
if (!session) return Astro.redirect('/portal/login');

const isReviewer = session.role === 'board' || session.role === 'admin' || session.role === 'arb' || session.role === 'arb_board';
if (!isReviewer) return Astro.redirect('/portal/dashboard');

const db = env?.DB;
const items = db ? await listPreapprovalItems(db) : [];
const categories = db ? await listPreapprovalCategories(db) : [];
const allRequests = db ? await listArbRequestsByOwner(db, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;
---

<BoardLayout title="Pre-approval library" subtitle="Add and manage architectural pre-approval items" draftCount={draftCount} role={session.role}>
  <h2 class="text-xl font-heading font-bold text-clr-green mb-6">Add pre-approval item</h2>
      <form id="library-form" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 space-y-4">
        <input type="hidden" name="id" id="form-id" value="" />
        <input type="hidden" name="csrf_token" id="form-csrf" value={session.csrfToken ?? ''} />
        <div>
          <label for="lib-category" class="block text-sm font-medium text-gray-700">Category</label>
          <input type="text" id="lib-category" name="category" list="lib-categories" placeholder="e.g. Fencing, Exterior Paint" class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
          <datalist id="lib-categories">
            {categories.map((c) => (
              <option value={c} />
            ))}
          </datalist>
        </div>
        <div>
          <label for="lib-title" class="block text-sm font-medium text-gray-700">Title *</label>
          <input type="text" id="lib-title" name="title" required class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" placeholder="e.g. Standard wood fence" />
        </div>
        <div>
          <label for="lib-description" class="block text-sm font-medium text-gray-700">Description (optional)</label>
          <textarea id="lib-description" name="description" rows={2} class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" placeholder="Brief description"></textarea>
        </div>
        <div>
          <label for="lib-rules" class="block text-sm font-medium text-gray-700">Rules / notes</label>
          <textarea id="lib-rules" name="rules" rows={3} class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" placeholder="Requirements, dimensions, materials that owners should follow. This text is shown in the template."></textarea>
        </div>
        <div id="lib-photos-section">
          <label class="block text-sm font-medium text-gray-700">Photos (1-5 images)</label>
          <input type="file" id="lib-files" name="file_0" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:rounded file:border-0 file:bg-clr-green file:px-4 file:py-2 file:text-white file:font-medium" />
          <p class="text-xs text-gray-500 mt-1">First image is used as the card thumbnail. Max 5 images.</p>
        </div>
        <div class="flex gap-3">
          <button type="submit" id="lib-submit" class="px-4 py-2 bg-clr-green text-white rounded-lg font-medium hover:brightness-110">Add item</button>
          <button type="button" id="lib-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 hidden">Cancel edit</button>
        </div>
      </form>

      <h3 class="text-lg font-heading font-semibold text-clr-green mb-3">Current items</h3>
      {items.length === 0 ? (
        <p class="text-gray-500">No items yet. Add one above.</p>
      ) : (
        <ul class="space-y-4">
          {items.map((item) => {
            const photos = parsePhotos(item.photos);
            return (
              <li class="bg-white rounded-xl border border-gray-100 p-4 shadow-sm flex flex-wrap gap-4 items-start" data-id={item.id}>
                {photos[0] && (
                  <div class="w-24 h-24 rounded-lg overflow-hidden bg-gray-100 shrink-0">
                    <img src={`/api/portal/file/${encodeURIComponent(photos[0].key)}`} alt="" class="w-full h-full object-cover" />
                  </div>
                )}
                <div class="flex-1 min-w-0">
                  <span class="font-medium text-gray-900">{item.title ?? '-'}</span>
                  {item.category && <span class="ml-2 text-sm text-gray-500">({item.category})</span>}
                  {item.rules && <p class="text-sm text-gray-600 mt-1 line-clamp-2">{item.rules}</p>}
                  {photos.length > 0 && (
                    <p class="text-xs text-gray-500 mt-1">{photos.length} photo(s)</p>
                  )}
                </div>
                <div class="flex gap-2 shrink-0">
                  <button type="button" class="lib-edit-btn px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200" data-id={item.id} data-category={item.category ?? ''} data-title={item.title ?? ''} data-description={item.description ?? ''} data-rules={item.rules ?? ''} data-photos={item.photos ?? '[]'}>Edit</button>
                  <button type="button" class="lib-delete-btn px-3 py-1.5 text-sm bg-red-50 text-red-700 rounded-lg hover:bg-red-100" data-id={item.id}>Delete</button>
                </div>
              </li>
            );
          })}
        </ul>
      )}

  <script is:inline>
    (function () {
      var form = document.getElementById('library-form');
      var idInput = document.getElementById('form-id');
      var categoryInput = document.getElementById('lib-category');
      var titleInput = document.getElementById('lib-title');
      var descriptionInput = document.getElementById('lib-description');
      var rulesInput = document.getElementById('lib-rules');
      var fileInput = document.getElementById('lib-files');
      var submitBtn = document.getElementById('lib-submit');
      var cancelBtn = document.getElementById('lib-cancel');
      var photosSection = document.getElementById('lib-photos-section');
      var csrfInput = document.getElementById('form-csrf');

      function setFormCreate() {
        idInput.value = '';
        categoryInput.value = '';
        titleInput.value = '';
        descriptionInput.value = '';
        rulesInput.value = '';
        if (fileInput) fileInput.value = '';
        submitBtn.textContent = 'Add item';
        cancelBtn.classList.add('hidden');
        photosSection.classList.remove('hidden');
      }

      function setFormEdit(id, category, title, description, rules) {
        idInput.value = id;
        categoryInput.value = category || '';
        titleInput.value = title || '';
        descriptionInput.value = description || '';
        rulesInput.value = rules || '';
        submitBtn.textContent = 'Update item';
        cancelBtn.classList.remove('hidden');
        photosSection.classList.add('hidden');
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var id = idInput.value.trim();
        var token = (csrfInput && csrfInput.value) || '';

        if (id) {
          fetch('/api/preapproval', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: id,
              category: categoryInput.value.trim() || null,
              title: titleInput.value.trim(),
              description: descriptionInput.value.trim() || null,
              rules: rulesInput.value.trim() || null,
              csrf_token: token
            })
          })
            .then(function (r) { return r.json().then(function (data) { return { ok: r.ok, data: data }; }); })
            .then(function (_) {
              if (_.ok) { setFormCreate(); window.location.reload(); }
              else alert(_.data.error || 'Update failed');
            })
            .catch(function () { alert('Network error'); });
          return;
        }

        var formData = new FormData(form);
        formData.set('csrf_token', token);
        if (fileInput && fileInput.files && fileInput.files.length) {
          for (var i = 0; i < Math.min(5, fileInput.files.length); i++) {
            formData.set('file_' + i, fileInput.files[i]);
          }
        }
        submitBtn.disabled = true;
        fetch('/api/preapproval', { method: 'POST', body: formData })
          .then(function (r) { return r.json().then(function (data) { return { ok: r.ok, data: data }; }); })
          .then(function (_) {
            if (_.ok) { setFormCreate(); window.location.reload(); }
            else alert(_.data.error || 'Create failed');
          })
          .catch(function () { alert('Network error'); })
          .then(function () { submitBtn.disabled = false; });
      });

      cancelBtn.addEventListener('click', setFormCreate);

      document.querySelectorAll('.lib-edit-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          setFormEdit(
            this.getAttribute('data-id'),
            this.getAttribute('data-category'),
            this.getAttribute('data-title'),
            this.getAttribute('data-description'),
            this.getAttribute('data-rules')
          );
        });
      });

      document.querySelectorAll('.lib-delete-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var id = this.getAttribute('data-id');
          if (!id || !confirm('Delete this item? This cannot be undone.')) return;
          var token = (csrfInput && csrfInput.value) || '';
          fetch('/api/preapproval', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, csrf_token: token })
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (data.success) window.location.reload();
              else alert(data.error || 'Delete failed');
            })
            .catch(function () { alert('Network error'); });
        });
      });
    })();
  </script>
</BoardLayout>
