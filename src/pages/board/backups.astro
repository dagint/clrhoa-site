---
export const prerender = false;

import BoardLayout from '../../layouts/BoardLayout.astro';
import { getBoardContext } from '../../lib/board-context';
import { listArbRequestsByHousehold } from '../../lib/arb-db';

const ctx = await getBoardContext(Astro);
if (ctx.redirect) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;
if (effectiveRole !== 'board' && effectiveRole !== 'admin') return Astro.redirect('/portal/dashboard');

const allRequests = env?.DB ? await listArbRequestsByHousehold(env.DB, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;

const url = Astro.url;
const connected = url.searchParams.get('connected') === '1';
const errorParam = url.searchParams.get('error') ?? '';
---

<BoardLayout title="Backups" subtitle="Download full backup or configure automated backups to Google Drive" draftCount={draftCount} role={effectiveRole} session={session} elevatedUntil={session.elevated_until}>
  <p class="text-gray-600 mb-6">
    Database (D1) and login whitelist (KV) backups. Automated backups run daily to Cloudflare R2; you can also send a copy to a Google Workspace Drive folder.
  </p>

  {connected && (
    <div class="mb-6 p-4 rounded-xl bg-green-50 border border-green-200 text-green-800 text-sm" role="alert">
      Google Drive connected. Enter a folder ID below and save to enable backup to Drive.
    </div>
  )}
  {errorParam && (
    <div class="mb-6 p-4 rounded-xl bg-red-50 border border-red-200 text-red-800 text-sm" role="alert">
      {errorParam === 'config' && 'Backup or Google Drive not configured (missing env).'}
      {errorParam === 'no_code' && 'OAuth callback missing code.'}
      {errorParam === 'no_refresh_token' && 'Google did not return a refresh token; try again with prompt=consent.'}
      {errorParam === 'token_exchange_failed' && 'Could not exchange OAuth code for token.'}
      {errorParam === 'db' && 'Database error.'}
      {!['config', 'no_code', 'no_refresh_token', 'token_exchange_failed', 'db'].includes(errorParam) && `Error: ${errorParam}`}
    </div>
  )}

  <section class="mb-8" aria-labelledby="download-backup-heading">
    <h2 id="download-backup-heading" class="text-lg font-heading font-semibold text-clr-green mb-3">Download full backup</h2>
    <p class="text-sm text-gray-600 mb-3">
      Get a ZIP with the current database (SQL) and whitelist (JSON) to save on your computer.
    </p>
    <a
      href="/api/board/backup-download"
      class="inline-flex items-center gap-2 bg-clr-green hover:brightness-110 text-white px-5 py-2.5 rounded-xl font-semibold text-sm"
      download
    >
      Download backup (ZIP)
    </a>
  </section>

  <section class="mb-8" aria-labelledby="automated-heading">
    <h2 id="automated-heading" class="text-lg font-heading font-semibold text-clr-green mb-3">Automated backups (Cloudflare R2)</h2>
    <p class="text-sm text-gray-600 mb-3">
      The backup Worker runs daily at 2:00 AM UTC. It exports D1 and the whitelist and stores them in R2 under <code class="bg-gray-100 px-1 rounded">backups/d1/</code> and <code class="bg-gray-100 px-1 rounded">backups/kv/</code>. Retention is applied (default 30 days).
    </p>
    <div id="backup-status" class="rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-700 space-y-1.5" role="status" aria-live="polite">
      <p class="font-medium text-gray-800">Status</p>
      <p id="backup-status-manual">Checking…</p>
      <p id="backup-status-r2">Checking…</p>
      <p id="backup-status-google">Checking…</p>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Deploy the Worker with <code class="bg-gray-100 px-1 rounded">npm run backup:deploy</code> and set <code class="bg-gray-100 px-1 rounded">CLOUDFLARE_API_TOKEN</code> and <code class="bg-gray-100 px-1 rounded">CLOUDFLARE_ACCOUNT_ID</code> for the Worker (and for manual download above).
    </p>
  </section>

  <section class="mb-8" aria-labelledby="google-drive-heading">
    <h2 id="google-drive-heading" class="text-lg font-heading font-semibold text-clr-green mb-3">Google Drive backup</h2>
    <p class="text-sm text-gray-600 mb-4">
      Optionally upload the same backup set to a Google Workspace Drive folder. Connect your Google account, then set the folder ID (from the folder URL in Drive) and schedule.
    </p>

    <form id="backup-config-form" class="space-y-4 max-w-xl">
      <div class="flex items-center gap-2">
        <input type="checkbox" id="google_drive_enabled" name="google_drive_enabled" class="rounded border-gray-300" />
        <label for="google_drive_enabled" class="text-sm font-medium text-gray-700">Enable Google Drive backup</label>
      </div>
      <div>
        <label for="google_drive_folder_id" class="block text-sm font-medium text-gray-700 mb-1">Google Drive folder ID</label>
        <input type="text" id="google_drive_folder_id" name="google_drive_folder_id" placeholder="e.g. from https://drive.google.com/drive/folders/FOLDER_ID" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm" />
      </div>
      <div class="flex flex-wrap gap-4">
        <div>
          <label for="schedule_type" class="block text-sm font-medium text-gray-700 mb-1">Schedule</label>
          <select id="schedule_type" name="schedule_type" class="rounded-lg border border-gray-300 px-3 py-2 text-sm">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <div>
          <label for="schedule_hour_utc" class="block text-sm font-medium text-gray-700 mb-1">Hour (UTC)</label>
          <input type="number" id="schedule_hour_utc" name="schedule_hour_utc" min="0" max="23" value="2" class="w-20 rounded-lg border border-gray-300 px-3 py-2 text-sm" />
        </div>
        <div id="schedule_day_wrap" class="hidden">
          <label for="schedule_day_of_week" class="block text-sm font-medium text-gray-700 mb-1">Day (0=Sun, 6=Sat)</label>
          <input type="number" id="schedule_day_of_week" name="schedule_day_of_week" min="0" max="6" value="0" class="w-20 rounded-lg border border-gray-300 px-3 py-2 text-sm" />
        </div>
      </div>
      <div class="flex items-center gap-4">
        <a href="/api/board/google-drive-auth" class="text-sm text-clr-orange hover:underline font-medium">Connect Google Drive</a>
        <button type="submit" class="bg-clr-green hover:brightness-110 text-white px-5 py-2.5 rounded-xl font-semibold text-sm">
          Save settings
        </button>
      </div>
    </form>
  </section>

  <script define:vars={{}}>
    (function () {
      const form = document.getElementById('backup-config-form');
      const scheduleType = document.getElementById('schedule_type');
      const dayWrap = document.getElementById('schedule_day_wrap');

      scheduleType?.addEventListener('change', function () {
        if (dayWrap) dayWrap.classList.toggle('hidden', scheduleType.value !== 'weekly');
      });

      async function load() {
        try {
          const r = await fetch('/api/board/backup-config');
          const c = await r.json();
          const enabled = document.getElementById('google_drive_enabled');
          const folderId = document.getElementById('google_drive_folder_id');
          const hour = document.getElementById('schedule_hour_utc');
          const day = document.getElementById('schedule_day_of_week');
          if (enabled) enabled.checked = c.google_drive_enabled;
          if (folderId) folderId.value = c.google_drive_folder_id || '';
          if (hour) hour.value = c.schedule_hour_utc ?? 2;
          if (day) day.value = c.schedule_day_of_week ?? 0;
          if (scheduleType) scheduleType.value = c.schedule_type || 'daily';
          if (dayWrap) dayWrap.classList.toggle('hidden', scheduleType?.value !== 'weekly');
        } catch (_) {}
      }
      load();

      (function loadBackupStatus() {
        const manualEl = document.getElementById('backup-status-manual');
        const r2El = document.getElementById('backup-status-r2');
        const googleEl = document.getElementById('backup-status-google');
        if (!manualEl || !r2El || !googleEl) return;
        fetch('/api/board/backup-status', { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.error) {
              manualEl.textContent = 'Could not load status.';
              r2El.textContent = '';
              googleEl.textContent = '';
              return;
            }
            manualEl.textContent = data.manual_download_configured
              ? 'Manual download: Configured. (CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN are set.)'
              : 'Manual download: Not configured. Set CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN in your deployment to enable "Download backup (ZIP)".';
            if (data.last_r2_backup_at) {
              var d = new Date(data.last_r2_backup_at);
              var label = isNaN(d.getTime()) ? data.last_r2_backup_at : d.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short', timeZone: 'UTC' }) + ' UTC';
              r2El.textContent = 'Automated R2 backups: Last run at ' + label + '.';
            } else {
              r2El.textContent = 'Automated R2 backups: No run recorded yet. Deploy the backup Worker (npm run backup:deploy) and set CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN for the Worker.';
            }
            if (data.last_google_backup_at) {
              var gd = new Date(data.last_google_backup_at);
              var glabel = isNaN(gd.getTime()) ? data.last_google_backup_at : gd.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short', timeZone: 'UTC' }) + ' UTC';
              googleEl.textContent = 'Google Drive: Last run at ' + glabel + '.';
            } else {
              googleEl.textContent = 'Google Drive: No run recorded yet. Enable Google Drive backup and set a folder to see last run time.';
            }
          })
          .catch(function () {
            manualEl.textContent = 'Could not load status.';
            r2El.textContent = '';
            if (googleEl) googleEl.textContent = '';
          });
      })();

      form?.addEventListener('submit', async function (e) {
        e.preventDefault();
        const enabled = document.getElementById('google_drive_enabled');
        const folderId = document.getElementById('google_drive_folder_id');
        const hour = document.getElementById('schedule_hour_utc');
        const day = document.getElementById('schedule_day_of_week');
        const payload = {
          google_drive_enabled: enabled?.checked ?? false,
          google_drive_folder_id: folderId?.value ?? '',
          schedule_type: scheduleType?.value ?? 'daily',
          schedule_hour_utc: parseInt(hour?.value ?? '2', 10),
          schedule_day_of_week: parseInt(day?.value ?? '0', 10),
          include_r2_manifest: false,
          include_r2_files: false,
        };
        const r = await fetch('/api/board/backup-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (r.ok) {
          const btn = form.querySelector('button[type="submit"]');
          if (btn) {
            const orig = btn.textContent;
            btn.textContent = 'Saved';
            setTimeout(() => { btn.textContent = orig; }, 2000);
          }
        }
      });
    })();
  </script>
</BoardLayout>
