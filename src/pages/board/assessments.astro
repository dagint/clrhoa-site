---
export const prerender = false;

import BoardLayout from '../../layouts/BoardLayout.astro';
import { getBoardContext } from '../../lib/board-context';
import { canRecordPayments } from '../../lib/auth';
import { listPrimaryOwnersByAddress } from '../../lib/directory-db';
import { listArbRequestsByHousehold } from '../../lib/arb-db';
import {
  getAssessmentByOwner,
  listAllAssessments,
  listAllSpecialAssessments,
  getCurrentQuarterEnd,
  isMissingForQuarter,
} from '../../lib/assessments-db';
import { escapeHtml } from '../../lib/sanitize';

const ctx = await getBoardContext(Astro);
if (ctx.redirect) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;
const isBoard = effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board';
if (!isBoard) return Astro.redirect('/portal/dashboard');
const canRecord = canRecordPayments(effectiveRole);

const db = env?.DB;
const owners = db ? await listPrimaryOwnersByAddress(db) : [];
const allRequests = db ? await listArbRequestsByHousehold(db, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;

const allAssessments = db ? await listAllAssessments(db) : [];
const allSpecials = db ? await listAllSpecialAssessments(db) : [];

const assessmentByEmail = new Map(allAssessments.map((a) => [a.owner_email, a]));
const specialsByEmail = new Map<string, { unpaid: number; list: typeof allSpecials }>();
for (const s of allSpecials) {
  const email = s.owner_email.toLowerCase();
  if (!specialsByEmail.has(email)) specialsByEmail.set(email, { unpaid: 0, list: [] });
  const entry = specialsByEmail.get(email)!;
  entry.list.push(s);
  if (!s.paid_at) entry.unpaid += s.amount;
}

const today = new Date().toISOString().slice(0, 10);
const currentYear = new Date().getFullYear();
const currentQuarterEnd = getCurrentQuarterEnd();

const sortedOwners = [...owners].filter((o) => o.email?.trim()).sort((a, b) => {
  const na = (a.name ?? a.email ?? '').toLowerCase();
  const nb = (b.name ?? b.email ?? '').toLowerCase();
  return na.localeCompare(nb);
});

/** Households missing payment for the current quarter only (paid_through < current quarter end). */
const missingThisQuarter = sortedOwners.filter((o) => {
  const email = (o.email ?? '').trim().toLowerCase();
  const assessment = assessmentByEmail.get(email) ?? null;
  return isMissingForQuarter(assessment?.paid_through ?? null, currentQuarterEnd);
});

function formatDate(s: string | null): string {
  if (!s) return '—';
  try {
    return new Date(s).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  } catch {
    return s;
  }
}

function formatCurrency(n: number): string {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
}
---

<BoardLayout title="Dues" subtitle="Record payments, add special assessments, set quarterly amounts" draftCount={draftCount} role={effectiveRole} session={session} elevatedUntil={session.elevated_until}>
  <div id="csrf-holder" class="hidden" data-csrf={escapeHtml(session.csrfToken ?? '')} aria-hidden="true"></div>
  <div id="assessments-message" class="hidden mb-4 p-4 rounded-xl border" role="status" aria-live="polite" aria-atomic="true"></div>

  {!canRecord && (effectiveRole === 'arb_board' || effectiveRole === 'admin') && (
    <div class="mb-4 p-4 rounded-xl bg-amber-50 border border-amber-200 text-amber-900 text-sm" role="status">
      <strong>View only.</strong> To record payments or add special assessments, use <strong>Act as Board</strong> in the yellow banner at the top of the page.
    </div>
  )}
  <p class="text-sm text-gray-600 mb-4">One row per <strong>property (address)</strong>. Multiple people may be at one address; the primary contact is used for dues. Quarterly dues are due on the 1st of each quarter month (Jan 1, Apr 1, Jul 1, Oct 1). Record payments below; use &quot;Add special assessment&quot; for one-off charges. The quarterly dues amount can be changed by the board (e.g. in settings or when needed).</p>

  <div class="flex flex-wrap items-center gap-4 mb-4">
    <span class="text-sm font-medium text-gray-700">Show:</span>
    <label class="flex items-center gap-2 cursor-pointer">
      <input type="radio" name="assessments-filter" value="missing" checked class="assessments-filter-missing rounded border-gray-300 text-clr-green focus:ring-clr-green" aria-label="Missing this quarter only" />
      <span class="text-sm text-gray-700">Missing this quarter only</span>
    </label>
    <label class="flex items-center gap-2 cursor-pointer">
      <input type="radio" name="assessments-filter" value="all" class="assessments-filter-all rounded border-gray-300 text-clr-green focus:ring-clr-green" aria-label="Show all" />
      <span class="text-sm text-gray-700">Show all</span>
    </label>
    <span class="text-xs text-gray-500" id="assessments-filter-count">({missingThisQuarter.length} of {sortedOwners.length} households)</span>
  </div>

  <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white shadow-sm">
    <table class="w-full text-sm min-w-[800px]" id="assessments-table">
      <thead class="bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
        <tr>
          <th class="text-left py-2 px-3 font-semibold text-gray-700">Name</th>
          <th class="text-left py-2 px-3 font-semibold text-gray-700">Email</th>
          <th class="text-right py-2 px-3 font-semibold text-gray-700 w-24">Balance</th>
          <th class="text-left py-2 px-3 font-semibold text-gray-700 w-28">Paid through</th>
          <th class="text-right py-2 px-3 font-semibold text-gray-700 w-20">Specials</th>
          {canRecord && <th class="text-left py-2 px-3 font-semibold text-gray-700">Record payment</th>}
        </tr>
      </thead>
      <tbody>
        {sortedOwners.map((o) => {
          const email = (o.email ?? '').trim().toLowerCase();
          const assessment = assessmentByEmail.get(email) ?? null;
          const specials = specialsByEmail.get(email);
          const unpaidSpecial = specials?.unpaid ?? 0;
          const balance = assessment?.balance ?? 0;
          const missingForCurrentQuarter = isMissingForQuarter(assessment?.paid_through ?? null, currentQuarterEnd);
          return (
            <tr
              class="border-b border-gray-100 hover:bg-gray-50/50"
              data-email={email}
              data-missing-this-quarter={missingForCurrentQuarter ? 'true' : 'false'}
            >
              <td class="py-2 px-3 font-medium text-gray-900">{o.name ?? '—'}</td>
              <td class="py-2 px-3 text-gray-600">{email || '—'}</td>
              <td class="py-2 px-3 text-right font-mono">{formatCurrency(balance)}</td>
              <td class="py-2 px-3 text-gray-600">{formatDate(assessment?.paid_through ?? null)}</td>
              <td class="py-2 px-3 text-right font-mono">{unpaidSpecial > 0 ? formatCurrency(unpaidSpecial) : '—'}</td>
              {canRecord && (
                <td class="py-2 px-3">
                  <div class="flex flex-wrap items-center gap-1.5">
                    <input type="number" step="0.01" min="0" placeholder="Amt" class="record-amount w-16 rounded border border-gray-200 px-2 py-1 text-right" aria-label="Payment amount" />
                    <input type="date" class="record-date w-32 rounded border border-gray-200 px-2 py-1" value={today} aria-label="Payment date" data-today={today} />
                    <label class="flex items-center gap-0.5 whitespace-nowrap">
                      <span class="text-xs text-gray-600 sr-only">How received</span>
                      <select class="record-method rounded border border-gray-200 px-1 py-1 text-xs min-w-0" aria-label="How received">
                        <option value="electronic_transfer">E-transfer</option>
                        <option value="check">Check</option>
                        <option value="cash">Cash</option>
                      </select>
                    </label>
                    <span class="record-check-wrap hidden">
                      <input type="text" class="record-check-number w-20 rounded border border-gray-200 px-2 py-1 text-xs" placeholder="Check #" aria-label="Check number" maxlength="24" />
                    </span>
                    <label class="flex items-center gap-0.5 whitespace-nowrap" title="Apply payment to this many quarters (current + future)">
                      <span class="text-xs text-gray-600">Qty:</span>
                      <select class="record-quarters w-12 rounded border border-gray-200 px-1 py-1 text-xs" aria-label="Quarters to apply">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                      </select>
                    </label>
                    <label class="flex items-center gap-0.5 whitespace-nowrap">
                      <input type="checkbox" class="record-fullyear rounded border-gray-300 text-clr-green focus:ring-clr-green" aria-label="Full year (4 quarters)" />
                      <span class="text-xs text-gray-600">Full yr</span>
                    </label>
                    <button type="button" class="record-btn px-2 py-1 rounded bg-clr-green text-white text-xs font-medium hover:brightness-110 whitespace-nowrap" data-email={email} data-balance={balance}>Record</button>
                  </div>
                </td>
              )}
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  {sortedOwners.length === 0 && (
    <p class="py-8 text-center text-gray-500">No owners in the directory yet. Add owners in Board → Directory.</p>
  )}

  <section class="mt-10">
    {canRecord && (
    <>
    <h2 class="text-lg font-heading font-semibold text-clr-green mb-3">Add special assessment</h2>
    <p class="text-sm text-gray-600 mb-3">One-off bill for a single owner. They will see it on Portal → Dues until paid.</p>
    <form id="add-special-form" class="flex flex-wrap items-end gap-3 mb-6">
      <input type="hidden" name="csrf_token" id="add-special-csrf" value={session.csrfToken ?? ''} />
      <div>
        <label for="special-owner" class="block text-xs font-medium text-gray-600 mb-0.5">Owner</label>
        <select id="special-owner" name="owner_email" required class="rounded border border-gray-200 px-3 py-2 min-w-[180px]">
          <option value="">— Select —</option>
          {sortedOwners.map((o) => (
            <option value={o.email ?? ''}>{o.name ?? o.email} ({o.email})</option>
          ))}
        </select>
      </div>
      <div>
        <label for="special-description" class="block text-xs font-medium text-gray-600 mb-0.5">Description</label>
        <input type="text" id="special-description" name="description" required placeholder="e.g. 2025 road repair" class="rounded border border-gray-200 px-3 py-2 w-48" />
      </div>
      <div>
        <label for="special-amount" class="block text-xs font-medium text-gray-600 mb-0.5">Amount ($)</label>
        <input type="number" id="special-amount" name="amount" step="0.01" min="0.01" required class="rounded border border-gray-200 px-3 py-2 w-24 text-right" />
      </div>
      <div>
        <label for="special-due" class="block text-xs font-medium text-gray-600 mb-0.5">Due date</label>
        <input type="date" id="special-due" name="due_date" class="rounded border border-gray-200 px-3 py-2 w-36" />
      </div>
      <button type="submit" id="add-special-btn" class="px-4 py-2 bg-clr-green text-white rounded-lg font-medium hover:brightness-110" aria-busy="false">Add</button>
    </form>
    </>
    )}

    {allSpecials.length > 0 && (
      <div class="overflow-x-auto rounded-xl border border-gray-200 bg-white">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Owner</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Description</th>
              <th class="text-right py-2 px-3 font-medium text-gray-700">Amount</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Due</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Status</th>
              <th class="text-left py-2 px-3 font-medium text-gray-700">Action</th>
            </tr>
          </thead>
          <tbody>
            {allSpecials.map((s) => (
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3">{s.owner_email}</td>
                <td class="py-2 px-3">{s.description}</td>
                <td class="py-2 px-3 text-right font-mono">{formatCurrency(s.amount)}</td>
                <td class="py-2 px-3">{formatDate(s.due_date)}</td>
                <td class="py-2 px-3">{s.paid_at ? `Paid ${formatDate(s.paid_at)}` : 'Unpaid'}</td>
                <td class="py-2 px-3">
                  {!s.paid_at && canRecord && (
                    <button type="button" class="mark-special-paid text-clr-green hover:underline text-xs" data-id={s.id} data-owner={s.owner_email}>Mark paid</button>
                  )}
                  {!s.paid_at && !canRecord && <span class="text-gray-400">—</span>}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </section>
</BoardLayout>

<script define:vars={{ today: today, currentYear: currentYear, csrfToken: session?.csrfToken ?? '', missingCount: missingThisQuarter.length, totalCount: sortedOwners.length }}>
  (function () {
    const msgEl = document.getElementById('assessments-message');
    const csrfHolder = document.getElementById('csrf-holder');
    const getCsrf = () => (csrfHolder?.getAttribute('data-csrf') ?? csrfToken ?? '').trim();
    const table = document.getElementById('assessments-table');
    const countEl = document.getElementById('assessments-filter-count');

    function showMsg(text, isError) {
      if (!msgEl) return;
      msgEl.textContent = text;
      msgEl.className = 'mb-4 p-4 rounded-xl border ' + (isError ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800');
      msgEl.classList.remove('hidden');
    }

    function applyFilter(showOnlyMissing) {
      if (!table) return;
      const rows = table.querySelectorAll('tbody tr[data-missing-this-quarter]');
      rows.forEach((tr) => {
        const missing = tr.getAttribute('data-missing-this-quarter') === 'true';
        tr.style.display = showOnlyMissing && !missing ? 'none' : '';
      });
      if (countEl) countEl.textContent = showOnlyMissing ? `(${missingCount} of ${totalCount} households)` : `(all ${totalCount} households)`;
    }

    document.querySelectorAll('input[name="assessments-filter"]').forEach((radio) => {
      radio.addEventListener('change', function () {
        applyFilter(this.value === 'missing');
      });
    });
    applyFilter(true);

    function toggleCheckNumber(row) {
      const wrap = row?.querySelector('.record-check-wrap');
      const methodSelect = row?.querySelector('.record-method');
      if (!wrap || !methodSelect) return;
      const isCheck = methodSelect.value === 'check';
      wrap.classList.toggle('hidden', !isCheck);
    }
    table?.querySelectorAll('tbody tr').forEach((tr) => {
      const methodSelect = tr.querySelector('.record-method');
      methodSelect?.addEventListener('change', () => toggleCheckNumber(tr));
      toggleCheckNumber(tr);
    });

    table?.addEventListener('click', async (e) => {
      const btn = e.target?.closest('.record-btn');
      if (!btn) return;
      const email = btn.getAttribute('data-email');
      const row = btn.closest('tr');
      const amountInput = row?.querySelector('.record-amount');
      const dateInput = row?.querySelector('.record-date');
      const fullYearCb = row?.querySelector('.record-fullyear');
      const quartersSelect = row?.querySelector('.record-quarters');
      const methodSelect = row?.querySelector('.record-method');
      const checkInput = row?.querySelector('.record-check-number');
      if (!email || !amountInput || !dateInput) return;
      const amount = parseFloat(amountInput.value);
      const paid_at = dateInput.value;
      if (Number.isNaN(amount) || amount <= 0) {
        showMsg('Enter a payment amount.', true);
        return;
      }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(paid_at)) {
        showMsg('Select a payment date.', true);
        return;
      }
      const payment_method = methodSelect?.value ?? 'electronic_transfer';
      const check_number = payment_method === 'check' && checkInput ? checkInput.value?.trim() || null : null;
      const quarters_to_apply = (fullYearCb && fullYearCb.checked)
        ? 4
        : Math.min(4, Math.max(1, parseInt(quartersSelect?.value ?? '1', 10) || 1));
      btn.disabled = true;
      btn.setAttribute('aria-busy', 'true');
      try {
        const res = await fetch('/api/assessments/record-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            owner_email: email,
            amount,
            paid_at,
            quarters_to_apply,
            payment_method,
            check_number,
            csrf_token: getCsrf(),
          }),
        });
        const data = await res.json();
        if (res.ok && data.success) {
          showMsg('Payment recorded. Reloading…', false);
          setTimeout(() => window.location.reload(), 800);
        } else {
          showMsg(data.error || 'Failed to record payment', true);
        }
      } catch (err) {
        showMsg('Network error. Try again.', true);
      } finally {
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
      }
    });

    const addSpecialForm = document.getElementById('add-special-form');
    const addSpecialBtn = document.getElementById('add-special-btn');
    if (addSpecialForm && addSpecialBtn) {
      addSpecialForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const owner = addSpecialForm.querySelector('#special-owner')?.value?.trim();
        const description = addSpecialForm.querySelector('#special-description')?.value?.trim();
        const amount = addSpecialForm.querySelector('#special-amount')?.value;
        const due_date = addSpecialForm.querySelector('#special-due')?.value?.trim() || null;
        if (!owner || !description || !amount) return;
        addSpecialBtn.disabled = true;
        addSpecialBtn.setAttribute('aria-busy', 'true');
        try {
          const res = await fetch('/api/assessments/special', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              owner_email: owner,
              description,
              amount: parseFloat(amount),
              due_date: due_date || undefined,
              csrf_token: getCsrf(),
            }),
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showMsg('Special assessment added.', false);
            setTimeout(() => window.location.reload(), 800);
          } else {
            showMsg(data.error || 'Failed to add', true);
          }
        } catch (err) {
          showMsg('Network error. Try again.', true);
        } finally {
          addSpecialBtn.disabled = false;
          addSpecialBtn.removeAttribute('aria-busy');
        }
      });
    }

    document.querySelectorAll('.mark-special-paid').forEach((btn) => {
      btn.addEventListener('click', async function () {
        const id = this.getAttribute('data-id');
        const owner = this.getAttribute('data-owner');
        if (!id || !owner) return;
        const paid_at = prompt('Payment date (YYYY-MM-DD):', today);
        if (!paid_at || !/^\d{4}-\d{2}-\d{2}$/.test(paid_at)) return;
        this.disabled = true;
        try {
          const res = await fetch('/api/assessments/special', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, owner_email: owner, paid_at, csrf_token: getCsrf() }),
          });
          const data = await res.json();
          if (res.ok && data.success) {
            showMsg('Marked as paid.', false);
            setTimeout(() => window.location.reload(), 800);
          } else {
            showMsg(data.error || 'Failed', true);
          }
        } catch (err) {
          showMsg('Network error.', true);
        } finally {
          this.disabled = false;
        }
      });
    });
  })();
</script>
