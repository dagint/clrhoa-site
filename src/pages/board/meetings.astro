---
export const prerender = false;

import BoardLayout from '../../layouts/BoardLayout.astro';
import { getSessionFromCookie } from '../../lib/auth';
import { listAllMeetings } from '../../lib/meetings-db';
import { listArbRequestsByOwner } from '../../lib/arb-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const cookieHeader = Astro.request.headers.get('cookie') ?? undefined;
let session = await getSessionFromCookie(cookieHeader, env?.SESSION_SECRET);

if (!session) {
  return Astro.redirect('/portal/login');
}

const isBoard = session.role === 'board' || session.role === 'admin' || session.role === 'arb_board';
if (!isBoard) {
  return Astro.redirect('/portal/dashboard');
}

const db = env?.DB;
const meetings = db ? await listAllMeetings(db) : [];
const allRequests = db ? await listArbRequestsByOwner(db, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;

function formatDateTime(dt: string): string {
  try {
    return new Date(dt).toLocaleString('en-US', {
      weekday: 'short',
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
    });
  } catch {
    return dt;
  }
}
---

<BoardLayout title="Meetings" subtitle="Manage meetings and agendas" draftCount={draftCount} role={session.role}>
  <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <h2 class="text-xl font-heading font-bold text-clr-green">Meetings</h2>
        <button
          type="button"
          id="btn-new-meeting"
          class="inline-flex items-center gap-2 bg-clr-green hover:brightness-110 text-white px-4 py-2 rounded-xl font-semibold text-sm"
        >
          New meeting
        </button>
      </div>

      <div id="form-panel" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8">
        <h3 class="text-lg font-heading font-semibold text-clr-green mb-4" id="form-title">New meeting</h3>
        <form id="meeting-form" class="space-y-4">
          <input type="hidden" name="id" id="form-id" value="" />
          <div>
            <label for="form-meeting-title" class="block text-sm font-medium text-gray-700">Title *</label>
            <input type="text" id="form-meeting-title" name="title" required class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
          </div>
          <div>
            <label for="form-meeting-datetime" class="block text-sm font-medium text-gray-700">Date & time *</label>
            <input type="datetime-local" id="form-meeting-datetime" name="datetime" required class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
          </div>
          <div>
            <label for="form-meeting-location" class="block text-sm font-medium text-gray-700">Location</label>
            <input type="text" id="form-meeting-location" name="location" class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2" />
          </div>
          <div>
            <label for="form-meeting-description" class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="form-meeting-description" name="description" rows="3" class="mt-1 block w-full rounded-lg border border-gray-200 px-3 py-2"></textarea>
          </div>
          <div>
            <label for="form-meeting-agenda" class="block text-sm font-medium text-gray-700">Agenda PDF</label>
            <input type="file" id="form-meeting-agenda" name="agenda" accept=".pdf,application/pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-clr-green file:text-white" />
            <input type="hidden" name="agenda_r2_key" id="form-agenda-key" value="" />
            <p class="text-xs text-gray-500 mt-1">Optional. Upload a PDF; it will be stored and linked for owners.</p>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="bg-clr-green hover:brightness-110 text-white px-4 py-2 rounded-lg font-medium text-sm">
              Save
            </button>
            <button type="button" id="btn-cancel-form" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium text-sm">
              Cancel
            </button>
          </div>
        </form>
      </div>

      {meetings.length === 0 ? (
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center text-gray-500">
          No meetings yet. Click &quot;New meeting&quot; to add one.
        </div>
      ) : (
        <ul class="space-y-4">
          {meetings.map((m) => (
            <li class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex flex-wrap items-center justify-between gap-3">
              <div>
                <h3 class="font-semibold text-clr-green">{m.title || 'Meeting'}</h3>
                <p class="text-sm text-gray-500">{formatDateTime(m.datetime)}</p>
                {m.location && <p class="text-sm text-gray-600">{m.location}</p>}
              </div>
              <div class="flex gap-2">
                {m.agenda_r2_key && (
                  <a
                    href={`/api/portal/file/${encodeURIComponent(m.agenda_r2_key)}`}
                    class="text-sm text-clr-green hover:underline"
                  >
                    Agenda
                  </a>
                )}
                <button
                  type="button"
                  class="edit-meeting text-sm text-clr-green hover:underline"
                  data-id={m.id}
                  data-title={m.title ?? ''}
                  data-datetime={m.datetime}
                  data-location={m.location ?? ''}
                  data-description={m.description ?? ''}
                  data-agenda-key={m.agenda_r2_key ?? ''}
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="delete-meeting text-sm text-red-600 hover:underline"
                  data-id={m.id}
                  data-title={m.title ?? 'Meeting'}
                >
                  Delete
                </button>
              </div>
            </li>
          ))}
        </ul>
      )}

<script>
  const formPanel = document.getElementById('form-panel');
  const formTitle = document.getElementById('form-title');
  const form = document.getElementById('meeting-form') as HTMLFormElement;
  const formId = document.getElementById('form-id') as HTMLInputElement;
  const formAgendaKey = document.getElementById('form-agenda-key') as HTMLInputElement;
  const agendaFileInput = document.getElementById('form-meeting-agenda') as HTMLInputElement;

  document.getElementById('btn-new-meeting')?.addEventListener('click', () => {
    formId.value = '';
    (document.getElementById('form-meeting-title') as HTMLInputElement).value = '';
    (document.getElementById('form-meeting-datetime') as HTMLInputElement).value = '';
    (document.getElementById('form-meeting-location') as HTMLInputElement).value = '';
    (document.getElementById('form-meeting-description') as HTMLTextAreaElement).value = '';
    formAgendaKey.value = '';
    agendaFileInput.value = '';
    formTitle!.textContent = 'New meeting';
    formPanel?.classList.remove('hidden');
  });

  document.getElementById('btn-cancel-form')?.addEventListener('click', () => {
    formPanel?.classList.add('hidden');
  });

  document.querySelectorAll('.edit-meeting').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = (btn as HTMLElement).dataset.id;
      const title = (btn as HTMLElement).dataset.title;
      const datetime = (btn as HTMLElement).dataset.datetime;
      const location = (btn as HTMLElement).dataset.location ?? '';
      const description = (btn as HTMLElement).dataset.description ?? '';
      const agendaKey = (btn as HTMLElement).dataset.agendaKey ?? '';
      formId.value = id ?? '';
      (document.getElementById('form-meeting-title') as HTMLInputElement).value = title ?? '';
      (document.getElementById('form-meeting-datetime') as HTMLInputElement).value = datetime?.slice(0, 16) ?? '';
      (document.getElementById('form-meeting-location') as HTMLInputElement).value = location;
      (document.getElementById('form-meeting-description') as HTMLTextAreaElement).value = description;
      formAgendaKey.value = agendaKey;
      agendaFileInput.value = '';
      formTitle!.textContent = 'Edit meeting';
      formPanel?.classList.remove('hidden');
    });
  });

  document.querySelectorAll('.delete-meeting').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const id = (btn as HTMLElement).dataset.id;
      const title = (btn as HTMLElement).dataset.title;
      if (!id || !confirm(`Delete "${title}"? This cannot be undone.`)) return;
      try {
        const res = await fetch(`/api/meetings?id=${encodeURIComponent(id)}`, { method: 'DELETE', credentials: 'same-origin' });
        const data = await res.json();
        if (data.success) window.location.reload();
        else alert(data.error || 'Failed to delete');
      } catch {
        alert('Network error');
      }
    });
  });

  agendaFileInput?.addEventListener('change', async () => {
    const file = agendaFileInput.files?.[0];
    if (!file) return;
    const fd = new FormData();
    fd.set('file', file);
    try {
      const res = await fetch('/api/meeting-agenda-upload', { method: 'POST', body: fd, credentials: 'same-origin' });
      const data = await res.json();
      if (data.key) formAgendaKey.value = data.key;
      else alert(data.error || 'Upload failed');
    } catch {
      alert('Upload failed');
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = formId.value.trim();
    const title = (document.getElementById('form-meeting-title') as HTMLInputElement).value.trim();
    const datetime = (document.getElementById('form-meeting-datetime') as HTMLInputElement).value.trim();
    const location = (document.getElementById('form-meeting-location') as HTMLInputElement).value.trim();
    const description = (document.getElementById('form-meeting-description') as HTMLTextAreaElement).value.trim();
    const agendaKey = formAgendaKey.value.trim();

    if (!title || !datetime) {
      alert('Title and date/time are required');
      return;
    }

    const body: Record<string, string> = { title, datetime, location, description, agenda_r2_key: agendaKey };
    const url = '/api/meetings';
    const method = id ? 'PUT' : 'POST';
    if (id) body.id = id;

    try {
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        credentials: 'same-origin',
      });
      const data = await res.json();
      if (data.success) window.location.reload();
      else alert(data.error || 'Failed to save');
    } catch {
      alert('Network error');
    }
  });
</script>
</BoardLayout>

