---
export const prerender = false;

import PortalLayout from '../../../../layouts/PortalLayout.astro';
import ProtectedPage from '../../../../components/ProtectedPage.astro';
import PortalNav from '../../../../components/PortalNav.astro';
import { getPortalContext } from '../../../../lib/portal-context';
import { SESSION_COOKIE_NAME } from '../../../../lib/auth';
import { getArbRequest, listArbFilesByRequest, listArbRequestsByHousehold } from '../../../../lib/arb-db';
import { listEmailsAtSameAddress } from '../../../../lib/directory-db.js';
import type { ArbFile } from '../../../../lib/arb-db';

const { id } = Astro.params;
const { env, session: sessionFromContext, effectiveRole } = await getPortalContext(Astro, { fingerprint: true });
if (!sessionFromContext) return Astro.redirect('/auth/login');
let session = sessionFromContext;

// Always ensure session has a CSRF token (update activity and refresh token if needed)
// This handles old sessions that were created before CSRF tokens were added
if (!session.csrfToken && env?.SESSION_SECRET) {
  // Generate CSRF token and update session
  // We already have a valid session, so we can safely add the CSRF token
  const crypto = globalThis.crypto;
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  const csrfToken = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');

  // Update session payload with CSRF token
  const updatedPayload = {
    ...session,
    csrfToken,
    lastActivity: Math.floor(Date.now() / 1000),
  };

  // Sign the updated payload
  const encoder = new TextEncoder();
  const data = encoder.encode(JSON.stringify(updatedPayload));
  const key = await crypto.subtle.importKey(
    'raw',
    encoder.encode(env.SESSION_SECRET),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  const sig = await crypto.subtle.sign('HMAC', key, data);
  const payloadB64 = btoa(String.fromCharCode(...new Uint8Array(data)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
  const sigB64 = btoa(String.fromCharCode(...new Uint8Array(sig)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
  const newCookieValue = `${payloadB64}.${sigB64}`;

  // Update session object and set cookie
  session = updatedPayload;
  const isSecure = Astro.url.protocol === 'https:';
  const secureFlag = isSecure ? '; Secure' : '';
  Astro.response.headers.set(
    'Set-Cookie',
    `${SESSION_COOKIE_NAME}=${newCookieValue}; HttpOnly${secureFlag}; SameSite=Lax; Path=/; Max-Age=${7 * 24 * 60 * 60}`
  );
}

// Final check: if session still doesn't have CSRF token, something is wrong
if (!session.csrfToken) {
  // This shouldn't happen, but if it does, redirect to force re-login
  return Astro.redirect('/auth/login');
}

const db = env?.DB;
if (!db || !id) {
  return Astro.redirect('/portal/my-requests');
}

// Get draft count for navigation badge
const allRequests = await listArbRequestsByHousehold(db, session.email);
const draftCount = allRequests.filter(r => r.status === 'pending').length;

const req = await getArbRequest(db, id);
if (!req) {
  // Request not found - redirect to my-requests
  return Astro.redirect('/portal/my-requests');
}
const householdEmails = await listEmailsAtSameAddress(db, req.owner_email);
if (!householdEmails.includes(session.email.trim().toLowerCase())) {
  // Not in this request's household - redirect to my-requests
  return Astro.redirect('/portal/my-requests');
}
if (req.status !== 'pending') {
  // Only pending requests can be edited
  // (Requests sent back for revision should have status 'pending' again)
  // Status is: {req.status} - redirecting to my-requests
  return Astro.redirect('/portal/my-requests');
}

const existingFiles: ArbFile[] = db ? await listArbFilesByRequest(db, id) : [];
const applicationTypes = ['Exterior Paint', 'Landscape Installation', 'Swimming Pool', 'Recreational Equipment', 'Fencing', 'Other'];
const selectedTypes = req.application_type ? req.application_type.split(',').map((s: string) => s.trim()).filter(Boolean) : [];
---

<PortalLayout title="Edit ARB Request | Member Portal | Crooked Lake Reserve HOA">
  <ProtectedPage>
  <div class="min-h-screen portal-theme-bg font-body">
    <PortalNav currentPath="/portal/my-requests" draftCount={draftCount} role={effectiveRole} staffRole={session?.role ?? ''} />

    <main class="max-w-2xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
      <h2 class="text-2xl font-heading font-bold text-clr-green mb-2">Edit ARB request #{req.id}</h2>
      <p class="text-gray-600 mb-6">Update the details below and save. Changes are saved electronically. Only pending requests can be edited. Existing attachments are kept. <a href="/arb-request-how-to" class="text-clr-orange hover:underline">How to submit an ARB request</a></p>

      {req.revision_notes && (
        <div class="mb-6 rounded-xl border-2 border-amber-200 bg-amber-50 p-4">
          <p class="text-sm font-semibold text-amber-900 mb-1">ARB requested revisions</p>
          <p class="text-sm text-amber-900 whitespace-pre-wrap">{req.revision_notes}</p>
          <p class="text-xs text-amber-700 mt-2">Address the items above, then save and submit for review again.</p>
        </div>
      )}

      <form
        id="arb-edit-form"
        class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 space-y-5"
        method="post"
        action="/api/arb-update"
      >
        <input type="hidden" name="request_id" value={req.id} />

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="applicant_name" class="block text-sm font-semibold text-gray-700 mb-1">Applicant's name <span class="text-red-600" aria-label="required">*</span></label>
            <input id="applicant_name" name="applicant_name" type="text" required value={req.applicant_name ?? ''} class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-clr-green focus:ring-1 focus:ring-clr-green" placeholder="Your full name" />
          </div>
          <div>
            <label for="phone" class="block text-sm font-semibold text-gray-700 mb-1">Phone number <span class="text-red-600" aria-label="required">*</span></label>
            <input id="phone" name="phone" type="tel" required value={req.phone ?? ''} class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-clr-green focus:ring-1 focus:ring-clr-green" placeholder="(555) 555-5555" />
          </div>
        </div>

        <div>
          <label for="property_address" class="block text-sm font-semibold text-gray-700 mb-1">Property address <span class="text-red-600" aria-label="required">*</span></label>
          <input id="property_address" name="property_address" type="text" required value={req.property_address ?? ''} class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-clr-green focus:ring-1 focus:ring-clr-green" placeholder="Street, lot or address" />
        </div>

        <div>
          <span class="block text-sm font-semibold text-gray-700 mb-2">Application for</span>
          <div class="flex flex-wrap gap-x-6 gap-y-2">
            {applicationTypes.map((type) => (
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" name="application_type" value={type} checked={selectedTypes.includes(type)} class="rounded border-gray-300 text-clr-green focus:ring-clr-green" />
                <span class="text-sm">{type}</span>
              </label>
            ))}
          </div>
        </div>

        <div>
          <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">Description of changes <span class="text-red-600" aria-label="required">*</span></label>
          <textarea
            id="description"
            name="description"
            rows="5"
            required
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-clr-green focus:ring-1 focus:ring-clr-green"
            placeholder="Describe the modification or project in detail..."
          >{req.description}</textarea>
        </div>

        {req.status === 'pending' && (
          <div>
            <label for="owner_notes" class="block text-sm font-semibold text-gray-700 mb-1">
              Your notes <span class="text-gray-400 font-normal">(optional)</span>
              <span class="ml-1 text-gray-400 cursor-help" title="Add notes for your reference. These are visible to you and ARB members." aria-label="Help: Owner notes">(i)</span>
            </label>
            <textarea
              id="owner_notes"
              name="owner_notes"
              rows="3"
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-clr-green focus:ring-1 focus:ring-clr-green"
              placeholder="Add any notes or context for ARB members..."
            >{req.owner_notes ?? ''}</textarea>
          </div>
        )}

        <div class="border-t border-gray-200 pt-5">
          <p class="text-sm font-semibold text-gray-700 mb-2">Attachments</p>
          {existingFiles.length > 0 ? (
            <ul class="space-y-2 mb-4" id="current-files-list">
              {existingFiles.map((file) => (
                <li class="flex items-center justify-between gap-2 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-sm">
                  <span class="text-gray-700 truncate">{file.filename}</span>
                  <button type="button" class="remove-file shrink-0 text-red-600 hover:text-red-700 font-semibold text-xs" data-request-id={req.id} data-file-id={file.id}>Remove</button>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-sm text-gray-500 mb-4">No attachments yet.</p>
          )}
          <p class="text-sm text-gray-500 mb-2">Add more: images or PDF, 5MB per file, 25MB total. Photos are resized before upload; by adding them you confirm you have reviewed the selection.</p>
          <input type="file" id="add-files-input" name="add_files" multiple accept="image/*,application/pdf" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-clr-beige file:text-clr-green file:font-semibold" />
          <button type="button" id="add-files-btn" class="mt-2 px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-sm font-semibold text-gray-700">Add selected files</button>
          <p id="add-files-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
        </div>

        <div id="form-error" class="hidden rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-700" role="alert"></div>
        <div id="form-success" class="hidden rounded-lg bg-green-50 border border-green-200 p-4 text-sm text-green-800" role="alert"></div>

        <div class="flex flex-wrap gap-3">
          <button
            type="submit"
            name="action"
            value="save"
            id="save-btn"
            class="px-6 py-3 border-2 border-clr-green text-clr-green bg-white hover:bg-clr-green/5 font-semibold rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Save
          </button>
          <button
            type="submit"
            name="action"
            value="save_and_submit"
            id="save-submit-btn"
            class="px-6 py-3 bg-clr-green hover:brightness-110 text-white font-semibold rounded-xl shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Save and submit
          </button>
          <a href="/portal/my-requests" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50">Cancel</a>
        </div>
        <p class="mt-2 text-sm text-gray-500">Save keeps your changes and lets you continue editing. Save and submit sends your request to the ARB for review.</p>
      </form>
    </main>
  </div>

  <script is:inline define:vars={{ requestId: req.id, reviewMaxWidth: 2000, archiveMaxWidth: 1200, maxFileBytes: 5 * 1024 * 1024, maxTotalBytes: 25 * 1024 * 1024 }}>
    (function () {
      const form = document.getElementById('arb-edit-form');
      const formError = document.getElementById('form-error');
      const formSuccess = document.getElementById('form-success');
      const saveBtn = document.getElementById('save-btn');
      const saveSubmitBtn = document.getElementById('save-submit-btn');
      const addFilesInput = document.getElementById('add-files-input');
      const addFilesBtn = document.getElementById('add-files-btn');
      const addFilesError = document.getElementById('add-files-error');

      function showErr(msg) {
        if (formError) { formError.textContent = msg; formError.classList.remove('hidden'); }
      }
      function hideErr() {
        if (formError) { formError.textContent = ''; formError.classList.add('hidden'); }
      }

      if (form) {
        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          hideErr();
          formSuccess?.classList.add('hidden');
          const action = (e.submitter && e.submitter.value) || 'save';
          const doSubmitForReview = action === 'save_and_submit';
          if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving…'; }
          if (saveSubmitBtn) { saveSubmitBtn.disabled = true; saveSubmitBtn.textContent = doSubmitForReview ? 'Saving and submitting…' : 'Saving…'; }
          const formData = new FormData(form);
          formData.delete('add_files');
          try {
            const res = await fetch(form.action, { method: 'POST', body: formData });
            const data = await res.json().catch(function () { return {}; });
            if (res.ok && data.success) {
              if (doSubmitForReview) {
                const res2 = await fetch('/api/arb-resubmit', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ requestId, csrfToken: (typeof window !== 'undefined' && window.csrfToken) || '' }),
                });
                const data2 = await res2.json().catch(function () { return {}; });
                if (res2.ok && data2.success) {
                  formSuccess.textContent = 'Changes saved and request submitted for ARB review.';
                  formSuccess.classList.remove('hidden');
                  setTimeout(function () { window.location.href = '/portal/my-requests'; }, 1500);
                } else {
                  formSuccess.textContent = 'Changes saved. Submit for review from My Requests if needed.';
                  formSuccess.classList.remove('hidden');
                  if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
                  if (saveSubmitBtn) { saveSubmitBtn.disabled = false; saveSubmitBtn.textContent = 'Save and submit'; }
                }
              } else {
                formSuccess.textContent = data.message || 'Changes saved.';
                formSuccess.classList.remove('hidden');
                if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
                if (saveSubmitBtn) { saveSubmitBtn.disabled = false; saveSubmitBtn.textContent = 'Save and submit'; }
              }
            } else {
              showErr(data.error || 'Update failed. Please try again.');
              if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
              if (saveSubmitBtn) { saveSubmitBtn.disabled = false; saveSubmitBtn.textContent = 'Save and submit'; }
            }
          } catch (err) {
            showErr('Network error. Please try again.');
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
            if (saveSubmitBtn) { saveSubmitBtn.disabled = false; saveSubmitBtn.textContent = 'Save and submit'; }
          }
        });
      }

      document.querySelectorAll('.remove-file').forEach(function (btn) {
        btn.addEventListener('click', async function () {
          const fileId = this.getAttribute('data-file-id');
          if (!fileId || !confirm('Remove this attachment? This cannot be undone.')) return;
          const originalText = this.textContent;
          this.disabled = true;
          this.textContent = 'Removing…';
          try {
            const res = await fetch('/api/arb-remove-file', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ requestId, fileId, csrfToken: (typeof window !== 'undefined' && window.csrfToken) || '' }),
            });
            const data = await res.json().catch(function () { return {}; });
            if (res.ok && data.success) {
              window.location.reload();
            } else {
              alert(data.error || 'Remove failed.');
              this.disabled = false;
              this.textContent = originalText;
            }
          } catch (err) {
            alert('Network error.');
            this.disabled = false;
            this.textContent = originalText;
          }
        });
      });

      function isImageType(t) { return t && t.startsWith('image/') && t !== 'image/heic'; }
      function resizeImage(file, maxWidth, quality) {
        return new Promise(function (resolve, reject) {
          var img = new Image();
          var url = URL.createObjectURL(file);
          img.onload = function () {
            URL.revokeObjectURL(url);
            var w = img.naturalWidth, h = img.naturalHeight;
            if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
            var canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            var ctx = canvas.getContext('2d');
            if (!ctx) { reject(new Error('Canvas')); return; }
            ctx.drawImage(img, 0, 0, w, h);
            canvas.toBlob(function (blob) {
              resolve(blob ? new File([blob], file.name.replace(/\.[^.]+$/i, '.jpg'), { type: 'image/jpeg' }) : null);
            }, 'image/jpeg', quality);
          };
          img.onerror = function () { URL.revokeObjectURL(url); reject(new Error('Load')); };
          img.src = url;
        });
      }

      if (addFilesBtn && addFilesInput) {
        addFilesBtn.addEventListener('click', async function () {
          var files = Array.from(addFilesInput.files || []);
          if (files.length === 0) {
            if (addFilesError) { addFilesError.textContent = 'Select at least one file.'; addFilesError.classList.remove('hidden'); }
            return;
          }
          if (addFilesError) addFilesError.classList.add('hidden');
          addFilesBtn.disabled = true;
          addFilesBtn.textContent = 'Adding…';
          var formData = new FormData();
          formData.set('request_id', requestId);
          formData.set('csrf_token', (typeof window !== 'undefined' && window.csrfToken) || '');
          try {
            for (var i = 0; i < files.length; i++) {
              var file = files[i];
              if (file.size > maxFileBytes) {
                addFilesError.textContent = 'File "' + file.name + '" exceeds 5MB.';
                addFilesError.classList.remove('hidden');
                addFilesBtn.disabled = false;
                addFilesBtn.textContent = 'Add selected files';
                return;
              }
              if (isImageType(file.type)) {
                try {
                  var reviewFile = await resizeImage(file, reviewMaxWidth, 0.82);
                  if (reviewFile) {
                    formData.append('file_' + i, reviewFile);
                    var archiveFile = await resizeImage(file, archiveMaxWidth, 0.70);
                    if (archiveFile) formData.append('file_' + i + '_archive', archiveFile);
                  } else {
                    formData.append('file_' + i, file);
                  }
                } catch (e) {
                  formData.append('file_' + i, file);
                }
              } else {
                formData.append('file_' + i, file);
              }
            }
            var res = await fetch('/api/arb-add-files', { method: 'POST', body: formData });
            var data = await res.json().catch(function () { return {}; });
            if (res.ok && data.success) {
              addFilesInput.value = '';
              window.location.reload();
            } else {
              addFilesError.textContent = data.error || 'Add failed.';
              addFilesError.classList.remove('hidden');
            }
          } catch (err) {
            addFilesError.textContent = 'Network error.';
            addFilesError.classList.remove('hidden');
          }
          addFilesBtn.disabled = false;
          addFilesBtn.textContent = 'Add selected files';
        });
      }
    })();
  </script>
  <script is:inline define:vars={{ csrfToken: session.csrfToken ?? '' }}>
    (function () {
      // Make CSRF token available to scripts
      if (typeof window !== 'undefined') {
        window.csrfToken = csrfToken;
      }

      // Add CSRF token to form
      const form = document.getElementById('arb-edit-form');
      if (form) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
      }

      // Session timeout: Auto-logout after 30 minutes of inactivity
      const SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes
      let lastActivity = Date.now();
      let timeoutWarningShown = false;

      function resetActivity() {
        lastActivity = Date.now();
        timeoutWarningShown = false;
      }

      function checkSessionTimeout() {
        const elapsed = Date.now() - lastActivity;
        const remaining = SESSION_TIMEOUT_MS - elapsed;

        if (remaining <= 0) {
          alert('Your session has expired due to inactivity. You will be redirected to the login page.');
          window.location.href = '/portal/login';
          return;
        }

        if (remaining <= 2 * 60 * 1000 && !timeoutWarningShown) {
          timeoutWarningShown = true;
          const confirmed = confirm('Your session will expire in 2 minutes due to inactivity. Click OK to stay logged in, or Cancel to log out now.');
          if (confirmed) {
            resetActivity();
            fetch('/portal/my-requests', { method: 'HEAD' }).catch(() => {});
          } else {
            window.location.href = '/portal/login';
            return;
          }
        }
      }

      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(function (event) {
        document.addEventListener(event, resetActivity, { passive: true });
      });

      setInterval(checkSessionTimeout, 60 * 1000);
    })();
  </script>
  </ProtectedPage>
</PortalLayout>
