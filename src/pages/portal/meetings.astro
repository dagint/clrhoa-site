---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import ProtectedPage from '../../components/ProtectedPage.astro';
import PortalNav from '../../components/PortalNav.astro';
import { getSessionFromCookie } from '../../lib/auth';
import { listArbRequestsByOwner } from '../../lib/arb-db';
import { listUpcomingWithCountsAndUser } from '../../lib/meetings-db';

const runtime = Astro.locals.runtime;
const env = runtime?.env;
const userAgent = Astro.request.headers.get('user-agent') ?? null;
const ipAddress = Astro.request.headers.get('cf-connecting-ip') ?? 
  Astro.request.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ?? null;
const cookieHeader = Astro.request.headers.get('cookie') ?? undefined;
let session = await getSessionFromCookie(
  cookieHeader,
  env?.SESSION_SECRET,
  userAgent,
  ipAddress
);

if (!session && env?.SESSION_SECRET) {
  session = await getSessionFromCookie(cookieHeader, env.SESSION_SECRET);
}

if (!session) {
  return Astro.redirect('/portal/login');
}

const db = env?.DB;
const draftCount = db
  ? (await listArbRequestsByOwner(db, session.email)).filter((r) => r.status === 'pending').length
  : 0;
const meetings = db ? await listUpcomingWithCountsAndUser(db, session.email) : [];

function formatDateTime(dt: string): string {
  try {
    const d = new Date(dt);
    return d.toLocaleString('en-US', {
      weekday: 'short',
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
    });
  } catch {
    return dt;
  }
}

function googleCalendarUrl(m: { title: string | null; datetime: string; description: string | null; location: string | null }): string {
  const start = new Date(m.datetime);
  const end = new Date(start.getTime() + 60 * 60 * 1000);
  const fmt = (d: Date) => d.toISOString().replace(/[-:]/g, '').slice(0, 15) + 'Z';
  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: (m.title || 'HOA Meeting').replace(/&/g, ' and '),
    dates: `${fmt(start)}/${fmt(end)}`,
    details: (m.description || '').replace(/&/g, ' and ').slice(0, 500),
    location: (m.location || '').replace(/&/g, ' and '),
  });
  return `https://calendar.google.com/calendar/render?${params.toString()}`;
}
---

<PortalLayout title="Meetings | Member Portal | Crooked Lake Reserve HOA">
  <ProtectedPage>
  <div class="min-h-screen portal-theme-bg font-body">
    <PortalNav currentPath="/portal/meetings" draftCount={draftCount} role={session.role} />

    <main class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
      <h2 class="text-2xl font-heading font-bold text-clr-green mb-2">Meetings</h2>
      <p class="text-gray-600 mb-6">
        Upcoming meetings. RSVP to help the board plan, and add events to your calendar.
      </p>

      {meetings.length === 0 ? (
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center text-gray-500">
          No upcoming meetings scheduled.
        </div>
      ) : (
        <ul class="space-y-6">
          {meetings.map((m) => (
            <li class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
              <h3 class="text-lg font-heading font-semibold text-clr-green mb-1">{m.title || 'Meeting'}</h3>
              <p class="text-sm text-gray-500 mb-2">{formatDateTime(m.datetime)}</p>
              {m.location && <p class="text-gray-600 text-sm mb-2">Location: {m.location}</p>}
              {m.description && <p class="text-gray-600 text-sm mb-3 whitespace-pre-wrap">{m.description}</p>}
              {m.agenda_r2_key && (
                <p class="mb-3">
                  <a
                    href={`/api/portal/file/${encodeURIComponent(m.agenda_r2_key)}`}
                    class="text-clr-green font-medium hover:underline"
                  >
                    View agenda (PDF)
                  </a>
                </p>
              )}
              <div class="flex flex-wrap items-center gap-3 mb-3">
                <span class="text-sm text-gray-500">Your RSVP:</span>
                <div class="flex gap-2" data-meeting-id={m.id}>
                  <button
                    type="button"
                    class={`rsvp-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${m.user_response === 'yes' ? 'bg-clr-green text-white' : 'bg-gray-100 text-gray-700'}`}
                    data-response="yes"
                    data-meeting-id={m.id}
                  >
                    Yes
                  </button>
                  <button
                    type="button"
                    class={`rsvp-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${m.user_response === 'maybe' ? 'bg-clr-green text-white' : 'bg-gray-100 text-gray-700'}`}
                    data-response="maybe"
                    data-meeting-id={m.id}
                  >
                    Maybe
                  </button>
                  <button
                    type="button"
                    class={`rsvp-btn px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${m.user_response === 'no' ? 'bg-clr-green text-white' : 'bg-gray-100 text-gray-700'}`}
                    data-response="no"
                    data-meeting-id={m.id}
                  >
                    No
                  </button>
                </div>
                <span class="rsvp-status text-sm text-gray-600" data-meeting-id={m.id}>
                  {m.user_response ? `You responded: ${m.user_response}` : '-'}
                </span>
              </div>
              <p class="text-sm text-gray-500 mb-2">
                Counts: Yes {m.yes_count} | No {m.no_count} | Maybe {m.maybe_count}
              </p>
              <a
                href={googleCalendarUrl(m)}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm text-clr-green hover:underline"
              >
                Add to Google Calendar
              </a>
            </li>
          ))}
        </ul>
      )}
    </main>
  </div>
  </ProtectedPage>

<script>
  document.querySelectorAll('.rsvp-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const meetingId = btn.dataset.meetingId;
      const response = btn.dataset.response;
      if (!meetingId || !response) return;
      const form = new FormData();
      form.set('meeting_id', meetingId);
      form.set('response', response);
      try {
        const res = await fetch('/api/meeting-rsvp', {
          method: 'POST',
          body: form,
          credentials: 'same-origin',
        });
        const data = await res.json();
        if (data.success) {
          const statusEl = document.querySelector(`.rsvp-status[data-meeting-id="${meetingId}"]`);
          if (statusEl) statusEl.textContent = `You responded: ${response}`;
          document.querySelectorAll(`.rsvp-btn[data-meeting-id="${meetingId}"]`).forEach((b) => {
            b.classList.remove('bg-clr-green', 'text-white');
            b.classList.add('bg-gray-100', 'text-gray-700');
          });
          btn.classList.remove('bg-gray-100', 'text-gray-700');
          btn.classList.add('bg-clr-green', 'text-white');
        } else {
          alert(data.error || 'Failed to save RSVP');
        }
      } catch {
        alert('Network error. Please try again.');
      }
    });
  });
</script>
</PortalLayout>
