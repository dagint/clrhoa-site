---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import ProtectedPage from '../../components/ProtectedPage.astro';
import PortalNav from '../../components/PortalNav.astro';
import PWAInstallPrompt from '../../components/PWAInstallPrompt.astro';
import PimElevationBanner from '../../components/PimElevationBanner.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getArbRequestCountsByStatus, listArbRequestsByHousehold } from '../../lib/arb-db';
import { listPendingSubmissions } from '../../lib/vendor-submissions-db';
import { getRecentOwnersCount, listOwners, getOwnerByEmail } from '../../lib/directory-db';
import { getRecentVendorsCount } from '../../lib/vendors-db';
import { listMaintenanceByHousehold } from '../../lib/maintenance-db';
import { listUpcomingWithCountsAndUser, householdHasRsvpd } from '../../lib/meetings-db';
import { listActiveFeedbackDocs, getFeedbackResponse, householdHasResponded } from '../../lib/feedback-db';
import { getDismissedKeys } from '../../lib/notification-dismissals';

const { env, session, effectiveRole } = await getPortalContext(Astro, { fingerprint: true });
if (!session) return Astro.redirect('/portal/login');

const { email, role, name } = session;
const db = env?.DB;
// Use session name when set; otherwise fall back to directory (owner) name so "Welcome back, Michael" works
let displayName = name?.trim() || null;
if (!displayName && db) {
  const owner = await getOwnerByEmail(db, email);
  displayName = owner?.name?.trim() || null;
}
const firstName = displayName ? displayName.split(/\s+/)[0] ?? null : null;
let arbCounts: { pending: number; in_review: number } = { pending: 0, in_review: 0 };
let pendingVendorCount = 0;
const isStaffRole = effectiveRole === 'arb' || effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board';
const hasStaffWhitelistRole = role === 'arb' || role === 'board' || role === 'admin' || role === 'arb_board';
const canRequestElevation = hasStaffWhitelistRole && !isStaffRole;
// Load ARB and vendor counts for any staff (by whitelist) so we can show outstanding items even when not elevated
if (db && hasStaffWhitelistRole) {
  const counts = await getArbRequestCountsByStatus(db);
  arbCounts = { pending: counts.pending, in_review: counts.in_review };
  const pendingSubmissions = await listPendingSubmissions(db);
  pendingVendorCount = pendingSubmissions.length;
}

// Get draft count for navigation badge
const allRequests = db ? await listArbRequestsByHousehold(db, email) : [];
const draftCount = allRequests.filter(r => r.status === 'pending').length;

// Quick action badge counts
let maintenanceOpenCount = 0;
let meetingsRsvpCount = 0;
let feedbackDueCount = 0;
if (db) {
  const maintenanceList = await listMaintenanceByHousehold(db, email);
  maintenanceOpenCount = maintenanceList.filter((m) => m.status !== 'completed').length;
  const upcomingMeetings = await listUpcomingWithCountsAndUser(db, email);
  meetingsRsvpCount = 0;
  for (const m of upcomingMeetings) {
    if (m.user_response != null) continue;
    if (await householdHasRsvpd(db, m.id, email)) continue;
    meetingsRsvpCount += 1;
  }
  const activeFeedback = await listActiveFeedbackDocs(db);
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().slice(0, 10);
  for (const doc of activeFeedback) {
    const resp = await getFeedbackResponse(db, doc.id, email);
    if (resp) continue;
    if (await householdHasResponded(db, doc.id, email)) continue;
    if (doc.deadline == null || doc.deadline <= tomorrowStr) feedbackDueCount += 1;
  }
}
const directoryCount = db ? (await listOwners(db)).length : 0;

// Notices: new vendors and new directory members (last 30 days)
const RECENT_DAYS = 30;
let recentVendorsCount = 0;
let recentOwnersCount = 0;
if (db) {
  recentVendorsCount = await getRecentVendorsCount(db, RECENT_DAYS);
  recentOwnersCount = await getRecentOwnersCount(db, RECENT_DAYS);
}
const hasNewNotices = recentVendorsCount > 0 || recentOwnersCount > 0;

// ARB badge for dashboard tile: my pending drafts (or for staff, board pending count)
const arbBadgeCount = isStaffRole ? arbCounts.pending : draftCount;
const showPimBanner = isStaffRole && typeof session.elevated_until === 'number' && session.elevated_until > Date.now();

// Dismissals: "Mark as read" hides a notice for 7 days
const dismissedSet = db ? await getDismissedKeys(db, email) : new Set<string>();
const showStaffOutstanding = hasStaffWhitelistRole && (arbCounts.in_review > 0 || arbCounts.pending > 0 || pendingVendorCount > 0) && !dismissedSet.has('staff_outstanding');
const showActionFeedback = feedbackDueCount > 0 && !dismissedSet.has('action_feedback');
const showActionMaintenance = maintenanceOpenCount > 0 && !dismissedSet.has('action_maintenance');
const showActionMeetings = meetingsRsvpCount > 0 && !dismissedSet.has('action_meetings');
const showActionNeededBanner = showActionFeedback || showActionMaintenance || showActionMeetings;
---

<PortalLayout title="Dashboard | Member Portal | Crooked Lake Reserve HOA">
  <ProtectedPage>
  <div class="min-h-screen bg-gray-50 portal-theme-bg font-body" id="portal-root">
    {showPimBanner && <PimElevationBanner elevatedUntil={session.elevated_until!} role={effectiveRole} />}
    <PortalNav currentPath="/portal/dashboard" draftCount={draftCount} role={effectiveRole} staffRole={session.role ?? ''} arbInReviewCount={arbCounts.in_review} vendorPendingCount={pendingVendorCount} />

      <main class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 portal-theme-card portal-card-accent p-6 sm:p-8">
          <h2 class="text-2xl font-heading font-bold text-clr-green mb-6">
            Welcome back{firstName ? `, ${firstName}` : ''} ({email})
          </h2>

          {hasStaffWhitelistRole && (
            <div class="mb-6 p-4 rounded-xl bg-amber-50 border border-amber-200" role="region" aria-label="Elevated access">
              <p class="text-sm font-semibold text-amber-900 mb-2">Board / ARB / Admin access</p>
              {canRequestElevation ? (
                <>
                  <p class="text-sm text-amber-800 mb-2">By default you see the same portal as all members. When you need to use board or ARB tools (directory, dues, meetings, ARB dashboard), click <strong>Request elevated access</strong>. You get 2 hours of access, then you’re back to normal. When you’re done, you can click <strong>Drop access</strong> anytime.</p>
                  <div class="flex flex-wrap items-center gap-3 mt-3">
                    <button type="button" id="pim-elevate-btn" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium text-sm">Request elevated access</button>
                    <a href="/portal/elevation-audit" class="text-sm text-amber-800 hover:text-amber-900 underline">View elevation audit (read-only)</a>
                  </div>
                </>
              ) : (
                <p class="text-sm text-amber-800 mb-2">You have elevated access. When you’re done, click <strong>Drop access</strong> in the banner above to return to normal member view. <a href="/portal/elevation-audit" class="text-amber-900 underline hover:no-underline">View elevation audit (read-only)</a> to see when others requested or dropped access.</p>
              )}
            </div>
          )}

          {/* Outstanding items for Board/ARB — visible even when not elevated so they know what needs attention */}
          {showStaffOutstanding && (
            <div class="mb-6 p-4 rounded-xl bg-amber-50/80 border border-amber-200" role="region" aria-label="Outstanding Board and ARB items">
              <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
                <p class="text-sm font-semibold text-amber-900">Outstanding items requiring your action</p>
                <button type="button" class="notification-dismiss text-xs text-amber-700 hover:text-amber-900 underline" data-key="staff_outstanding" aria-label="Mark as read">Mark as read</button>
              </div>
              {!isStaffRole && <p class="text-sm text-amber-800 mb-3">The following need attention. You must request elevated access to act on them.</p>}
              <ul class="list-none space-y-1.5 mb-3">
                {(arbCounts.in_review > 0 || arbCounts.pending > 0) && (
                  <li>
                    <a href={isStaffRole ? '/portal/arb-dashboard' : '/portal/request-elevated-access?return=' + encodeURIComponent('/portal/arb-dashboard')} class="text-sm font-medium text-amber-900 hover:text-amber-700 underline">
                      ARB: {arbCounts.in_review} in review, {arbCounts.pending} pending
                    </a>
                  </li>
                )}
                {pendingVendorCount > 0 && (
                  <li>
                    <a href={isStaffRole ? '/board/vendors' : '/portal/request-elevated-access?return=' + encodeURIComponent('/board/vendors')} class="text-sm font-medium text-amber-900 hover:text-amber-700 underline">
                      Vendor submissions: {pendingVendorCount} pending
                    </a>
                  </li>
                )}
              </ul>
              {!isStaffRole && (
                <a href="/portal/request-elevated-access" class="inline-block bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-medium text-sm">Request elevated access to complete these</a>
              )}
            </div>
          )}

          {/* Action needed: for all members when they have feedback due, open maintenance, or meetings to RSVP */}
          {showActionNeededBanner && (
            <div class="mb-6 p-4 rounded-xl bg-clr-green/10 border border-clr-green/30" role="region" aria-label="Action needed">
              <p class="text-sm font-semibold text-clr-green mb-2">Action needed</p>
              <p class="text-sm text-gray-700 mb-3">You have outstanding items that need your attention. Use <strong>Mark as read</strong> to hide an item for 7 days.</p>
              <ul class="list-none space-y-2 mb-0">
                {showActionFeedback && (
                  <li class="flex flex-wrap items-center gap-2">
                    <a href="/portal/feedback" class="inline-flex items-center gap-2 text-sm font-medium text-clr-green hover:underline">
                      Document feedback: {feedbackDueCount} due for your review
                    </a>
                    <button type="button" class="notification-dismiss text-xs text-gray-600 hover:text-clr-green underline" data-key="action_feedback" aria-label="Mark as read">Mark as read</button>
                  </li>
                )}
                {showActionMaintenance && (
                  <li class="flex flex-wrap items-center gap-2">
                    <a href="/portal/maintenance" class="inline-flex items-center gap-2 text-sm font-medium text-clr-green hover:underline">
                      Maintenance: {maintenanceOpenCount} open request{maintenanceOpenCount === 1 ? '' : 's'}
                    </a>
                    <button type="button" class="notification-dismiss text-xs text-gray-600 hover:text-clr-green underline" data-key="action_maintenance" aria-label="Mark as read">Mark as read</button>
                  </li>
                )}
                {showActionMeetings && (
                  <li class="flex flex-wrap items-center gap-2">
                    <a href="/portal/meetings" class="inline-flex items-center gap-2 text-sm font-medium text-clr-green hover:underline">
                      Meetings: RSVP for {meetingsRsvpCount} upcoming meeting{meetingsRsvpCount === 1 ? '' : 's'}
                    </a>
                    <button type="button" class="notification-dismiss text-xs text-gray-600 hover:text-clr-green underline" data-key="action_meetings" aria-label="Mark as read">Mark as read</button>
                  </li>
                )}
              </ul>
            </div>
          )}

          <p class="text-sm text-gray-600 mb-4">Choose an action below to get started.</p>

          {hasNewNotices && (
            <div class="mb-6 p-4 rounded-xl bg-clr-green/10 border border-clr-green/20" role="region" aria-label="Recent updates">
              <p class="text-sm font-semibold text-clr-green mb-2">Recent updates</p>
              <ul class="text-sm text-gray-700 portal-theme-text space-y-1">
                {recentVendorsCount > 0 && (
                  <li>
                    <a href="/portal/vendors" class="text-clr-green hover:underline font-medium">
                      {recentVendorsCount} new vendor{recentVendorsCount === 1 ? '' : 's'} added
                    </a>
                    <span class="text-gray-500 portal-theme-text-muted"> in the last {RECENT_DAYS} days</span>
                  </li>
                )}
                {recentOwnersCount > 0 && (
                  <li>
                    <a href="/portal/directory" class="text-clr-green hover:underline font-medium">
                      {recentOwnersCount} new member{recentOwnersCount === 1 ? '' : 's'} in the directory
                    </a>
                    <span class="text-gray-500 portal-theme-text-muted"> in the last {RECENT_DAYS} days</span>
                  </li>
                )}
              </ul>
            </div>
          )}

          <!-- Quick actions: clear next steps for all members -->
          <h3 class="text-base font-heading font-semibold text-gray-800 mb-3">Quick actions</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8" role="navigation" aria-label="Quick actions">
            <a href="/portal/arb-request" class="flex flex-col items-center justify-center p-6 rounded-2xl bg-clr-green hover:brightness-110 text-white shadow-md transition-all min-h-[140px]">
              <span class="mb-2 w-10 h-10 flex items-center justify-center" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></span>
              <span class="font-heading font-semibold text-center">New ARB request</span>
              {arbBadgeCount > 0 && (
                <span class="mt-2 text-sm font-medium opacity-90">{arbBadgeCount} pending</span>
              )}
            </a>
            <a href="/portal/maintenance" class="flex flex-col items-center justify-center p-6 rounded-2xl bg-clr-beige hover:brightness-95 text-clr-green shadow-md transition-all min-h-[140px]">
              <span class="mb-2 w-10 h-10 flex items-center justify-center" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></span>
              <span class="font-heading font-semibold text-center">Maintenance</span>
              {maintenanceOpenCount > 0 && (
                <span class="mt-2 text-sm font-medium">{maintenanceOpenCount} open</span>
              )}
            </a>
            <a href="/portal/meetings" class="flex flex-col items-center justify-center p-6 rounded-2xl bg-gray-100 hover:bg-gray-200 text-gray-800 portal-theme-card transition-all min-h-[140px]">
              <span class="mb-2 w-10 h-10 flex items-center justify-center" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span>
              <span class="font-heading font-semibold text-center">Upcoming meetings</span>
              {meetingsRsvpCount > 0 && (
                <span class="mt-2 text-sm font-medium text-gray-600 portal-theme-text-muted">RSVP for {meetingsRsvpCount}</span>
              )}
            </a>
            <a href="/portal/directory" class="flex flex-col items-center justify-center p-6 rounded-2xl bg-gray-100 hover:bg-gray-200 text-gray-800 portal-theme-card transition-all min-h-[140px]">
              <span class="mb-2 w-10 h-10 flex items-center justify-center" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
              <span class="font-heading font-semibold text-center">Owner directory</span>
              {directoryCount > 0 && (
                <span class="mt-2 text-sm font-medium text-gray-600 portal-theme-text-muted">{directoryCount} members</span>
              )}
            </a>
          </div>

          <!-- Notification badges summary -->
          <div class="flex flex-wrap gap-3 mb-6" role="status" aria-label="Notification summary">
            {arbBadgeCount > 0 && (
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-amber-100 text-amber-800 text-sm">
                <span aria-hidden="true">ARB:</span> {arbBadgeCount} pending
              </span>
            )}
            {maintenanceOpenCount > 0 && (
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-100 text-blue-800 text-sm">
                Maintenance: {maintenanceOpenCount} open
              </span>
            )}
            {meetingsRsvpCount > 0 && (
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-100 text-gray-800 portal-theme-card text-sm">
                Meetings: RSVP for {meetingsRsvpCount}
              </span>
            )}
            {feedbackDueCount > 0 && (
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-clr-green/15 text-clr-green text-sm">
                Feedback: {feedbackDueCount} due
              </span>
            )}
          </div>

          <p class="text-sm text-gray-500 portal-theme-text-muted">
            Your role: <strong class="text-clr-green">{effectiveRole}</strong>
          </p>
          <p class="text-sm text-gray-600 mt-4">
            <a href="/arb-request-how-to" class="text-clr-orange hover:underline">How to submit an ARB request</a>
          </p>
          {isStaffRole && (
            <section class="mt-6 p-4 rounded-xl bg-gray-50 border border-gray-200" aria-labelledby="quick-actions-heading">
              <h3 id="quick-actions-heading" class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-3">Quick actions</h3>
              <div class="flex flex-wrap gap-3">
                {(effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board') && (
                  <a href="/board/assessments" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-clr-green hover:brightness-110 text-white font-semibold text-sm shadow-sm">
                    Record payment
                  </a>
                )}
                {(effectiveRole === 'arb' || effectiveRole === 'admin' || effectiveRole === 'arb_board') && (
                  <a href="/portal/arb-dashboard" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border-2 border-clr-green text-clr-green hover:bg-clr-green/10 font-semibold text-sm">
                    ARB Dashboard
                    {(arbCounts.pending > 0 || arbCounts.in_review > 0) && (
                      <span class="inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1 rounded-full bg-amber-500 text-white text-xs font-bold" aria-label={`${arbCounts.in_review} in review, ${arbCounts.pending} pending`}>{arbCounts.in_review + arbCounts.pending}</span>
                    )}
                  </a>
                )}
                {(effectiveRole === 'board' || effectiveRole === 'admin' || effectiveRole === 'arb_board') && (
                  <a href="/board/vendors" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border-2 border-gray-300 text-gray-700 hover:bg-gray-100 font-semibold text-sm">
                    Vendor submissions
                    {pendingVendorCount > 0 && (
                      <span class="inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1 rounded-full bg-amber-500 text-white text-xs font-bold" aria-label={`${pendingVendorCount} pending`}>{pendingVendorCount}</span>
                    )}
                  </a>
                )}
                <a href="/portal/board" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl border border-gray-300 text-gray-600 hover:bg-gray-100 font-medium text-sm">
                  Board home
                </a>
              </div>
            </section>
          )}
        </div>
      </main>
  </div>
  <PWAInstallPrompt />
  <script>
    document.getElementById('pim-elevate-btn')?.addEventListener('click', function () {
      const btn = this as HTMLButtonElement;
      btn.disabled = true;
      fetch('/api/pim/elevate', { method: 'POST', credentials: 'same-origin' })
        .then(function (r) {
          if (r.ok) window.location.reload();
          else btn.disabled = false;
        })
        .catch(function () { btn.disabled = false; });
    });

    document.querySelectorAll('.notification-dismiss').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const key = (this as HTMLElement).getAttribute('data-key');
        if (!key) return;
        const el = this as HTMLButtonElement;
        el.disabled = true;
        fetch('/api/notifications/dismiss', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key }),
        })
          .then(function (r) {
            if (r.ok) window.location.reload();
            else el.disabled = false;
          })
          .catch(function () { el.disabled = false; });
      });
    });
  </script>
  </ProtectedPage>
</PortalLayout>
