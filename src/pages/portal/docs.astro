---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import ProtectedPage from '../../components/ProtectedPage.astro';
import PortalNav from '../../components/PortalNav.astro';
import GlobalSearch from '../../components/GlobalSearch.astro';
import { getPortalContext } from '../../lib/portal-context';
import { listArbRequestsByOwner } from '../../lib/arb-db';

const { env, session } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/portal/login');

const db = env?.DB;
const allRequests = db ? await listArbRequestsByOwner(db, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;
---

<PortalLayout title="Documentation | Member Portal | Crooked Lake Reserve HOA">
  <ProtectedPage>
  <div class="min-h-screen bg-gray-50 portal-theme-bg font-body">
    <GlobalSearch fixed={true} class="portal-theme-header" />
    <div class="pt-14">
      <PortalNav currentPath="/portal/docs" draftCount={draftCount} role={session.role} />

      <main class="max-w-4xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
        <h1 class="text-2xl font-heading font-bold text-clr-green mb-2">Portal documentation</h1>
        <p class="text-gray-600 portal-theme-text-muted mb-8">
          A short guide to the member portal. Use the links above to jump to a section.
        </p>

        <nav aria-label="Documentation sections" class="mb-10">
          <ul class="flex flex-wrap gap-2">
            <li><a href="#home" class="text-sm text-clr-green hover:underline font-medium">Home</a></li>
            <li><a href="#directory" class="text-sm text-clr-green hover:underline font-medium">Directory</a></li>
            <li><a href="#documents" class="text-sm text-clr-green hover:underline font-medium">Documents</a></li>
            <li><a href="#my-account" class="text-sm text-clr-green hover:underline font-medium">My account</a></li>
            <li><a href="#requests" class="text-sm text-clr-green hover:underline font-medium">Requests &amp; submissions</a></li>
            <li><a href="#community" class="text-sm text-clr-green hover:underline font-medium">Meetings &amp; feedback</a></li>
            <li><a href="#help" class="text-sm text-clr-green hover:underline font-medium">Help</a></li>
          </ul>
        </nav>

        <div class="space-y-10">
          <section id="home" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 portal-theme-card">
            <h2 class="text-xl font-heading font-bold text-clr-green mb-3">Home (Dashboard)</h2>
            <p class="text-gray-700 portal-theme-text">
              Your starting page after you sign in. From here you can quickly open a new ARB request, report maintenance, see upcoming meetings, and go to the member directory. The dashboard shows a short summary of what needs your attention.
            </p>
          </section>

          <section id="directory" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 portal-theme-card">
            <h2 class="text-xl font-heading font-bold text-clr-green mb-3">Directory</h2>
            <p class="text-gray-700 portal-theme-text">
              A list of members and their contact information. You can see names and addresses; phone numbers and emails are hidden until you click &quot;Reveal&quot; so the board can track who views contact details. Your own listing is managed under <strong>My account</strong>.
            </p>
          </section>

          <section id="documents" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 portal-theme-card">
            <h2 class="text-xl font-heading font-bold text-clr-green mb-3">Documents</h2>
            <p class="text-gray-700 portal-theme-text">
              HOA documents such as bylaws, meeting minutes, and notices. Open any document to view or download it.
            </p>
          </section>

          <section id="my-account" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 portal-theme-card">
            <h2 class="text-xl font-heading font-bold text-clr-green mb-3">My account (Profile)</h2>
            <p class="text-gray-700 portal-theme-text">
              Update your directory listing (name, address, phone numbers) and your notification preferences. Here you can choose which emails you receive, opt in or out of SMS alerts, and enable or disable browser push notifications. Your login email is fixed and cannot be changed here.
            </p>
          </section>

          <section id="requests" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 portal-theme-card">
            <h2 class="text-xl font-heading font-bold text-clr-green mb-3">Requests and submissions</h2>
            <ul class="list-disc list-inside text-gray-700 portal-theme-text space-y-2 mt-2">
              <li><strong>My requests</strong> – View and manage your architectural review (ARB) requests. You can save drafts, edit pending requests, and see status and ARB feedback.</li>
              <li><strong>New ARB request</strong> – Submit a new application for exterior changes (fence, paint, landscaping, etc.). Fill out the form and attach photos or documents. You can use an item from the <strong>Pre-approval library</strong> as a template.</li>
              <li><strong>Maintenance</strong> – Report a maintenance issue (e.g. road, common area). The board can assign a vendor and update the status.</li>
              <li><strong>Vendors</strong> – See board-recommended vendors and suggest new ones. Suggested vendors are reviewed before they appear on the list.</li>
              <li><strong>Pre-approval library</strong> – Browse pre-approved designs. Use one as a template when submitting an ARB request to speed up your application.</li>
              <li><strong>Assessments</strong> – View your balance and payment history. Payment is made by the method specified by the board (e.g. check); the portal does not process payments.</li>
            </ul>
          </section>

          <section id="community" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 portal-theme-card">
            <h2 class="text-xl font-heading font-bold text-clr-green mb-3">Meetings and feedback</h2>
            <p class="text-gray-700 portal-theme-text mb-3">
              <strong>Meetings</strong> – Upcoming board and community meetings. You can RSVP and add the event to your calendar.
            </p>
            <p class="text-gray-700 portal-theme-text">
              <strong>Feedback</strong> – When the board posts a document for feedback or sign-off (e.g. a policy or amendment), you can review it and submit your response (approve, reject, or comment).
            </p>
          </section>

          <section id="help" class="bg-white rounded-2xl border border-gray-100 p-6 sm:p-8 portal-theme-card">
            <h2 class="text-xl font-heading font-bold text-clr-green mb-3">Help</h2>
            <p class="text-gray-700 portal-theme-text">
              Use <strong>Documentation</strong> (this page) for an overview of each section. Use <strong>FAQ</strong> for answers to common questions about the portal. You can also search from the bar at the top to find ARB requests, meetings, vendors, directory entries, and library items.
            </p>
          </section>
        </div>
      </main>
    </div>
  </div>
  </ProtectedPage>
</PortalLayout>
