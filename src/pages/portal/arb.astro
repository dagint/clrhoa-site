---
/**
 * ARB Landing Zone: /portal/arb
 *
 * Required permissions: effectiveRole === 'arb' or 'arb_board'
 *
 * Route-level guard: Uses getArbContext() to enforce ARB-only access.
 * Redirects non-ARB users to their appropriate landing zone:
 * - admin → /portal/admin
 * - board → /portal/board
 * - arb/arb_board whitelist but not elevated → /portal/request-elevated-access
 * - member → /portal/dashboard
 *
 * When a user elevates to ARB role (via PIM), they are redirected here.
 * When a user de-elevates or PIM expires, they revert to member role and see /portal/dashboard.
 */
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import ArbNav from '../../components/ArbNav.astro';
import { getArbContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';

// Route-level guard: enforce ARB-only access
const ctx = await getArbContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);
---

<PortalLayout title="ARB | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/arb"
    pageTitle="ARB"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <ArbNav currentPath="/portal/arb" />

    <div class="mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-2">ARB</h1>
      <p class="text-gray-600 text-lg">Review ARB requests and manage the pre-approval library. Board tools (directory, dues, documents) require Board role or Act as Board.</p>
    </div>
    <div class="mb-8 flex flex-wrap gap-4">
      <a href="/portal/arb-dashboard" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-clr-green hover:brightness-110 text-white font-semibold text-base shadow-sm">
        ARB Dashboard
        {badges.arbInReviewCount > 0 && (
          <span class="inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1 rounded-full bg-amber-500 text-white text-xs font-bold">{badges.arbInReviewCount}</span>
        )}
      </a>
      <a href="/board/library" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl border-2 border-gray-300 text-gray-700 hover:bg-gray-100 font-semibold text-base">
        Pre-approval library
      </a>
    </div>
    <p class="text-base text-gray-500">Use the banner to <strong>Act as Board</strong> when you need directory, dues, meetings, or other board-only tools (arb_board only).</p>
  </PortalPage>
</PortalLayout>
