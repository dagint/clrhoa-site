---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { listPortalNewsItems, getNewsItemImageKeys } from '../../lib/news-items-db';

const { env, session, effectiveRole } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/portal/login');

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);

const PORTAL_NEWS_PAGE_SIZES = [10, 25, 50, 100] as const;
const DEFAULT_PORTAL_NEWS_PAGE_SIZE = 25;
const url = Astro.url;

const getPage = (): number => {
  const p = url.searchParams.get('page');
  const n = p ? parseInt(p, 10) : 1;
  return Number.isNaN(n) || n < 1 ? 1 : Math.min(n, 1000);
};

const getLimit = (): number => {
  const p = url.searchParams.get('limit');
  const n = p ? parseInt(p, 10) : DEFAULT_PORTAL_NEWS_PAGE_SIZE;
  return PORTAL_NEWS_PAGE_SIZES.includes(n as (typeof PORTAL_NEWS_PAGE_SIZES)[number]) ? n : DEFAULT_PORTAL_NEWS_PAGE_SIZE;
};

const page = getPage();
const pageSize = getLimit();

function portalNewsPageUrl(value: number): string {
  const u = new URL(url);
  if (value <= 1) u.searchParams.delete('page');
  else u.searchParams.set('page', String(value));
  if (pageSize !== DEFAULT_PORTAL_NEWS_PAGE_SIZE) u.searchParams.set('limit', String(pageSize));
  return u.pathname + u.search;
}

const items = db ? await listPortalNewsItems(db, pageSize, (page - 1) * pageSize) : [];

function formatDate(s: string | null): string {
  if (!s) return '—';
  try {
    return new Date(s).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  } catch {
    return s;
  }
}
---

<PortalLayout title="News & Announcements | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/news"
    pageTitle="Board Announcements"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-3">Board Announcements</h1>
      <p class="text-gray-600 text-lg">
        News and announcements from the board. Members-only items are not visible on the public site.
      </p>
    </div>

    {items.length === 0 && page === 1 ? (
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        <p class="text-gray-500 text-lg mb-2">No announcements yet</p>
        <p class="text-gray-400">Check back later for news from the board</p>
      </div>
    ) : (
      <>
        <div class="flex flex-wrap items-center gap-3 mb-6">
          <label for="portal-news-per-page" class="text-base font-medium text-gray-700">Items per page:</label>
          <select
            id="portal-news-per-page"
            name="limit"
            class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-base text-gray-700 focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green"
          >
            {PORTAL_NEWS_PAGE_SIZES.map((size) => (
              <option value={size} selected={pageSize === size}>{size}</option>
            ))}
          </select>
        </div>

        <div class="space-y-6">
          {items.map((item) => {
            const imageKeys = getNewsItemImageKeys(item);
            return (
              <article class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sm:p-8 hover:shadow-md transition-shadow">
                <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
                  <h2 class="text-2xl font-heading font-semibold text-clr-green">{item.title}</h2>
                  <div class="flex flex-col items-end gap-1">
                    <time class="text-base text-gray-600" datetime={item.created_at ?? undefined}>
                      {formatDate(item.created_at)}
                    </time>
                    {item.is_public === 1 ? (
                      <span class="inline-block px-3 py-1 text-sm font-medium rounded-lg bg-green-100 text-green-800">
                        Public
                      </span>
                    ) : (
                      <span class="inline-block px-3 py-1 text-sm font-medium rounded-lg bg-amber-100 text-amber-800">
                        Members Only
                      </span>
                    )}
                  </div>
                </div>

                <div class="prose prose-gray max-w-none text-base whitespace-pre-wrap leading-relaxed">
                  {item.body}
                </div>

                {imageKeys.length > 0 && (
                  <div class="mt-6 flex flex-wrap gap-3">
                    {imageKeys.slice(0, 6).map((key) => (
                      <img
                        src={`/api/news-file/${key}`}
                        alt=""
                        class="w-24 h-24 object-cover rounded-lg border-2 border-gray-200 hover:border-clr-green transition-colors cursor-pointer"
                        loading="lazy"
                      />
                    ))}
                    {imageKeys.length > 6 && (
                      <span class="flex items-center text-sm text-gray-500 font-medium">
                        +{imageKeys.length - 6} more
                      </span>
                    )}
                  </div>
                )}

                {item.is_public === 1 && (
                  <div class="mt-6 pt-6 border-t border-gray-200">
                    <a
                      href={`/news/item/${item.id}`}
                      class="inline-flex items-center gap-2 text-clr-orange font-semibold hover:underline text-base"
                    >
                      <span>View on public site</span>
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </a>
                  </div>
                )}
              </article>
            );
          })}
        </div>

        {items.length > 0 && (
          <nav class="flex items-center justify-between gap-4 mt-8 p-4 border-t border-gray-200 bg-gray-50 rounded-xl" aria-label="News pagination">
            <span class="text-base text-gray-700 font-medium">Page {page}</span>
            <div class="flex gap-3">
              {page > 1 && (
                <a
                  href={portalNewsPageUrl(page - 1)}
                  class="px-5 py-2 bg-white border border-gray-300 rounded-lg text-base text-gray-700 font-medium hover:bg-gray-100 transition-colors"
                >
                  ← Previous
                </a>
              )}
              {items.length === pageSize && (
                <a
                  href={portalNewsPageUrl(page + 1)}
                  class="px-5 py-2 bg-clr-green text-white rounded-lg text-base font-semibold hover:brightness-110 transition-all"
                >
                  Next →
                </a>
              )}
            </div>
          </nav>
        )}

        <script is:inline>
          document.getElementById('portal-news-per-page')?.addEventListener('change', function () {
            const limit = this.value;
            const u = new URL(window.location.href);
            u.searchParams.set('limit', limit);
            u.searchParams.delete('page');
            if (limit === '25') u.searchParams.delete('limit');
            window.location.href = u.pathname + u.search;
          });
        </script>
      </>
    )}
  </PortalPage>
</PortalLayout>
