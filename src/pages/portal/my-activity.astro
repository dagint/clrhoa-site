---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { listDirectoryLogsByViewer } from '../../lib/directory-db';
import { listArbAuditLogForOwner } from '../../lib/arb-db';
import { getLastLogonTime, listLoginHistoryByEmail } from '../../lib/login-history-db';

const { env, session, effectiveRole } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/auth/login');

const ACTIVITY_PAGE_SIZES = [10, 25, 50, 100] as const;
const DEFAULT_PAGE_SIZE = 10;
const url = Astro.url;
const getPage = (key: string): number => {
  const p = url.searchParams.get(key);
  const n = p ? parseInt(p, 10) : 1;
  return Number.isNaN(n) || n < 1 ? 1 : Math.min(n, 500);
};
const getLimit = (): number => {
  const p = url.searchParams.get('limit');
  const n = p ? parseInt(p, 10) : DEFAULT_PAGE_SIZE;
  return ACTIVITY_PAGE_SIZES.includes(n as (typeof ACTIVITY_PAGE_SIZES)[number]) ? n : DEFAULT_PAGE_SIZE;
};
const dirPage = getPage('dir_page');
const arbPage = getPage('arb_page');
const loginPage = getPage('login_page');
const pageSize = getLimit();

function activityPageUrl(key: string, value: number): string {
  const u = new URL(url);
  if (value <= 1) u.searchParams.delete(key);
  else u.searchParams.set(key, String(value));
  if (pageSize !== DEFAULT_PAGE_SIZE) u.searchParams.set('limit', String(pageSize));
  return u.pathname + u.search;
}

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);
const dirLogs = db ? await listDirectoryLogsByViewer(db, email, pageSize, (dirPage - 1) * pageSize) : [];
const arbLogs = db ? await listArbAuditLogForOwner(db, email, pageSize, (arbPage - 1) * pageSize) : [];
const lastLogon = db ? await getLastLogonTime(db, email) : null;
const loginHistory = db ? await listLoginHistoryByEmail(db, email, pageSize, (loginPage - 1) * pageSize) : [];

const BLANK = '—';

function formatDate(s: string | null): string {
  if (!s) return BLANK;
  try {
    const d = new Date(s);
    return Number.isNaN(d.getTime()) ? s : d.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
  } catch {
    return s ?? BLANK;
  }
}

function formatLoginTime(s: string | null): string {
  return formatDate(s);
}

/** Describe what was revealed for "my activity" without re-displaying contact details. */
function revealType(row: { target_name: string | null; target_phone: string | null; target_email: string | null }): string {
  if (row.target_name === '(full directory export)') return 'Full directory export';
  if (row.target_name === '(directory info updated)') return 'Directory info updated';
  if (row.target_email !== null && row.target_email !== undefined && String(row.target_email).trim() !== '') return 'Email';
  return 'Phone';
}
---

<PortalLayout title="My activity | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/my-activity"
    pageTitle="My Activity"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-3">My Activity</h1>
      <p class="text-gray-600 text-lg leading-relaxed">
        A log of your own actions on the portal: when you revealed directory contact info and when your ARB requests were updated. Only you can see this page; the board has a separate full audit log for transparency.
      </p>
    </div>

    <div class="flex flex-wrap items-center gap-3 mb-8">
      <label for="activity-per-page" class="text-base font-medium text-gray-700">Per page:</label>
      <select id="activity-per-page" name="limit" class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-base text-gray-700 focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green" aria-label="Entries per page">
          {ACTIVITY_PAGE_SIZES.map((size) => (
            <option value={size} selected={pageSize === size}>{size}</option>
          ))}
        </select>
        <span class="text-sm text-gray-500">Use Previous and Next under each section to browse older activity.</span>
      </div>
      <script is:inline>
        document.getElementById('activity-per-page')?.addEventListener('change', function () {
          const limit = this.value;
          const u = new URL(window.location.href);
          u.searchParams.set('limit', limit);
          u.searchParams.delete('dir_page');
          u.searchParams.delete('arb_page');
          u.searchParams.delete('login_page');
          if (limit === '10') u.searchParams.delete('limit');
          window.location.href = u.pathname + u.search;
        });
      </script>

      <section class="mb-10" aria-labelledby="login-activity-heading">
        <h2 id="login-activity-heading" class="text-2xl font-heading font-semibold text-clr-green mb-4">Login activity</h2>
        <p class="text-sm text-gray-600 mb-3">Recent sign-ins to your account. If you see a time or IP address you don't recognize, change your password immediately and contact the board.</p>
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-4">
          <div class="p-4 bg-gray-50 border-b border-gray-200">
            <p class="text-base text-gray-700">
              Last logon: <strong>{formatLoginTime(lastLogon)}</strong>
            </p>
          </div>
          {loginHistory.length === 0 ? (
            <p class="p-4 text-gray-500 text-sm">No login history yet. History is recorded each time you sign in.</p>
          ) : (
            <>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                      <th class="text-left py-2 px-3 font-medium text-gray-700">IP address</th>
                    </tr>
                  </thead>
                  <tbody>
                    {loginHistory.map((row) => (
                      <tr class="border-b border-gray-100 last:border-0">
                        <td class="py-2 px-3 text-gray-600">{formatLoginTime(row.logged_at)}</td>
                        <td class="py-2 px-3 font-mono text-gray-600">{row.ip_address?.trim() || BLANK}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Login activity pagination">
                <span class="text-gray-600">Page {loginPage}</span>
                <div class="flex gap-2">
                  {loginPage > 1 && <a href={activityPageUrl('login_page', loginPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
                  {loginHistory.length === pageSize && <a href={activityPageUrl('login_page', loginPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
                </div>
              </nav>
            </>
          )}
        </div>
      </section>

      <section class="mb-10" aria-labelledby="dir-activity-heading">
        <h2 id="dir-activity-heading" class="text-2xl font-heading font-semibold text-clr-green mb-4">Directory: contact I revealed</h2>
        <p class="text-sm text-gray-600 mb-3">When you clicked &quot;Reveal phone&quot; or &quot;Reveal email&quot; in the directory, when you updated your directory info (profile), or when you exported the full directory (board only).</p>
        {dirLogs.length === 0 ? (
          <p class="p-4 bg-gray-50 rounded-xl text-gray-500 text-sm">No directory actions yet.</p>
        ) : (
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Target</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Revealed</th>
                  </tr>
                </thead>
                <tbody>
                  {dirLogs.map((row) => (
                    <tr class="border-b border-gray-100 last:border-0">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.timestamp)}</td>
                      <td class="py-2 px-3">{row.target_name === '(directory info updated)' ? 'My profile' : (row.target_name ?? BLANK)}</td>
                      <td class="py-2 px-3">{revealType(row)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="Directory activity pagination">
              <span class="text-gray-600">Page {dirPage}</span>
              <div class="flex gap-2">
                {dirPage > 1 && <a href={activityPageUrl('dir_page', dirPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
                {dirLogs.length === pageSize && <a href={activityPageUrl('dir_page', dirPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
              </div>
            </nav>
          </div>
        )}
      </section>

      <section aria-labelledby="arb-activity-heading">
        <h2 id="arb-activity-heading" class="text-2xl font-heading font-semibold text-clr-green mb-4">ARB: activity on my requests</h2>
        <p class="text-sm text-gray-600 mb-3">Status changes on your ARB requests (submitted, sent back for revisions, approved, rejected, or cancelled by you).</p>
        {arbLogs.length === 0 ? (
          <p class="p-4 bg-gray-50 rounded-xl text-gray-500 text-sm">No ARB activity yet.</p>
        ) : (
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">When</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Request</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Action</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Status</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Changed by</th>
                    <th class="text-left py-2 px-3 font-medium text-gray-700">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {arbLogs.map((row) => (
                    <tr class="border-b border-gray-100 last:border-0">
                      <td class="py-2 px-3 text-gray-600">{formatDate(row.created)}</td>
                      <td class="py-2 px-3">
                        <a href="/portal/my-requests" class="font-mono text-clr-green hover:underline">{row.request_id}</a>
                      </td>
                      <td class="py-2 px-3">{row.action}</td>
                      <td class="py-2 px-3">{row.old_status ?? BLANK} → {row.new_status ?? BLANK}</td>
                      <td class="py-2 px-3 font-mono text-sm">{row.changed_by_email ?? BLANK}{row.changed_by_role ? ` (${row.changed_by_role})` : ''}</td>
                      <td class="py-2 px-3 text-gray-600 max-w-xs truncate" title={row.notes ?? undefined}>{row.notes ?? BLANK}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <nav class="flex items-center justify-between gap-2 py-2 px-3 border-t border-gray-200 bg-gray-50 text-sm" aria-label="ARB activity pagination">
              <span class="text-gray-600">Page {arbPage}</span>
              <div class="flex gap-2">
                {arbPage > 1 && <a href={activityPageUrl('arb_page', arbPage - 1)} class="text-clr-green hover:underline font-medium">Previous</a>}
                {arbLogs.length === pageSize && <a href={activityPageUrl('arb_page', arbPage + 1)} class="text-clr-green hover:underline font-medium">Next</a>}
              </div>
            </nav>
          </div>
      )}
    </section>
  </PortalPage>
</PortalLayout>
