---
/**
 * ADMIN Landing Zone: /portal/admin
 *
 * Required permissions: effectiveRole === 'admin'
 *
 * Route-level guard: Uses getAdminContext() to enforce admin-only access.
 * Redirects non-admin users to their appropriate landing zone:
 * - board/arb_board → /portal/board
 * - arb → /portal/arb
 * - admin whitelist but not elevated → /portal/request-elevated-access
 * - member → /portal/dashboard
 *
 * When a user elevates to admin role (via PIM), they are redirected here.
 * When a user de-elevates or PIM expires, they revert to member role and see /portal/dashboard.
 */
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import AdminNav from '../../components/AdminNav.astro';
import { getAdminContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';

// Route-level guard: enforce admin-only access
const ctx = await getAdminContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);
---

<PortalLayout title="Admin | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/admin"
    pageTitle="Admin"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <AdminNav currentPath="/portal/admin" />

    <div class="mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-2">Admin</h1>
      <p class="text-gray-600 text-lg">Site operations, content management, and system administration.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Site Management -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" aria-labelledby="admin-site-heading">
        <h2 id="admin-site-heading" class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Site Management</h2>
        <ul class="space-y-3">
          <li>
            <a href="/portal/admin/feedback" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Site feedback</span>
              <span class="text-sm text-gray-400">User feedback</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/sms-requests" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">SMS requests</span>
              <span class="text-sm text-gray-400">SMS opt-ins</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/test-email" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Test email</span>
              <span class="text-sm text-gray-400">Send test</span>
            </a>
          </li>
        </ul>
      </section>

      <!-- System & Data -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" aria-labelledby="admin-system-heading">
        <h2 id="admin-system-heading" class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">System &amp; Data</h2>
        <ul class="space-y-3">
          <li>
            <a href="/portal/admin/usage" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Site usage</span>
              <span class="text-sm text-gray-400">Analytics</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/audit-logs" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Audit logs</span>
              <span class="text-sm text-gray-400">Activity logs</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/users" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Users</span>
              <span class="text-sm text-gray-400">Accounts</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/permissions" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Permissions</span>
              <span class="text-sm text-gray-400">RBAC roles</span>
            </a>
          </li>
          <li>
            <a href="/board/compliance" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Compliance</span>
              <span class="text-sm text-gray-400">FL HOA reqs</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/backups" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Backups</span>
              <span class="text-sm text-gray-400">DB backups</span>
            </a>
          </li>
        </ul>
      </section>

      <!-- Content Management -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" aria-labelledby="admin-content-heading">
        <h2 id="admin-content-heading" class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Content</h2>
        <ul class="space-y-3">
          <li>
            <a href="/portal/admin/news" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">News</span>
              <span class="text-sm text-gray-400">Announcements</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/member-documents" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Member docs</span>
              <span class="text-sm text-gray-400">Protected</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/public-documents" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Public docs</span>
              <span class="text-sm text-gray-400">Public access</span>
            </a>
          </li>
        </ul>
      </section>

      <!-- Directory & People -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" aria-labelledby="admin-people-heading">
        <h2 id="admin-people-heading" class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Directory &amp; People</h2>
        <ul class="space-y-3">
          <li>
            <a href="/portal/admin/directory" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Directory</span>
              <span class="text-sm text-gray-400">Member list</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/contacts" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Contacts</span>
              <span class="text-sm text-gray-400">Submissions</span>
            </a>
          </li>
        </ul>
      </section>

      <!-- Services & Operations -->
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" aria-labelledby="admin-services-heading">
        <h2 id="admin-services-heading" class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Services</h2>
        <ul class="space-y-3">
          <li>
            <a href="/portal/admin/vendors" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Vendors</span>
              <span class="text-sm text-gray-400">Contractors</span>
            </a>
          </li>
          <li>
            <a href="/portal/admin/maintenance" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Maintenance</span>
              <span class="text-sm text-gray-400">Requests</span>
            </a>
          </li>
        </ul>
      </section>
    </div>
  </PortalPage>
</PortalLayout>
