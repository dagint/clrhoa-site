---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import ProtectedPage from '../../components/ProtectedPage.astro';
import PortalNav from '../../components/PortalNav.astro';
import GlobalSearch from '../../components/GlobalSearch.astro';
import { getPortalContext } from '../../lib/portal-context';
import { listPreapprovalItems, listPreapprovalCategories, parsePhotos } from '../../lib/preapproval-db';
import { listArbRequestsByOwner } from '../../lib/arb-db';

const { env, session } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/portal/login');

const db = env?.DB;
const url = new URL(Astro.request.url);
const categoryFilter = url.searchParams.get('category') || '';

const categories = db ? await listPreapprovalCategories(db) : [];
const items = db
  ? await listPreapprovalItems(db, categoryFilter ? { category: categoryFilter } : undefined)
  : [];
const allRequests = db ? await listArbRequestsByOwner(db, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;
---

<PortalLayout title="Pre-approval Library | Member Portal | Crooked Lake Reserve HOA">
  <ProtectedPage>
  <div class="min-h-screen bg-gray-50 portal-theme-bg font-body">
    <GlobalSearch fixed={true} class="portal-theme-header" />
    <div class="pt-14">
      <PortalNav currentPath="/portal/library" draftCount={draftCount} role={session.role} />

      <main class="max-w-4xl mx-auto px-4 sm:px-6 py-8">
        <h2 class="text-2xl font-heading font-bold text-clr-green mb-2">Architectural Pre-Approval Library</h2>
        <p class="text-gray-600 portal-theme-text-muted mb-6">
          Browse pre-approved designs and use one as a template when submitting an ARB request.
        </p>

        {categories.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-6" role="tablist" aria-label="Filter by category">
            <a
              href="/portal/library"
              class:list={['px-4 py-2 rounded-lg text-sm font-medium transition-colors', !categoryFilter ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 portal-theme-card']}
            >
              All
            </a>
            {categories.map((cat) => (
              <a
                href={`/portal/library?category=${encodeURIComponent(cat)}`}
                class:list={['px-4 py-2 rounded-lg text-sm font-medium transition-colors', categoryFilter === cat ? 'bg-clr-green text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 portal-theme-card']}
              >
                {cat}
              </a>
            ))}
          </div>
        )}

        {items.length === 0 ? (
          <div class="bg-white rounded-2xl border border-gray-100 p-8 text-center text-gray-500 portal-theme-text-muted">
            No pre-approved items yet. The board may add designs to this library over time.
          </div>
        ) : (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="library-grid">
            {items.map((item) => {
              const photos = parsePhotos(item.photos);
              const firstPhoto = photos[0];
              return (
                <article
                  class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden portal-theme-card flex flex-col"
                  id={item.id}
                >
                  <div class="aspect-video bg-gray-100 relative">
                    {firstPhoto ? (
                      <img
                        src={`/api/portal/file/${encodeURIComponent(firstPhoto.key)}`}
                        alt=""
                        class="w-full h-full object-cover"
                        loading="lazy"
                      />
                    ) : (
                      <div class="w-full h-full flex items-center justify-center text-gray-400 text-4xl">-</div>
                    )}
                  </div>
                  <div class="p-4 flex flex-col flex-1">
                    <h3 class="font-heading font-semibold text-clr-green text-lg">{item.title ?? 'Untitled'}</h3>
                    {item.category && (
                      <p class="text-sm text-gray-500 mt-0.5">{item.category}</p>
                    )}
                    {item.rules && (
                      <p class="text-sm text-gray-600 mt-2 line-clamp-3 portal-theme-text">{item.rules}</p>
                    )}
                    <a
                      href={`/portal/arb-request?template=${encodeURIComponent(item.id)}`}
                      class="mt-4 inline-flex items-center justify-center px-4 py-2 bg-clr-green text-white text-sm font-medium rounded-lg hover:brightness-110 transition-colors"
                    >
                      Use as template
                    </a>
                  </div>
                </article>
              );
            })}
          </div>
        )}
      </main>
    </div>
  </div>
  </ProtectedPage>
</PortalLayout>
