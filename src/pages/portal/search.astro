---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import SearchResults from '../../components/SearchResults.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { runPortalSearch } from '../../lib/search';

const { env, session, effectiveRole } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/auth/login');

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);

const url = new URL(Astro.request.url);
const q = (url.searchParams.get('q') ?? '').trim();
const result = q && db
  ? await runPortalSearch(db, q, { email: session.email, role: effectiveRole })
  : { arb: [], meetings: [], vendors: [], owners: [], feedback_docs: [], preapproval: [] };
---

<PortalLayout title="Search | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/search"
    pageTitle="Search"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-4">Search</h1>
      {q ? (
        <SearchResults arb={result.arb} meetings={result.meetings} vendors={result.vendors} owners={result.owners} feedback_docs={result.feedback_docs} preapproval={result.preapproval} query={q} />
      ) : (
        <p class="text-base text-gray-500 portal-theme-text-muted">Enter a term above to search ARB requests, meetings, vendors, directory, feedback, and the pre-approval library.</p>
      )}
    </div>
  </PortalPage>
</PortalLayout>
