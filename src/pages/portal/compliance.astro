---
/**
 * Members-only compliance page - View all compliance documents in one place
 * Shows both public and members-only compliance documents
 */
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import ProtectedPage from '../../components/ProtectedPage.astro';
import PortalNav from '../../components/PortalNav.astro';
import { getPortalContext } from '../../lib/portal-context';
import { listArbRequestsByHousehold } from '../../lib/arb-db';
import { listComplianceRequirements, getCurrentComplianceDocument, type ComplianceRequirement, type ComplianceDocument } from '../../lib/compliance-db';

const { env, session, effectiveRole } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/auth/login');

const db = env?.DB;
if (!db) {
  return new Response('Service unavailable', { status: 503 });
}

const allRequests = db ? await listArbRequestsByHousehold(db, session.email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;

// Fetch all requirements
const allRequirements = await listComplianceRequirements(db);

// For each requirement, get current document if exists
interface RequirementWithDoc {
  requirement: ComplianceRequirement;
  document: ComplianceDocument | null;
}

const requirementsWithDocs: RequirementWithDoc[] = await Promise.all(
  allRequirements.map(async (req) => {
    const doc = await getCurrentComplianceDocument(db, req.id);
    return { requirement: req, document: doc };
  })
);

// Members see all documents (public + members-only)
const availableRequirements = requirementsWithDocs.filter(({ document }) => !!document);

// Group by category
const categories = [
  { key: 'governing_docs', label: 'Governing Documents', icon: 'ðŸ“œ' },
  { key: 'financial', label: 'Financial Documents', icon: 'ðŸ’°' },
  { key: 'meetings', label: 'Meetings & Notices', icon: 'ðŸ“…' },
  { key: 'contracts', label: 'Contracts & Bids', icon: 'ðŸ“' },
  { key: 'insurance', label: 'Insurance', icon: 'ðŸ›¡ï¸' },
  { key: 'other', label: 'Other', icon: 'ðŸ“‹' },
];

const groupedRequirements = categories.map((cat) => ({
  ...cat,
  items: availableRequirements.filter(({ requirement }) => requirement.category === cat.key),
})).filter((cat) => cat.items.length > 0);

function formatDate(s: string | null): string {
  if (!s) return '';
  try {
    return new Date(s).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch {
    return s;
  }
}

const totalDocs = availableRequirements.length;
const publicDocs = availableRequirements.filter(({ document }) => document?.visibility === 'public').length;
const memberDocs = availableRequirements.filter(({ document }) => document?.visibility === 'members').length;
const totalRequirements = allRequirements.length;
const compliancePercent = totalRequirements > 0 ? Math.round((totalDocs / totalRequirements) * 100) : 0;
---

<PortalLayout title="Compliance Documents | Member Portal | Crooked Lake Reserve HOA">
  <ProtectedPage>
    <div class="min-h-screen portal-theme-bg font-body">
      <PortalNav currentPath="/portal/compliance" draftCount={draftCount} role={effectiveRole} staffRole={session?.role ?? ''} />

      <main class="max-w-5xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
        <!-- Header -->
        <div class="mb-8">
          <h1 class="text-3xl sm:text-4xl font-heading font-bold text-clr-green mb-3">
            Compliance Documents
          </h1>
          <p class="text-gray-600 text-lg mb-4">
            Florida Statute 720.303(4) compliance documents. As a member, you have access to both public documents and members-only records.
          </p>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="p-4 rounded-xl bg-white shadow-sm border border-gray-100">
            <div class="text-3xl font-bold text-clr-green mb-1">{compliancePercent}%</div>
            <div class="text-sm text-gray-600">Compliance</div>
          </div>
          <div class="p-4 rounded-xl bg-white shadow-sm border border-gray-100">
            <div class="text-3xl font-bold text-clr-green mb-1">{totalDocs}</div>
            <div class="text-sm text-gray-600">Available</div>
          </div>
          <div class="p-4 rounded-xl bg-white shadow-sm border border-gray-100">
            <div class="text-3xl font-bold text-gray-700 mb-1">{publicDocs}</div>
            <div class="text-sm text-gray-600">Public</div>
          </div>
          <div class="p-4 rounded-xl bg-white shadow-sm border border-gray-100">
            <div class="text-3xl font-bold text-blue-600 mb-1">{memberDocs}</div>
            <div class="text-sm text-gray-600">Members-Only</div>
          </div>
        </div>

        <!-- Document Categories -->
        {groupedRequirements.length > 0 ? (
          <div class="space-y-6">
            {groupedRequirements.map((category) => (
              <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-xl font-heading font-semibold text-clr-green mb-4 flex items-center gap-2">
                  <span class="text-2xl">{category.icon}</span>
                  {category.label}
                </h2>
                <div class="space-y-3">
                  {category.items.map(({ requirement, document }) => (
                    <div class="p-4 rounded-xl border border-gray-200 hover:border-clr-green/30 hover:shadow-sm transition-all">
                      <div class="flex items-start justify-between gap-4 flex-wrap">
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-1 flex-wrap">
                            <h3 class="font-medium text-gray-900">{requirement.title}</h3>
                            {document?.visibility === 'members' && (
                              <span class="px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                Members Only
                              </span>
                            )}
                            {requirement.requires_annual_update === 1 && (
                              <span class="px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">
                                Annual Update Required
                              </span>
                            )}
                          </div>
                          <p class="text-sm text-gray-600 mb-2">{requirement.statute_ref}</p>
                          {document && (
                            <div class="flex items-center gap-4 text-sm text-gray-500 flex-wrap">
                              <span>ðŸ“„ {document.title}</span>
                              {document.document_date && (
                                <span>ðŸ“… {formatDate(document.document_date)}</span>
                              )}
                              <span class="text-xs">Updated {formatDate(document.uploaded_at)}</span>
                            </div>
                          )}
                        </div>
                        {document?.file_key && (
                          <a
                            href={`/api/compliance/file/${document.file_key}`}
                            class="px-4 py-2 bg-clr-green text-white rounded-lg font-medium hover:brightness-110 text-sm whitespace-nowrap"
                            target="_blank"
                            rel="noopener noreferrer"
                          >
                            Download
                          </a>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            ))}
          </div>
        ) : (
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
            <p class="text-gray-500 text-lg mb-2">No compliance documents have been uploaded yet.</p>
            <p class="text-sm text-gray-600">The Board will upload required documents as they become available.</p>
          </div>
        )}

        <!-- Info Footer -->
        <div class="mt-8 p-6 rounded-xl bg-gray-50 border border-gray-200">
          <h3 class="font-semibold text-gray-900 mb-3">About These Documents</h3>
          <p class="text-sm text-gray-700 mb-3">
            Florida Statute 720.303(4) requires homeowners associations to make certain official records available to members. This page provides convenient access to all required compliance documents.
          </p>
          <p class="text-sm text-gray-700 mb-2">
            <strong>Document Types:</strong>
          </p>
          <ul class="list-disc list-inside space-y-1 text-sm text-gray-700 ml-2">
            <li><strong>Public:</strong> Available to all members and the general public (bylaws, covenants, rules)</li>
            <li><strong>Members-Only:</strong> Available only to association members (minutes, budgets, contracts)</li>
          </ul>
          <p class="text-sm text-gray-600 mt-4">
            <strong>Questions?</strong> Contact the Board at <a href="mailto:board@clrhoa.com" class="text-clr-green hover:underline">board@clrhoa.com</a>
          </p>
        </div>

        <!-- Quick Links -->
        <div class="mt-6 flex flex-wrap gap-4 justify-center text-sm">
          <a href="/portal/documents" class="text-clr-green hover:underline">Member Documents</a>
          <span class="text-gray-400">â€¢</span>
          <a href="/documents" class="text-clr-green hover:underline">Public Documents</a>
          <span class="text-gray-400">â€¢</span>
          <a href="/portal/dashboard" class="text-clr-green hover:underline">Dashboard</a>
        </div>
      </main>
    </div>
  </ProtectedPage>
</PortalLayout>
