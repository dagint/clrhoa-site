---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { isElevatedRole, getEffectiveRole } from '../../lib/auth';

const { env, session, effectiveRole } = await getPortalContext(Astro, { fingerprint: true });
if (!session) return Astro.redirect('/auth/login');

const whitelistRole = session.role?.toLowerCase() ?? 'member';
const hasStaffWhitelistRole = isElevatedRole(whitelistRole);
const isCurrentlyElevated = isElevatedRole(getEffectiveRole(session));

// No staff role: send to dashboard (they shouldn't be here)
if (!hasStaffWhitelistRole) {
  return Astro.redirect('/portal/dashboard');
}

// Already elevated: send to return URL or role landing zone
if (isCurrentlyElevated) {
  const returnTo = Astro.url.searchParams.get('return');
  const safeReturn = returnTo && returnTo.startsWith('/') && !returnTo.startsWith('//') ? returnTo : null;
  if (safeReturn) return Astro.redirect(safeReturn);
  const { ROLE_LANDING } = await import('../../config/navigation');
  const landing = ROLE_LANDING[whitelistRole] ?? '/portal/dashboard';
  return Astro.redirect(landing);
}

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);

const returnParam = Astro.url.searchParams.get('return');
const returnLabel = returnParam && returnParam.startsWith('/board') ? 'Board' : returnParam && returnParam.startsWith('/admin') ? 'Admin' : returnParam && returnParam.includes('arb-dashboard') ? 'ARB Dashboard' : returnParam ? 'that page' : null;
---

<PortalLayout title="Request elevated access | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/request-elevated-access"
    pageTitle="Elevated Access Required"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <div class="max-w-2xl">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8">
        <h1 class="text-3xl font-heading font-bold text-clr-green mb-3">Elevated access required</h1>
        <p class="text-gray-700 text-base mb-4">
          You have a Board, ARB, or Admin role. To use Board tools (directory, dues, meetings, documents, audit logs) or the ARB dashboard, you need to request <strong>elevated access</strong> for a short time.
        </p>
        <p class="text-base text-gray-600 mb-6">
          Elevated access lasts 2 hours. When you're done, use <strong>Drop access</strong> in the banner to return to normal member view. All requests are logged for transparency.
        </p>
        <div class="flex flex-wrap items-center gap-4">
          <button type="button" id="pim-elevate-btn" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-3 rounded-lg font-semibold text-base shadow-sm">
            Request elevated access
          </button>
          <a href="/portal/dashboard" class="text-base text-gray-600 hover:text-clr-green underline">Back to dashboard</a>
        </div>
        {returnLabel && (
          <p class="mt-4 text-base text-gray-500">
            After you request access, you'll be taken to {returnLabel}.
          </p>
        )}
      </div>
    </div>
  </PortalPage>

  <script is:inline define:vars={{ returnParam, staffRole: whitelistRole, adminLanding: '/portal/admin', boardLanding: '/portal/board', arbLanding: '/portal/arb' }}>
    (function () {
      var btn = document.getElementById('pim-elevate-btn');
      if (!btn) return;
      btn.addEventListener('click', function () {
        var b = /** @type {HTMLButtonElement} */ (btn);
        b.disabled = true;
        fetch('/api/pim/elevate', { method: 'POST', credentials: 'same-origin' })
          .then(function (r) {
            if (r.ok) {
              var go = (typeof returnParam === 'string' && returnParam.startsWith('/') && !returnParam.startsWith('//'))
                ? returnParam
                : (staffRole === 'admin' ? adminLanding : staffRole === 'arb' ? arbLanding : boardLanding) || '/portal/dashboard';
              window.location.href = go;
            } else {
              b.disabled = false;
            }
          })
          .catch(function () { b.disabled = false; });
      });
    })();
  </script>
</PortalLayout>
