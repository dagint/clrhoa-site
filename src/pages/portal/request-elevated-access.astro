---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { isElevatedRole, getEffectiveRole } from '../../lib/auth';

const { env, session, effectiveRole } = await getPortalContext(Astro, { fingerprint: true });
if (!session) return Astro.redirect('/auth/login');

const whitelistRole = session.role?.toLowerCase() ?? 'member';
const hasStaffWhitelistRole = isElevatedRole(whitelistRole);
const isCurrentlyElevated = isElevatedRole(getEffectiveRole(session));

// No staff role: send to dashboard (they shouldn't be here)
if (!hasStaffWhitelistRole) {
  return Astro.redirect('/portal/dashboard');
}

// Already elevated: send to return URL or role landing zone
if (isCurrentlyElevated) {
  const returnTo = Astro.url.searchParams.get('return');
  const safeReturn = returnTo && returnTo.startsWith('/') && !returnTo.startsWith('//') ? returnTo : null;
  if (safeReturn) return Astro.redirect(safeReturn);
  const { ROLE_LANDING } = await import('../../config/navigation');
  const landing = ROLE_LANDING[whitelistRole] ?? '/portal/dashboard';
  return Astro.redirect(landing);
}

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);

const returnParam = Astro.url.searchParams.get('return');
const returnLabel = returnParam && returnParam.startsWith('/board') ? 'Board' : returnParam && returnParam.startsWith('/admin') ? 'Admin' : returnParam && returnParam.includes('arb-dashboard') ? 'ARB Dashboard' : returnParam ? 'that page' : null;
---

<PortalLayout title="Request elevated access | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/request-elevated-access"
    pageTitle="Elevated Access Required"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <div class="max-w-2xl">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8">
        <h1 class="text-3xl font-heading font-bold text-clr-green mb-3">Elevated Access Required</h1>
        <p class="text-gray-700 text-base mb-4">
          You have a Board, ARB, or Admin role. To use Board tools (directory, dues, meetings, documents, audit logs) or the ARB dashboard, you need to request <strong>elevated access</strong> for a short time.
        </p>
        <p class="text-base text-gray-600 mb-6">
          Elevated access lasts <strong>1 hour</strong>. When you're done, use <strong>Drop access</strong> in the banner to return to normal member view. All requests are logged for transparency.
        </p>

        <!-- Error/Success Messages -->
        <div id="pim-message" class="hidden mb-6 p-4 rounded-lg"></div>

        <!-- Elevation Request Form -->
        <form id="pim-elevate-form" class="space-y-4">
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
              Confirm your password <span class="text-red-600">*</span>
            </label>
            <p class="text-sm text-gray-600 mb-2">
              For security, please re-enter your password to request elevated access.
            </p>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-clr-green focus:border-transparent"
              placeholder="Enter your password"
            />
          </div>

          <div class="flex flex-wrap items-center gap-4">
            <button
              type="submit"
              id="pim-elevate-btn"
              class="bg-amber-600 hover:bg-amber-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-semibold text-base shadow-sm transition-colors"
            >
              Request Elevated Access
            </button>
            <a href="/portal/dashboard" class="text-base text-gray-600 hover:text-clr-green underline">
              Back to dashboard
            </a>
          </div>

          {returnLabel && (
            <p class="text-base text-gray-500">
              After you request access, you'll be taken to {returnLabel}.
            </p>
          )}
        </form>
      </div>
    </div>
  </PortalPage>

  <script is:inline define:vars={{ returnParam, staffRole: whitelistRole, adminLanding: '/portal/admin', boardLanding: '/portal/board', arbLanding: '/portal/arb' }}>
    (function () {
      var form = document.getElementById('pim-elevate-form');
      var btn = document.getElementById('pim-elevate-btn');
      var passwordInput = document.getElementById('password');
      var messageDiv = document.getElementById('pim-message');

      if (!form || !btn || !passwordInput || !messageDiv) return;

      function showMessage(text, isError) {
        messageDiv.textContent = text;
        messageDiv.className = isError
          ? 'mb-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-700'
          : 'mb-6 p-4 rounded-lg bg-green-50 border border-green-200 text-green-700';
      }

      function hideMessage() {
        messageDiv.className = 'hidden mb-6 p-4 rounded-lg';
        messageDiv.textContent = '';
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        hideMessage();

        var password = passwordInput.value;
        if (!password) {
          showMessage('Password is required', true);
          return;
        }

        var b = /** @type {HTMLButtonElement} */ (btn);
        b.disabled = true;
        b.textContent = 'Requesting access...';

        fetch('/api/pim/elevate', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password })
        })
          .then(function (r) {
            return r.json().then(function (data) {
              return { ok: r.ok, status: r.status, data: data };
            });
          })
          .then(function (result) {
            if (result.ok) {
              showMessage('Elevated access granted! Redirecting...', false);
              var go = (typeof returnParam === 'string' && returnParam.startsWith('/') && !returnParam.startsWith('//'))
                ? returnParam
                : (staffRole === 'admin' ? adminLanding : staffRole === 'arb' ? arbLanding : boardLanding) || '/portal/dashboard';
              setTimeout(function () {
                window.location.href = go;
              }, 1000);
            } else {
              var errorMsg = result.data.error || 'Failed to request elevated access';
              showMessage(errorMsg, true);
              b.disabled = false;
              b.textContent = 'Request Elevated Access';
              passwordInput.value = '';
              passwordInput.focus();
            }
          })
          .catch(function (err) {
            showMessage('Network error. Please try again.', true);
            b.disabled = false;
            b.textContent = 'Request Elevated Access';
          });
      });
    })();
  </script>
</PortalLayout>
