---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import FormField from '../../components/FormField.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { getOwnerByEmail, getPhonesArray, listHouseholdMembersWithLogin } from '../../lib/directory-db';

const { env, session, effectiveRole } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/auth/login');

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);

const owner = db ? await getOwnerByEmail(db, email) : null;
const phonesInitial = owner ? getPhonesArray(owner) : [];
if (phonesInitial.length === 0) phonesInitial.push('');

const hasName = !!(owner?.name?.trim());
const hasAddress = !!(owner?.address?.trim());
const hasPhones = phonesInitial.some((p) => !!(p && String(p).trim()));
// Admin accounts (e.g. service providers) are not required to have an address
const profileComplete =
  effectiveRole === 'admin' ? hasName && hasPhones : hasName && hasAddress && hasPhones;
const requiredParam = Astro.url.searchParams.get('required') === '1';
const startInEditMode = !profileComplete || requiredParam;

const householdMembersWithLogin = db ? await listHouseholdMembersWithLogin(db, email) : [];
---

<PortalLayout title="Profile | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/profile"
    pageTitle="My Profile"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <div class="max-w-3xl mx-auto">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 mb-8">
        <h1 class="text-3xl font-heading font-bold text-clr-green mb-3">My Profile</h1>
        <p class="text-gray-600 text-lg mb-3">
          Your directory listing and household information. Directory info is shown to other members and prefills ARB requests.
        </p>
        <div class="flex flex-wrap gap-x-6 gap-y-2 text-gray-600 text-base">
          <p>
            <a href="/portal/my-activity" class="text-clr-orange font-semibold hover:underline">My activity</a> — view your login history and action log
          </p>
          <p>
            <a href="/portal/preferences" class="text-clr-orange font-semibold hover:underline">Preferences</a> — privacy settings and notifications
          </p>
        </div>
      </div>

      {requiredParam && (
        <div class="mb-8 p-5 bg-amber-50 border border-amber-200 rounded-xl text-amber-900" role="alert">
          <strong class="text-base">Profile required.</strong>
          <span class="text-base">
            {effectiveRole === 'admin'
              ? ' Please complete your name and at least one phone number.'
              : ' Please complete your name, address, and at least one phone number.'}
          </span>
        </div>
      )}

      <!-- Section 1: Directory listing -->
      <section class="mb-10" aria-labelledby="profile-dir-heading">
        <h2 id="profile-dir-heading" class="text-2xl font-heading font-semibold text-clr-green mb-4">Directory listing</h2>
        <div id="profile-view" class={`bg-white rounded-2xl shadow-sm border border-gray-100 portal-theme-card portal-card-accent p-6 sm:p-8 ${startInEditMode ? 'hidden' : ''}`}>
          <dl class="space-y-5">
            <div>
              <dt class="text-base font-semibold text-gray-600">Name</dt>
              <dd id="profile-view-name" class="mt-1 text-gray-900 text-lg">{owner?.name?.trim() || 'Not set'}</dd>
            </div>
            <div>
              <dt class="text-base font-semibold text-gray-600">Property address</dt>
              <dd id="profile-view-address" class="mt-1 text-gray-900 text-lg">{owner?.address?.trim() || 'Not set'}</dd>
            </div>
            <div>
              <dt class="text-base font-semibold text-gray-600">Lot number</dt>
              <dd id="profile-view-lot" class="mt-1 text-gray-900 text-lg">{owner?.lot_number?.trim() || 'Not set'}</dd>
            </div>
            <div>
              <dt class="text-base font-semibold text-gray-600">Phone numbers</dt>
              <dd id="profile-view-phones" class="mt-1 text-gray-900 text-lg">{phonesInitial.filter((p) => p && String(p).trim()).join(', ') || 'Not set'}</dd>
            </div>
            <div>
              <dt class="text-base font-semibold text-gray-600">Email</dt>
              <dd class="mt-1 text-gray-900 text-lg">{email}</dd>
              <p class="text-sm text-gray-500 mt-1">Login address; cannot be changed here.</p>
            </div>
          </dl>

          <!-- Contact Sharing Status -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            {owner?.share_contact_with_members !== 0 ? (
              <div class="flex items-start gap-3 p-4 bg-green-50 border border-green-200 rounded-lg">
                <svg class="w-5 h-5 text-green-600 mt-0.5 shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                </svg>
                <div class="flex-1">
                  <p class="text-base font-semibold text-green-900">Contact info shared in directory</p>
                  <p class="text-sm text-green-800 mt-1">Other HOA members can see your phone number and email in the member directory.</p>
                  <a href="/portal/preferences" class="text-sm text-green-700 hover:text-green-900 underline font-medium mt-2 inline-block">Change privacy settings</a>
                </div>
              </div>
            ) : (
              <div class="flex items-start gap-3 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <svg class="w-5 h-5 text-amber-600 mt-0.5 shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                </svg>
                <div class="flex-1">
                  <p class="text-base font-semibold text-amber-900">Contact info is private</p>
                  <p class="text-sm text-amber-800 mt-1">Your contact info is hidden from other members. Board/ARB/Admin can still see it when needed.</p>
                  <a href="/portal/preferences" class="text-sm text-amber-700 hover:text-amber-900 underline font-medium mt-2 inline-block">Enable sharing in preferences</a>
                </div>
              </div>
            )}
          </div>
          <div class="mt-8">
            <button type="button" id="profile-edit-btn" class="px-6 py-3 bg-clr-green text-white rounded-lg font-semibold text-base hover:brightness-110 transition-all">Edit directory info</button>
          </div>
        </div>

        <form id="my-info-form" class={`bg-white rounded-2xl shadow-sm border border-gray-100 portal-theme-card portal-card-accent p-6 sm:p-8 space-y-5 ${startInEditMode ? '' : 'hidden'}`}>
          <input type="hidden" name="csrf_token" id="my-info-csrf" value={session.csrfToken ?? ''} />
          <FormField
            id="my-info-name"
            name="name"
            label="Name"
            type="text"
            value={owner?.name ?? ''}
            placeholder="Your name"
            labelClass="block text-base font-semibold text-gray-700"
            inputClass="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-3 text-base focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green"
          />
          <FormField
            id="my-info-address"
            name="address"
            label="Property address"
            type="text"
            value={owner?.address ?? ''}
            placeholder="Street, lot or address"
            description="Used in the directory and to prefill the ARB request form."
            labelClass="block text-base font-semibold text-gray-700"
            inputClass="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-3 text-base focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green"
          />
          <FormField
            id="my-info-lot-number"
            name="lot_number"
            label="Lot number"
            type="text"
            value={owner?.lot_number ?? ''}
            placeholder="1–25"
            description="Optional. Use 1–25 if you know your lot number."
            labelClass="block text-base font-semibold text-gray-700"
            inputClass="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-3 text-base focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green"
            extra={{ inputmode: 'numeric', min: 1, max: 25 }}
          />
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="block text-base font-semibold text-gray-700">Phone numbers (directory)</label>
              <button type="button" id="my-info-add-phone" class="text-base text-clr-orange hover:underline font-semibold">Add another</button>
            </div>
            <p class="text-sm text-gray-500 mb-3">These appear in the member directory. Add or edit below; the SMS number in Notifications will be added here if it is new.</p>
            <div id="my-info-phones" class="space-y-3">
              {phonesInitial.map((p, i) => (
                <div class="flex gap-3 items-center phone-row">
                  <input type="tel" class="phone-input block flex-1 rounded-lg border border-gray-300 px-4 py-3 text-base focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green" value={p} placeholder="(555) 555-5555" data-index={i} />
                  <button type="button" class="remove-phone text-base text-red-600 hover:underline shrink-0" data-index={i} aria-label="Remove phone">Remove</button>
                </div>
              ))}
            </div>
          </div>
          <div class="flex gap-4 flex-wrap items-center pt-2">
            <button type="submit" id="my-info-submit" class="px-6 py-3 bg-clr-green text-white rounded-lg font-semibold text-base hover:brightness-110 transition-all">Save directory info</button>
            <button type="button" id="profile-cancel-btn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold text-base hover:bg-gray-300 transition-colors">Cancel</button>
            <span id="my-info-message" class="text-base text-gray-500"></span>
          </div>
        </form>
      </section>

      <!-- Section: Household accounts (others at same address who can sign in) -->
      <section aria-labelledby="profile-household-heading" class="mb-10">
        <h2 id="profile-household-heading" class="text-2xl font-heading font-semibold text-clr-green mb-4">Household accounts</h2>
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 portal-theme-card p-6 sm:p-8">
          <p class="text-base text-gray-600 mb-4 leading-relaxed">
            Other people at your property address who are in the directory and have portal sign-in. You can see who else can log in here; each person manages their own account from My account.
          </p>
          {householdMembersWithLogin.length === 0 ? (
            <p class="text-base text-gray-500">No other household members with portal access at your address. Only directory entries with the same property address who have a portal account appear here.</p>
          ) : (
            <ul class="space-y-4" role="list">
              {householdMembersWithLogin.map((m) => (
                <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 py-3 border-b border-gray-100 last:border-b-0 last:pb-0">
                  <div>
                    <span class="font-semibold text-gray-900 text-base">{m.name || 'No name'}</span>
                    {m.is_primary === 1 && (
                      <span class="ml-2 text-sm text-gray-500">Primary contact</span>
                    )}
                  </div>
                  <span class="text-base text-gray-600">{m.email}</span>
                </li>
              ))}
            </ul>
          )}
        </div>
      </section>
    </div>

  <script is:inline>
    (function () {
      const form = document.getElementById('my-info-form');
      const submitBtn = document.getElementById('my-info-submit');
      const messageEl = document.getElementById('my-info-message');
      const csrfInput = document.getElementById('my-info-csrf');
      const container = document.getElementById('my-info-phones');
      const addBtn = document.getElementById('my-info-add-phone');
      const profileView = document.getElementById('profile-view');
      const profileEditBtn = document.getElementById('profile-edit-btn');
      const profileCancelBtn = document.getElementById('profile-cancel-btn');
      const viewName = document.getElementById('profile-view-name');
      const viewAddress = document.getElementById('profile-view-address');
      const viewPhones = document.getElementById('profile-view-phones');

      function showEditMode() {
        if (profileView) profileView.classList.add('hidden');
        if (form) form.classList.remove('hidden');
      }
      function showViewMode() {
        if (profileView) profileView.classList.remove('hidden');
        if (form) form.classList.add('hidden');
      }
      const viewLot = document.getElementById('profile-view-lot');
      function updateViewFromForm() {
        const name = document.getElementById('my-info-name')?.value?.trim() || 'Not set';
        const address = document.getElementById('my-info-address')?.value?.trim() || 'Not set';
        const lot = document.getElementById('my-info-lot-number')?.value?.trim() || 'Not set';
        const phones = [];
        container?.querySelectorAll('.phone-input').forEach(function (input) {
          const v = input.value?.trim();
          if (v) phones.push(v);
        });
        if (viewName) viewName.textContent = name;
        if (viewAddress) viewAddress.textContent = address;
        if (viewLot) viewLot.textContent = lot;
        if (viewPhones) viewPhones.textContent = phones.length ? phones.join(', ') : 'Not set';
      }

      profileEditBtn?.addEventListener('click', showEditMode);
      profileCancelBtn?.addEventListener('click', function () {
        updateViewFromForm();
        showViewMode();
        if (messageEl) messageEl.textContent = '';
      });

      addBtn?.addEventListener('click', function () {
        const row = document.createElement('div');
        row.className = 'flex gap-2 items-center phone-row';
        const idx = container?.querySelectorAll('.phone-row').length ?? 0;
        const input = document.createElement('input');
        input.type = 'tel';
        input.className = 'phone-input block flex-1 rounded-lg border border-gray-300 px-4 py-3 text-base focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green';
        input.placeholder = '(555) 555-5555';
        input.setAttribute('data-index', String(idx));
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-phone text-base text-red-600 hover:underline shrink-0';
        removeBtn.setAttribute('data-index', String(idx));
        removeBtn.setAttribute('aria-label', 'Remove phone');
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', function () {
          if ((container?.querySelectorAll('.phone-row').length ?? 0) > 1) row.remove();
        });
        row.appendChild(input);
        row.appendChild(removeBtn);
        container?.appendChild(row);
      });

      document.querySelectorAll('.remove-phone').forEach((btn) => {
        btn.addEventListener('click', function () {
          const row = this.closest('.phone-row');
          if (container && (container.querySelectorAll('.phone-row').length ?? 0) > 1) row?.remove();
        });
      });

      form?.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!messageEl) return;
        messageEl.textContent = '';
        const token = (csrfInput && csrfInput.value) || '';
        const phones = [];
        container?.querySelectorAll('.phone-input').forEach((input) => {
          const v = input.value?.trim();
          if (v) phones.push(v);
        });
        const lotNumber = document.getElementById('my-info-lot-number')?.value?.trim() || null;
        const payload = { name: document.getElementById('my-info-name')?.value?.trim() || null, address: document.getElementById('my-info-address')?.value?.trim() || null, lot_number: lotNumber, phones: phones.length ? phones : [], csrf_token: token };
        submitBtn.disabled = true;
        try {
          const res = await fetch('/api/owners/me', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'same-origin' });
          const data = await res.json();
          if (res.ok && data.success) {
            messageEl.textContent = data.created ? 'Saved. You are now in the directory.' : 'Saved.';
            messageEl.className = 'text-base text-clr-green font-semibold';
            updateViewFromForm();
            showViewMode();
            if (window.location.search.indexOf('required=1') !== -1) { window.location.href = '/portal/dashboard'; return; }
          } else {
            messageEl.textContent = data.error || 'Save failed.';
            messageEl.className = 'text-base text-red-600 font-semibold';
          }
        } catch (err) {
          messageEl.textContent = 'Network error. Try again.';
          messageEl.className = 'text-base text-red-600 font-semibold';
        } finally {
          submitBtn.disabled = false;
        }
      });
    })();
  </script>
  </PortalPage>
</PortalLayout>
