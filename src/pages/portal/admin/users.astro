---
/**
 * Admin: User Management
 *
 * Admin-only page for managing user accounts.
 * Features:
 * - List all users with filtering (role, status, search)
 * - Create new users with password setup email
 * - Edit user details (role, status, name, phone)
 * - Resend password setup emails
 * - View audit logs for user actions
 */
export const prerender = false;

import BoardLayout from '../../../layouts/BoardLayout.astro';
import { getAdminContext } from '../../../lib/board-context';

const ctx = await getAdminContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;

const db = env?.DB;

// Query parameters for filtering
const url = Astro.url;
const q = url.searchParams;
const roleFilter = q.get('role') ?? '';
const statusFilter = q.get('status') ?? '';
const search = q.get('search') ?? '';

// Stats data
let stats = {
  totalUsers: 0,
  activeUsers: 0,
  pendingUsers: 0,
  adminUsers: 0,
  boardUsers: 0,
  arbUsers: 0,
  memberUsers: 0,
};

if (db) {
  try {
    // Get total counts
    const totalResult = await db.prepare('SELECT COUNT(*) as count FROM users').first<{ count: number }>();
    stats.totalUsers = totalResult?.count || 0;

    // Get active users
    const activeResult = await db.prepare('SELECT COUNT(*) as count FROM users WHERE status = ?').bind('active').first<{ count: number }>();
    stats.activeUsers = activeResult?.count || 0;

    // Get pending users
    const pendingResult = await db.prepare('SELECT COUNT(*) as count FROM users WHERE status = ?').bind('pending_setup').first<{ count: number }>();
    stats.pendingUsers = pendingResult?.count || 0;

    // Get role counts
    const adminResult = await db.prepare('SELECT COUNT(*) as count FROM users WHERE role = ?').bind('admin').first<{ count: number }>();
    stats.adminUsers = adminResult?.count || 0;

    const boardResult = await db.prepare('SELECT COUNT(*) as count FROM users WHERE role IN (?, ?)').bind('board', 'arb_board').first<{ count: number }>();
    stats.boardUsers = boardResult?.count || 0;

    const arbResult = await db.prepare('SELECT COUNT(*) as count FROM users WHERE role IN (?, ?)').bind('arb', 'arb_board').first<{ count: number }>();
    stats.arbUsers = arbResult?.count || 0;

    const memberResult = await db.prepare('SELECT COUNT(*) as count FROM users WHERE role = ?').bind('member').first<{ count: number }>();
    stats.memberUsers = memberResult?.count || 0;
  } catch (err) {
    console.error('Failed to load user stats:', err);
  }
}
---

<BoardLayout
  title="User Management"
  subtitle="Manage user accounts, roles, and permissions."
  draftCount={0}
  role={effectiveRole}
  session={session}
  elevatedUntil={session.elevated_until}
  mainWide
  showRoleBanner={false}
>
  <!-- Stats Dashboard -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="rounded-lg border border-gray-200 bg-white p-4">
      <div class="text-sm text-gray-600 mb-1">Total Users</div>
      <div class="text-2xl font-bold text-gray-900">{stats.totalUsers}</div>
    </div>
    <div class="rounded-lg border border-gray-200 bg-white p-4">
      <div class="text-sm text-gray-600 mb-1">Active</div>
      <div class="text-2xl font-bold text-green-600">{stats.activeUsers}</div>
    </div>
    <div class="rounded-lg border border-gray-200 bg-white p-4">
      <div class="text-sm text-gray-600 mb-1">Pending Setup</div>
      <div class="text-2xl font-bold text-yellow-600">{stats.pendingUsers}</div>
    </div>
    <div class="rounded-lg border border-gray-200 bg-white p-4">
      <div class="text-sm text-gray-600 mb-1">Admins</div>
      <div class="text-2xl font-bold text-red-600">{stats.adminUsers}</div>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <button
      id="create-user-btn"
      type="button"
      class="inline-flex items-center gap-2 rounded-lg bg-clr-green px-4 py-2.5 text-sm font-medium text-white hover:bg-clr-green/90 focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
      </svg>
      Create New User
    </button>
  </div>

  <!-- Filters -->
  <div class="mb-6 rounded-lg border border-gray-200 bg-gray-50 p-4">
    <form method="get" action="/portal/admin/users" class="flex flex-wrap items-end gap-3">
      <label class="flex flex-col gap-1 text-sm font-medium text-gray-700">
        Role
        <select name="role" class="rounded border border-gray-300 px-2 py-1.5 text-sm">
          <option value="" selected={!roleFilter}>All Roles</option>
          <option value="member" selected={roleFilter === 'member'}>Member</option>
          <option value="arb" selected={roleFilter === 'arb'}>ARB</option>
          <option value="board" selected={roleFilter === 'board'}>Board</option>
          <option value="arb_board" selected={roleFilter === 'arb_board'}>ARB + Board</option>
          <option value="admin" selected={roleFilter === 'admin'}>Admin</option>
        </select>
      </label>

      <label class="flex flex-col gap-1 text-sm font-medium text-gray-700">
        Status
        <select name="status" class="rounded border border-gray-300 px-2 py-1.5 text-sm">
          <option value="" selected={!statusFilter}>All Statuses</option>
          <option value="active" selected={statusFilter === 'active'}>Active</option>
          <option value="pending_setup" selected={statusFilter === 'pending_setup'}>Pending Setup</option>
          <option value="inactive" selected={statusFilter === 'inactive'}>Inactive</option>
          <option value="locked" selected={statusFilter === 'locked'}>Locked</option>
        </select>
      </label>

      <label class="flex flex-col gap-1 text-sm font-medium text-gray-700">
        Search
        <input
          type="text"
          name="search"
          value={search}
          placeholder="Email or name..."
          class="rounded border border-gray-300 px-2 py-1.5 text-sm w-64"
        />
      </label>

      <button
        type="submit"
        class="rounded bg-clr-green px-4 py-1.5 text-sm font-medium text-white hover:bg-clr-green/90"
      >
        Apply Filters
      </button>

      {(roleFilter || statusFilter || search) && (
        <a
          href="/portal/admin/users"
          class="rounded border border-gray-300 bg-white px-4 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          Clear
        </a>
      )}
    </form>
  </div>

  <!-- Users List (Loaded via JavaScript) -->
  <div id="users-container" class="rounded-xl border border-gray-200 bg-white overflow-hidden">
    <div class="p-8 text-center">
      <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-clr-green border-r-transparent"></div>
      <p class="mt-2 text-sm text-gray-500">Loading users...</p>
    </div>
  </div>

  <!-- Create User Modal -->
  <div id="create-user-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>
      <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:align-middle">
        <form id="create-user-form">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modal-title">Create New User</h3>

            <div class="space-y-4">
              <div>
                <label for="create-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                <input
                  type="email"
                  id="create-email"
                  name="email"
                  required
                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-clr-green focus:ring-clr-green sm:text-sm"
                  placeholder="user@example.com"
                />
              </div>

              <div>
                <label for="create-role" class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                <select
                  id="create-role"
                  name="role"
                  required
                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-clr-green focus:ring-clr-green sm:text-sm"
                >
                  <option value="member">Member</option>
                  <option value="arb">ARB</option>
                  <option value="board">Board</option>
                  <option value="arb_board">ARB + Board</option>
                  <option value="admin">Admin</option>
                </select>
              </div>

              <div>
                <label for="create-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input
                  type="text"
                  id="create-name"
                  name="name"
                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-clr-green focus:ring-clr-green sm:text-sm"
                  placeholder="John Doe"
                />
              </div>

              <div>
                <label for="create-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                <input
                  type="tel"
                  id="create-phone"
                  name="phone"
                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-clr-green focus:ring-clr-green sm:text-sm"
                  placeholder="(555) 123-4567"
                />
              </div>

              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="create-send-email"
                  name="sendEmail"
                  checked
                  class="h-4 w-4 rounded border-gray-300 text-clr-green focus:ring-clr-green"
                />
                <label for="create-send-email" class="ml-2 block text-sm text-gray-700">
                  Send password setup email
                </label>
              </div>
            </div>

            <div id="create-error" class="hidden mt-4 rounded-md bg-red-50 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="ml-3">
                  <p id="create-error-text" class="text-sm text-red-800"></p>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
            <button
              type="submit"
              class="inline-flex w-full justify-center rounded-md border border-transparent bg-clr-green px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-clr-green/90 focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2 sm:ml-3 sm:w-auto sm:text-sm"
            >
              Create User
            </button>
            <button
              type="button"
              id="cancel-create-btn"
              class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-clr-green focus:ring-offset-2 sm:mt-0 sm:w-auto sm:text-sm"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script is:inline>
    // Load users on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();
      setupCreateUserModal();
    });

    async function loadUsers() {
      const container = document.getElementById('users-container');
      if (!container) return;

      try {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);

        const response = await fetch(`/api/admin/users?${params.toString()}`);

        if (!response.ok) {
          throw new Error('Failed to load users');
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load users');
        }

        renderUsersTable(data);
      } catch (error) {
        console.error('Error loading users:', error);
        container.innerHTML = `
          <div class="p-6 text-center text-red-600">
            <p>Failed to load users. Please try again.</p>
          </div>
        `;
      }
    }

    function renderUsersTable(data) {
      const container = document.getElementById('users-container');
      if (!container) return;

      const { users, pagination } = data;

      if (users.length === 0) {
        container.innerHTML = `
          <div class="p-6 text-center text-gray-500">
            <p>No users found matching your filters.</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="text-left py-3 px-4 font-medium text-gray-700">Email</th>
                <th class="text-left py-3 px-4 font-medium text-gray-700">Name</th>
                <th class="text-left py-3 px-4 font-medium text-gray-700">Role</th>
                <th class="text-left py-3 px-4 font-medium text-gray-700">Status</th>
                <th class="text-left py-3 px-4 font-medium text-gray-700">Last Login</th>
                <th class="text-left py-3 px-4 font-medium text-gray-700">Created</th>
                <th class="text-right py-3 px-4 font-medium text-gray-700">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                  <td class="py-3 px-4">
                    <div class="font-medium text-gray-900">${escapeHtml(user.email)}</div>
                    ${user.phone ? `<div class="text-xs text-gray-500">${escapeHtml(user.phone)}</div>` : ''}
                  </td>
                  <td class="py-3 px-4 text-gray-700">${user.name ? escapeHtml(user.name) : '—'}</td>
                  <td class="py-3 px-4">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${getRoleBadgeClass(user.role)}">
                      ${user.role}
                    </span>
                  </td>
                  <td class="py-3 px-4">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusBadgeClass(user.status)}">
                      ${user.status}
                    </span>
                  </td>
                  <td class="py-3 px-4 text-gray-600 text-xs whitespace-nowrap">${formatDate(user.last_login)}</td>
                  <td class="py-3 px-4 text-gray-600 text-xs whitespace-nowrap">${formatDate(user.created)}</td>
                  <td class="py-3 px-4 text-right">
                    ${user.status === 'pending_setup' ? `
                      <button
                        class="text-sm text-clr-green hover:text-clr-green/80 mr-2"
                        onclick="resendSetupEmail('${escapeHtml(user.email)}')"
                      >
                        Resend Email
                      </button>
                    ` : ''}
                    <button
                      class="text-sm text-blue-600 hover:text-blue-800"
                      onclick="editUser('${escapeHtml(user.email)}')"
                    >
                      Edit
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${pagination.totalPages > 1 ? `
          <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6">
            <div class="flex flex-1 justify-between sm:hidden">
              ${pagination.hasPrev ? `
                <a href="?page=${pagination.page - 1}" class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                  Previous
                </a>
              ` : ''}
              ${pagination.hasNext ? `
                <a href="?page=${pagination.page + 1}" class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
                  Next
                </a>
              ` : ''}
            </div>
            <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
              <div>
                <p class="text-sm text-gray-700">
                  Showing <span class="font-medium">${(pagination.page - 1) * pagination.limit + 1}</span> to <span class="font-medium">${Math.min(pagination.page * pagination.limit, pagination.totalCount)}</span> of{' '}
                  <span class="font-medium">${pagination.totalCount}</span> results
                </p>
              </div>
              <div>
                <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                  ${pagination.hasPrev ? `
                    <a href="?page=${pagination.page - 1}" class="relative inline-flex items-center rounded-l-md border border-gray-300 bg-white px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50">
                      <span class="sr-only">Previous</span>
                      ‹
                    </a>
                  ` : ''}
                  ${Array.from({ length: Math.min(5, pagination.totalPages) }, (_, i) => {
                    const pageNum = i + 1;
                    const isCurrent = pageNum === pagination.page;
                    return `
                      <a
                        href="?page=${pageNum}"
                        class="relative inline-flex items-center border border-gray-300 px-4 py-2 text-sm font-medium ${isCurrent ? 'z-10 bg-clr-green text-white' : 'bg-white text-gray-700 hover:bg-gray-50'}"
                      >
                        ${pageNum}
                      </a>
                    `;
                  }).join('')}
                  ${pagination.hasNext ? `
                    <a href="?page=${pagination.page + 1}" class="relative inline-flex items-center rounded-r-md border border-gray-300 bg-white px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50">
                      <span class="sr-only">Next</span>
                      ›
                    </a>
                  ` : ''}
                </nav>
              </div>
            </div>
          </div>
        ` : ''}
      `;

      container.innerHTML = html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      try {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch {
        return dateStr || '—';
      }
    }

    function getRoleBadgeClass(role) {
      switch (role) {
        case 'admin': return 'bg-red-100 text-red-800';
        case 'board':
        case 'arb_board': return 'bg-blue-100 text-blue-800';
        case 'arb': return 'bg-purple-100 text-purple-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case 'active': return 'bg-green-100 text-green-800';
        case 'pending_setup': return 'bg-yellow-100 text-yellow-800';
        case 'inactive': return 'bg-gray-100 text-gray-600';
        case 'locked': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function setupCreateUserModal() {
      const modal = document.getElementById('create-user-modal');
      const openBtn = document.getElementById('create-user-btn');
      const cancelBtn = document.getElementById('cancel-create-btn');
      const form = document.getElementById('create-user-form');

      if (!modal || !openBtn || !cancelBtn || !form) return;

      openBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        form.reset();
        hideError();
      });

      cancelBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await createUser(form);
      });
    }

    async function createUser(form) {
      const formData = new FormData(form);
      const data = {
        email: formData.get('email'),
        role: formData.get('role'),
        name: formData.get('name'),
        phone: formData.get('phone'),
        sendEmail: formData.get('sendEmail') === 'on',
      };

      try {
        const response = await fetch('/api/admin/users/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create user');
        }

        // Success - close modal and reload
        document.getElementById('create-user-modal').classList.add('hidden');
        await loadUsers();
      } catch (error) {
        showError(error.message);
      }
    }

    // Expose functions to global scope for onclick handlers in dynamically generated HTML
    window.resendSetupEmail = async function(email) {
      if (!confirm(`Resend password setup email to ${email}?`)) return;

      try {
        const response = await fetch('/api/admin/users/resend-setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to resend email');
        }

        alert('Password setup email sent successfully!');
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    };

    window.editUser = function(email) {
      // TODO: Implement edit user modal
      alert(`Edit user: ${email} (coming soon)`);
    };

    function showError(message) {
      const errorDiv = document.getElementById('create-error');
      const errorText = document.getElementById('create-error-text');
      if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }

    function hideError() {
      const errorDiv = document.getElementById('create-error');
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
    }
  </script>
</BoardLayout>
