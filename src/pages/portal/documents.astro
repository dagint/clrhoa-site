---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getArbRequestCountsByStatus, listArbRequestsByHousehold } from '../../lib/arb-db';
import { listPendingSubmissions } from '../../lib/vendor-submissions-db';
import { getOwnerByEmail } from '../../lib/directory-db';
import { listMaintenanceByHousehold } from '../../lib/maintenance-db';
import { listUpcomingWithCountsAndUser, householdHasRsvpd } from '../../lib/meetings-db';
import { listActiveFeedbackDocs, getFeedbackResponse, householdHasResponded } from '../../lib/feedback-db';
import { listMemberDocuments } from '../../lib/member-documents-db';
import { MEMBER_DOC_CATEGORIES, MEMBER_DOC_CATEGORY_LABELS } from '../../lib/member-documents-db';

const { env, session, effectiveRole } = await getPortalContext(Astro);
if (!session) return Astro.redirect('/portal/login');

const { email, role, name } = session;
const db = env?.DB;

// User display name
let displayName = name?.trim() || null;
if (!displayName && db) {
  const owner = await getOwnerByEmail(db, email);
  displayName = owner?.name?.trim() || null;
}

// Badge counts for sidebar
let arbCounts: { pending: number; in_review: number } = { pending: 0, in_review: 0 };
let pendingVendorCount = 0;
const hasStaffWhitelistRole = role === 'arb' || role === 'board' || role === 'admin' || role === 'arb_board';

if (db && hasStaffWhitelistRole) {
  const counts = await getArbRequestCountsByStatus(db);
  arbCounts = { pending: counts.pending, in_review: counts.in_review };
  const pendingSubmissions = await listPendingSubmissions(db);
  pendingVendorCount = pendingSubmissions.length;
}

const allRequests = db ? await listArbRequestsByHousehold(db, email) : [];
const draftCount = allRequests.filter((r) => r.status === 'pending').length;

let maintenanceOpenCount = 0;
let meetingsRsvpCount = 0;
let feedbackDueCount = 0;
if (db) {
  const maintenanceList = await listMaintenanceByHousehold(db, email);
  maintenanceOpenCount = maintenanceList.filter((m) => m.status !== 'completed').length;
  const upcomingMeetings = await listUpcomingWithCountsAndUser(db, email);
  meetingsRsvpCount = 0;
  for (const m of upcomingMeetings) {
    if (m.user_response != null) continue;
    if (await householdHasRsvpd(db, m.id, email)) continue;
    meetingsRsvpCount += 1;
  }
  const activeFeedback = await listActiveFeedbackDocs(db);
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().slice(0, 10);
  for (const doc of activeFeedback) {
    const resp = await getFeedbackResponse(db, doc.id, email);
    if (resp) continue;
    if (await householdHasResponded(db, doc.id, email)) continue;
    if (doc.deadline == null || doc.deadline <= tomorrowStr) feedbackDueCount += 1;
  }
}

// Documents
const docs = db ? await listMemberDocuments(db) : [];

function formatDate(s: string | null): string {
  if (!s) return '';
  try {
    return new Date(s).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch {
    return s;
  }
}

const docsByCategory = MEMBER_DOC_CATEGORIES.map((cat) => ({
  category: cat,
  label: MEMBER_DOC_CATEGORY_LABELS[cat],
  docs: docs.filter((d) => d.category === cat),
}));
---

<PortalLayout title="Documents | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/documents"
    pageTitle="Documents"
    userName={displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={arbCounts.in_review}
    vendorPendingCount={pendingVendorCount}
    maintenanceOpenCount={maintenanceOpenCount}
    meetingsRsvpCount={meetingsRsvpCount}
    feedbackDueCount={feedbackDueCount}
  >
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-2">Member Documents</h1>
      <p class="text-gray-600 text-lg">
        Redacted minutes, budgets, and other member-only files.
      </p>
    </div>

    {docs.length === 0 ? (
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="text-gray-500 text-lg mb-2">No member documents yet</p>
        <p class="text-gray-400">Check back later or contact the board if you need a document added.</p>
      </div>
    ) : (
      <div class="space-y-8">
        {docsByCategory.map(({ label, docs: catDocs }) => (
          catDocs.length > 0 && (
            <section>
              <h2 class="text-xl font-heading font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <span class="w-1 h-6 bg-clr-green rounded-full"></span>
                {label}
              </h2>
              <ul class="space-y-3">
                {catDocs.map((doc) => (
                  <li>
                    <a
                      href={`/api/portal/file/${encodeURIComponent(doc.file_key)}`}
                      class="flex items-center gap-4 bg-white rounded-xl border border-gray-200 p-5 shadow-sm hover:shadow-md hover:border-clr-green/40 transition-all group"
                    >
                      <div class="w-12 h-12 rounded-lg bg-clr-green/10 flex items-center justify-center shrink-0 group-hover:bg-clr-green/20 transition-colors">
                        <svg class="w-6 h-6 text-clr-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-gray-900 font-semibold text-lg mb-1">{doc.title}</p>
                        {doc.uploaded_at && (
                          <p class="text-sm text-gray-500">
                            Uploaded {formatDate(doc.uploaded_at)}
                          </p>
                        )}
                      </div>
                      <div class="flex items-center gap-2 text-clr-orange font-medium shrink-0">
                        <span>Download</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                      </div>
                    </a>
                  </li>
                ))}
              </ul>
            </section>
          )
        ))}
      </div>
    )}

    <div class="mt-12 p-6 bg-gray-50 rounded-xl border border-gray-200">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-clr-green shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <p class="font-medium text-gray-800 mb-1">Looking for public documents?</p>
          <p class="text-gray-600 text-sm mb-3">
            Covenants, bylaws, ARB forms, and proxy forms are available on the public website.
          </p>
          <a href="/documents" class="inline-flex items-center gap-2 text-clr-green hover:underline font-medium">
            View public documents
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </PortalPage>
</PortalLayout>
