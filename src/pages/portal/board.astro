---
/**
 * BOARD Landing Zone: /portal/board
 *
 * Required permissions: effectiveRole === 'board' or 'arb_board'
 *
 * Route-level guard: Uses getBoardContext() to enforce board-only access.
 * Redirects non-board users to their appropriate landing zone:
 * - admin → /portal/admin
 * - arb → /portal/arb
 * - board/arb_board whitelist but not elevated → /portal/request-elevated-access
 * - member → /portal/dashboard
 *
 * When a user elevates to board role (via PIM), they are redirected here.
 * When a user de-elevates or PIM expires, they revert to member role and see /portal/dashboard.
 */
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import BoardNav from '../../components/BoardNav.astro';
import { getBoardContext } from '../../lib/board-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';

// Route-level guard: enforce board-only access
const ctx = await getBoardContext(Astro);
if ('redirect' in ctx) return Astro.redirect(ctx.redirect);
const { env, session, effectiveRole } = ctx;

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);
---

<PortalLayout title="Board | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/board"
    pageTitle="Board"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <BoardNav currentPath="/portal/board" />

    <div class="mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-2">Board</h1>
      <p class="text-gray-600 text-lg">Manage directory, documents, and operations.</p>
    </div>

    <div class="mb-8 flex flex-wrap gap-4">
      <a href="/board/assessments" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-clr-green hover:brightness-110 text-white font-semibold text-base shadow-sm">
        Record payment
      </a>
      <a href="/board/vendors" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl border-2 border-gray-300 text-gray-700 hover:bg-gray-100 font-semibold text-base">
        Vendor submissions
        {badges.vendorPendingCount > 0 && (
          <span class="inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1 rounded-full bg-amber-500 text-white text-xs font-bold">{badges.vendorPendingCount}</span>
        )}
      </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" aria-labelledby="board-docs-heading">
        <h2 id="board-docs-heading" class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Documents</h2>
        <ul class="space-y-3">
          <li>
            <a href="/board/public-documents" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Public documents</span>
              <span class="text-sm text-gray-400">Bylaws, covenants, forms</span>
            </a>
          </li>
          <li>
            <a href="/board/member-documents" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Member documents</span>
              <span class="text-sm text-gray-400">Minutes, budgets</span>
            </a>
          </li>
        </ul>
      </section>

      <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" aria-labelledby="board-ops-heading">
        <h2 id="board-ops-heading" class="text-base font-semibold text-gray-500 uppercase tracking-wide mb-4">Directory &amp; operations</h2>
        <ul class="space-y-3">
          <li>
            <a href="/board/directory" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Directory</span>
              <span class="text-sm text-gray-400">Homeowner list</span>
            </a>
          </li>
          <li>
            <a href="/board/vendors" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Vendors</span>
              {badges.vendorPendingCount > 0 ? (
                <span class="text-sm font-semibold text-amber-600">{badges.vendorPendingCount} pending</span>
              ) : (
                <span class="text-sm text-gray-400">Recommendations</span>
              )}
            </a>
          </li>
          <li>
            <a href="/board/meetings" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Meetings</span>
              <span class="text-sm text-gray-400">Agendas</span>
            </a>
          </li>
          <li>
            <a href="/board/maintenance" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Maintenance</span>
              <span class="text-sm text-gray-400">Requests</span>
            </a>
          </li>
          <li>
            <a href="/board/feedback" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Feedback</span>
              <span class="text-sm text-gray-400">Surveys</span>
            </a>
          </li>
          <li>
            <a href="/board/library" class="flex items-center justify-between gap-3 p-4 rounded-xl border border-gray-100 hover:border-clr-green hover:bg-clr-green/5 transition-colors">
              <span class="font-semibold text-clr-green text-base">Pre-approval library</span>
              <span class="text-sm text-gray-400">Approve &amp; manage</span>
            </a>
          </li>
        </ul>
      </section>
    </div>

    <p class="mt-8 text-base text-gray-500">
      <a href="/board/audit-logs" class="text-clr-green hover:underline">Audit logs</a> for transparency on directory and ARB access.
    </p>
  </PortalPage>
</PortalLayout>
