---
export const prerender = false;

import PortalLayout from '../../layouts/PortalLayout.astro';
import PortalPage from '../../components/PortalPage.astro';
import { getPortalContext } from '../../lib/portal-context';
import { getPortalBadgeCounts } from '../../lib/portal-badge-counts';
import { listMaintenanceByHousehold, parsePhotosJson, MAINTENANCE_CATEGORIES } from '../../lib/maintenance-db';

const { env, session, effectiveRole } = await getPortalContext(Astro, { fingerprint: true });
if (!session) return Astro.redirect('/auth/login');

const { email, role, name } = session;
const db = env?.DB;
const badges = await getPortalBadgeCounts(db, email, role, name);
const requests = db ? await listMaintenanceByHousehold(db, email) : [];

const categories = MAINTENANCE_CATEGORIES;

function categoryLabel(cat: string): string {
  return cat === 'general' ? 'General' : cat.charAt(0).toUpperCase() + cat.slice(1);
}

function formatDate(s: string): string {
  try {
    return new Date(s).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch {
    return s;
  }
}
---

<PortalLayout title="Maintenance | Member Portal | Crooked Lake Reserve HOA">
  <PortalPage
    currentPath="/portal/maintenance"
    pageTitle="Maintenance"
    userName={badges.displayName ?? undefined}
    userEmail={email}
    effectiveRole={effectiveRole}
    draftCount={badges.draftCount}
    role={effectiveRole}
    staffRole={role ?? ''}
    arbInReviewCount={badges.arbInReviewCount}
    vendorPendingCount={badges.vendorPendingCount}
    maintenanceOpenCount={badges.maintenanceOpenCount}
    meetingsRsvpCount={badges.meetingsRsvpCount}
    feedbackDueCount={badges.feedbackDueCount}
  >
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 mb-8">
      <h1 class="text-3xl font-heading font-bold text-clr-green mb-3">Maintenance Requests</h1>
      <p class="text-gray-600 text-lg">
        Report common-area maintenance or repair issues. The board will review and update status.
      </p>
    </div>

    <section class="bg-white portal-theme-card rounded-2xl shadow-sm border border-gray-100 p-6 sm:p-8 mb-8">
      <h2 class="text-2xl font-heading font-semibold text-clr-green mb-5">New request</h2>
        <form id="maintenance-form" class="space-y-5">
          <div>
            <label for="maint-category" class="block text-base font-semibold text-gray-700 mb-2">Category *</label>
            <select id="maint-category" name="category" required class="block w-full rounded-lg border border-gray-300 px-4 py-3 text-base focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green">
              {categories.map((c) => (
                <option value={c}>{categoryLabel(c)}</option>
              ))}
            </select>
          </div>
          <div>
            <label for="maint-description" class="block text-base font-semibold text-gray-700 mb-2">Description *</label>
            <textarea id="maint-description" name="description" required rows="5" class="block w-full rounded-lg border border-gray-300 px-4 py-3 text-base focus:border-clr-green focus:outline-none focus:ring-2 focus:ring-clr-green" placeholder="Describe the issue and location..."></textarea>
          </div>
          <div>
            <label for="maint-photos" class="block text-base font-semibold text-gray-700 mb-2">Photos (optional)</label>
            <input type="file" id="maint-photos" name="photos" accept="image/jpeg,image/png,image/gif,image/webp,image/heic" multiple class="block w-full text-base text-gray-600 file:mr-4 file:py-3 file:px-5 file:rounded-lg file:border-0 file:bg-clr-green file:text-white file:font-semibold file:hover:brightness-110 file:transition-all" />
            <p class="text-sm text-gray-500 mt-2">JPEG, PNG, GIF, WebP, or HEIC. Up to 25MB total. Photos are automatically resized and compressed for web.</p>
          </div>
          <p id="maint-form-status" class="text-base text-clr-green font-semibold hidden" role="status" aria-live="polite"></p>
          <button type="submit" id="maint-submit-btn" class="bg-clr-green hover:brightness-110 text-white px-6 py-3 rounded-xl font-semibold text-base transition-all">
            Submit request
          </button>
        </form>
      </section>

      <h2 class="text-2xl font-heading font-semibold text-clr-green mb-4">Your requests</h2>
    {requests.length === 0 ? (
      <div class="bg-white portal-theme-card rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
        </svg>
        <p class="text-gray-500 text-lg mb-2">No maintenance requests yet</p>
        <p class="text-gray-400">Submit a request above to report common-area issues</p>
      </div>
    ) : (
      <ul class="space-y-5">
        {requests.map((r) => {
          const photos = parsePhotosJson(r.photos);
          return (
            <li class="bg-white portal-theme-card rounded-2xl shadow-sm border border-gray-200 p-6 sm:p-8">
              <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
                <div class="flex flex-wrap items-center gap-2">
                  <span class="font-semibold text-clr-green text-lg">{categoryLabel(r.category)}</span>
                  <span class="text-base text-gray-500">{formatDate(r.created)}</span>
                  <span class={`text-sm font-semibold px-3 py-1 rounded-lg ${r.status === 'completed' ? 'bg-green-100 text-green-800' : r.status === 'in_progress' ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-700'}`}>
                    {r.status}
                  </span>
                </div>
              </div>
              <p class="text-gray-700 text-base leading-relaxed">{r.description}</p>
              {r.vendor_assigned && (
                <p class="text-base text-gray-600 mt-3">
                  <span class="font-semibold">Vendor:</span> {r.vendor_assigned}
                </p>
              )}
              {photos.length > 0 && (
                <div class="flex flex-wrap gap-3 mt-4">
                  {photos.slice(0, 5).map((key) => (
                    <a
                      href={`/api/portal/file/${encodeURIComponent(key)}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 text-base text-clr-orange font-semibold hover:underline"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <span>View photo</span>
                    </a>
                  ))}
                  {photos.length > 5 && <span class="text-base text-gray-500">+{photos.length - 5} more</span>}
                </div>
              )}
            </li>
          );
        })}
      </ul>
    )}
  </PortalPage>
</PortalLayout>

<script is:inline>
  (function () {
    const form = document.getElementById('maintenance-form');
    const statusEl = document.getElementById('maint-form-status');
    const submitBtn = document.getElementById('maint-submit-btn');

    const MAINT_PHOTO_MAX_WIDTH = 1920;
    const MAINT_PHOTO_JPEG_QUALITY = 0.82;

    /** Optimize image for web: resize to max width, compress as JPEG. Same as news. */
    function optimizeImageForWeb(file) {
      const imageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/heic'];
      const isImage = file.type && (imageTypes.includes(file.type) || file.type.startsWith('image/'));
      if (!isImage) return Promise.resolve(file);

      return new Promise(function (resolve) {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = function () {
          URL.revokeObjectURL(url);
          let w = img.naturalWidth;
          let h = img.naturalHeight;
          if (w > MAINT_PHOTO_MAX_WIDTH) {
            h = Math.round((h * MAINT_PHOTO_MAX_WIDTH) / w);
            w = MAINT_PHOTO_MAX_WIDTH;
          }
          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          if (!ctx) {
            resolve(file);
            return;
          }
          ctx.drawImage(img, 0, 0, w, h);
          canvas.toBlob(
            function (blob) {
              const name = file.name.replace(/\.[^.]+$/i, '.jpg');
              resolve(blob ? new File([blob], name, { type: 'image/jpeg' }) : file);
            },
            'image/jpeg',
            MAINT_PHOTO_JPEG_QUALITY
          );
        };
        img.onerror = function () {
          URL.revokeObjectURL(url);
          resolve(file);
        };
        img.src = url;
      });
    }

    function showStatus(text) {
      if (!statusEl) return;
      statusEl.textContent = text;
      statusEl.classList.remove('hidden');
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const category = form.querySelector('[name="category"]')?.value;
      const description = form.querySelector('[name="description"]')?.value?.trim();
      if (!description) {
        alert('Please enter a description');
        return;
      }
      const fileInput = form.querySelector('[name="photos"]');
      let files = fileInput?.files ? Array.from(fileInput.files).filter((f) => f.size > 0) : [];

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');
      }
      if (files.length > 0) showStatus('Optimizing photos for webâ€¦');

      try {
        if (files.length > 0) {
          const optimized = await Promise.all(files.map((f) => optimizeImageForWeb(f)));
          files = optimized.filter(Boolean);
        }
        const fd = new FormData();
        fd.set('category', category ?? '');
        fd.set('description', description);
        files.forEach((f) => fd.append('photos', f));

        const res = await fetch('/api/maintenance-submit', { method: 'POST', body: fd, credentials: 'same-origin' });
        const data = await res.json();
        if (data.success) {
          showStatus('Submitted. Photos optimized for web.');
          window.location.reload();
        } else {
          alert(data.error || 'Failed to submit');
        }
      } catch {
        alert('Network error. Please try again.');
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.removeAttribute('aria-busy');
        }
      }
    });
  })();
</script>
