---
/**
 * Password Setup Page
 *
 * First-time password setup for new users.
 * Users arrive here via email link with setup token.
 *
 * URL: /auth/setup-password?token=xxx
 *
 * Features:
 * - Simple, clean form with minimal fields
 * - Password visibility toggle
 * - Password strength indicator
 * - Clear error messages
 * - Mobile-responsive design
 * - Automatic redirect to dashboard on success
 */

import BaseLayout from '../../layouts/BaseLayout.astro';

// Get token from URL query parameter
const token = Astro.url.searchParams.get('token');

// If no token, show error state
const hasToken = !!token;
---

<BaseLayout title="Set Up Your Password - CLRHOA Portal">
  <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-emerald-100 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <!-- Logo/Header -->
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900">Welcome to CLRHOA</h1>
        <p class="mt-2 text-sm text-gray-600">
          {hasToken
            ? "Set up your password to access your member portal"
            : "Invalid or missing setup link"}
        </p>
      </div>

      {hasToken ? (
        <!-- Password Setup Form -->
        <div class="bg-white py-8 px-6 shadow-xl rounded-lg sm:px-10">
          <form id="setup-form" class="space-y-6">
            <!-- Hidden token field -->
            <input type="hidden" id="token" name="token" value={token} />

            <!-- Password field -->
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700">
                Create Password
              </label>
              <div class="mt-1 relative">
                <input
                  id="password"
                  name="password"
                  type="password"
                  autocomplete="new-password"
                  required
                  minlength="8"
                  maxlength="128"
                  class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-600 focus:border-green-600 sm:text-sm"
                  placeholder="At least 8 characters"
                />
                <button
                  type="button"
                  id="toggle-password"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                  aria-label="Toggle password visibility"
                >
                  <svg id="eye-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  <svg id="eye-slash-icon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                  </svg>
                </button>
              </div>
              <!-- Password strength indicator -->
              <div id="strength-indicator" class="mt-2 hidden">
                <div class="flex items-center space-x-2">
                  <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="strength-bar" class="h-full transition-all duration-300"></div>
                  </div>
                  <span id="strength-text" class="text-xs font-medium"></span>
                </div>
              </div>
              <p class="mt-2 text-xs text-gray-500">
                Minimum 8 characters. Use a mix of letters, numbers, and symbols for better security.
              </p>
            </div>

            <!-- Confirm Password field -->
            <div>
              <label for="password_confirm" class="block text-sm font-medium text-gray-700">
                Confirm Password
              </label>
              <div class="mt-1">
                <input
                  id="password_confirm"
                  name="password_confirm"
                  type="password"
                  autocomplete="new-password"
                  required
                  minlength="8"
                  maxlength="128"
                  class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-600 focus:border-green-600 sm:text-sm"
                  placeholder="Re-enter your password"
                />
              </div>
            </div>

            <!-- Error message -->
            <div id="error-message" class="hidden rounded-md bg-red-50 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="ml-3">
                  <p id="error-text" class="text-sm font-medium text-red-800"></p>
                </div>
              </div>
            </div>

            <!-- Submit button -->
            <div>
              <button
                type="submit"
                id="submit-btn"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-700 hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600 transition-colors duration-200"
              >
                Set Up Password
              </button>
            </div>
          </form>

          <!-- Support info -->
          <div class="mt-6 text-center">
            <p class="text-xs text-gray-500">
              Need help? Contact us at{' '}
              <a href="mailto:support@clrhoa.com" class="text-green-700 hover:text-green-800">
                support@clrhoa.com
              </a>
            </p>
          </div>
        </div>
      ) : (
        <!-- Invalid Token State -->
        <div class="bg-white py-8 px-6 shadow-xl rounded-lg sm:px-10">
          <div class="rounded-md bg-yellow-50 p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">
                  Invalid Setup Link
                </h3>
                <div class="mt-2 text-sm text-yellow-700">
                  <p>
                    This setup link is invalid or has expired. Please contact your administrator to request a new setup link.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6">
            <a
              href="/auth/login"
              class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-700 hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600"
            >
              Go to Login
            </a>
          </div>
        </div>
      )}
    </div>
  </div>

  <script>
    // Password visibility toggle
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const toggleBtn = document.getElementById('toggle-password');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeSlashIcon = document.getElementById('eye-slash-icon');

    toggleBtn?.addEventListener('click', () => {
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      eyeIcon?.classList.toggle('hidden');
      eyeSlashIcon?.classList.toggle('hidden');
    });

    // Password strength indicator
    const strengthIndicator = document.getElementById('strength-indicator');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');

    function calculatePasswordStrength(password: string): { score: number; label: string; color: string } {
      let score = 0;

      if (password.length >= 8) score++;
      if (password.length >= 12) score++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
      if (/[0-9]/.test(password)) score++;
      if (/[^a-zA-Z0-9]/.test(password)) score++;

      if (score <= 1) return { score: 20, label: 'Weak', color: 'bg-red-500' };
      if (score === 2) return { score: 40, label: 'Fair', color: 'bg-orange-500' };
      if (score === 3) return { score: 60, label: 'Good', color: 'bg-yellow-500' };
      if (score === 4) return { score: 80, label: 'Strong', color: 'bg-green-500' };
      return { score: 100, label: 'Excellent', color: 'bg-green-600' };
    }

    passwordInput?.addEventListener('input', (e) => {
      const password = (e.target as HTMLInputElement).value;

      if (password.length > 0) {
        strengthIndicator?.classList.remove('hidden');
        const strength = calculatePasswordStrength(password);

        if (strengthBar && strengthText) {
          strengthBar.style.width = `${strength.score}%`;
          strengthBar.className = `h-full transition-all duration-300 ${strength.color}`;
          strengthText.textContent = strength.label;
          strengthText.className = `text-xs font-medium ${strength.color.replace('bg-', 'text-')}`;
        }
      } else {
        strengthIndicator?.classList.add('hidden');
      }
    });

    // Form submission
    const form = document.getElementById('setup-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    function showError(message: string) {
      if (errorMessage && errorText) {
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
      }
    }

    function hideError() {
      errorMessage?.classList.add('hidden');
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const formData = new FormData(form);
      const token = formData.get('token') as string;
      const password = formData.get('password') as string;
      const password_confirm = formData.get('password_confirm') as string;

      // Client-side validation
      if (password !== password_confirm) {
        showError('Passwords do not match');
        return;
      }

      if (password.length < 8) {
        showError('Password must be at least 8 characters long');
        return;
      }

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Setting up...';

      try {
        const response = await fetch('/api/auth/setup-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password, password_confirm }),
        });

        const data = (await response.json()) as {
          success?: boolean;
          redirectTo?: string;
          error?: string;
        };

        if (response.ok) {
          // Success - redirect to dashboard
          window.location.href = data.redirectTo || '/portal/dashboard';
        } else {
          // Show error message
          showError(data.error || 'An error occurred. Please try again.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Set Up Password';
        }
      } catch (error) {
        console.error('Setup error:', error);
        showError('Network error. Please check your connection and try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Set Up Password';
      }
    });
  </script>
</BaseLayout>
