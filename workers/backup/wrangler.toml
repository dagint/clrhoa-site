# Backup Worker: cron-triggered D1 export + KV whitelist dump to R2, optional Google Drive (Phase 3).
# Deploy from repo root: npx wrangler deploy workers/backup
# Set secrets: npx wrangler secret put CLOUDFLARE_BACKUP_API_TOKEN --env backup (from workers/backup dir)
# Or from root: npx wrangler secret put CLOUDFLARE_BACKUP_API_TOKEN --config workers/backup/wrangler.toml
name = "clrhoa-backup"
main = "src/index.ts"
compatibility_date = "2025-02-01"
compatibility_flags = ["nodejs_compat"]

# Run daily at 2:00 AM UTC
[triggers]
crons = ["0 2 * * *"]

# Same D1 as main app (for Phase 3: read backup_config)
[[d1_databases]]
binding = "DB"
database_name = "clrhoa_db"
database_id = "66c2da44-c133-4e57-9352-e72637901cb4"

[[kv_namespaces]]
binding = "CLOURHOA_USERS"
id = "45ba5f4e64864c1eb5fcc7a6705b0a70"

[[r2_buckets]]
binding = "BACKUP_R2"
bucket_name = "clrhoa-files"

[vars]
# Cloudflare account ID â€” must match your account. Set in this file (same value as CLOUDFLARE_ACCOUNT_ID in GitHub Secrets).
# If you use CI/CD, ensure this value is your real account ID (e.g. edd8cf1c48ad414729e72fb0bf468543).
CLOUDFLARE_ACCOUNT_ID = "edd8cf1c48ad414729e72fb0bf468543"
# D1 database UUID (same as main app wrangler.toml)
D1_DATABASE_ID = "a214f9da-3577-4ee7-bc50-bc9b9754a79c"
# Retention: keep daily backups this many days
BACKUP_RETENTION_DAYS = "30"

# Secrets (set via wrangler secret put):
# CLOUDFLARE_BACKUP_API_TOKEN - API token scoped: D1 Read (export), R2 Edit (write backups), KV Read (dump whitelist)
# Phase 3: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, BACKUP_ENCRYPTION_KEY (for decrypting refresh_token)
